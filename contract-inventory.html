<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>合同库存管理系统 - 采购合同数量统计</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a56db',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
        
        // 从localStorage更新公司选择器
        function updateCompanySelectors() {
            const companySelectors = document.querySelectorAll('select[id="company-select"]');
            const companies = JSON.parse(localStorage.getItem('companyNames')) || {
                'companyA': '普利美（常州）环境工程科技有限公司',
                'companyB': '无锡龙力印铁设备制造有限公司'
            };
            
            companySelectors.forEach(selector => {
                // 保存当前选中的值
                const currentValue = selector.value;
                
                // 清空现有选项
                selector.innerHTML = '';
                
                // 添加新选项
                Object.entries(companies).forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    selector.appendChild(option);
                });
                
                // 恢复选中值
                selector.value = currentValue;
            });
        }
        
        // 页面加载时更新公司选择器
        document.addEventListener('DOMContentLoaded', function() {
            updateCompanySelectors();
        });
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .card {
                @apply bg-white rounded-lg shadow-card p-6 transition-all-300;
            }
            .card:hover {
                @apply shadow-card-hover;
            }
            .btn {
                @apply px-4 py-2 rounded-md font-medium transition-all-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary/50;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success/50;
            }
            .btn-warning {
                @apply bg-warning text-white hover:bg-warning/90 focus:ring-warning/50;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger/50;
            }
            .nav-link {
                @apply flex items-center gap-2 px-3 py-2 rounded-md text-sm transition-all-300 whitespace-nowrap;
            }
            .nav-link.active {
                @apply bg-primary text-white font-medium;
            }
            .nav-link:not(.active) {
                @apply text-gray-600 hover:bg-gray-200;
            }
            .badge {
                @apply px-2 py-1 text-xs font-medium rounded-full;
            }
            .badge-primary {
                @apply bg-primary/20 text-primary;
            }
            .badge-success {
                @apply bg-success/20 text-success;
            }
            .badge-warning {
                @apply bg-warning/20 text-warning;
            }
            .badge-danger {
                @apply bg-danger/20 text-danger;
            }
            .badge-info {
                @apply bg-info/20 text-info;
            }
            .form-input, .form-select, .form-textarea {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .form-group {
                @apply mb-4;
            }
            .table-container {
                @apply overflow-x-auto relative;
            }
            .table {
                @apply min-w-full divide-y divide-gray-200;
                table-layout: fixed;
            }
            .table th {
                @apply px-4 py-3 bg-gray-50 text-left text-xs font-medium uppercase tracking-wider;
                color: #6b7280; /* text-gray-500 */
            }
            .table td {
                @apply px-4 py-3 whitespace-nowrap text-sm;
                color: #6b7280; /* text-gray-500 */
            }
            .table tr {
                @apply hover:bg-gray-50;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex flex-col h-screen overflow-hidden">
        <!-- 顶部导航栏 -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <!-- 系统 Logo 和公司选择 -->
            <div class="flex items-center justify-between p-4 border-b border-gray-100">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-primary flex items-center gap-2">
                        <i class="fa fa-cubes"></i>
                        <span>合同库存管理</span>
                    </h1>
                    <p class="text-xs text-gray-500">采购合同数量统计系统</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <select id="company-select" class="form-input h-10">
                            <option value="companyA">普利美（常州）环境工程科技有限公司</option>
                            <option value="companyB">无锡龙力印铁设备制造有限公司</option>
                        </select>
                    </div>
                    
                    <!-- 数据管理下拉菜单 -->
                    <div class="relative">
                        <button id="data-management-btn" class="btn btn-primary">
                            <i class="fa fa-cog mr-1"></i>数据管理
                            <i class="fa fa-chevron-down ml-1"></i>
                        </button>
                        <div id="data-management-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                            <button id="export-data-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i class="fa fa-download mr-2"></i>导出数据
                            </button>
                            <button id="import-data-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i class="fa fa-upload mr-2"></i>导入数据
                            </button>
                            <div class="border-t border-gray-100 my-1"></div>
                            <button id="import-from-index-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                <i class="fa fa-exchange mr-2"></i>从主系统导入合同
                            </button>
                        </div>
                        <!-- 分页控件容器 -->
                        <div id="recent-activities-pagination-stats" class="p-4 border-t border-gray-300"></div>
                    </div>
                </div>
            </div>
            
            <!-- 主导航菜单 -->
            <div class="p-1 bg-gray-50">
                <nav class="flex items-center gap-1 overflow-x-auto">
                    <a href="#dashboard" class="nav-link active" data-page="dashboard">
                        <i class="fa fa-dashboard w-4 text-center"></i>
                        <span>统计概览</span>
                    </a>
                    <a href="#contracts" class="nav-link" data-page="contracts">
                        <i class="fa fa-file-text w-4 text-center"></i>
                        <span>合同管理</span>
                    </a>
                    <a href="#receipts" class="nav-link" data-page="receipts">
                        <i class="fa fa-truck w-4 text-center"></i>
                        <span>收货记录</span>
                    </a>
                    <a href="#returns" class="nav-link" data-page="returns">
                        <i class="fa fa-exchange w-4 text-center"></i>
                        <span>退货记录</span>
                    </a>
                    <a href="#inventory" class="nav-link" data-page="inventory">
                        <i class="fa fa-bar-chart w-4 text-center"></i>
                        <span>库存统计</span>
                    </a>
                    <a href="#comparison" class="nav-link" data-page="comparison">
                        <i class="fa fa-balance-scale w-4 text-center"></i>
                        <span>合同比对</span>
                    </a>

                </nav>
            </div>
            

        </header>
        
        <!-- 主内容区 -->
        <main class="flex-1 overflow-y-auto bg-gray-50" style="margin-top: 0;">
            
            <!-- 页面内容 -->
            <div class="p-4">
                <!-- 统计概览页面 -->
                <div id="dashboard-page" class="page">
                    <!-- 统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">合同总数</p>
                                    <h3 class="text-2xl font-bold" id="total-contracts">0</h3>
                                </div>
                                <div class="p-3 bg-primary/10 rounded-full">
                                    <i class="fa fa-file-text-o text-primary text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">已完成收货</p>
                                    <h3 class="text-2xl font-bold" id="completed-receipts">0</h3>
                                </div>
                                <div class="p-3 bg-success/10 rounded-full">
                                    <i class="fa fa-check-circle text-success text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">待收货数量</p>
                                    <h3 class="text-2xl font-bold" id="pending-quantity">0</h3>
                                </div>
                                <div class="p-3 bg-warning/10 rounded-full">
                                    <i class="fa fa-clock-o text-warning text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">存在差异合同</p>
                                    <h3 class="text-2xl font-bold" id="difference-contracts">0</h3>
                                </div>
                                <div class="p-3 bg-danger/10 rounded-full">
                                    <i class="fa fa-exclamation-triangle text-danger text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 最近合同动态 -->
                    <div class="card mb-6">
                        <h3 class="text-lg font-medium mb-4">最近合同动态</h3>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>合同号</th>
                                        <th>供应商</th>
                                        <th>产品名称</th>
                                        <th>合同数量</th>
                                        <th>已收数量</th>
                                        <th>未收数量</th>
                                        <th>状态</th>
                                        <th>更新时间</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-activities">
                                    <!-- 最近动态数据将动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 分页控件容器 -->
                        <div id="recent-activities-pagination-stats" class="p-4 border-t border-gray-300"></div>
                    </div>
                </div>
                
                <!-- 合同管理页面 -->
                <div id="contracts-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div></div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="w-full sm:w-auto max-w-sm">
                                <input type="text" id="contract-search" class="form-input" placeholder="请输入合同号、供应商等关键词进行搜索">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 合同列表 -->
                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                    <th>合同号</th>
                                    <th>供应商</th>
                                    <th>产品名称</th>
                                    <th>规格型号</th>
                                    <th>合同数量</th>
                                    <th>单位</th>
                                    <th>单价</th>
                                    <th>合同日期</th>
                                    <th>交货期</th>
                                    <th>状态</th>
                                </tr>
                                </thead>
                                <tbody id="contract-table-body">
                                    <!-- 合同数据将动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 分页控件容器 -->
                        <div id="contract-pagination-stats" class="p-4 border-t border-gray-300"></div>
                    </div>
                </div>
                
                <!-- 收货记录页面 -->
                <div id="receipts-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div></div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="w-full sm:w-auto max-w-sm">
                                <input type="text" id="receipt-search" class="form-input" placeholder="请输入合同号、供应商等关键词进行搜索">
                            </div>
                            <button id="create-receipt-btn" class="btn btn-primary">
                                <i class="fa fa-plus mr-2"></i>新建收货记录
                            </button>
                        </div>
                    </div>
                    
                    <!-- 收货记录列表 -->
                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>收货单号</th>
                                        <th>合同号</th>
                                        <th>供应商</th>
                                        <th>产品名称</th>
                                        <th>规格型号</th>
                                        <th>收货数量</th>
                                        <th>单位</th>
                                        <th>收货日期</th>
                                        <th>收货人</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="receipt-table-body">
                                    <!-- 收货记录数据将动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 分页控件容器 -->
                        <div id="receipt-pagination-stats" class="p-4 border-t border-gray-300"></div>
                    </div>
                </div>
                
                <!-- 退货记录页面 -->
                <div id="returns-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div></div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="w-full sm:w-auto max-w-sm">
                                <input type="text" id="return-search" class="form-input" placeholder="请输入合同号、供应商等关键词进行搜索">
                            </div>
                            <button id="create-return-btn" class="btn btn-primary">
                                <i class="fa fa-plus mr-2"></i>新建退货记录
                            </button>
                        </div>
                    </div>
                    
                    <!-- 退货记录列表 -->
                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>退货单号</th>
                                        <th>合同号</th>
                                        <th>供应商</th>
                                        <th>产品名称</th>
                                        <th>规格型号</th>
                                        <th>退货数量</th>
                                        <th>单位</th>
                                        <th>退货日期</th>
                                        <th>退货原因</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="return-table-body">
                                    <!-- 退货记录数据将动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 分页控件容器 -->
                        <div id="return-pagination-stats" class="p-4 border-t border-gray-300"></div>
                    </div>
                </div>
                
                <!-- 库存统计页面 -->
                <div id="inventory-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div></div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="w-full sm:w-auto max-w-sm">
                                <input type="text" id="inventory-search" class="form-input" placeholder="请输入合同号、产品名称等关键词进行搜索">
                            </div>
                            <button id="export-inventory-btn" class="btn btn-primary">
                                <i class="fa fa-download mr-2"></i>导出统计
                            </button>
                        </div>
                    </div>
                    
                    <!-- 库存统计列表 -->
                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>合同号</th>
                                        <th>供应商</th>
                                        <th>产品名称</th>
                                        <th>规格型号</th>
                                        <th>单位</th>
                                        <th>合同数量</th>
                                        <th>已收数量</th>
                                        <th>已退数量</th>
                                        <th>库存数量</th>
                                        <th>未收数量</th>
                                        <th>完成率</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body">
                                    <!-- 库存统计数据将动态生成 -->
                                </tbody>
                                <tfoot class="font-bold">
                                    <tr>
                                        <td colspan="5" class="text-right">合计：</td>
                                        <td id="total-contract-quantity">0</td>
                                        <td id="total-received-quantity">0</td>
                                        <td id="total-returned-quantity">0</td>
                                        <td id="total-inventory-quantity">0</td>
                                        <td id="total-pending-quantity">0</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <!-- 分页控件容器 -->
                        <div id="inventory-pagination-stats" class="p-4 border-t border-gray-300"></div>
                    </div>
                </div>
                
                <!-- 合同比对页面 -->
                <div id="comparison-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div></div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="w-full sm:w-auto max-w-sm">
                                <input type="text" id="comparison-search" class="form-input" placeholder="请输入合同号进行比对">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 比对结果列表 -->
                    <div class="card">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>合同号</th>
                                        <th>供应商</th>
                                        <th>产品名称</th>
                                        <th>合同数量</th>
                                        <th>实际收货</th>
                                        <th>差异数量</th>
                                        <th>差异率</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="comparison-table-body">
                                    <!-- 比对结果数据将动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        <!-- 分页控件容器 -->
                        <div id="comparison-pagination-stats" class="p-4 border-t border-gray-300"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 新建合同模态框 -->

    
    <!-- 新建收货记录模态框 -->
    <div id="create-receipt-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            新建收货记录
                        </h3>
                        <div class="mt-4">
                            <form id="create-receipt-form" class="space-y-4">
                                <!-- 第1行：供应商 -->
                                <div class="form-group">
                                    <label for="receipt-supplier" class="form-label">供应商 <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="receipt-supplier" class="form-input" required>
                                        <div id="supplier-suggestions" class="absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg z-10 max-h-60 overflow-y-auto hidden"></div>
                                    </div>
                                </div>
                                
                                <!-- 第2行：合同号 -->
                                <div class="form-group">
                                    <label for="receipt-contract-number" class="form-label">合同号 <span class="text-red-500">*</span></label>
                                    <select id="receipt-contract-number" class="form-input" multiple required></select>
                                    <p class="text-xs text-gray-500 mt-1">按住Ctrl键可多选合同号</p>
                                </div>
                                
                                <!-- 第3行：产品名称、规格型号和单位 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                                    <div class="form-group">
                                        <label for="receipt-product" class="form-label">产品名称 <span class="text-red-500">*</span></label>
                                        <input type="text" id="receipt-product" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="receipt-spec" class="form-label">规格型号 <span class="text-red-500">*</span></label>
                                        <input type="text" id="receipt-spec" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="receipt-unit" class="form-label">单位 <span class="text-red-500">*</span></label>
                                        <input type="text" id="receipt-unit" class="form-input" readonly required>
                                    </div>
                                </div>
                                
                                <!-- 第4行：收货日期和收货数量 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                    <div class="form-group">
                                        <label for="receipt-date" class="form-label">收货日期 <span class="text-red-500">*</span></label>
                                        <input type="date" id="receipt-date" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="receipt-quantity" class="form-label">收货数量 <span class="text-red-500">*</span></label>
                                        <input type="number" id="receipt-quantity" class="form-input" step="0.001" min="0" required>
                                    </div>
                                </div>
                                
                                <!-- 第5行：收货人和收货单号 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                    <div class="form-group">
                                        <label for="receipt-person" class="form-label">收货人</label>
                                        <input type="text" id="receipt-person" class="form-input" value="许小成">
                                    </div>
                                    <div class="form-group">
                                        <label for="receipt-receipt-number" class="form-label">收货单号</label>
                                        <input type="text" id="receipt-receipt-number" class="form-input">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="receipt-remark" class="form-label">备注</label>
                                    <textarea id="receipt-remark" class="form-textarea" rows="3"></textarea>
                                </div>
                                
                                <div class="flex justify-end gap-3">
                                    <button type="button" id="cancel-receipt-btn" class="btn btn-secondary">取消</button>
                                    <button type="submit" class="btn btn-primary">保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑收货记录模态框 -->
    <div id="edit-receipt-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            编辑收货记录
                        </h3>
                        <div class="mt-4">
                            <form id="edit-receipt-form" class="space-y-4">
                                <input type="hidden" id="edit-receipt-id">
                                
                                <!-- 第1行：收货单号 -->
                                <div class="form-group">
                                    <label for="edit-receipt-number" class="form-label">收货单号 <span class="text-red-500">*</span></label>
                                    <input type="text" id="edit-receipt-number" class="form-input" required>
                                </div>
                                
                                <!-- 第2行：产品信息 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                                    <div class="form-group">
                                        <label for="edit-receipt-product" class="form-label">产品名称 <span class="text-red-500">*</span></label>
                                        <input type="text" id="edit-receipt-product" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-receipt-spec" class="form-label">规格型号 <span class="text-red-500">*</span></label>
                                        <input type="text" id="edit-receipt-spec" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-receipt-unit" class="form-label">单位 <span class="text-red-500">*</span></label>
                                        <input type="text" id="edit-receipt-unit" class="form-input" readonly required>
                                    </div>
                                </div>
                                
                                <!-- 第3行：收货日期和收货数量 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                    <div class="form-group">
                                        <label for="edit-receipt-date" class="form-label">收货日期 <span class="text-red-500">*</span></label>
                                        <input type="date" id="edit-receipt-date" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-receipt-quantity" class="form-label">收货数量 <span class="text-red-500">*</span></label>
                                        <input type="number" id="edit-receipt-quantity" class="form-input" step="0.001" min="0" required>
                                    </div>
                                </div>
                                
                                <!-- 第4行：收货人 -->
                                <div class="form-group">
                                    <label for="edit-receipt-person" class="form-label">收货人</label>
                                    <input type="text" id="edit-receipt-person" class="form-input">
                                </div>
                                
                                <!-- 第4行：备注 -->
                                <div class="form-group">
                                    <label for="edit-receipt-remark" class="form-label">备注</label>
                                    <textarea id="edit-receipt-remark" class="form-textarea" rows="3"></textarea>
                                </div>
                                
                                <div class="flex justify-end gap-3">
                                    <button type="button" id="cancel-edit-receipt-btn" class="btn btn-secondary">取消</button>
                                    <button type="submit" class="btn btn-primary">保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑退货记录模态框 -->
    <div id="edit-return-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            编辑退货记录
                        </h3>
                        <div class="mt-4">
                            <form id="edit-return-form" class="space-y-4">
                                <input type="hidden" id="edit-return-id">
                                
                                <!-- 第1行：退货单号 -->
                                <div class="form-group">
                                    <label for="edit-return-number" class="form-label">退货单号 <span class="text-red-500">*</span></label>
                                    <input type="text" id="edit-return-number" class="form-input" required>
                                </div>
                                
                                <!-- 第2行：产品信息 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                                    <div class="form-group">
                                        <label for="edit-return-product" class="form-label">产品名称 <span class="text-red-500">*</span></label>
                                        <input type="text" id="edit-return-product" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-return-spec" class="form-label">规格型号 <span class="text-red-500">*</span></label>
                                        <input type="text" id="edit-return-spec" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-return-unit" class="form-label">单位 <span class="text-red-500">*</span></label>
                                        <input type="text" id="edit-return-unit" class="form-input" readonly required>
                                    </div>
                                </div>
                                
                                <!-- 第3行：退货日期和退货数量 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                    <div class="form-group">
                                        <label for="edit-return-date" class="form-label">退货日期 <span class="text-red-500">*</span></label>
                                        <input type="date" id="edit-return-date" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="edit-return-quantity" class="form-label">退货数量 <span class="text-red-500">*</span></label>
                                        <input type="number" id="edit-return-quantity" class="form-input" step="0.001" min="0" required>
                                    </div>
                                </div>
                                
                                <!-- 第3行：退货原因 -->
                                <div class="form-group">
                                    <label for="edit-return-reason" class="form-label">退货原因 <span class="text-red-500">*</span></label>
                                    <textarea id="edit-return-reason" class="form-textarea" rows="3" required></textarea>
                                </div>
                                
                                <!-- 第4行：备注 -->
                                <div class="form-group">
                                    <label for="edit-return-remark" class="form-label">备注</label>
                                    <textarea id="edit-return-remark" class="form-textarea" rows="3"></textarea>
                                </div>
                                
                                <div class="flex justify-end gap-3">
                                    <button type="button" id="cancel-edit-return-btn" class="btn btn-secondary">取消</button>
                                    <button type="submit" class="btn btn-primary">保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新建退货记录模态框 -->
    <div id="create-return-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            新建退货记录
                        </h3>
                        <div class="mt-4">
                            <form id="create-return-form" class="space-y-4">
                                <!-- 第1行：供应商 -->
                                <div class="form-group">
                                    <label for="return-supplier" class="form-label">供应商 <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <input type="text" id="return-supplier" class="form-input" required>
                                        <div id="return-supplier-suggestions" class="absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg z-10 max-h-60 overflow-y-auto hidden"></div>
                                    </div>
                                </div>
                                
                                <!-- 第2行：合同号 -->
                                <div class="form-group">
                                    <label for="return-contract-number" class="form-label">合同号 <span class="text-red-500">*</span></label>
                                    <select id="return-contract-number" class="form-input" multiple required></select>
                                    <p class="text-xs text-gray-500 mt-1">按住Ctrl键可多选合同号</p>
                                </div>
                                
                                <!-- 第3行：产品名称、规格型号和单位 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                                    <div class="form-group">
                                        <label for="return-product" class="form-label">产品名称 <span class="text-red-500">*</span></label>
                                        <input type="text" id="return-product" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="return-spec" class="form-label">规格型号 <span class="text-red-500">*</span></label>
                                        <input type="text" id="return-spec" class="form-input" readonly required>
                                    </div>
                                    <div class="form-group">
                                        <label for="return-unit" class="form-label">单位 <span class="text-red-500">*</span></label>
                                        <input type="text" id="return-unit" class="form-input" readonly required>
                                    </div>
                                </div>
                                
                                <!-- 第4行：退货日期和退货数量 -->
                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                    <div class="form-group">
                                        <label for="return-date" class="form-label">退货日期 <span class="text-red-500">*</span></label>
                                        <input type="date" id="return-date" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="return-quantity" class="form-label">退货数量 <span class="text-red-500">*</span></label>
                                        <input type="number" id="return-quantity" class="form-input" step="0.001" min="0" required>
                                    </div>
                                </div>
                                
                                <!-- 第5行：退货原因 -->
                                <div class="form-group">
                                    <label for="return-reason" class="form-label">退货原因 <span class="text-red-500">*</span></label>
                                    <textarea id="return-reason" class="form-textarea" rows="3" required></textarea>
                                </div>
                                
                                <!-- 第6行：备注 -->
                                <div class="form-group">
                                    <label for="return-remark" class="form-label">备注</label>
                                    <textarea id="return-remark" class="form-textarea" rows="3"></textarea>
                                </div>
                                
                                <div class="flex justify-end gap-3">
                                    <button type="button" id="cancel-return-btn" class="btn btn-secondary">取消</button>
                                    <button type="submit" class="btn btn-primary">保存</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 密码验证模态框 -->
    <div id="password-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="password-modal-title">
                            密码验证
                        </h3>
                        <div class="mt-4">
                            <form id="password-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="password-input" class="form-label">请输入密码</label>
                                    <input type="password" id="password-input" class="form-input" placeholder="输入密码" required>
                                </div>
                                
                                <div class="flex justify-end gap-3">
                                    <button type="button" id="cancel-password-btn" class="btn btn-secondary">取消</button>
                                    <button type="submit" class="btn btn-primary">确定</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript 代码 -->
    <script>
        // 全局变量
        let currentCompany = localStorage.getItem('currentCompany_index') || 'companyA';
        
        // 分页相关全局变量
        let currentPage = 1;
        let itemsPerPage = 10;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            // 公司选择事件
            const companySelect = document.getElementById('company-select');
            if (companySelect) {
                companySelect.value = currentCompany;
                companySelect.addEventListener('change', function() {
                    currentCompany = this.value;
                    localStorage.setItem('currentCompany_index', currentCompany);
                    location.reload();
                });
            }
            
            // 数据管理下拉菜单事件
            const dataManagementBtn = document.getElementById('data-management-btn');
            const dataManagementDropdown = document.getElementById('data-management-dropdown');
            
            if (dataManagementBtn && dataManagementDropdown) {
                dataManagementBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    dataManagementDropdown.classList.toggle('hidden');
                });
                
                // 点击页面其他地方关闭下拉菜单
                document.addEventListener('click', function(e) {
                    if (!dataManagementBtn.contains(e.target) && !dataManagementDropdown.contains(e.target)) {
                        dataManagementDropdown.classList.add('hidden');
                    }
                });
            }
            
            // 从主系统导入合同按钮事件
            const importFromIndexBtn = document.getElementById('import-from-index-btn');
            if (importFromIndexBtn) {
                importFromIndexBtn.addEventListener('click', function() {
                    importContractsFromIndex();
                });
            }
            
            // 导航菜单切换
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const pageTitle = document.getElementById('page-title');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有活跃状态
                    navLinks.forEach(l => l.classList.remove('active'));
                    pages.forEach(p => p.classList.add('hidden'));
                    
                    // 添加当前活跃状态
                    this.classList.add('active');
                    const pageId = this.getAttribute('data-page');
                    const targetPage = document.getElementById(`${pageId}-page`);
                    targetPage.classList.remove('hidden');
                    
                    // 更新页面标题（如果存在）
                    if (pageTitle) {
                        pageTitle.textContent = this.querySelector('span').textContent;
                    }
                    
                    // 初始化页面数据
                    initPageData(pageId);
                    
                    // 关闭数据管理下拉菜单（如果打开）
                    const dataManagementDropdown = document.getElementById('data-management-dropdown');
                    if (dataManagementDropdown) {
                        dataManagementDropdown.classList.add('hidden');
                    }
                });
            });
            
            // 初始化表单事件
            initFormEvents();
            
            // 从index.html导入合同数据的函数
        function importContractsFromIndex() {
            const currentCompany = localStorage.getItem('currentCompany_index') || 'companyA';
            
            // 从index.html的localStorage中获取采购订单数据
            const indexStorageKey = `purchaseOrders_${currentCompany}`;
            const purchaseOrders = JSON.parse(localStorage.getItem(indexStorageKey)) || [];
            
            // 从contract-inventory.html的localStorage中获取现有合同数据
            const contractStorageKey = `contracts_${currentCompany}`;
            let existingContracts = JSON.parse(localStorage.getItem(contractStorageKey)) || [];
            
            // 创建合同号映射，便于更新现有合同
            const contractMap = new Map(existingContracts.map(c => [c.contractNumber, c]));
            
            // 用于存储更新或新增的合同
            const updatedContracts = [];
            const newContractCount = 0;
            
            // 遍历采购订单数据
            purchaseOrders.forEach(order => {
                // 过滤掉没有产品的订单
                if (!Array.isArray(order.products)) return;
                
                // 过滤掉产品名称全为"木箱"的订单
                const validProducts = order.products.filter(product => product.productName !== '木箱');
                if (validProducts.length === 0) return;
                
                // 检查合同是否已存在
                let contract = contractMap.get(order.contractNumber);
                
                if (contract) {
                    // 更新现有合同的产品列表
                    contract.products = validProducts;
                    contract.updatedAt = new Date().toISOString();
                } else {
                    // 创建新的合同记录，包含所有有效产品
                    contract = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        contractNumber: order.contractNumber,
                        supplier: order.supplier,
                        products: validProducts, // 存储所有有效产品
                        contractDate: order.orderDate,
                        deliveryDate: order.deliveryDate,
                        status: 'in-progress', // 默认状态
                        remark: order.remarks || '',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    contractMap.set(order.contractNumber, contract);
                }
                
                updatedContracts.push(contract);
            });
            
            // 如果有更新或新增的合同
            if (updatedContracts.length > 0) {
                // 将Map转换为数组
                const allContracts = Array.from(contractMap.values());
                localStorage.setItem(contractStorageKey, JSON.stringify(allContracts));
                
                // 更新页面数据
                if (typeof renderContractList === 'function') {
                    renderContractList();
                }
                if (typeof renderInventoryList === 'function') {
                    renderInventoryList();
                }
                if (typeof renderComparisonList === 'function') {
                    renderComparisonList();
                }
                if (typeof initDashboardData === 'function') {
                    initDashboardData();
                }
                
                alert(`成功从index.html导入/更新 ${updatedContracts.length} 个合同！`);
            } else {
                alert('没有找到符合条件的合同！');
            }
        }
        
        // 页面加载完成后，自动导入数据
        importContractsFromIndex();
        
        // 初始化统计概览数据
        initDashboardData();
        });
        
        // 初始化页面数据
        function initPageData(pageId) {
            switch(pageId) {
                case 'dashboard':
                    initDashboardData();
                    break;
                case 'contracts':
                    // 获取当前搜索值并传递给渲染函数
                    const searchValue = document.getElementById('contract-search')?.value || '';
                    renderContractList(searchValue);
                    break;
                case 'receipts':
                    // 获取当前搜索值并传递给渲染函数
                    const receiptSearchValue = document.getElementById('receipt-search')?.value || '';
                    renderReceiptList(receiptSearchValue);
                    break;
                case 'returns':
                    renderReturnList();
                    break;
                case 'inventory':
                    renderInventoryList();
                    break;
                case 'comparison':
                    renderComparisonList();
                    break;
            }
        }
        
        // 全局变量 - 用于存储当前需要更新的合同信息
        let currentUpdateContractInfo = null;
        
        // 初始化表单事件
        function initFormEvents() {
            // 新建收货记录表单
            const createReceiptForm = document.getElementById('create-receipt-form');
            if (createReceiptForm) {
                createReceiptForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveReceipt();
                });
            }
            
            // 新建退货记录表单
            const createReturnForm = document.getElementById('create-return-form');
            if (createReturnForm) {
                createReturnForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveReturn();
                });
            }
            
            document.getElementById('create-receipt-btn')?.addEventListener('click', function() {
                document.getElementById('create-receipt-modal').classList.remove('hidden');
                // 清空表单
                document.getElementById('create-receipt-form').reset();
                // 设置收货日期默认值为今日
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('receipt-date').value = today;
                // 重置收货人默认值
                document.getElementById('receipt-person').value = '许小成';
            });
            
            document.getElementById('cancel-receipt-btn')?.addEventListener('click', function() {
                document.getElementById('create-receipt-modal').classList.add('hidden');
                document.getElementById('create-receipt-form').reset();
            });
            
            // 密码模态框事件
            const passwordModal = document.getElementById('password-modal');
            const passwordForm = document.getElementById('password-form');
            const cancelPasswordBtn = document.getElementById('cancel-password-btn');
            
            if (passwordForm) {
                passwordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const password = document.getElementById('password-input').value;
                    if (password === '2601') {
                        // 密码正确，执行合同更新
                        if (currentUpdateContractInfo) {
                            updateContractAndSyncIndex(
                                currentUpdateContractInfo.contractId,
                                currentUpdateContractInfo.receivedQuantity,
                                currentUpdateContractInfo.productName
                            );
                            // 重置当前更新信息
                            currentUpdateContractInfo = null;
                        }
                        // 关闭密码模态框
                        passwordModal.classList.add('hidden');
                        // 清空密码输入框
                        document.getElementById('password-input').value = '';
                    } else {
                        alert('密码错误，请重新输入！');
                        document.getElementById('password-input').value = '';
                    }
                });
            }
            
            if (cancelPasswordBtn) {
                cancelPasswordBtn.addEventListener('click', function() {
                    passwordModal.classList.add('hidden');
                    document.getElementById('password-input').value = '';
                    currentUpdateContractInfo = null;
                });
            }
            
            // 供应商自动完成功能
            const supplierInput = document.getElementById('receipt-supplier');
            const supplierSuggestions = document.getElementById('supplier-suggestions');
            const contractNumberSelect = document.getElementById('receipt-contract-number');
            
            // 为收货数量输入框添加悬停提示功能
            const receiptQuantityInput = document.getElementById('receipt-quantity');
            
            // 计算并显示收货数量提示
            function updateQuantityTooltip() {
                const selectedOptions = Array.from(contractNumberSelect.selectedOptions);
                if (selectedOptions.length === 0) {
                    receiptQuantityInput.title = '';
                    return;
                }
                
                // 只处理第一个选中的合同号
                const contractNumber = selectedOptions[0].value;
                const contracts = getData('contracts');
                const receipts = getData('receipts');
                
                // 查找合同信息
                const contract = contracts.find(c => c.contractNumber === contractNumber);
                if (!contract) {
                    receiptQuantityInput.title = '';
                    return;
                }
                
                // 获取当前显示的产品和规格
                const currentProductName = document.getElementById('receipt-product').value;
                const currentSpec = document.getElementById('receipt-spec').value;
                if (!currentProductName) {
                    receiptQuantityInput.title = '';
                    return;
                }
                
                // 计算合同总数量
                let totalContractQuantity = 0;
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    // 多产品合同，获取当前显示产品和规格的数量
                    const productInfo = contract.products.find(p => p.productName === currentProductName && p.specification === currentSpec);
                    if (productInfo) {
                        totalContractQuantity = parseFloat(productInfo.quantity) || 0;
                    }
                } else {
                    // 单产品合同
                    totalContractQuantity = parseFloat(contract.quantity) || 0;
                }
                
                // 计算已收货数量，考虑产品名称和规格型号
                const receivedQuantity = receipts
                    .filter(r => r.contractNumber === contractNumber && r.product === currentProductName && r.spec === currentSpec)
                    .reduce((sum, r) => sum + r.quantity, 0);
                
                // 计算还缺数量
                const missingQuantity = totalContractQuantity - receivedQuantity;
                
                // 设置提示信息
                receiptQuantityInput.title = `合同总数量: ${totalContractQuantity}\n已收货数量: ${receivedQuantity}\n还缺数量: ${missingQuantity > 0 ? missingQuantity : 0}`;
            }
            
            // 当合同号选择变化时更新提示
            contractNumberSelect.addEventListener('change', updateQuantityTooltip);
            
            // 当产品名称变化时更新提示
            document.getElementById('receipt-product').addEventListener('change', updateQuantityTooltip);
            
            // 为收货数量输入框添加悬停事件，实时更新提示
            receiptQuantityInput.addEventListener('mouseenter', updateQuantityTooltip);
            
            // 获取所有唯一供应商列表
            function getUniqueSuppliers() {
                const contracts = getData('contracts');
                const suppliers = new Set();
                contracts.forEach(contract => {
                    if (contract.supplier) {
                        suppliers.add(contract.supplier);
                    }
                });
                return Array.from(suppliers);
            }
            
            // 显示供应商建议
            function showSupplierSuggestions(query) {
                const suppliers = getUniqueSuppliers();
                const filtered = suppliers.filter(supplier => 
                    supplier.toLowerCase().includes(query.toLowerCase())
                );
                
                if (filtered.length > 0) {
                    supplierSuggestions.innerHTML = filtered.map(supplier => `
                        <div class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer supplier-suggestion">
                            ${supplier}
                        </div>
                    `).join('');
                    supplierSuggestions.classList.remove('hidden');
                    
                    // 检查是否完全匹配
                    const exactMatch = filtered.find(supplier => 
                        supplier.toLowerCase() === query.toLowerCase()
                    );
                    if (exactMatch) {
                        selectSupplier(exactMatch);
                    }
                } else {
                    supplierSuggestions.classList.add('hidden');
                }
            }
            
            // 选择供应商
            function selectSupplier(supplier) {
                supplierInput.value = supplier;
                supplierSuggestions.classList.add('hidden');
                // 更新合同号列表
                updateContractNumbers(supplier);
                // 清空产品信息
                document.getElementById('receipt-product').value = '';
                document.getElementById('receipt-unit').value = '';
            }
            
            // 更新合同号列表
            function updateContractNumbers(supplier) {
                const contracts = getData('contracts');
                // 调试：打印合同数据
                console.log('所有合同:', contracts);
                console.log('选择的供应商:', supplier);
                
                // 清理供应商名称（去除首尾空格）
                const cleanedSupplier = supplier.trim();
                
                // 获取该供应商下所有非已完成的合同
                // 支持中文状态和英文状态值，支持模糊匹配供应商名称
                const filteredContracts = contracts.filter(contract => {
                    const contractSupplier = (contract.supplier || '').trim();
                    const isSameSupplier = contractSupplier.toLowerCase() === cleanedSupplier.toLowerCase();
                    
                    // 支持多种状态值
                    const isCompleted = ['completed', '已完成', '完成'].includes(contract.status);
                    const isNotCompleted = !isCompleted;
                    
                    console.log('合同:', contract.contractNumber, '供应商:', contractSupplier, '状态:', contract.status, '供应商匹配:', isSameSupplier, '状态匹配:', isNotCompleted);
                    return isSameSupplier && isNotCompleted;
                });
                
                console.log('过滤后的合同:', filteredContracts);
                
                // 清空现有选项
                contractNumberSelect.innerHTML = '';
                
                // 添加新选项
                if (filteredContracts.length === 0) {
                    // 如果没有匹配的合同，显示提示
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '该供应商下没有可用合同';
                    option.disabled = true;
                    contractNumberSelect.appendChild(option);
                } else {
                    filteredContracts.forEach(contract => {
                        const option = document.createElement('option');
                        option.value = contract.contractNumber;
                        option.textContent = contract.contractNumber;
                        contractNumberSelect.appendChild(option);
                    });
                }
            }
            
            // 供应商输入框失焦事件：如果输入值与某个供应商匹配，自动选择
            supplierInput.addEventListener('blur', function() {
                const inputValue = this.value.trim().toLowerCase();
                if (!inputValue) return;
                
                const contracts = getData('contracts');
                // 从合同中直接查找匹配的供应商
                const matchedContract = contracts.find(contract => 
                    contract.supplier && contract.supplier.trim().toLowerCase() === inputValue
                );
                
                if (matchedContract) {
                    selectSupplier(matchedContract.supplier);
                } else {
                    // 尝试模糊匹配
                    const similarContract = contracts.find(contract => 
                        contract.supplier && contract.supplier.toLowerCase().includes(inputValue)
                    );
                    if (similarContract) {
                        selectSupplier(similarContract.supplier);
                    }
                }
            });
            
            // 添加切换按钮的容器
            const contractNumberContainer = document.getElementById('receipt-contract-number').parentElement;
            let switchButton = document.getElementById('switch-product-btn');
            if (!switchButton) {
                switchButton = document.createElement('button');
                switchButton.id = 'switch-product-btn';
                switchButton.className = 'btn btn-secondary btn-sm mt-1';
                switchButton.innerHTML = '<i class="fa fa-arrow-right mr-1"></i>切换下一条';
                switchButton.style.display = 'none';
                contractNumberContainer.appendChild(switchButton);
            }
            
            // 当前显示的产品索引和当前合同
            let currentProductIndex = 0;
            let currentContract = null;
            
            // 切换到下一个产品
            function switchNextProduct() {
                if (!currentContract || !Array.isArray(currentContract.products) || currentContract.products.length <= 1) {
                    return;
                }
                
                currentProductIndex = (currentProductIndex + 1) % currentContract.products.length;
                const product = currentContract.products[currentProductIndex];
                document.getElementById('receipt-product').value = product.productName || '';
                document.getElementById('receipt-spec').value = product.specification || '';
                document.getElementById('receipt-unit').value = product.unit || '';
                // 更新提示
                updateQuantityTooltip();
            }
            
            // 绑定切换按钮事件
            switchButton.addEventListener('click', switchNextProduct);
            
            // 当合同号选择变化时，自动填充产品信息
            contractNumberSelect.addEventListener('change', function() {
                const selectedOptions = Array.from(this.selectedOptions);
                // 隐藏切换按钮
                switchButton.style.display = 'none';
                currentProductIndex = 0;
                currentContract = null;
                
                // 检查是否多选且有合同号项下有多个产品名称
                if (selectedOptions.length > 1) {
                    const contracts = getData('contracts');
                    for (const option of selectedOptions) {
                        const contract = contracts.find(c => c.contractNumber === option.value);
                        if (contract && Array.isArray(contract.products) && contract.products.length > 1) {
                            // 清空选择
                            this.value = '';
                            // 取消所有选项
                            selectedOptions.forEach(opt => opt.selected = false);
                            // 显示提示
                            alert(`合同号 ${option.value} 项下有多个产品名称，不能多选`);
                            // 清空产品信息
                            document.getElementById('receipt-product').value = '';
                            document.getElementById('receipt-spec').value = '';
                            document.getElementById('receipt-unit').value = '';
                            return;
                        }
                    }
                }
                
                if (selectedOptions.length > 0) {
                    const contractNumber = selectedOptions[0].value;
                    const contract = getData('contracts').find(c => c.contractNumber === contractNumber);
                    currentContract = contract;
                    
                    if (contract) {
                        if (Array.isArray(contract.products) && contract.products.length > 1) {
                            // 显示切换按钮
                            switchButton.style.display = 'inline-block';
                            // 显示第一个产品
                            const product = contract.products[0];
                            document.getElementById('receipt-product').value = product.productName || '';
                            document.getElementById('receipt-spec').value = product.specification || '';
                            document.getElementById('receipt-unit').value = product.unit || '';
                        } else {
                            // 单个产品
                            const productInfo = getProductInfoFromContract(contractNumber);
                            document.getElementById('receipt-product').value = productInfo.product || '';
                            document.getElementById('receipt-spec').value = productInfo.spec || '';
                            document.getElementById('receipt-unit').value = productInfo.unit || '';
                        }
                    }
                } else {
                    document.getElementById('receipt-product').value = '';
                    document.getElementById('receipt-spec').value = '';
                    document.getElementById('receipt-unit').value = '';
                }
            });
            
            // 根据合同号获取产品信息
            function getProductInfoFromContract(contractNumber) {
                const contracts = getData('contracts');
                const contract = contracts.find(c => c.contractNumber === contractNumber);
                if (contract) {
                    if (Array.isArray(contract.products) && contract.products.length > 0) {
                        // 多产品合同，返回第一个产品
                        return {
                            product: contract.products[0].productName,
                            spec: contract.products[0].specification,
                            unit: contract.products[0].unit
                        };
                    } else {
                        // 单产品合同
                        return {
                            product: contract.product,
                            spec: contract.spec,
                            unit: contract.unit
                        };
                    }
                }
                return { product: '', spec: '', unit: '' };
            }
            
            // 供应商输入事件
            supplierInput.addEventListener('input', function(e) {
                showSupplierSuggestions(e.target.value);
            });
            
            // 点击建议选择供应商
            supplierSuggestions.addEventListener('click', function(e) {
                if (e.target.classList.contains('supplier-suggestion')) {
                    selectSupplier(e.target.textContent);
                }
            });
            
            // 点击页面其他地方隐藏建议
            document.addEventListener('click', function(e) {
                if (!supplierInput.contains(e.target) && !supplierSuggestions.contains(e.target)) {
                    supplierSuggestions.classList.add('hidden');
                }
            });
            
            // 合同号选择事件
            contractNumberSelect.addEventListener('change', function() {
                const selectedOptions = Array.from(this.selectedOptions);
                if (selectedOptions.length > 0) {
                    const contractNumber = selectedOptions[0].value;
                    const productInfo = getProductInfoFromContract(contractNumber);
                    document.getElementById('receipt-product').value = productInfo.product;
                    document.getElementById('receipt-unit').value = productInfo.unit;
                } else {
                    document.getElementById('receipt-product').value = '';
                    document.getElementById('receipt-unit').value = '';
                }
            });
            
            document.getElementById('create-return-btn')?.addEventListener('click', function() {
                document.getElementById('create-return-modal').classList.remove('hidden');
                // 设置退货日期默认值为今日
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('return-date').value = today;
                // 清空表单
                document.getElementById('create-return-form').reset();
                // 重置退货日期默认值
                document.getElementById('return-date').value = today;
            });
            
            document.getElementById('cancel-return-btn')?.addEventListener('click', function() {
                document.getElementById('create-return-modal').classList.add('hidden');
                document.getElementById('create-return-form').reset();
            });
            
            // 编辑收货记录模态框事件
            document.getElementById('cancel-edit-receipt-btn')?.addEventListener('click', function() {
                document.getElementById('edit-receipt-modal').classList.add('hidden');
            });
            
            // 编辑收货记录表单提交事件
            const editReceiptForm = document.getElementById('edit-receipt-form');
            if (editReceiptForm) {
                editReceiptForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveEditedReceipt();
                });
            }
            
            // 编辑退货记录模态框事件
            document.getElementById('cancel-edit-return-btn')?.addEventListener('click', function() {
                document.getElementById('edit-return-modal').classList.add('hidden');
            });
            
            // 编辑退货记录表单提交事件
            const editReturnForm = document.getElementById('edit-return-form');
            if (editReturnForm) {
                editReturnForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveEditedReturn();
                });
            }
            
            // 退货记录 - 供应商自动完成功能
            const returnSupplierInput = document.getElementById('return-supplier');
            const returnSupplierSuggestions = document.getElementById('return-supplier-suggestions');
            const returnContractNumberSelect = document.getElementById('return-contract-number');
            
            // 退货记录 - 显示供应商建议
            function showReturnSupplierSuggestions(query) {
                const suppliers = getUniqueSuppliers();
                const filtered = suppliers.filter(supplier => 
                    supplier.toLowerCase().includes(query.toLowerCase())
                );
                
                if (filtered.length > 0) {
                    returnSupplierSuggestions.innerHTML = filtered.map(supplier => `
                        <div class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer supplier-suggestion">
                            ${supplier}
                        </div>
                    `).join('');
                    returnSupplierSuggestions.classList.remove('hidden');
                } else {
                    returnSupplierSuggestions.classList.add('hidden');
                }
            }
            
            // 退货记录 - 选择供应商
            function selectReturnSupplier(supplier) {
                returnSupplierInput.value = supplier;
                returnSupplierSuggestions.classList.add('hidden');
                // 更新合同号列表
                updateReturnContractNumbers(supplier);
                // 清空产品信息
                document.getElementById('return-product').value = '';
                document.getElementById('return-unit').value = '';
            }
            
            // 退货记录 - 更新合同号列表
            function updateReturnContractNumbers(supplier) {
                const contracts = getData('contracts');
                // 获取该供应商下所有非已完成的合同
                const filteredContracts = contracts.filter(contract => {
                    const contractSupplier = (contract.supplier || '').trim();
                    const isSameSupplier = contractSupplier.toLowerCase() === supplier.trim().toLowerCase();
                    return isSameSupplier;
                });
                
                // 清空现有选项
                returnContractNumberSelect.innerHTML = '';
                
                // 添加新选项
                if (filteredContracts.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '该供应商下没有可用合同';
                    option.disabled = true;
                    returnContractNumberSelect.appendChild(option);
                } else {
                    filteredContracts.forEach(contract => {
                        const option = document.createElement('option');
                        option.value = contract.contractNumber;
                        option.textContent = contract.contractNumber;
                        returnContractNumberSelect.appendChild(option);
                    });
                }
            }
            
            // 退货记录 - 根据合同号获取产品信息
            function getReturnProductInfoFromContract(contractNumber) {
                const contracts = getData('contracts');
                const contract = contracts.find(c => c.contractNumber === contractNumber);
                if (contract) {
                    if (Array.isArray(contract.products) && contract.products.length > 0) {
                        // 多产品合同，返回第一个产品
                        return {
                            product: contract.products[0].productName,
                            spec: contract.products[0].specification,
                            unit: contract.products[0].unit
                        };
                    } else {
                        // 单产品合同
                        return {
                            product: contract.product,
                            spec: contract.spec,
                            unit: contract.unit
                        };
                    }
                }
                return { product: '', spec: '', unit: '' };
            }
            
            // 退货记录 - 供应商输入事件
            returnSupplierInput.addEventListener('input', function(e) {
                showReturnSupplierSuggestions(e.target.value);
            });
            
            // 退货记录 - 点击建议选择供应商
            returnSupplierSuggestions.addEventListener('click', function(e) {
                if (e.target.classList.contains('supplier-suggestion')) {
                    selectReturnSupplier(e.target.textContent);
                }
            });
            
            // 退货记录 - 点击页面其他地方隐藏建议
            document.addEventListener('click', function(e) {
                if (!returnSupplierInput.contains(e.target) && !returnSupplierSuggestions.contains(e.target)) {
                    returnSupplierSuggestions.classList.add('hidden');
                }
            });
            
            // 退货记录 - 供应商输入框失焦事件
            returnSupplierInput.addEventListener('blur', function() {
                const inputValue = this.value.trim().toLowerCase();
                if (!inputValue) return;
                
                const contracts = getData('contracts');
                // 从合同中直接查找匹配的供应商
                const matchedContract = contracts.find(contract => 
                    contract.supplier && contract.supplier.trim().toLowerCase() === inputValue
                );
                
                if (matchedContract) {
                    selectReturnSupplier(matchedContract.supplier);
                }
            });
            
            // 添加切换按钮的容器
            const returnContractNumberContainer = document.getElementById('return-contract-number').parentElement;
            let returnSwitchButton = document.getElementById('return-switch-product-btn');
            if (!returnSwitchButton) {
                returnSwitchButton = document.createElement('button');
                returnSwitchButton.id = 'return-switch-product-btn';
                returnSwitchButton.className = 'btn btn-secondary btn-sm mt-1';
                returnSwitchButton.innerHTML = '<i class="fa fa-arrow-right mr-1"></i>切换下一条';
                returnSwitchButton.style.display = 'none';
                returnContractNumberContainer.appendChild(returnSwitchButton);
            }
            
            // 当前显示的产品索引和当前合同
            let returnCurrentProductIndex = 0;
            let returnCurrentContract = null;
            
            // 切换到下一个产品
            function returnSwitchNextProduct() {
                if (!returnCurrentContract || !Array.isArray(returnCurrentContract.products) || returnCurrentContract.products.length <= 1) {
                    return;
                }
                
                returnCurrentProductIndex = (returnCurrentProductIndex + 1) % returnCurrentContract.products.length;
                const product = returnCurrentContract.products[returnCurrentProductIndex];
                document.getElementById('return-product').value = product.productName || '';
                document.getElementById('return-spec').value = product.specification || '';
                document.getElementById('return-unit').value = product.unit || '';
                // 更新提示
                updateReturnQuantityTooltip();
            }
            
            // 绑定切换按钮事件
            returnSwitchButton.addEventListener('click', returnSwitchNextProduct);
            
            // 更新退货数量提示
            function updateReturnQuantityTooltip() {
                const contractNumberSelect = document.getElementById('return-contract-number');
                const selectedOptions = Array.from(contractNumberSelect.selectedOptions);
                if (selectedOptions.length === 0) {
                    return;
                }
                
                const contractNumber = selectedOptions[0].value;
                const currentProductName = document.getElementById('return-product').value;
                const currentSpec = document.getElementById('return-spec').value;
                if (!currentProductName) {
                    document.getElementById('return-quantity').title = '';
                    return;
                }
                
                const contracts = getData('contracts');
                const receipts = getData('receipts');
                const returns = getData('returns');
                
                const contract = contracts.find(c => c.contractNumber === contractNumber);
                if (!contract) {
                    return;
                }
                
                // 计算合同总数量
                let totalContractQuantity = 0;
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    // 多产品合同，获取当前显示产品和规格的数量
                    const productInfo = contract.products.find(p => p.productName === currentProductName && p.specification === currentSpec);
                    if (productInfo) {
                        totalContractQuantity = parseFloat(productInfo.quantity) || 0;
                    }
                } else {
                    // 单产品合同
                    totalContractQuantity = parseFloat(contract.quantity) || 0;
                }
                
                // 计算已收货数量，考虑规格型号
                const receivedQuantity = receipts
                    .filter(r => r.contractNumber === contractNumber && r.product === currentProductName && r.spec === currentSpec)
                    .reduce((sum, r) => sum + r.quantity, 0);
                
                // 计算已退货数量，考虑规格型号
                const returnedQuantity = returns
                    .filter(r => r.contractNumber === contractNumber && r.product === currentProductName && r.spec === currentSpec)
                    .reduce((sum, r) => sum + r.quantity, 0);
                
                // 计算还可退数量
                const availableReturnQuantity = receivedQuantity - returnedQuantity;
                
                // 设置提示信息
                document.getElementById('return-quantity').title = `合同总数量: ${totalContractQuantity}\n已收货数量: ${receivedQuantity}\n已退货数量: ${returnedQuantity}\n还可退数量: ${availableReturnQuantity > 0 ? availableReturnQuantity : 0}`;
            }
            
            // 退货记录 - 当合同号选择变化时，自动填充产品信息
            returnContractNumberSelect.addEventListener('change', function() {
                const selectedOptions = Array.from(this.selectedOptions);
                // 隐藏切换按钮
                returnSwitchButton.style.display = 'none';
                returnCurrentProductIndex = 0;
                returnCurrentContract = null;
                
                // 检查是否多选且有合同号项下有多个产品名称
                if (selectedOptions.length > 1) {
                    const contracts = getData('contracts');
                    for (const option of selectedOptions) {
                        const contract = contracts.find(c => c.contractNumber === option.value);
                        if (contract && Array.isArray(contract.products) && contract.products.length > 1) {
                            // 清空选择
                            this.value = '';
                            // 取消所有选项
                            selectedOptions.forEach(opt => opt.selected = false);
                            // 显示提示
                            alert(`合同号 ${option.value} 项下有多个产品名称，不能多选`);
                            // 清空产品信息
                            document.getElementById('return-product').value = '';
                            document.getElementById('return-spec').value = '';
                            document.getElementById('return-unit').value = '';
                            return;
                        }
                    }
                }
                
                if (selectedOptions.length > 0) {
                    const contractNumber = selectedOptions[0].value;
                    const contract = getData('contracts').find(c => c.contractNumber === contractNumber);
                    returnCurrentContract = contract;
                    
                    if (contract) {
                        if (Array.isArray(contract.products) && contract.products.length > 1) {
                            // 显示切换按钮
                            returnSwitchButton.style.display = 'inline-block';
                            // 显示第一个产品
                            const product = contract.products[0];
                            document.getElementById('return-product').value = product.productName || '';
                            document.getElementById('return-spec').value = product.specification || '';
                            document.getElementById('return-unit').value = product.unit || '';
                        } else {
                            // 单个产品
                            const productInfo = getReturnProductInfoFromContract(contractNumber);
                            document.getElementById('return-product').value = productInfo.product || '';
                            document.getElementById('return-spec').value = productInfo.spec || '';
                            document.getElementById('return-unit').value = productInfo.unit || '';
                        }
                        // 更新提示
                        updateReturnQuantityTooltip();
                    }
                } else {
                    document.getElementById('return-product').value = '';
                    document.getElementById('return-spec').value = '';
                    document.getElementById('return-unit').value = '';
                    document.getElementById('return-quantity').title = '';
                }
            });
            
            // 为退货数量输入框添加悬停事件，实时更新提示
            document.getElementById('return-quantity').addEventListener('mouseenter', updateReturnQuantityTooltip);
            
            // 合同搜索事件
            const contractSearchInput = document.getElementById('contract-search');
            if (contractSearchInput) {
                contractSearchInput.addEventListener('input', function(e) {
                    renderContractList(e.target.value.trim());
                });
            }
            
            // 收货记录搜索事件
            const receiptSearchInput = document.getElementById('receipt-search');
            if (receiptSearchInput) {
                receiptSearchInput.addEventListener('input', function(e) {
                    renderReceiptList(e.target.value.trim());
                });
            }
            
            // 退货记录搜索事件
            const returnSearchInput = document.getElementById('return-search');
            if (returnSearchInput) {
                returnSearchInput.addEventListener('input', function(e) {
                    renderReturnList(e.target.value.trim());
                });
            }
            
            // 库存统计搜索事件
            const inventorySearchInput = document.getElementById('inventory-search');
            if (inventorySearchInput) {
                inventorySearchInput.addEventListener('input', function(e) {
                    renderInventoryList(e.target.value.trim());
                });
            }
            
            // 合同比对搜索事件
            const comparisonSearchInput = document.getElementById('comparison-search');
            if (comparisonSearchInput) {
                comparisonSearchInput.addEventListener('input', function(e) {
                    renderComparisonList(e.target.value.trim());
                });
            }
            
            // 导出库存统计事件
            const exportInventoryBtn = document.getElementById('export-inventory-btn');
            if (exportInventoryBtn) {
                exportInventoryBtn.addEventListener('click', function() {
                    exportInventoryToExcel();
                });
            }
        }
        
        // 数据存储管理
        function getStorageKey(prefix) {
            return `${prefix}_${currentCompany}`;
        }
        
        function saveData(key, data) {
            localStorage.setItem(getStorageKey(key), JSON.stringify(data));
        }
        
        function getData(key) {
            const data = localStorage.getItem(getStorageKey(key));
            return data ? JSON.parse(data) : [];
        }
        
        // 保存合同

        
        // 自动生成收货单号
        function generateReceiptNumber() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            const random = Math.floor(1000 + Math.random() * 9000);
            return `${dateStr}${random}`;
        }
        
        // 保存收货记录
        function saveReceipt() {
            const contractNumberSelect = document.getElementById('receipt-contract-number');
            const selectedOptions = Array.from(contractNumberSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                alert('请至少选择一个合同号');
                return;
            }
            
            // 获取表单数据
            const supplier = document.getElementById('receipt-supplier').value;
            const product = document.getElementById('receipt-product').value;
            const spec = document.getElementById('receipt-spec').value;
            const unit = document.getElementById('receipt-unit').value;
            const quantity = parseFloat(document.getElementById('receipt-quantity').value);
            const receiptDate = document.getElementById('receipt-date').value;
            const person = document.getElementById('receipt-person').value;
            const remark = document.getElementById('receipt-remark').value;
            
            // 自动生成收货单号（如果未输入）
            let receiptNumber = document.getElementById('receipt-receipt-number').value;
            if (!receiptNumber) {
                receiptNumber = generateReceiptNumber();
            }
            
            const receipts = getData('receipts');
            
            // 为每个选中的合同号创建一条收货记录
            selectedOptions.forEach(option => {
                const contractNumber = option.value;
                const receipt = {
                    id: Date.now().toString() + '-' + Math.floor(Math.random() * 1000),
                    receiptNumber: receiptNumber,
                    contractNumber: contractNumber,
                    supplier: supplier,
                    product: product,
                    spec: spec,
                    quantity: quantity,
                    unit: unit,
                    receiptDate: receiptDate,
                    person: person,
                    remark: remark,
                    createdAt: new Date().toISOString()
                };
                receipts.push(receipt);
            });
            
            saveData('receipts', receipts);
            
            // 关闭模态框并重置表单
            document.getElementById('create-receipt-modal').classList.add('hidden');
            document.getElementById('create-receipt-form').reset();
            
            // 更新相关列表
            renderReceiptList();
            renderInventoryList();
            renderComparisonList();
            initDashboardData();
            
            // 显示成功消息
            alert('收货记录保存成功！');
        }
        
        // 保存退货记录
        function saveReturn() {
            const returnContractNumberSelect = document.getElementById('return-contract-number');
            const selectedOptions = Array.from(returnContractNumberSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                alert('请至少选择一个合同号');
                return;
            }
            
            // 获取表单数据
            const supplier = document.getElementById('return-supplier').value;
            const product = document.getElementById('return-product').value;
            const spec = document.getElementById('return-spec').value;
            const unit = document.getElementById('return-unit').value;
            const quantity = parseFloat(document.getElementById('return-quantity').value);
            const returnDate = document.getElementById('return-date').value;
            const reason = document.getElementById('return-reason').value;
            const remark = document.getElementById('return-remark').value;
            
            // 生成退货单号
            const returnNumber = `RT-${Date.now()}`;
            
            const returns = getData('returns');
            
            // 为每个选中的合同号创建一条退货记录
            selectedOptions.forEach(option => {
                const contractNumber = option.value;
                const returnRecord = {
                    id: Date.now().toString() + '-' + Math.floor(Math.random() * 1000),
                    returnNumber: returnNumber,
                    contractNumber: contractNumber,
                    supplier: supplier,
                    product: product,
                    spec: spec,
                    quantity: quantity,
                    unit: unit,
                    returnDate: returnDate,
                    reason: reason,
                    remark: remark,
                    createdAt: new Date().toISOString()
                };
                returns.push(returnRecord);
            });
            
            saveData('returns', returns);
            
            // 关闭模态框并重置表单
            document.getElementById('create-return-modal').classList.add('hidden');
            document.getElementById('create-return-form').reset();
            
            // 更新相关列表
            renderReturnList();
            renderInventoryList();
            renderComparisonList();
            initDashboardData();
            
            // 显示成功消息
            alert('退货记录保存成功！');
        }
        
        // 编辑退货记录
        function editReturn(id) {
            const returns = getData('returns');
            const returnRecord = returns.find(r => r.id === id);
            
            if (returnRecord) {
                // 填充表单数据
                document.getElementById('edit-return-id').value = returnRecord.id;
                document.getElementById('edit-return-number').value = returnRecord.returnNumber;
                document.getElementById('edit-return-product').value = returnRecord.product || '';
                document.getElementById('edit-return-spec').value = returnRecord.spec || '';
                document.getElementById('edit-return-unit').value = returnRecord.unit || '';
                document.getElementById('edit-return-date').value = returnRecord.returnDate;
                document.getElementById('edit-return-quantity').value = returnRecord.quantity;
                document.getElementById('edit-return-reason').value = returnRecord.reason;
                document.getElementById('edit-return-remark').value = returnRecord.remark;
                
                // 打开模态框
                document.getElementById('edit-return-modal').classList.remove('hidden');
            }
        }
        
        // 保存编辑后的退货记录
        function saveEditedReturn() {
            const id = document.getElementById('edit-return-id').value;
            const returnNumber = document.getElementById('edit-return-number').value;
            const returnDate = document.getElementById('edit-return-date').value;
            const quantity = parseFloat(document.getElementById('edit-return-quantity').value);
            const reason = document.getElementById('edit-return-reason').value;
            const remark = document.getElementById('edit-return-remark').value;
            
            const returns = getData('returns');
            const index = returns.findIndex(r => r.id === id);
            
            if (index !== -1) {
                // 更新退货记录
                returns[index] = {
                    ...returns[index],
                    returnNumber: returnNumber,
                    returnDate: returnDate,
                    quantity: quantity,
                    reason: reason,
                    remark: remark
                };
                
                saveData('returns', returns);
                
                // 关闭模态框
                document.getElementById('edit-return-modal').classList.add('hidden');
                
                // 更新相关列表
                renderReturnList();
                renderInventoryList();
                renderComparisonList();
                initDashboardData();
                
                // 显示成功消息
                alert('退货记录编辑成功！');
            }
        }
        
        // 渲染合同列表
        function renderContractList(searchTerm = '') {
            const contracts = getData('contracts');
            const receipts = getData('receipts');
            const returns = getData('returns');
            const tbody = document.getElementById('contract-table-body');
            
            // 过滤合同数据 - 只要合同中的任何产品匹配，就显示整个合同
            const filteredContracts = contracts.filter(contract => {
                // 合同级别的搜索字段
                const contractFields = [
                    contract.contractNumber,
                    contract.supplier,
                    contract.contractDate,
                    contract.deliveryDate,
                    getStatusText(contract.status)
                ].filter(Boolean).join(' ').toLowerCase();
                
                // 检查合同级别是否匹配
                if (contractFields.includes(searchTerm.toLowerCase())) {
                    return true;
                }
                
                // 产品级别的搜索 - 只要有一个产品匹配，整个合同就匹配
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    return contract.products.some(product => {
                        const productFields = [
                            product.productName,
                            product.specification,
                            product.quantity.toString(),
                            product.unit,
                            product.unitPrice.toString()
                        ].filter(Boolean).join(' ').toLowerCase();
                        return productFields.includes(searchTerm.toLowerCase());
                    });
                } else {
                    // 兼容旧数据结构（单个产品）
                    const legacyProductFields = [
                        contract.product,
                        contract.spec,
                        contract.quantity.toString(),
                        contract.unit,
                        contract.price.toString()
                    ].filter(Boolean).join(' ').toLowerCase();
                    return legacyProductFields.includes(searchTerm.toLowerCase());
                }
            });
            
            // 分页逻辑
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedContracts = filteredContracts.slice(startIndex, endIndex);
            
            if (paginatedContracts.length === 0 && filteredContracts.length > 0) {
                // 如果当前页没有数据，但总共有数据，说明当前页超出范围，重置为第一页
                currentPage = 1;
                renderContractList(searchTerm);
                return;
            }
            
            if (filteredContracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">暂无合同数据</td></tr>';
                // 更新分页控件
                updatePaginationAndStats([], {
                    pageType: 'contract',
                    containerId: 'contract-pagination-stats',
                    searchInputId: 'contract-search',
                    filterFunction: renderContractList
                });
                return;
            }
            
            // 用于存储最终的HTML行
            let rows = [];
            
            // 遍历每个匹配的合同，显示该合同的所有产品行
            paginatedContracts.forEach(contract => {
                // 如果合同有products数组，遍历每个产品
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    // 显示该合同的所有产品行
                    contract.products.forEach((product, index) => {
                        // 计算该产品的已收数量，考虑规格型号
                        const receivedQuantity = receipts
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName && r.spec === product.specification)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算该产品的已退数量，考虑规格型号
                        const returnedQuantity = returns
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName && r.spec === product.specification)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算实际收货数量（已收数量 - 已退数量）
                        const actualReceivedQuantity = receivedQuantity - returnedQuantity;
                        
                        // 确定产品状态
                        let productStatus;
                        if (actualReceivedQuantity === 0) {
                            productStatus = 'pending'; // 未开始
                        } else if (actualReceivedQuantity < parseFloat(product.quantity) || 0) {
                            productStatus = 'in-progress'; // 执行中
                        } else {
                            productStatus = 'completed'; // 执行完毕
                        }
                        
                        // 只在第一个产品行显示完整的合同信息
                        rows.push(`
                            <tr>
                                <td>${index === 0 ? contract.contractNumber : ''}</td>
                                <td>${index === 0 ? contract.supplier : ''}</td>
                                <td>${product.productName || '-'}</td>
                                <td>${product.specification || '-'}</td>
                                <td>${parseFloat(product.quantity) || 0}</td>
                                <td>${product.unit || '-'}</td>
                                <td>¥${(parseFloat(product.unitPrice) || 0).toFixed(2)}</td>
                                <td>${index === 0 ? contract.contractDate : ''}</td>
                                <td>${index === 0 ? contract.deliveryDate : ''}</td>
                                <td><span class="badge badge-${getStatusColor(productStatus)}" style="cursor: pointer; border-radius: 12px;">${getStatusText(productStatus)}</span></td>
                            </tr>
                        `);
                    });
                } else {
                    // 兼容旧数据结构（单个产品字段）
                    // 计算已收数量
                    const receivedQuantity = receipts
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算已退数量
                    const returnedQuantity = returns
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算实际收货数量（已收数量 - 已退数量）
                    const actualReceivedQuantity = receivedQuantity - returnedQuantity;
                    
                    // 确定产品状态
                    let productStatus;
                    if (actualReceivedQuantity === 0) {
                        productStatus = 'pending'; // 未开始
                    } else if (actualReceivedQuantity < contract.quantity || 0) {
                        productStatus = 'in-progress'; // 执行中
                    } else {
                        productStatus = 'completed'; // 执行完毕
                    }
                    
                    rows.push(`
                        <tr>
                            <td>${contract.contractNumber}</td>
                            <td>${contract.supplier}</td>
                            <td>${contract.product || '-'}</td>
                            <td>${contract.spec || '-'}</td>
                            <td>${contract.quantity || 0}</td>
                            <td>${contract.unit || '-'}</td>
                            <td>¥${(contract.price || 0).toFixed(2)}</td>
                            <td>${contract.contractDate || '-'}</td>
                            <td>${contract.deliveryDate || '-'}</td>
                            <td><span class="badge badge-${getStatusColor(productStatus)}" onclick="toggleContractStatus('${contract.id}')" style="cursor: pointer; border-radius: 12px;">${getStatusText(productStatus)}</span></td>
                        </tr>
                    `);
                }
            });
            
            // 将所有行添加到表格中
            tbody.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="10" class="text-center py-4 text-gray-500">未找到匹配的合同数据</td></tr>';
            
            // 更新分页控件
            updatePaginationAndStats(filteredContracts, {
                pageType: 'contract',
                containerId: 'contract-pagination-stats',
                searchInputId: 'contract-search',
                filterFunction: renderContractList
            });
        }
        
        // 渲染收货记录列表
        function renderReceiptList(searchTerm = '') {
            const receipts = getData('receipts');
            const tbody = document.getElementById('receipt-table-body');
            
            // 过滤收货记录数据
            const filteredReceipts = receipts.filter(receipt => {
                // 将所有字段合并成一个字符串进行搜索
                const searchableText = [
                    receipt.receiptNumber,
                    receipt.contractNumber,
                    receipt.supplier,
                    receipt.product,
                    receipt.quantity.toString(),
                    receipt.unit,
                    receipt.receiptDate,
                    receipt.person,
                    receipt.remark
                ].filter(Boolean).join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm.toLowerCase());
            });
            
            // 分页逻辑
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedReceipts = filteredReceipts.slice(startIndex, endIndex);
            
            if (paginatedReceipts.length === 0 && filteredReceipts.length > 0) {
                // 如果当前页没有数据，但总共有数据，说明当前页超出范围，重置为第一页
                currentPage = 1;
                renderReceiptList(searchTerm);
                return;
            }
            
            if (filteredReceipts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-500">暂无收货记录</td></tr>';
                // 更新分页控件
                updatePaginationAndStats([], {
                    pageType: 'receipt',
                    containerId: 'receipt-pagination-stats',
                    searchInputId: 'receipt-search',
                    filterFunction: renderReceiptList
                });
                return;
            }
            
            tbody.innerHTML = paginatedReceipts.map(receipt => `
                <tr>
                    <td>${receipt.receiptNumber}</td>
                    <td>${receipt.contractNumber}</td>
                    <td>${receipt.supplier}</td>
                    <td>${receipt.product}</td>
                    <td>${receipt.spec || '-'}</td>
                    <td>${receipt.quantity}</td>
                    <td>${receipt.unit}</td>
                    <td>${receipt.receiptDate}</td>
                    <td>${receipt.person}</td>
                    <td>${receipt.remark}</td>
                    <td>
                        <button class="btn btn-primary btn-sm mr-1" onclick="editReceipt('${receipt.id}')">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteReceipt('${receipt.id}')">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // 更新分页控件
            updatePaginationAndStats(filteredReceipts, {
                pageType: 'receipt',
                containerId: 'receipt-pagination-stats',
                searchInputId: 'receipt-search',
                filterFunction: renderReceiptList
            });
        }
        
        // 渲染退货记录列表
        function renderReturnList(searchTerm = '') {
            const returns = getData('returns');
            const tbody = document.getElementById('return-table-body');
            
            // 过滤退货记录数据
            const filteredReturns = returns.filter(returnRecord => {
                // 将所有字段合并成一个字符串进行搜索
                const searchableText = [
                    returnRecord.returnNumber,
                    returnRecord.contractNumber,
                    returnRecord.supplier,
                    returnRecord.product,
                    returnRecord.quantity.toString(),
                    returnRecord.unit,
                    returnRecord.returnDate,
                    returnRecord.reason,
                    returnRecord.remark
                ].filter(Boolean).join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm.toLowerCase());
            });
            
            // 分页逻辑
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedReturns = filteredReturns.slice(startIndex, endIndex);
            
            if (paginatedReturns.length === 0 && filteredReturns.length > 0) {
                // 如果当前页没有数据，但总共有数据，说明当前页超出范围，重置为第一页
                currentPage = 1;
                renderReturnList(searchTerm);
                return;
            }
            
            if (filteredReturns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-500">暂无退货记录</td></tr>';
                // 更新分页控件
                updatePaginationAndStats([], {
                    pageType: 'return',
                    containerId: 'return-pagination-stats',
                    searchInputId: 'return-search',
                    filterFunction: renderReturnList
                });
                return;
            }
            
            tbody.innerHTML = paginatedReturns.map(returnRecord => `
                <tr>
                    <td>${returnRecord.returnNumber}</td>
                    <td>${returnRecord.contractNumber}</td>
                    <td>${returnRecord.supplier}</td>
                    <td>${returnRecord.product}</td>
                    <td>${returnRecord.spec || '-'}</td>
                    <td>${returnRecord.quantity}</td>
                    <td>${returnRecord.unit}</td>
                    <td>${returnRecord.returnDate}</td>
                    <td>${returnRecord.reason}</td>
                    <td>${returnRecord.remark}</td>
                    <td>
                        <button class="btn btn-primary btn-sm mr-1" onclick="editReturn('${returnRecord.id}')">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteReturn('${returnRecord.id}')">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // 更新分页控件
            updatePaginationAndStats(filteredReturns, {
                pageType: 'return',
                containerId: 'return-pagination-stats',
                searchInputId: 'return-search',
                filterFunction: renderReturnList
            });
        }
        
        // 渲染库存统计列表
        function renderInventoryList(searchTerm = '') {
            const contracts = getData('contracts');
            const receipts = getData('receipts');
            const returns = getData('returns');
            const tbody = document.getElementById('inventory-table-body');
            
            if (contracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-500">暂无合同数据</td></tr>';
                // 更新分页控件
                updatePaginationAndStats([], {
                    pageType: 'inventory',
                    containerId: 'inventory-pagination-stats',
                    searchInputId: 'inventory-search',
                    filterFunction: renderInventoryList
                });
                return;
            }
            
            // 计算库存统计数据
            const inventoryData = [];
            
            contracts.forEach(contract => {
                // 处理包含products数组的合同
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    contract.products.forEach(product => {
                        // 计算该产品的已收数量，考虑规格型号
                        const receivedQuantity = receipts
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName && r.spec === product.specification)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算该产品的已退数量，考虑规格型号
                        const returnedQuantity = returns
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName && r.spec === product.specification)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算库存数量
                        const inventoryQuantity = parseFloat((receivedQuantity - returnedQuantity).toFixed(3));
                        
                        // 计算未收数量
                        const productQuantity = parseFloat(product.quantity) || 0;
                        const pendingQuantity = parseFloat((productQuantity - inventoryQuantity).toFixed(3));
                        
                        // 计算完成率
                        const completionRate = productQuantity > 0 ? (inventoryQuantity / productQuantity * 100).toFixed(3) : '0.00';
                        
                        inventoryData.push({
                            ...contract,
                            product: product.productName,
                            spec: product.specification,
                            quantity: productQuantity,
                            unit: product.unit,
                            price: parseFloat(product.unitPrice) || 0,
                            receivedQuantity,
                            returnedQuantity,
                            inventoryQuantity,
                            pendingQuantity,
                            completionRate
                        });
                    });
                } else {
                    // 兼容旧数据结构（单个产品）
                    // 计算已收数量
                    const receivedQuantity = receipts
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算已退数量
                    const returnedQuantity = returns
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算库存数量
                    const inventoryQuantity = parseFloat((receivedQuantity - returnedQuantity).toFixed(3));
                    
                    // 计算未收数量
                    const pendingQuantity = parseFloat((contract.quantity - inventoryQuantity).toFixed(3));
                    
                    // 计算完成率
                    const completionRate = contract.quantity > 0 ? (inventoryQuantity / contract.quantity * 100).toFixed(3) : '0.00';
                    
                    inventoryData.push({
                        ...contract,
                        receivedQuantity,
                        returnedQuantity,
                        inventoryQuantity,
                        pendingQuantity,
                        completionRate
                    });
                }
            });
            
            // 过滤库存数据
            const filteredInventoryData = inventoryData.filter(item => {
                // 将所有字段合并成一个字符串进行搜索
                const searchableText = [
                    item.contractNumber,
                    item.supplier,
                    item.product,
                    item.spec,
                    item.unit,
                    item.quantity.toString(),
                    item.receivedQuantity.toString(),
                    item.returnedQuantity.toString(),
                    item.inventoryQuantity.toString(),
                    item.pendingQuantity.toString(),
                    item.completionRate
                ].filter(Boolean).join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm.toLowerCase());
            });
            
            // 分页逻辑
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedInventoryData = filteredInventoryData.slice(startIndex, endIndex);
            
            if (paginatedInventoryData.length === 0 && filteredInventoryData.length > 0) {
                // 如果当前页没有数据，但总共有数据，说明当前页超出范围，重置为第一页
                currentPage = 1;
                renderInventoryList(searchTerm);
                return;
            }
            
            // 渲染表格
            if (filteredInventoryData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center py-4 text-gray-500">未找到匹配的库存数据</td></tr>';
            } else {
                tbody.innerHTML = paginatedInventoryData.map(item => `
                    <tr>
                        <td>${item.contractNumber}</td>
                        <td>${item.supplier}</td>
                        <td>${item.product}</td>
                        <td>${item.spec}</td>
                        <td>${item.unit}</td>
                        <td>${item.quantity}</td>
                        <td>${item.receivedQuantity}</td>
                        <td>${item.returnedQuantity}</td>
                        <td>${item.inventoryQuantity}</td>
                        <td>${item.pendingQuantity}</td>
                        <td>${item.completionRate}%</td>
                    </tr>
                `).join('');
            }
            
            // 计算总计（基于过滤后的数据）
            const totalContractQuantity = filteredInventoryData.reduce((sum, item) => sum + item.quantity, 0);
            const totalReceivedQuantity = filteredInventoryData.reduce((sum, item) => sum + item.receivedQuantity, 0);
            const totalReturnedQuantity = filteredInventoryData.reduce((sum, item) => sum + item.returnedQuantity, 0);
            const totalInventoryQuantity = filteredInventoryData.reduce((sum, item) => sum + item.inventoryQuantity, 0);
            const totalPendingQuantity = filteredInventoryData.reduce((sum, item) => sum + item.pendingQuantity, 0);
            
            // 更新总计行
            document.getElementById('total-contract-quantity').textContent = totalContractQuantity;
            document.getElementById('total-received-quantity').textContent = totalReceivedQuantity;
            document.getElementById('total-returned-quantity').textContent = totalReturnedQuantity;
            document.getElementById('total-inventory-quantity').textContent = totalInventoryQuantity;
            document.getElementById('total-pending-quantity').textContent = totalPendingQuantity;
            
            // 更新分页控件
            updatePaginationAndStats(filteredInventoryData, {
                pageType: 'inventory',
                containerId: 'inventory-pagination-stats',
                searchInputId: 'inventory-search',
                filterFunction: renderInventoryList
            });
        }
        
        // 渲染合同比对列表
        function renderComparisonList(searchTerm = '') {
            const contracts = getData('contracts');
            const receipts = getData('receipts');
            const returns = getData('returns');
            const tbody = document.getElementById('comparison-table-body');
            
            if (contracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">暂无合同数据</td></tr>';
                // 更新分页控件
                updatePaginationAndStats([], {
                    pageType: 'comparison',
                    containerId: 'comparison-pagination-stats',
                    searchInputId: 'comparison-search',
                    filterFunction: renderComparisonList
                });
                return;
            }
            
            // 计算比对数据并同步合同状态
            const comparisonData = [];
            const updatedContracts = [...contracts];
            
            contracts.forEach((contract, contractIndex) => {
                // 处理包含products数组的合同
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    let allProductsPending = true;
                    let allProductsCompleted = true;
                    
                    contract.products.forEach(product => {
                        // 计算该产品的已收数量，考虑规格型号
                        const receivedQuantity = receipts
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName && r.spec === product.specification)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算该产品的已退数量，考虑规格型号
                        const returnedQuantity = returns
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName && r.spec === product.specification)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算实际收货数量（已收数量 - 已退数量）
                        const actualReceivedQuantity = parseFloat((receivedQuantity - returnedQuantity).toFixed(3));
                        
                        // 计算差异数量（库存数量 - 合同数量）
                        const productQuantity = parseFloat(product.quantity) || 0;
                        const difference = parseFloat((actualReceivedQuantity - productQuantity).toFixed(3));
                        
                        // 计算差异率（库存数量 - 合同数量）/ 合同数量 * 100
                        const differenceRate = productQuantity > 0 ? ((difference / productQuantity) * 100).toFixed(3) : '0.00';
                        
                        // 确定产品状态
                        let productStatus;
                        if (actualReceivedQuantity === 0) {
                            productStatus = 'pending'; // 未开始
                            allProductsCompleted = false; // 有未开始的产品，合同未全部完成
                        } else if (actualReceivedQuantity < productQuantity) {
                            productStatus = 'in-progress'; // 执行中
                            allProductsPending = false;
                            allProductsCompleted = false;
                        } else {
                            productStatus = 'completed'; // 执行完毕
                            allProductsPending = false;
                        }
                        
                        comparisonData.push({
                            ...contract,
                            product: product.productName,
                            spec: product.specification,
                            quantity: productQuantity,
                            unit: product.unit,
                            price: parseFloat(product.unitPrice) || 0,
                            receivedQuantity: actualReceivedQuantity,
                            difference,
                            differenceRate,
                            status: productStatus
                        });
                    });
                    
                    // 确定合同整体状态
                    let contractStatus;
                    if (allProductsPending) {
                        contractStatus = 'pending'; // 所有产品都未开始，合同状态为未开始
                    } else if (allProductsCompleted) {
                        contractStatus = 'completed'; // 所有产品都已完成，合同状态为执行完毕
                    } else {
                        contractStatus = 'in-progress'; // 部分产品在执行中，合同状态为执行中
                    }
                    
                    // 同步状态到合同数据
                    updatedContracts[contractIndex] = {
                        ...updatedContracts[contractIndex],
                        status: contractStatus
                    };
                } else {
                    // 兼容旧数据结构（单个产品）
                    // 计算已收数量
                    const receivedQuantity = receipts
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算已退数量
                    const returnedQuantity = returns
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算实际收货数量（已收数量 - 已退数量）
                    const actualReceivedQuantity = parseFloat((receivedQuantity - returnedQuantity).toFixed(3));
                    
                    // 计算差异数量（库存数量 - 合同数量）
                    const difference = parseFloat((actualReceivedQuantity - contract.quantity).toFixed(3));
                    
                    // 计算差异率（库存数量 - 合同数量）/ 合同数量 * 100
                    const differenceRate = contract.quantity > 0 ? ((difference / contract.quantity) * 100).toFixed(3) : '0.00';
                    
                    // 确定状态
                    let status;
                    if (actualReceivedQuantity === 0) {
                        status = 'pending'; // 未开始
                    } else if (actualReceivedQuantity < contract.quantity) {
                        status = 'in-progress'; // 执行中
                    } else {
                        status = 'completed'; // 执行完毕
                    }
                    
                    comparisonData.push({
                        ...contract,
                        receivedQuantity: actualReceivedQuantity,
                        difference,
                        differenceRate,
                        status
                    });
                    
                    // 同步状态到合同数据
                    updatedContracts[contractIndex] = {
                        ...updatedContracts[contractIndex],
                        status: status
                    };
                }
            });
            
            // 保存更新后的合同数据到localStorage
            saveData('contracts', updatedContracts);
            
            // 应用搜索过滤
            const filteredComparisonData = comparisonData.filter(item => {
                // 将所有字段合并成一个字符串进行搜索
                const searchableText = [
                    item.contractNumber,
                    item.supplier,
                    item.product,
                    item.quantity.toString(),
                    item.receivedQuantity.toString(),
                    item.difference.toString(),
                    item.differenceRate,
                    getComparisonStatusText(item.status)
                ].filter(Boolean).join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm.toLowerCase());
            });
            
            // 分页逻辑
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedComparisonData = filteredComparisonData.slice(startIndex, endIndex);
            
            if (paginatedComparisonData.length === 0 && filteredComparisonData.length > 0) {
                // 如果当前页没有数据，但总共有数据，说明当前页超出范围，重置为第一页
                currentPage = 1;
                renderComparisonList(searchTerm);
                return;
            }
            
            // 渲染表格
            if (filteredComparisonData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">未找到匹配的合同比对数据</td></tr>';
            } else {
                tbody.innerHTML = paginatedComparisonData.map(item => `
                    <tr>
                        <td>${item.contractNumber}</td>
                        <td>${item.supplier}</td>
                        <td>${item.product}</td>
                        <td>${item.quantity}</td>
                        <td>${item.receivedQuantity}</td>
                        <td style="${item.difference < 0 ? 'color: #ef4444; font-weight: bold;' : item.difference > 0 ? 'color: #10b981; font-weight: bold;' : 'color: #10b981;'}">${item.difference}</td>
                        <td style="${parseFloat(item.differenceRate) < 0 ? 'color: #ef4444; font-weight: bold;' : parseFloat(item.differenceRate) > 0 ? 'color: #10b981; font-weight: bold;' : 'color: #10b981;'}">${item.differenceRate}%</td>
                        <td><span class="badge badge-${getStatusColor(item.status)}">${getComparisonStatusText(item.status)}</span></td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="updateContractFromComparison('${item.id}', ${item.receivedQuantity}, '${item.product}')">
                                <i class="fa fa-refresh"></i> 更新合同
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            
            // 更新分页控件
            updatePaginationAndStats(filteredComparisonData, {
                pageType: 'comparison',
                containerId: 'comparison-pagination-stats',
                searchInputId: 'comparison-search',
                filterFunction: renderComparisonList
            });
        }
        
        // 初始化统计概览数据
        function initDashboardData() {
            const contracts = getData('contracts');
            const receipts = getData('receipts');
            
            // 计算统计数据
            const totalContracts = contracts.length;
            const completedContracts = contracts.filter(c => c.status === 'completed').length;
            
            // 计算待收货数量
            let pendingQuantity = 0;
            contracts.forEach(contract => {
                // 如果合同有products数组
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    contract.products.forEach(product => {
                        const productName = product.productName;
                        const productSpec = product.specification;
                        const productQuantity = parseFloat(product.quantity) || 0;
                        const receivedQuantity = receipts
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === productName && r.spec === productSpec)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        pendingQuantity += Math.max(0, productQuantity - receivedQuantity);
                    });
                } else {
                    // 兼容旧数据结构（单个产品）
                    const receivedQuantity = receipts
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    pendingQuantity += Math.max(0, contract.quantity - receivedQuantity);
                }
            });
            
            // 计算存在差异的合同数量
            let differenceContracts = 0;
            contracts.forEach(contract => {
                let hasDifference = false;
                
                // 如果合同有products数组
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    contract.products.forEach(product => {
                        const productName = product.productName;
                        const productSpec = product.specification;
                        const productQuantity = parseFloat(product.quantity) || 0;
                        const receivedQuantity = receipts
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === productName && r.spec === productSpec)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        if (productQuantity !== receivedQuantity) {
                            hasDifference = true;
                        }
                    });
                } else {
                    // 兼容旧数据结构（单个产品）
                    const receivedQuantity = receipts
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    if (contract.quantity !== receivedQuantity) {
                        hasDifference = true;
                    }
                }
                
                if (hasDifference) {
                    differenceContracts++;
                }
            });
            
            // 更新统计卡片
            document.getElementById('total-contracts').textContent = totalContracts;
            document.getElementById('completed-receipts').textContent = completedContracts;
            document.getElementById('pending-quantity').textContent = pendingQuantity;
            document.getElementById('difference-contracts').textContent = differenceContracts;
            
            // 更新最近合同动态
            updateRecentActivities();
        }
        
        // 更新最近合同动态
        function updateRecentActivities() {
            const contracts = getData('contracts');
            const receipts = getData('receipts');
            const tbody = document.getElementById('recent-activities');
            
            // 用于存储所有合同产品的动态数据
            const allContractActivities = [];
            
            // 遍历每个合同
            contracts.forEach(contract => {
                // 如果合同有products数组
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    contract.products.forEach(product => {
                        const productName = product.productName;
                        const productQuantity = parseFloat(product.quantity) || 0;
                        
                        // 计算该产品的已收数量
                        const receivedQuantity = receipts
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === productName)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        const pendingQuantity = Math.max(0, productQuantity - receivedQuantity);
                        
                        allContractActivities.push({
                            ...contract,
                            product: productName,
                            quantity: productQuantity,
                            receivedQuantity,
                            pendingQuantity
                        });
                    });
                } else {
                    // 兼容旧数据结构（单个产品）
                    const receivedQuantity = receipts
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    const pendingQuantity = Math.max(0, contract.quantity - receivedQuantity);
                    
                    allContractActivities.push({
                        ...contract,
                        receivedQuantity,
                        pendingQuantity
                    });
                }
            });
            
            // 获取最近10条合同动态
            const recentActivities = [...allContractActivities]
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .slice(0, 10);
            
            // 渲染最近动态
            tbody.innerHTML = recentActivities.map(activity => `
                <tr>
                    <td>${activity.contractNumber}</td>
                    <td>${activity.supplier}</td>
                    <td>${activity.product}</td>
                    <td>${activity.quantity}</td>
                    <td>${activity.receivedQuantity}</td>
                    <td>${activity.pendingQuantity}</td>
                    <td><span class="badge badge-${getStatusColor(activity.status)}">${getStatusText(activity.status)}</span></td>
                    <td>${new Date(activity.updatedAt).toLocaleString()}</td>
                </tr>
            `).join('');
        }
        
        // 更新合同最终数量
        function updateContractFinalQuantity(contractId, finalQuantity, productName) {
            if (confirm(`确定要将合同产品 "${productName}" 的最终数量更新为 ${finalQuantity} 吗？`)) {
                const contracts = getData('contracts');
                const updatedContracts = contracts.map(contract => {
                    if (contract.id === contractId) {
                        // 如果合同有products数组
                        if (Array.isArray(contract.products) && contract.products.length > 0) {
                            const updatedProducts = contract.products.map(product => {
                                if (product.productName === productName) {
                                    return {
                                        ...product,
                                        quantity: finalQuantity
                                    };
                                }
                                return product;
                            });
                            
                            return {
                                ...contract,
                                products: updatedProducts,
                                status: 'completed',
                                updatedAt: new Date().toISOString()
                            };
                        } else {
                            // 兼容旧数据结构（单个产品）
                            return {
                                ...contract,
                                quantity: finalQuantity,
                                status: 'completed',
                                updatedAt: new Date().toISOString()
                            };
                        }
                    }
                    return contract;
                });
                
                saveData('contracts', updatedContracts);
                
                // 更新相关列表
                renderInventoryList();
                renderComparisonList();
                initDashboardData();
                
                alert('合同最终数量更新成功！');
            }
        }
        
        // 从比对结果更新合同 - 显示密码模态框
        function updateContractFromComparison(contractId, receivedQuantity, productName) {
            // 存储当前需要更新的合同信息
            currentUpdateContractInfo = {
                contractId: contractId,
                receivedQuantity: receivedQuantity,
                productName: productName
            };
            // 显示密码模态框
            document.getElementById('password-modal').classList.remove('hidden');
        }
        
        // 实际执行合同更新并同步到index.html
        function updateContractAndSyncIndex(contractId, receivedQuantity, productName) {
            const contracts = getData('contracts');
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) {
                alert('未找到该合同！');
                return;
            }
            
            // 更新当前文件的合同数据
            const updatedContracts = contracts.map(contract => {
                if (contract.id === contractId) {
                    // 如果合同有products数组
                    if (Array.isArray(contract.products) && contract.products.length > 0) {
                        const updatedProducts = contract.products.map(product => {
                            if (product.productName === productName) {
                                return {
                                    ...product,
                                    quantity: receivedQuantity
                                };
                            }
                            return product;
                        });
                        
                        return {
                            ...contract,
                            products: updatedProducts,
                            status: 'completed',
                            updatedAt: new Date().toISOString()
                        };
                    } else {
                        // 兼容旧数据结构（单个产品）
                        return {
                            ...contract,
                            quantity: receivedQuantity,
                            status: 'completed',
                            updatedAt: new Date().toISOString()
                        };
                    }
                }
                return contract;
            });
            
            saveData('contracts', updatedContracts);
            
            // 同步更新到index.html的localStorage
            syncToIndexHtml(contract.contractNumber, receivedQuantity, productName);
            
            // 更新相关列表
            renderContractList();
            renderInventoryList();
            renderComparisonList();
            initDashboardData();
            
            alert('合同更新成功！');
        }
        
        // 同步更新到index.html的localStorage
        function syncToIndexHtml(contractNumber, receivedQuantity, productName) {
            const currentCompany = localStorage.getItem('currentCompany_index') || 'companyA';
            const indexStorageKey = `purchaseOrders_${currentCompany}`;
            
            // 获取index.html的采购订单数据
            const purchaseOrders = JSON.parse(localStorage.getItem(indexStorageKey)) || [];
            
            // 更新采购订单数据
            const updatedOrders = purchaseOrders.map(order => {
                // 不区分大小写和空格比较合同号
                if (order.contractNumber && contractNumber && 
                    order.contractNumber.trim().toLowerCase() === contractNumber.trim().toLowerCase()) {
                    // 如果订单有products数组
                    if (Array.isArray(order.products) && order.products.length > 0) {
                        // 更新产品数据
                        const updatedProducts = order.products.map(product => {
                            // 创建深拷贝，避免直接修改原对象
                            const updatedProduct = {...product};
                            
                            // 不区分大小写和空格比较产品名称
                            if (updatedProduct.productName && productName && 
                                updatedProduct.productName.trim().toLowerCase() === productName.trim().toLowerCase()) {
                                // 更新数量
                                updatedProduct.quantity = parseFloat(receivedQuantity) || 0;
                            }
                            
                            // 重新计算每个产品的金额（单价 * 数量）
                            const unitPrice = parseFloat(updatedProduct.unitPrice) || 0;
                            const quantity = parseFloat(updatedProduct.quantity) || 0;
                            updatedProduct.amount = unitPrice * quantity;
                            
                            return updatedProduct;
                        });
                        
                        // 重新计算订单总金额
                        const totalAmount = updatedProducts.reduce((sum, product) => {
                            return sum + (parseFloat(product.amount) || 0);
                        }, 0);
                        
                        // 创建更新后的订单对象
                        const updatedOrder = {
                            ...order,
                            products: updatedProducts,
                            // 强制更新所有可能的总金额字段
                            totalAmount: totalAmount,
                            totalAmountWithTax: totalAmount,
                            actualAmount: totalAmount
                        };
                        
                        return updatedOrder;
                    }
                }
                return order;
            });
            
            // 保存更新后的采购订单数据回localStorage
            localStorage.setItem(indexStorageKey, JSON.stringify(updatedOrders));
        }
        
        // 辅助函数
        function getStatusColor(status) {
            const colorMap = {
                'pending': 'warning',
                'in-progress': 'info',
                'completed': 'success',
                'cancelled': 'danger',
                'normal': 'info',
                'difference': 'warning',
                'completed': 'success'
            };
            return colorMap[status] || 'info';
        }
        
        function getStatusText(status) {
            const textMap = {
                'pending': '未开始',
                'in-progress': '执行中',
                'completed': '已完成',
                'cancelled': '取消'
            };
            return textMap[status] || status;
        }
        
        function getComparisonStatusText(status) {
            const textMap = {
                'pending': '未开始',
                'in-progress': '执行中',
                'completed': '执行完毕'
            };
            return textMap[status] || status;
        }
        
        // 切换合同状态
        function toggleContractStatus(contractId) {
            const contracts = getData('contracts');
            const contractIndex = contracts.findIndex(contract => contract.id === contractId);
            
            if (contractIndex === -1) return;
            
            // 定义状态切换顺序：pending → in-progress → completed → cancelled → pending
            const statusOrder = ['pending', 'in-progress', 'completed', 'cancelled'];
            const currentStatus = contracts[contractIndex].status;
            const currentIndex = statusOrder.indexOf(currentStatus);
            
            // 计算下一个状态
            const nextIndex = (currentIndex + 1) % statusOrder.length;
            contracts[contractIndex].status = statusOrder[nextIndex];
            contracts[contractIndex].updatedAt = new Date().toISOString();
            
            // 保存更新后的合同数据
            saveData('contracts', contracts);
            
            // 重新渲染合同列表
            renderContractList(document.getElementById('contract-search')?.value || '');
            
            // 更新相关列表
            renderInventoryList();
            renderComparisonList();
            initDashboardData();
        }
        
        // 占位函数，用于后续扩展
        function viewReceipt(receiptId) {
            alert(`查看收货记录详情：${receiptId}`);
        }
        
        function deleteReceipt(receiptId) {
            if (confirm('确定要删除此收货记录吗？')) {
                const receipts = getData('receipts');
                const updatedReceipts = receipts.filter(receipt => receipt.id !== receiptId);
                saveData('receipts', updatedReceipts);
                renderReceiptList();
                renderInventoryList();
                renderComparisonList();
                initDashboardData();
                alert('收货记录删除成功！');
            }
        }
        
        // 编辑收货记录
        function editReceipt(receiptId) {
            const receipts = getData('receipts');
            const receipt = receipts.find(r => r.id === receiptId);
            if (!receipt) {
                alert('未找到该收货记录');
                return;
            }
            
            // 填充表单数据
            document.getElementById('edit-receipt-id').value = receipt.id;
            document.getElementById('edit-receipt-number').value = receipt.receiptNumber;
            document.getElementById('edit-receipt-product').value = receipt.product || '';
            document.getElementById('edit-receipt-spec').value = receipt.spec || '';
            document.getElementById('edit-receipt-unit').value = receipt.unit || '';
            document.getElementById('edit-receipt-date').value = receipt.receiptDate;
            document.getElementById('edit-receipt-quantity').value = receipt.quantity;
            document.getElementById('edit-receipt-person').value = receipt.person;
            document.getElementById('edit-receipt-remark').value = receipt.remark;
            
            // 打开模态框
            document.getElementById('edit-receipt-modal').classList.remove('hidden');
        }
        
        // 保存编辑后的收货记录
        function saveEditedReceipt() {
            const receiptId = document.getElementById('edit-receipt-id').value;
            const receipts = getData('receipts');
            const receiptIndex = receipts.findIndex(r => r.id === receiptId);
            
            if (receiptIndex === -1) {
                alert('未找到该收货记录');
                return;
            }
            
            // 更新收货记录
            receipts[receiptIndex] = {
                ...receipts[receiptIndex],
                receiptNumber: document.getElementById('edit-receipt-number').value,
                receiptDate: document.getElementById('edit-receipt-date').value,
                quantity: parseFloat(document.getElementById('edit-receipt-quantity').value),
                person: document.getElementById('edit-receipt-person').value,
                remark: document.getElementById('edit-receipt-remark').value
            };
            
            // 保存数据
            saveData('receipts', receipts);
            
            // 关闭模态框
            document.getElementById('edit-receipt-modal').classList.add('hidden');
            
            // 更新相关列表
            renderReceiptList();
            renderInventoryList();
            renderComparisonList();
            initDashboardData();
            
            // 显示成功消息
            alert('收货记录编辑成功！');
        }
        
        function viewReturn(returnId) {
            alert(`查看退货记录详情：${returnId}`);
        }
        
        function deleteReturn(returnId) {
            if (confirm('确定要删除此退货记录吗？')) {
                const returns = getData('returns');
                const updatedReturns = returns.filter(r => r.id !== returnId);
                saveData('returns', updatedReturns);
                renderReturnList();
                renderInventoryList();
                renderComparisonList();
                initDashboardData();
                alert('退货记录删除成功！');
            }
        }
        
        function viewInventoryDetail(contractNumber) {
            alert(`查看库存详情：${contractNumber}`);
        }
        

        
        // 通用分页和统计更新函数
        function updatePaginationAndStats(filteredData, options) {
            const {
                pageType,
                containerId,
                totalAmountId,
                totalTaxAmountId,
                searchInputId,
                filterFunction,
                isInvoice = false
            } = options;
            
            const totalItems = filteredData.length;
            let totalAmount = 0;
            let totalTaxAmount = 0;
            
            if (isInvoice) {
                totalAmount = filteredData.reduce((sum, item) => sum + (item.amount || 0), 0);
                totalTaxAmount = filteredData.reduce((sum, item) => sum + (item.taxAmount || 0), 0);
            } else {
                totalAmount = filteredData.reduce((sum, item) => sum + (item.amount || 0), 0);
            }
            
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // 更新总计摘要
            if (totalAmountId) {
                const totalAmountElement = document.getElementById(totalAmountId);
                if (totalAmountElement) {
                    totalAmountElement.textContent = `¥${new Intl.NumberFormat('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(totalAmount)}`;
                }
            }
            
            if (totalTaxAmountId) {
                const totalTaxAmountElement = document.getElementById(totalTaxAmountId);
                if (totalTaxAmountElement) {
                    totalTaxAmountElement.textContent = `¥${new Intl.NumberFormat('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(totalTaxAmount)}`;
                }
            }
            
            // 获取预先定义的容器
            const mainContainer = document.getElementById(containerId);
            if (!mainContainer) return;
            
            // 清空容器内容
            mainContainer.innerHTML = '';
            
            // 生成分页按钮
            let paginationHTML = '';
            
            // 首页按钮
            paginationHTML += `<button class="${pageType}-first-page px-3 py-1 rounded-l-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 ${currentPage === 1 ? 'disabled:opacity-50' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                首页
            </button>`;
            
            // 上一页按钮
            paginationHTML += `<button class="${pageType}-prev-page px-3 py-1 border-t border-b border-gray-300 bg-white text-gray-700 hover:bg-gray-50 ${currentPage === 1 ? 'disabled:opacity-50' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                上一页
            </button>`;
            
            // 页码按钮
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="${pageType}-page-btn px-3 py-1 border-t border-b border-gray-300 bg-white text-gray-700 hover:bg-gray-50 ${i === currentPage ? 'bg-primary text-white' : ''}" data-page="${i}">
                    ${i}
                </button>`;
            }
            
            // 下一页按钮
            paginationHTML += `<button class="${pageType}-next-page px-3 py-1 border-t border-b border-gray-300 bg-white text-gray-700 hover:bg-gray-50 ${currentPage === totalPages ? 'disabled:opacity-50' : ''}" ${currentPage === totalPages ? 'disabled' : ''}>
                下一页
            </button>`;
            
            // 末页按钮
            paginationHTML += `<button class="${pageType}-last-page px-3 py-1 rounded-r-md border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 ${currentPage === totalPages ? 'disabled:opacity-50' : ''}" ${currentPage === totalPages ? 'disabled' : ''}>
                末页
            </button>`;
            
            // 更新主容器内容
            mainContainer.innerHTML = `
                <div class="flex flex-wrap justify-between items-center">
                    <div class="text-sm text-gray-500 mb-2 sm:mb-0">
                        显示 ${(currentPage - 1) * itemsPerPage + 1} 到 ${Math.min(currentPage * itemsPerPage, totalItems)} 条，共 ${totalItems} 条记录
                    </div>
                    <div class="flex items-center space-x-4 w-full sm:w-auto">
                        <div class="flex items-center mb-2 sm:mb-0">
                            <label for="${pageType}-items-per-page" class="mr-2 text-sm text-gray-600">每页显示：</label>
                            <select id="${pageType}-items-per-page" class="border border-gray-300 rounded-md px-2 py-1 text-sm">
                                <option value="5" ${itemsPerPage === 5 ? 'selected' : ''}>5条</option>
                                <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>10条</option>
                                <option value="20" ${itemsPerPage === 20 ? 'selected' : ''}>20条</option>
                                <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>50条</option>
                                <option value="100" ${itemsPerPage === 100 ? 'selected' : ''}>100条</option>
                                <option value="200" ${itemsPerPage === 200 ? 'selected' : ''}>200条</option>
                            </select>
                        </div>
                        <div class="flex justify-center">
                            ${paginationHTML}
                        </div>
                    </div>
                </div>
            `;
            
            // 添加每页显示条数变化事件
            const itemsPerPageSelect = document.getElementById(`${pageType}-items-per-page`);
            if (itemsPerPageSelect) {
                itemsPerPageSelect.addEventListener('change', function() {
                    itemsPerPage = parseInt(this.value);
                    currentPage = 1; // 重置为第一页
                    const searchInput = document.getElementById(searchInputId);
                    filterFunction(searchInput ? searchInput.value : '');
                });
            }
            
            // 添加分页按钮事件
            const firstPageBtn = document.querySelector(`.${pageType}-first-page`);
            if (firstPageBtn) {
                firstPageBtn.addEventListener('click', function() {
                    currentPage = 1;
                    const searchInput = document.getElementById(searchInputId);
                    filterFunction(searchInput ? searchInput.value : '');
                });
            }
            
            const prevPageBtn = document.querySelector(`.${pageType}-prev-page`);
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        const searchInput = document.getElementById(searchInputId);
                        filterFunction(searchInput ? searchInput.value : '');
                    }
                });
            }
            
            const pageBtns = document.querySelectorAll(`.${pageType}-page-btn`);
            pageBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    currentPage = parseInt(this.dataset.page);
                    const searchInput = document.getElementById(searchInputId);
                    filterFunction(searchInput ? searchInput.value : '');
                });
            });
            
            const nextPageBtn = document.querySelector(`.${pageType}-next-page`);
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', function() {
                    if (currentPage < totalPages) {
                        currentPage++;
                        const searchInput = document.getElementById(searchInputId);
                        filterFunction(searchInput ? searchInput.value : '');
                    }
                });
            }
            
            const lastPageBtn = document.querySelector(`.${pageType}-last-page`);
            if (lastPageBtn) {
                lastPageBtn.addEventListener('click', function() {
                    currentPage = totalPages;
                    const searchInput = document.getElementById(searchInputId);
                    filterFunction(searchInput ? searchInput.value : '');
                });
            }
        }

        // 导出库存统计到Excel
        function exportInventoryToExcel() {
            // 获取当前搜索条件
            const inventorySearchInput = document.getElementById('inventory-search');
            const searchTerm = inventorySearchInput ? inventorySearchInput.value.trim() : '';
            
            // 获取库存数据
            const contracts = getData('contracts');
            const receipts = getData('receipts');
            const returns = getData('returns');
            
            // 计算库存统计数据
            const inventoryData = [];
            
            contracts.forEach(contract => {
                // 处理包含products数组的合同
                if (Array.isArray(contract.products) && contract.products.length > 0) {
                    contract.products.forEach(product => {
                        // 计算该产品的已收数量
                        const receivedQuantity = receipts
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算该产品的已退数量
                        const returnedQuantity = returns
                            .filter(r => r.contractNumber === contract.contractNumber && r.product === product.productName)
                            .reduce((sum, r) => sum + r.quantity, 0);
                        
                        // 计算库存数量
                        const inventoryQuantity = parseFloat((receivedQuantity - returnedQuantity).toFixed(3));
                        
                        // 计算未收数量
                        const productQuantity = parseFloat(product.quantity) || 0;
                        const pendingQuantity = parseFloat((productQuantity - inventoryQuantity).toFixed(3));
                        
                        // 计算完成率
                        const completionRate = productQuantity > 0 ? (inventoryQuantity / productQuantity * 100).toFixed(3) : '0.00';
                        
                        inventoryData.push({
                            '合同号': contract.contractNumber,
                            '供应商': contract.supplier,
                            '产品名称': product.productName,
                            '规格型号': product.specification,
                            '单位': product.unit,
                            '合同数量': productQuantity,
                            '已收数量': receivedQuantity,
                            '已退数量': returnedQuantity,
                            '库存数量': inventoryQuantity,
                            '未收数量': pendingQuantity,
                            '完成率(%)': parseFloat(completionRate)
                        });
                    });
                } else {
                    // 兼容旧数据结构（单个产品）
                    // 计算已收数量
                    const receivedQuantity = receipts
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算已退数量
                    const returnedQuantity = returns
                        .filter(r => r.contractNumber === contract.contractNumber)
                        .reduce((sum, r) => sum + r.quantity, 0);
                    
                    // 计算库存数量
                    const inventoryQuantity = parseFloat((receivedQuantity - returnedQuantity).toFixed(3));
                    
                    // 计算未收数量
                    const pendingQuantity = parseFloat((contract.quantity - inventoryQuantity).toFixed(3));
                    
                    // 计算完成率
                    const completionRate = contract.quantity > 0 ? (inventoryQuantity / contract.quantity * 100).toFixed(3) : '0.00';
                    
                    inventoryData.push({
                        '合同号': contract.contractNumber,
                        '供应商': contract.supplier,
                        '产品名称': contract.product,
                        '规格型号': contract.spec,
                        '单位': contract.unit,
                        '合同数量': contract.quantity,
                        '已收数量': receivedQuantity,
                        '已退数量': returnedQuantity,
                        '库存数量': inventoryQuantity,
                        '未收数量': pendingQuantity,
                        '完成率(%)': parseFloat(completionRate)
                    });
                }
            });
            
            // 应用与页面相同的过滤条件
            const filteredInventoryData = inventoryData.filter(item => {
                // 将所有字段合并成一个字符串进行搜索
                const searchableText = [
                    item['合同号'],
                    item['供应商'],
                    item['产品名称'],
                    item['规格型号'],
                    item['单位'],
                    item['合同数量'].toString(),
                    item['已收数量'].toString(),
                    item['已退数量'].toString(),
                    item['库存数量'].toString(),
                    item['未收数量'].toString(),
                    item['完成率(%)'].toString()
                ].filter(Boolean).join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm.toLowerCase());
            });
            
            // 添加合计行
            const totalRow = {
                '合同号': '合计',
                '供应商': '',
                '产品名称': '',
                '规格型号': '',
                '单位': '',
                '合同数量': filteredInventoryData.reduce((sum, item) => sum + item['合同数量'], 0),
                '已收数量': filteredInventoryData.reduce((sum, item) => sum + item['已收数量'], 0),
                '已退数量': filteredInventoryData.reduce((sum, item) => sum + item['已退数量'], 0),
                '库存数量': filteredInventoryData.reduce((sum, item) => sum + item['库存数量'], 0),
                '未收数量': filteredInventoryData.reduce((sum, item) => sum + item['未收数量'], 0),
                '完成率(%)': ''
            };
            
            filteredInventoryData.push(totalRow);
            
            // 创建工作簿和工作表
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(filteredInventoryData, {
                header: ['合同号', '供应商', '产品名称', '规格型号', '单位', '合同数量', '已收数量', '已退数量', '库存数量', '未收数量', '完成率(%)']
            });
            
            // 设置列宽
            const colWidths = [
                { wch: 15 }, // 合同号
                { wch: 20 }, // 供应商
                { wch: 25 }, // 产品名称
                { wch: 20 }, // 规格型号
                { wch: 8 },  // 单位
                { wch: 12 }, // 合同数量
                { wch: 12 }, // 已收数量
                { wch: 12 }, // 已退数量
                { wch: 12 }, // 库存数量
                { wch: 12 }, // 未收数量
                { wch: 12 }  // 完成率(%)
            ];
            ws['!cols'] = colWidths;
            
            // 为所有数量列设置数值格式
            const numberFormat = '0.00';
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            for (let R = 1; R <= range.e.r; ++R) {
                // 合同数量 (列F)
                const cellF = XLSX.utils.encode_cell({ c: 5, r: R });
                if (ws[cellF]) {
                    ws[cellF].z = numberFormat;
                }
                // 已收数量 (列G)
                const cellG = XLSX.utils.encode_cell({ c: 6, r: R });
                if (ws[cellG]) {
                    ws[cellG].z = numberFormat;
                }
                // 已退数量 (列H)
                const cellH = XLSX.utils.encode_cell({ c: 7, r: R });
                if (ws[cellH]) {
                    ws[cellH].z = numberFormat;
                }
                // 库存数量 (列I)
                const cellI = XLSX.utils.encode_cell({ c: 8, r: R });
                if (ws[cellI]) {
                    ws[cellI].z = numberFormat;
                }
                // 未收数量 (列J)
                const cellJ = XLSX.utils.encode_cell({ c: 9, r: R });
                if (ws[cellJ]) {
                    ws[cellJ].z = numberFormat;
                }
                // 完成率 (列K)
                const cellK = XLSX.utils.encode_cell({ c: 10, r: R });
                if (ws[cellK]) {
                    ws[cellK].z = '0.00%';
                }
            }
            
            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, ws, '库存统计');
            
            // 生成文件名
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const fileName = `库存统计_${dateStr}.xlsx`;
            
            // 导出Excel文件
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>