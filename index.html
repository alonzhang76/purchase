<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcurePay - 采购付款发票管理系统</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- 统一的 Tailwind 配置 -->
    <!-- 通用的金额格式化函数 -->
    <script>
        // 通用的金额千分位格式化函数
        function formatCurrency(amount) {
            // 将输入转换为数字
            const num = parseFloat(amount);
            
            // 检查是否是有效数字
            if (isNaN(num)) {
                return '¥0.00';
            }
            
            // 保留两位小数并转换为字符串
            const numStr = num.toFixed(2);
            
            // 分离整数部分和小数部分
            const parts = numStr.split('.');
            
            // 对整数部分添加千分位分隔符
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            // 重新组合整数部分和小数部分
            return `¥${parts.join('.')}`;
        }
        
        // 将格式化后的金额字符串转回数字
        function parseCurrency(formattedAmount) {
            if (typeof formattedAmount !== 'string') {
                return parseFloat(formattedAmount) || 0;
            }
            // 移除货币符号和千分位分隔符，然后转换为数字
            return parseFloat(formattedAmount.replace(/[¥,]/g, '')) || 0;
        }
        
        // 数量千分位格式化函数
        function formatQuantity(quantity) {
            const num = parseFloat(quantity);
            if (isNaN(num)) return '0';
            // 检查是否为整数
            if (Number.isInteger(num)) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            } else {
                // 对于小数，只对整数部分进行千分位格式化
                const numStr = num.toString();
                const parts = numStr.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                return parts.join('.');
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            const textMap = {
                'pending': '未开始',
                'in-progress': '执行中',
                'completed': '执行完毕',
                'cancelled': '取消'
            };
            return textMap[status] || status;
        }
    </script>
    <script>
        // 供应商模糊搜索功能
        document.addEventListener('DOMContentLoaded', function() {
            // 设置日期输入框的默认值为当前日期
            const today = new Date().toISOString().split('T')[0];
            const paymentDateInput = document.getElementById('payment-date');
            const contractPaymentDateInput = document.getElementById('contract-payment-date');
            if (paymentDateInput) paymentDateInput.value = today;
            if (contractPaymentDateInput) contractPaymentDateInput.value = today;
            
            const supplierInput = document.getElementById('supplier');
            const supplierDropdown = document.getElementById('supplier-dropdown');
            
            // 为供应商输入框添加事件监听器
            supplierInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                
                // 清空下拉菜单
                supplierDropdown.innerHTML = '';
                supplierDropdown.classList.add('hidden');
                
                if (searchTerm === '') {
                    return;
                };

         // 切换发票列表页码
         function changeInvoicePage(page) {
             const storageKey = `${getCurrentCompany()}-invoices`;
             const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
             const totalPages = Math.ceil(invoices.length / invoicesPerPage);
             if (page > 0 && page <= totalPages) {
                 currentInvoicePage = page;
                 renderInvoiceList();
             }
         }
                
                // 从localStorage加载供应商数据，如果不存在则使用空数组
                let suppliers = localStorage.getItem('suppliers') ? JSON.parse(localStorage.getItem('suppliers')) : [];
                
                // 过滤供应商列表
                const filteredSuppliers = suppliers.filter(supplier => {
                    // 检查所有供应商属性是否包含搜索词
                    for (const key in supplier) {
                        if (supplier.hasOwnProperty(key) && typeof supplier[key] === 'string') {
                            if (supplier[key].toLowerCase().includes(searchTerm)) {
                                return true;
                            
                    }
                        }
                    }
                    return false;
                });
                
                if (filteredSuppliers.length > 0) {
                    // 显示下拉菜单
                    supplierDropdown.classList.remove('hidden');
                    
                    // 生成下拉菜单选项
                    filteredSuppliers.forEach(supplier => {
                        const option = document.createElement('div');
                        option.className = 'p-2 cursor-pointer hover:bg-gray-100 transition-colors';
                        option.innerHTML = `<div class="font-medium">${supplier.supplierName}</div><div class="text-sm text-gray-500">${supplier.phoneNumber || ''}</div>`;
                        
                        // 添加点击事件
                        option.addEventListener('click', function() {
                            // 使用事件委托确保在模态框中也能正常工作
                            supplierInput.value = supplier.supplierName;
                            supplierDropdown.classList.add('hidden');
                            // 触发输入事件以更新表单验证
                            supplierInput.dispatchEvent(new Event('input'));
                        });
                        
                        supplierDropdown.appendChild(option);
                    });
                }
            });
            
            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', function(e) {
                if (!supplierDropdown.contains(e.target) && e.target !== supplierInput) {
                    supplierDropdown.classList.add('hidden');
                }
            });
        });

        // 公司选择状态管理 - 从localStorage读取保存的公司，默认使用第一个公司
        let currentCompany = localStorage.getItem('currentCompany_index') || 'companyA';
        
        // 获取当前公司的函数
        function getCurrentCompany() {
            return currentCompany;
        }
        
        // 防抖函数 - 防止短时间内多次调用导致性能问题
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 保存公司名称到localStorage
        function saveCompanyNames() {
            const companyInputs = document.querySelectorAll('.company-item input');
            const companies = {};
            
            companyInputs.forEach(input => {
                const companyId = input.getAttribute('data-company-id');
                companies[companyId] = input.value;
            });
            
            localStorage.setItem('companyNames', JSON.stringify(companies));
            
            // 更新当前页面的公司选择器
            updateCompanySelectors();
            
            // 关闭模态框
            document.getElementById('manage-companies-modal').classList.add('hidden');
        }
        
        // 更新页面上的所有公司选择器
        function updateCompanySelectors() {
            const companySelectors = document.querySelectorAll('select[id="company-select"]');
            const companies = JSON.parse(localStorage.getItem('companyNames')) || {
                'companyA': '普利美（常州）环境工程科技有限公司',
                'companyB': '无锡龙力印铁设备制造有限公司'
            };
            
            companySelectors.forEach(selector => {
                // 保存当前选中的值
                const currentValue = selector.value;
                
                // 清空现有选项
                selector.innerHTML = '';
                
                // 添加新选项
                Object.entries(companies).forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    selector.appendChild(option);
                });
                
                // 恢复选中值
                selector.value = currentValue;
            });
            
            // 更新模态框中的公司选择器
            const modalSelectors = document.querySelectorAll('#contract-migration-modal select, #create-payment-modal select');
            modalSelectors.forEach(selector => {
                const currentValue = selector.value;
                selector.innerHTML = '';
                
                Object.entries(companies).forEach(([id, name]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = name;
                    selector.appendChild(option);
                });
                
                selector.value = currentValue;
            });
        }
        
        // 计算并更新发票状态（基于付款金额与发票金额的比较）- 优化版
        function updateInvoicePaymentStatus() {
            const invoiceStorageKey = `${getCurrentCompany()}-invoices`;
            const paymentStorageKey = `${getCurrentCompany()}-payments`;
            
            // 使用try-catch防止解析错误
            let invoices = [];
            let payments = [];
            try {
                invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
                payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
            } catch (error) {
                console.error('解析数据时出错:', error);
                return { updatedInvoices: invoices };
            }
            
            // 创建发票编号到付款金额的Map缓存，避免重复计算
            const invoicePaymentMap = new Map();
            
            // 预处理付款数据，建立发票编号和金额的映射关系
            payments.forEach(payment => {
                if (!payment.amount) return; // 跳过无效付款记录
                
                // 处理多个发票编号（逗号分隔）
                const paymentInvoiceNumbers = payment.invoiceNumbers
                    ? payment.invoiceNumbers.split(',').map(num => num.trim()).filter(num => num)
                    : [];
                
                // 对于每个关联的发票，累加付款金额
                const paymentAmount = parseFloat(payment.amount) || 0;
                paymentInvoiceNumbers.forEach(invoiceNumber => {
                    const currentAmount = invoicePaymentMap.get(invoiceNumber) || 0;
                    invoicePaymentMap.set(invoiceNumber, currentAmount + paymentAmount);
                });
            });
            
            // 优化更新逻辑，只在必要时更新发票
            let hasChanges = false;
            const updatedInvoices = invoices.map(invoice => {
                // 直接从Map中获取已付款总额，避免O(n²)复杂度
                const totalPaid = invoicePaymentMap.get(invoice.invoiceNumber) || 0;
                const difference = invoice.amount - totalPaid;
                
                // 确定新状态
                let newStatus = '未付款';
                if (difference <= 0) {
                    newStatus = '已付清';
                } else if (totalPaid > 0) {
                    newStatus = '部分付款';
                }
                
                // 检查是否需要更新（只有状态或金额发生变化时才更新）
                const needUpdate = 
                    newStatus !== invoice.status || 
                    totalPaid !== (invoice.totalPaid || 0) || 
                    difference !== (invoice.paymentDifference || 0);
                
                if (needUpdate) {
                    hasChanges = true;
                    return {
                        ...invoice,
                        status: newStatus,
                        totalPaid: totalPaid,
                        paymentDifference: difference,
                        updatedAt: new Date().toISOString() // 更新时间戳
                    };
                }
                
                // 如果没有变化，返回原始对象
                return invoice;
            });
            
            // 只在有变化时才写入localStorage，减少IO操作
            if (hasChanges) {
                localStorage.setItem(invoiceStorageKey, JSON.stringify(updatedInvoices));
                // 调用更新仪表盘统计数据函数
                updateDashboardStats();
            }
            
            return { updatedInvoices };
        }
        
        // 创建防抖版本的更新函数，用于频繁触发的场景
        const debouncedUpdateStatus = debounce(updateInvoicePaymentStatus, 300);
        
        // 初始化模拟数据函数 - 仅保留供应商数据，删除三个表格的示例数据生成
        function initMockData() {
            // 初始化供应商数据
            const supplierStorageKey = 'suppliers';
            if (!localStorage.getItem(supplierStorageKey)) {
                const mockSuppliers = [
                    { id: '1', supplierName: '上海科技有限公司', contactPerson: '张三', phoneNumber: '13800138001', email: 'zs@example.com', address: '上海市浦东新区科技大道1号' },
                    { id: '2', supplierName: '北京创新科技', contactPerson: '李四', phoneNumber: '13800138002', email: 'ls@example.com', address: '北京市海淀区中关村大街1号' },
                    { id: '3', supplierName: '广州电子有限公司', contactPerson: '王五', phoneNumber: '13800138003', email: 'ww@example.com', address: '广州市天河区天河路1号' },
                    { id: '4', supplierName: '深圳科技有限公司', contactPerson: '赵六', phoneNumber: '13800138004', email: 'zl@example.com', address: '深圳市南山区科技园1号' },
                    { id: '5', supplierName: '杭州网络科技', contactPerson: '钱七', phoneNumber: '13800138005', email: 'qq@example.com', address: '杭州市西湖区文三路1号' }
                ];
                localStorage.setItem(supplierStorageKey, JSON.stringify(mockSuppliers));
            }
            
            // 注意：已删除三个表格（采购订单列表、发票列表、付款列表）的示例数据生成代码
            // 但可以在这里初始化一些基础的公司关联数据结构，确保数据存储格式一致
        }

        // 管理抬头公司功能
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化模拟数据（如果不存在）
            initMockData();
            
            // 初始化详细采购报表
            if (typeof initDetailedPurchaseReport === 'function') {
                initDetailedPurchaseReport();
            }
            
            // 管理抬头公司按钮点击事件
            const manageCompaniesBtn = document.getElementById('manage-companies-btn');
            if (manageCompaniesBtn) {
                manageCompaniesBtn.addEventListener('click', function() {
                    document.getElementById('manage-companies-modal').classList.remove('hidden');
                });
            }
            
            const companySelect = document.getElementById('company-select');
            if (companySelect) {
                companySelect.value = currentCompany;
                
                // 监听公司选择变化
                companySelect.addEventListener('change', function() {
                    currentCompany = this.value;
                    localStorage.setItem('currentCompany_index', currentCompany);
                    // 保存当前激活的页面
                    const activeNavLink = document.querySelector('.nav-link.active');
                    if (activeNavLink) {
                        const activePage = activeNavLink.getAttribute('data-page');
                        localStorage.setItem('lastActivePage', activePage);
                    }
                    location.reload();
                });
            }
            // 页面加载时更新公司选择器
            updateCompanySelectors();
            
            // 页面加载完成后重新渲染所有列表 - 安全检查
            try {
                if (typeof renderPurchaseOrderList === 'function') {
                    renderPurchaseOrderList();
                }
                if (typeof renderInvoiceList === 'function') {
                    renderInvoiceList();
                }
                if (typeof renderPaymentList === 'function') {
                    renderPaymentList('');
                }
            } catch (e) {
                console.log('初始化渲染函数时出错:', e);
            }
            
            // 初始化备份数据下拉菜单
            const backupDropdownBtn = document.getElementById('backup-dropdown-btn');
            const backupDropdownMenu = document.getElementById('backup-dropdown-menu');
            
            if (backupDropdownBtn && backupDropdownMenu) {
                // 点击备份数据按钮时显示/隐藏下拉菜单
                backupDropdownBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    backupDropdownMenu.classList.toggle('hidden');
                });
                
                // 点击页面其他地方时关闭下拉菜单
                document.addEventListener('click', function(e) {
                    if (!backupDropdownBtn.contains(e.target) && !backupDropdownMenu.contains(e.target)) {
                        backupDropdownMenu.classList.add('hidden');
                    }
                });
                
                // 点击下拉菜单项时关闭下拉菜单
                const dropdownItems = backupDropdownMenu.querySelectorAll('button, label');
                dropdownItems.forEach(item => {
                    item.addEventListener('click', function() {
                        backupDropdownMenu.classList.add('hidden');
                    });
                });
            }
        });
     tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a56db',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .card {
                @apply bg-white rounded-lg shadow-card p-6 transition-all-300;
            }
            .card:hover {
                @apply shadow-card-hover;
            }
            .btn {
                @apply px-4 py-2 rounded-md font-medium transition-all-300 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-secondary text-white hover:bg-secondary/90 focus:ring-secondary/50;
            }
            .btn-success {
                @apply bg-success text-white hover:bg-success/90 focus:ring-success/50;
            }
            .btn-warning {
                @apply bg-warning text-white hover:bg-warning/90 focus:ring-warning/50;
            }
            .btn-danger {
                @apply bg-danger text-white hover:bg-danger/90 focus:ring-danger/50;
            }
            .nav-link {
                @apply flex items-center gap-3 px-4 py-3 rounded-md transition-all-300;
            }
            .nav-link.active {
                @apply bg-primary/10 text-primary font-medium;
            }
            .nav-link:not(.active) {
                @apply text-gray-600 hover:bg-gray-100;
            }
            .badge {
                @apply px-2 py-1 text-xs font-medium rounded-full;
            }
            .badge-primary {
                @apply bg-primary/20 text-primary;
            }
            .badge-success {
                @apply bg-success/20 text-success;
            }
            .badge-warning {
                @apply bg-warning/20 text-warning;
            }
            .badge-danger {
                @apply bg-danger/20 text-danger;
            }
            .badge-info {
                @apply bg-info/20 text-info;
            }
            .form-input, .form-textarea {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .form-group {
                @apply mb-4;
            }
            .table-container {
                @apply overflow-x-auto relative;
            }
            .table {
                @apply min-w-full divide-y divide-gray-200;
                table-layout: fixed;
            }
            .table th {
                @apply px-4 py-1 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider;
            }
            .table td {
                @apply px-4 py-1 whitespace-nowrap text-sm text-gray-500;
            }
            /* 设置表格行高 */
            .table tr {
                @apply h-8 hover:bg-gray-50;
            }
            /* 为供应商列设置固定宽度 */
            .purchase-order-table th:nth-child(4),
            .purchase-order-table td:nth-child(4) {
                @apply min-w-[300px] max-w-[400px] whitespace-nowrap;
            }
            /* 采购订单列表冻结列样式 */
            /* 设置每列的冻结位置和宽度 */
            .purchase-order-table th:nth-child(1),
            .purchase-order-table td:nth-child(1) {
                @apply sticky left-0 bg-white z-10 w-[40px];
            }
            .purchase-order-table th:nth-child(2),
            .purchase-order-table td:nth-child(2) {
                @apply sticky left-[40px] bg-white z-20 w-[120px];
            }
            .purchase-order-table th:nth-child(3),
            .purchase-order-table td:nth-child(3) {
                @apply sticky left-[160px] bg-white z-30 w-[100px];
            }
            .purchase-order-table th:nth-child(4),
            .purchase-order-table td:nth-child(4) {
                @apply sticky left-[260px] bg-white z-40 min-w-[300px] max-w-[400px] whitespace-nowrap;
            }
            /* 设置总金额（含税）列宽度 */
            .table.purchase-order-table th:nth-child(13),
            .table.purchase-order-table td:nth-child(13) {
                width: 60px !important;
                min-width: 60px !important;
                max-width: 120px !important;
                @apply whitespace-nowrap text-ellipsis overflow-hidden;
            }
            .tab {
                @apply px-4 py-2 text-sm font-medium rounded-t-lg;
            }
            .tab.active {
                @apply bg-white text-primary border-b-2 border-primary;
            }
            .tab:not(.active) {
                @apply text-gray-500 hover:bg-gray-100;
            }
            .stat-card {
                @apply flex items-center justify-between p-4 bg-white rounded-lg shadow-card;
            }
            .stat-value {
                @apply text-2xl font-bold;
            }
            .stat-label {
                @apply text-sm text-gray-500;
            }
            .stat-icon {
                @apply p-3 rounded-full text-white;
            }

        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- 管理抬头公司模态框 -->
    <div id="manage-companies-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0 sm:items-end sm:justify-center">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity z-45" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6 sm:align-bottom">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            管理抬头公司
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                管理系统中使用的公司抬头信息，修改后将同步更新所有相关文件。
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-5">
                    <div class="space-y-4">
                        <!-- 公司列表 -->
                        <div id="companies-list" class="space-y-3">
                            <!-- 公司项将通过JavaScript动态生成 -->
                            <div class="company-item flex items-center gap-3">
                                <div class="w-16 text-sm text-gray-500">companyA:</div>
                                <input type="text" class="form-input flex-1" value="普利美（常州）环境工程科技有限公司" data-company-id="companyA">
                            </div>
                            <div class="company-item flex items-center gap-3">
                                <div class="w-16 text-sm text-gray-500">companyB:</div>
                                <input type="text" class="form-input flex-1" value="无锡龙力印铁设备制造有限公司" data-company-id="companyB">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm" onclick="saveCompanyNames()">
                        保存修改
                    </button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="document.getElementById('manage-companies-modal').classList.add('hidden')">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 合同迁移模态框 -->
    <div id="contract-migration-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0 sm:items-end sm:justify-center">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity z-45" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6 sm:align-bottom">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            合同迁移
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                将A公司的采购合同迁移到B公司。
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-5">
                    <div class="space-y-4">
                        <!-- 源公司选择 -->
                        <div>
                            <label for="source-company" class="block text-sm font-medium text-gray-700">
                                源公司
                            </label>
                            <select id="source-company" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                                <option value="companyA">普利美（常州）环境工程科技有限公司</option>
                                <option value="companyB">无锡龙力印铁设备制造有限公司</option>
                            </select>
                        </div>
                        
                        <!-- 目标公司选择 -->
                        <div>
                            <label for="target-company" class="block text-sm font-medium text-gray-700">
                                目标公司
                            </label>
                            <select id="target-company" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                                <option value="companyA">普利美（常州）环境工程科技有限公司</option>
                                <option value="companyB">无锡龙力印铁设备制造有限公司</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm" onclick="migrateContracts()">
                        迁移
                    </button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="document.getElementById('contract-migration-modal').classList.add('hidden')">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建付款模态框 -->
    <div id="create-payment-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity z-45" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fa fa-credit-card text-primary-600 text-lg"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            新建付款
                        </h3>
                        <div class="mt-4">
                            <form id="create-payment-form" class="space-y-4">
                                <!-- 付款方式选择 -->
                                <div class="form-group">
                                    <label>付款方式</label>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="payment-method-option" value="invoice" checked>
                                            凭发票付款
                                        </label>
                                        <label>
                                            <input type="radio" name="payment-method-option" value="contract">
                                            凭合同付款
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- 凭发票付款部分 -->
                                <div id="invoice-payment-section">
                                    <!-- 新发票信息（先付款再开票时显示） -->
                                    <div id="new-invoice-section" class="space-y-4 hidden">
                                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                            <div class="form-group">
                                                <label for="new-invoice-date" class="form-label">新发票日期</label>
                                                <input type="date" id="new-invoice-date" class="form-input">
                                            </div>
                                        </div>
                                           
                                        <!-- 新发票金额输入框已移除，系统将使用付款金额作为发票金额 -->
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建发票模态框 -->
    <div id="create-invoice-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 transition-opacity z-45" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            
            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fa fa-file-text-o text-primary-600 text-lg"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            新建发票
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                请填写发票相关信息。
                            </p>
                        </div>
                    </div>
                </div>
                <div class="mt-5">
                    <form id="create-invoice-form" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label for="invoice-date" class="form-label">发票日期</label>
                                <input type="date" id="invoice-date" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="invoice-number" class="form-label">发票编号</label>
                                <input type="text" id="invoice-number" class="form-input">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- 侧边导航栏 -->
        <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 ease-in-out flex-shrink-0 overflow-hidden">
            <!-- 系统 Logo -->
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-bold text-primary flex items-center gap-2">
                    <i class="fa fa-line-chart"></i>
                    <span>ProcurePay</span>
                </h1>
                <p class="text-xs text-gray-500 mt-1">采购付款发票管理系统</p>
            </div>
            
            <!-- 导航菜单 -->
            <nav class="flex-1 overflow-y-auto p-4 space-y-1">
                <a href="#procurement" class="nav-link" data-page="procurement">
                    <i class="fa fa-shopping-cart w-5 text-center"></i>
                    <span>采购管理</span>
                </a>
                <a href="#invoices" class="nav-link" data-page="invoices">
                    <i class="fa fa-file-text w-5 text-center"></i>
                    <span>发票管理</span>
                </a>
                <a href="#payments" class="nav-link" data-page="payments">
                    <i class="fa fa-credit-card w-5 text-center"></i>
                    <span>付款管理</span>
                </a>
                <a href="#suppliers" class="nav-link" data-page="suppliers">
                    <i class="fa fa-users w-5 text-center"></i>
                    <span>供应商管理</span>
                </a>
                <a href="#reports" class="nav-link" data-page="reports">
                    <i class="fa fa-bar-chart w-5 text-center"></i>
                    <span>数据统计</span>
                </a>
                <a href="#dashboard" class="nav-link active" data-page="dashboard">
                    <i class="fa fa-dashboard w-5 text-center"></i>
                    <span>备忘录</span>
                </a>
                <!-- 添加线条和快速链接文本 -->
                <div class="border-t-2 border-gray-400 my-2 rounded-t shadow-inner"></div>
                <div class="text-gray-500 text-sm font-medium px-4 py-1">快速链接</div>
                <a href="#" class="nav-link" style="background-color: #1a56db; color: white;" onclick="openBalanceSheetWindow(); return false;">
                    <i class="fa fa-file-alt w-5 text-center"></i>
                    <span>收支表</span>
                </a>
                <a href="#" class="nav-link" style="background-color: #1a56db; color: white;" onclick="openNormalInvoiceWindow(); return false;">
                    <i class="fa fa-file-invoice w-5 text-center"></i>
                    <span>普票管理项</span>
                </a>
                <a href="#" class="nav-link" style="background-color: #1a56db; color: white;" onclick="openInvoiceWindow(); return false;">
                    <i class="fa fa-file-invoice w-5 text-center"></i>
                    <span>专票管理项</span>
                </a>
                
                <script>
                function openInvoiceWindow() {
                    // 尝试直接打开窗口，如果窗口已存在则会聚焦到该窗口
                    window.open('invoice.html', 'invoice_window', 'noopener,noreferrer');
                }
                
                function openBalanceSheetWindow() {
                    // 尝试直接打开窗口，如果窗口已存在则会聚焦到该窗口
                    const balanceSheetWindow = window.open('收支表.html?selectFirstCompany=true', 'balance_sheet_window', 'noopener,noreferrer');
                    
                    // 如果窗口已存在，刷新页面
                    if (balanceSheetWindow && balanceSheetWindow.location) {
                        balanceSheetWindow.location.href = '收支表.html?selectFirstCompany=true';
                    }
                }
                
                function openNormalInvoiceWindow() {
                    // 尝试直接打开窗口，如果窗口已存在则会聚焦到该窗口
                    window.open('普票登记系统.html', 'normal_invoice_window', 'noopener,noreferrer');
                }
                </script>
            </nav>
            
            <!-- 用户信息 -->
            <div class="p-4 border-t border-gray-200">
                <p class="text-sm font-medium text-gray-500">AlonZhang Designed</p>
            </div>
        </aside>
        
        <!-- 可折叠分隔线 -->
        <div id="sidebar-toggle" class="w-4 bg-gray-100 hover:bg-gray-200 cursor-pointer flex items-center justify-center relative z-10 border-l border-r border-gray-300 transition-all duration-300">
            <div class="toggle-arrow w-3 h-3 border-l-2 border-t-2 border-gray-500 transform rotate-45 transition-transform duration-300"></div>
        </div>
        
        <!-- 主内容区 -->
        <main class="flex-1 overflow-y-auto bg-gray-50">
            <!-- 顶部状态栏 -->
            <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center gap-4">
                        <button id="mobile-menu-button" class="lg:hidden text-gray-500 hover:text-gray-700">
                            <i class="fa fa-bars"></i>
                        </button>
                        <h2 id="page-title" class="text-lg font-medium">备忘录</h2>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="manage-companies-btn" class="btn btn-primary">
                            <i class="fa fa-cog mr-2"></i>管理抬头公司
                        </button>
                        <div class="relative">
                            <select id="company-select" class="form-input h-10">
                                <option value="companyA">普利美（常州）环境工程科技有限公司</option>
                                <option value="companyB">无锡龙力印铁设备制造有限公司</option>
                            </select>
                        </div>
                        
                        <!-- 数据备份与恢复下拉菜单 -->
                        <div class="relative">
                            <button id="backup-dropdown-btn" class="flex items-center gap-1 px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                <i class="fa fa-database"></i>
                                备份数据
                                <i class="fa fa-chevron-down text-xs"></i>
                            </button>
                            <div id="backup-dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                                <button id="export-data-btn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <i class="fa fa-download mr-2"></i>导出数据
                                </button>
                                <label for="import-data-input" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                    <i class="fa fa-upload mr-2"></i>恢复数据
                                </label>
                                <input type="file" id="import-data-input" accept=".json" class="hidden" />
                            </div>
                        </div>
                    </div>
                




                <!-- 新建付款模态框 -->
                <div id="create-payment-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
                    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <!-- 背景遮罩 -->
                        <div class="fixed inset-0 transition-opacity z-45" aria-hidden="true">
                            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                        </div>
                        
                        <!-- 模态框内容 -->
                        <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <i class="fa fa-credit-card text-primary-600 text-lg"></i>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        新建付款
                                    </h3>
                                    <div class="mt-4">
                                        <form id="create-payment-form" class="space-y-4">
                                            <!-- 付款方式选择 -->
                                            <div class="form-group">
                                                <label>付款方式</label>
                                                <div class="radio-group">
                                                    <label>
                                                        <input type="radio" name="payment-method-option" value="invoice" checked>
                                                        凭发票付款
                                                    </label>
                                                    <label>
                                                        <input type="radio" name="payment-method-option" value="contract">
                                                        凭合同付款
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- 凭发票付款部分 -->
                                            <div id="invoice-payment-section">
                                                <!-- 新发票信息（先付款再开票时显示） -->
                                                <div id="new-invoice-section" class="space-y-4 hidden">
                                                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                        <div class="form-group">
                                                            <label for="new-invoice-date" class="form-label">新发票日期</label>
                                                            <input type="date" id="new-invoice-date" class="form-input">
                                                        </div>
                                                    </div>
                                                      
                                                    <!-- 新发票金额输入框已移除，系统将使用付款金额作为发票金额 -->
                                                </div>
                                            
                                            <!-- 付款详情 -->
                                            <div class="grid grid-cols-1 gap-4">
                                                <div class="form-group">
                                                    <label for="payment-number" class="form-label">合同号</label>
                                                    <input type="text" id="payment-number" class="form-input" style="width: 100%;" required>
                                                </div>
                                            </div>
                                            
                                            <!-- 关联发票区域 -->
                                            <div class="form-group">
                                                <label class="form-label mb-2">关联发票</label>
                                                <div class="mb-2">
                                                    <input type="text" id="payment-invoice-id" class="form-input" placeholder="关联发票编号（多个发票用逗号分隔）" style="width: 100%;">
                                                </div>
                                                <div class="bg-gray-50 p-3 rounded-md max-h-60 overflow-y-auto" id="invoice-checkboxes-container">
                                                    <p class="text-gray-500 text-sm">加载中...</p>
                                                </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                <div class="form-group">
                                                    <label for="payment-date" class="form-label">付款日期</label>
                                                    <input type="date" id="payment-date" class="form-input" required>
                                                </div>
                                                
                                                <div class="form-group">
                                                    <label for="payment-amount" class="form-label">付款金额</label>
                                                    <div class="relative">
                                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                                                        <input type="number" id="payment-amount" class="form-input pl-8 text-center" step="0.01" required>
                                                    </div>
                                            </div>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                <div class="form-group">
                                                    <label for="payment-method" class="form-label">付款方式</label>
                                                    <select id="payment-method" class="form-select" required>
                                                        <option value="银行转账">银行转账</option>
                                                        <option value="支付宝">支付宝</option>
                                                        <option value="微信支付">微信支付</option>
                                                        <option value="现金">现金</option>
                                                    </select>
                                                </div>
                                                

                                            </div>
                                            
                                            <div class="form-group">
                                                <label for="payment-supplier" class="form-label">供应商</label>
                                                <input type="text" id="payment-supplier" class="form-input" required>
                                                <div id="payment-supplier-search-results" class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md border border-gray-200 max-h-60 overflow-y-auto"></div>
                                            </div>
                                            
                                            <!-- 备注 -->
                                            <div class="form-group">
                                                <label for="payment-remark" class="form-label">备注</label>
                                                <textarea id="payment-remark" class="form-textarea" rows="3" placeholder="请输入备注信息"></textarea>
                                            </div>
                                            
                                            <!-- 按钮容器 -->
                                            <div class="flex justify-end items-center mt-6 px-4 py-3 bg-gray-50 rounded-b-lg w-full">
                                                <button type="button" class="btn btn-secondary mr-3" id="cancel-payment-btn" style="writing-mode: horizontal-tb;">
                                                    取消
                                                </button>
                                                <button type="button" class="btn btn-primary" id="save-payment-btn" style="writing-mode: horizontal-tb;">
                                                    <i class="fa fa-save mr-1"></i>保存
                                                </button>
                                            </div>
                                            </div>
                                            
                                            <!-- 凭合同付款部分（暂隐藏） -->
                                            <div id="contract-payment-section" class="hidden">
                                                <!-- 合同付款详情 -->
                                                <div class="grid grid-cols-1 gap-4">
                                                    <div class="form-group">
                                                        <label for="contract-payment-number" class="form-label">合同号</label>
                                                        <input type="text" id="contract-payment-number" class="form-input" style="width: 100%;" required>
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                    <div class="form-group">
                                                        <label for="payment-stage" class="form-label">付款阶段</label>
                                                        <select id="payment-stage" class="form-select" required>
                                                            <option value="预付款">预付款</option>
                                                            <option value="进度款">进度款</option>
                                                            <option value="验收款">验收款</option>
                                                            <option value="尾款">尾款</option>
                                                            <option value="质保金">质保金</option>
                                                        </select>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                        <label for="payment-condition" class="form-label">付款条件</label>
                                                        <select id="payment-condition" class="form-select" required>
                                                            <option value="合同签订后">合同签订后</option>
                                                            <option value="到货后">到货后</option>
                                                            <option value="验收合格后">验收合格后</option>
                                                            <option value="项目完成后">项目完成后</option>
                                                            <option value="其他">其他</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                    <div class="form-group">
                                                        <label for="payment-percentage" class="form-label">付款比例</label>
                                                        <div class="relative">
                                                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">%</span>
                                                            <input type="number" id="payment-percentage" class="form-input pl-8 text-center" step="0.01" min="0" max="100">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                    <div class="form-group">
                                                        <label for="contract-payment-date" class="form-label">付款日期</label>
                                                        <input type="date" id="contract-payment-date" class="form-input" required>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                        <label for="contract-payment-amount" class="form-label">付款金额</label>
                                                        <div class="relative">
                                                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                                                            <input type="number" id="contract-payment-amount" class="form-input pl-8 text-center" step="0.01" required>
                                                        </div>
                                                </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                    <div class="form-group">
                                                        <label for="contract-payment-method" class="form-label">付款方式</label>
                                                        <select id="contract-payment-method" class="form-select" required>
                                                            <option value="银行转账">银行转账</option>
                                                            <option value="支付宝">支付宝</option>
                                                            <option value="微信支付">微信支付</option>
                                                            <option value="现金">现金</option>
                                                        </select>
                                                    </div>
                                                    

                                                </div>
                                                
                                                <div class="form-group relative">
                                                    <label for="contract-payment-supplier" class="form-label">供应商</label>
                                                    <input type="text" id="contract-payment-supplier" class="form-input" required>
                                                    <div id="contract-payment-supplier-search-results" class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg rounded-md border border-gray-200 max-h-60 overflow-y-auto"></div>
                                                </div>
                                                <div id="contract-selection-container" class="hidden mt-3 p-4 border border-gray-200 rounded-md bg-gray-50">
                                                    <h4 class="text-sm font-medium text-gray-700 mb-2">请选择要付款的合同：</h4>
                                                    <div id="contract-selection-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                                                </div>
                                                
                                                <!-- 备注 -->
                                                <div class="form-group">
                                                    <label for="contract-payment-remark" class="form-label">备注</label>
                                                    <textarea id="contract-payment-remark" class="form-textarea" rows="3" placeholder="请输入备注信息"></textarea>
                                                </div>
                                                
                                                <!-- 按钮容器 -->
                                                <div class="flex justify-end items-center mt-6 px-4 py-3 bg-gray-50 rounded-b-lg w-full">
                                                    <button type="button" class="btn btn-secondary mr-3" id="cancel-contract-payment-btn" style="writing-mode: horizontal-tb;">
                                                        取消
                                                    </button>
                                                    <button type="button" class="btn btn-primary" id="save-contract-payment-btn" style="writing-mode: horizontal-tb;">
                                                        <i class="fa fa-save mr-1"></i>保存
                                                    </button>
                                                </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </header>
            
            <!-- 页面内容 -->
            <div class="p-6">
                <!-- 备忘录页面 -->
                <div id="dashboard-page" class="page active">
                    <!-- 统计卡片已移除 -->
                    
                    <!-- 图表区域已移除 -->

                    <!-- 待办事项 -->
                    <div class="card mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">待办事项</h3>
                            <button id="add-todo-btn" class="btn btn-primary btn-sm">
                                <i class="fa fa-plus mr-1"></i>添加事项
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <div class="min-w-[600px]">
                                <ul id="todo-list" class="space-y-2">
                                    <!-- 待办事项将通过JavaScript动态生成 -->
                                </ul>
                                <div id="empty-todo" class="text-center py-8 text-gray-500">
                                    暂无待办事项，点击上方按钮添加
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 待办事项模态框 -->
                    <div id="todo-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
                            <h4 class="text-lg font-medium mb-4">添加待办事项</h4>
                            <div class="mb-4">
                                <label for="todo-content" class="block text-sm font-medium text-gray-700 mb-1">待办内容</label>
                                <textarea id="todo-content" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入待办事项内容"></textarea>
                            </div>
                            <div class="flex justify-end gap-3">
                                <button id="cancel-todo-btn" class="btn btn-secondary">取消</button>
                                <button id="save-todo-btn" class="btn btn-primary">保存</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 记事本 -->
                    <div class="card mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">记事本</h3>
                            <div class="flex gap-2">
                                <button id="save-note-btn" class="btn btn-primary btn-sm">
                                    <i class="fa fa-save mr-1"></i>保存
                                </button>
                                <button id="clear-note-btn" class="btn btn-danger btn-sm">
                                    <i class="fa fa-trash mr-1"></i>清空
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <div class="min-w-[600px]">
                                <textarea id="note-content" rows="8" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary" placeholder="在这里记录您的想法和笔记..."></textarea>
                                <div class="text-right text-sm text-gray-500 mt-2">
                                    <span id="note-stats">0 个字符</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    


                    <!-- 内容已移动到数据统计页面 -->
                </div>
                
                <!-- 采购管理页面 -->
                <div id="procurement-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <div class="flex items-center gap-3 mb-4 md:mb-0">
                            <h2 class="text-xl font-bold">采购管理</h2>
                            <button class="btn btn-primary" onclick="window.open('contract-inventory.html', '_blank', 'noopener,noreferrer')">
                                <i class="fa fa-file-text mr-2"></i>合同货物记录
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">

                            <div class="w-full sm:w-auto max-w-sm">
                                <input type="text" id="purchaseOrderSearch" class="form-input w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary" placeholder="请输入合同号、供应商等关键词进行搜索">
                            </div>
                            <button class="btn btn-primary" data-action="new-purchase-order">
                                <i class="fa fa-plus mr-2"></i>新建采购订单
                            </button>
                        </div>
                    </div>
                    

                    
                    <!-- 查询订单模态框 -->
                    <div id="queryModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                            <div class="modal-header p-4 border-b">
                                <h3 class="text-lg font-medium">查询采购订单</h3>
                                <button id="closeQueryModal" class="text-gray-500 hover:text-gray-700">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body p-6">
                                <form id="queryForm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">供应商</label>
                                            <input type="text" id="querySupplier" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">产品名称</label>
                                            <input type="text" id="queryProductName" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">成本类型</label>
                                            <input type="text" id="queryCostType" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                                            <input type="text" id="queryCategory" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
                                            <input type="date" id="queryStartDate" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                        <div class="form-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">结束日期</label>
                                            <input type="date" id="queryEndDate" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-3">
                                        <button type="button" id="resetQueryBtn" class="btn btn-secondary px-4 py-2 rounded-md">重置</button>
                                        <button type="submit" id="executeQueryBtn" class="btn btn-primary px-4 py-2 rounded-md">查询</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- 采购订单列表 -->
                    <div class="card">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <h3 class="text-lg font-medium mb-2 sm:mb-0">采购订单列表</h3>
                                <button id="query-orders-btn" class="btn btn-primary btn-sm text-sm">
                                    <i class="fa fa-search mr-1"></i>查询订单
                                </button>
                                <button id="clear-all-orders-btn" class="btn btn-danger btn-sm text-sm">
                                    <i class="fa fa-trash-o mr-1"></i>清空所有记录
                                </button>
                                <button id="migrate-selected-btn" class="btn btn-warning btn-sm text-sm" title="迁移选中的合同">
                                    <i class="fa fa-exchange mr-1"></i>迁移
                                </button>
                            </div>
                        </div>
                        
                        <!-- 合同日期筛选 -->
                        <div class="flex flex-wrap items-center gap-3 mb-4">
                            <div class="flex items-center gap-2">
                                <label for="purchase-start-date" class="text-sm font-medium text-gray-700 whitespace-nowrap">合同日期：</label>
                                <input type="date" id="purchase-start-date" class="form-input px-3 py-2 border border-gray-300 rounded-md">
                                <span class="text-gray-500 whitespace-nowrap">至</span>
                                <input type="date" id="purchase-end-date" class="form-input px-3 py-2 border border-gray-300 rounded-md">
                                <button id="purchase-date-filter-btn" class="btn btn-primary btn-sm text-sm whitespace-nowrap">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                                <button id="purchase-date-reset-btn" class="btn btn-secondary btn-sm text-sm whitespace-nowrap">
                                    <i class="fa fa-refresh mr-1"></i>重置
                                </button>
                            </div>
                        </div>
                        

                        
                        <!-- 查询状态显示 -->
                        <div id="queryStatus" class="hidden mb-4 p-3 bg-blue-50 text-blue-700 rounded-md">
                            <div class="flex items-center justify-between">
                                <span><i class="fa fa-filter mr-2"></i>正在显示查询结果</span>
                                <button id="cancelQueryBtn" class="btn btn-sm btn-blue">
                                    <i class="fa fa-times mr-1"></i>取消查询
                                </button>
                            </div>
                        </div>
                        
                        <!-- 记录条数统计 -->
                        <div class="flex items-center justify-between mb-4 text-sm text-gray-600">
                            <span>共 <strong id="totalRecords">0</strong> 条记录</span>
                            <div class="flex items-center gap-2">
                                <label class="whitespace-nowrap">每页显示:</label>
                                <select id="pageSize" class="form-input py-1 px-2 text-sm border border-gray-300 rounded-md">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span>条</span>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table purchase-order-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="rounded text-primary focus:ring-primary">
                                        </th>

                                        <th>合同号</th>
                                        <th>状态</th>
                                        <th>供应商</th>
                                        <th>合同日期</th>
                                        <th>交货期</th>
                                        <th>实际到货期</th>
                                        <th>产品名称</th>
                                        <th>规格型号</th>
                                        <th>单价</th>
                                        <th>数量</th>
                                        <th>单位</th>
                                        <th style="width: 140px !important; min-width: 140px !important; max-width: 140px !important;">总金额（含税）</th>
                                        <th>成本类别</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="purchaseOrderTableBody">
                                    <!-- 暂无采购订单数据 -->
                                </tbody>
                                <tfoot class="font-bold">
                                    <tr>
                                        <td colspan="10" class="text-right">合计：</td>
                                        <td id="totalQuantitySum" class="text-center">0</td>
                                        <td></td> <!-- 单位列 -->
                                        <td id="totalAmountSum" class="text-left" style="width: 140px !important; min-width: 140px !important; max-width: 140px !important;">¥0.00</td>
                                        <td colspan="3"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- 分页控件 -->
                        <div class="flex flex-col sm:flex-row items-center justify-between mt-4" id="paginationControls">
                            <div class="text-sm text-gray-600 mb-2 sm:mb-0">
                                第 <span id="currentPage">1</span> / <span id="totalPages">1</span> 页
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="firstPage" class="btn btn-secondary btn-small" disabled>
                                    <i class="fa fa-angle-double-left"></i>
                                </button>
                                <button id="prevPage" class="btn btn-secondary btn-small" disabled>
                                    <i class="fa fa-angle-left"></i>
                                </button>
                                <div class="flex items-center gap-1">
                                    <!-- 页码按钮将动态生成 -->
                                </div>
                                <button id="nextPage" class="btn btn-secondary btn-small" disabled>
                                    <i class="fa fa-angle-right"></i>
                                </button>
                                <button id="lastPage" class="btn btn-secondary btn-small" disabled>
                                    <i class="fa fa-angle-double-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 发票管理页面 -->
                <div id="invoices-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-xl font-bold mb-4 md:mb-0">发票管理</h2>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative">
                                <input type="text" id="invoice-search-input" placeholder="搜索发票..." class="form-input pl-10 pr-4 py-2 text-center">
                                <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="create-invoice-btn" class="btn btn-primary flex items-center">
                                <i class="fa fa-plus mr-1"></i>新建发票
                            </button>
                        </div>
                    </div>
                    

                    

                    

                    
                    <!-- 发票列表 -->
                    <div class="card">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <h3 class="text-lg font-medium mb-2 sm:mb-0">发票列表</h3>
                        </div>
                        
                        <!-- 发票日期筛选 -->
                        <div class="flex flex-wrap items-center gap-3 mb-2">
                            <div class="flex items-center gap-2">
                                <label for="invoice-start-date" class="text-sm font-medium text-gray-700 whitespace-nowrap">发票日期：</label>
                                <input type="date" id="invoice-start-date" class="form-input px-3 py-2 border border-gray-300 rounded-md">
                                <span class="text-gray-500 whitespace-nowrap">至</span>
                                <input type="date" id="invoice-end-date" class="form-input px-3 py-2 border border-gray-300 rounded-md">
                                <button id="invoice-date-filter-btn" class="btn btn-primary btn-sm text-sm whitespace-nowrap">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                                <button id="invoice-date-reset-btn" class="btn btn-secondary btn-sm text-sm whitespace-nowrap">
                                    <i class="fa fa-refresh mr-1"></i>重置
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-2">
                            <div class="text-sm text-gray-600">
                                共 <span id="invoice-record-count">0</span> 条记录
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="rounded text-primary focus:ring-primary">
                                        </th>
                                        <th>发票编号</th>
                                        <th>合同号</th>
                                        <th>供应商</th>
                                        <th>发票日期</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-list-body">
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="5" class="text-right font-medium">合计:</td>
                                        <td id="invoice-total-amount" class="font-bold text-primary">¥0.00</td>
                                        <td colspan="2"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <button id="invoice-prev-page" class="btn btn-secondary" disabled>
                                上一页
                            </button>
                            <div class="text-sm text-gray-600">
                                第 <span id="invoice-current-page">1</span> / <span id="invoice-total-pages">0</span> 页
                            </div>
                            <button id="invoice-next-page" class="btn btn-secondary" disabled>
                                下一页
                            </button>
                        </div>

                    </div>
                </div>
                
                <!-- 新建发票模态框 -->
                <div id="create-invoice-modal" class="fixed z-50 inset-0 overflow-y-auto hidden">
                    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <!-- 背景遮罩 -->
                        <div class="fixed inset-0 transition-opacity z-45" aria-hidden="true">
                            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
                        </div>
                        
                        <!-- 模态框内容 -->
                        <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <i class="fa fa-file-text-o text-primary-600 text-lg"></i>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                        新建发票
                                    </h3>
                                    <div class="mt-4">
                                        <form class="space-y-4">
                                            <!-- 发票编号 -->
                                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                <div class="form-group">
                                                    <label for="invoice-number" class="form-label">发票编号</label>
                                                    <input type="text" id="invoice-number" class="form-input" placeholder="" required>
                                                </div>
                                                
                                                <!-- 发票日期 -->
                                                <div class="form-group">
                                                    <label for="invoice-date" class="form-label">发票日期</label>
                                                    <input type="date" id="invoice-date" class="form-input" required>
                                                </div>
                                            </div>
                                            
                                            <!-- 发票金额 -->
                                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                <div class="form-group">
                                                    <label for="invoice-amount" class="form-label">发票金额</label>
                                                    <div class="relative">
                                                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                                                        <input type="number" id="invoice-amount" class="form-input pl-8 text-center" placeholder="0.00" step="0.01" required>
                                                    </div>
                                                </div>
                                                
                                                <!-- 发票状态被移除 -->
                                            </div>
                                            
                                            <!-- 合同号 -->
                                            <div class="form-group">
                                                <label for="purchase-order" class="form-label">合同号</label>
                                                <input type="text" id="purchase-order" class="form-input" placeholder="请输入合同号" required>
                                            </div>
                                            
                                            <!-- 供应商信息 -->
                                            <div class="form-group">
                                                <label class="form-label">供应商信息</label>
                                                <div class="relative">
                                                    <input type="text" id="supplier-name" class="form-input" placeholder="供应商名称">
                                                    <div id="supplier-search-results" class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg overflow-y-auto max-h-48 hidden"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- 备注 -->
                                            <div class="form-group">
                                                <label for="invoice-remark" class="form-label">备注</label>
                                                <textarea id="invoice-remark" class="form-textarea" rows="3" placeholder="请输入备注信息"></textarea>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                <button type="button" class="btn btn-primary sm:w-auto w-full" id="save-invoice-btn">
                                    <i class="fa fa-save mr-1"></i>保存
                                </button>
                                <button type="button" class="btn btn-secondary sm:mr-3 mr-0 sm:w-auto w-full mb-3 sm:mb-0" id="sync-invoice-btn">
                                    同步至进销发票
                                </button>
                                <button type="button" class="btn btn-secondary sm:mr-3 mr-0 sm:w-auto w-full mb-3 sm:mb-0" id="cancel-invoice-btn">
                                    取消
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 付款管理页面 -->
                <div id="payments-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-xl font-bold mb-4 md:mb-0">付款管理</h2>
                        
                        <!-- 搜索框和新建付款按钮 -->
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                        <!-- 搜索框 -->
                        <div class="relative">
                            <input type="text" id="payment-search-input" placeholder="搜索付款..." class="form-input pl-10 pr-4 py-2 text-center">
                            <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <!-- 新建付款按钮 -->
                        <button id="create-payment-btn" class="btn btn-primary">
                            <i class="fa fa-plus mr-2"></i>新建付款
                        </button>
                    </div>
                </div>
                
                <!-- 付款列表 -->
                    <div class="card">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <h3 class="text-lg font-medium mb-2 sm:mb-0">付款列表</h3>
                        </div>
                        
                        <!-- 付款日期筛选 -->
                        <div class="flex flex-wrap items-center gap-3 mb-4">
                            <div class="flex items-center gap-2">
                                <label for="payment-start-date" class="text-sm font-medium text-gray-700 whitespace-nowrap">付款日期：</label>
                                <input type="date" id="payment-start-date" class="form-input px-3 py-2 border border-gray-300 rounded-md">
                                <span class="text-gray-500 whitespace-nowrap">至</span>
                                <input type="date" id="payment-end-date" class="form-input px-3 py-2 border border-gray-300 rounded-md">
                                <button id="payment-date-filter-btn" class="btn btn-primary btn-sm text-sm whitespace-nowrap">
                                    <i class="fa fa-filter mr-1"></i>筛选
                                </button>
                                <button id="payment-date-reset-btn" class="btn btn-secondary btn-sm text-sm whitespace-nowrap">
                                    <i class="fa fa-refresh mr-1"></i>重置
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="rounded text-primary focus:ring-primary">
                                        </th>
                                        <th>合同号</th>
                                        <th>发票编号</th>
                                        <th>付款状态</th>
                                        <th>付款类型</th>
                                        <th>供应商</th>
                                        <th>付款日期</th>
                                        <th>金额</th>
                                        <th>付款方式</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentListTableBody">
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="7" class="text-right font-bold py-2">合计:</td>
                                        <td id="paymentTotalAmountTable" class="text-right font-bold py-2">¥0.00</td>
                                        <td colspan="1" class="py-2">共 <span id="paymentTotalRecords">0</span> 条记录</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <!-- 分页控件 -->
                        <div class="flex justify-center items-center mt-4">
                            <button id="paymentFirstPage" class="btn btn-sm btn-outline mr-2">首页</button>
                            <button id="paymentPrevPage" class="btn btn-sm btn-outline mr-2">上一页</button>
                            <span id="paymentPageInfo" class="mr-2">第 1/1 页</span>
                            <button id="paymentNextPage" class="btn btn-sm btn-outline mr-2">下一页</button>
                            <button id="paymentLastPage" class="btn btn-sm btn-outline">末页</button>
                        </div>

                    </div>
                </div>
                
                <!-- 供应商管理页面 -->
                <div id="suppliers-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-xl font-bold mb-4 md:mb-0">供应商管理</h2>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative">
                                <input type="text" id="supplier-search" placeholder="搜索供应商..." class="form-input pl-10 text-center">
                                <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button class="btn btn-primary" data-action="new-supplier">
                                <i class="fa fa-plus mr-2"></i>添加供应商
                            </button>
                        </div>
                    </div>
                    

                    
                    <!-- 供应商列表 -->
                    <div class="card">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <h3 class="text-lg font-medium mb-2 sm:mb-0">供应商列表</h3>
                            <div class="flex gap-2">
                                <button class="btn btn-success" id="exportExcel">
                                    <i class="fa fa-file-excel-o mr-2"></i>导出EXCEL
                                </button>
                                <button class="btn btn-info" id="importExcelBtn">
                                    <i class="fa fa-file-excel-o mr-2"></i>导入EXCEL
                                </button>
                                <input type="file" id="importExcel" accept=".xlsx,.xls" style="display: none;" />
                            </div>
                        </div>
                        <div class="supplier-cards grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- 供应商卡片示例 -->
                            <div class="supplier-card card p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-lg">供应商编号</h3>
                                        <p class="text-sm text-gray-600">SUP-001</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                        <span class="text-sm text-green-700">启用</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <h4 class="text-sm font-medium mb-1">供应商名称</h4>
                                        <p class="text-sm">供应商A</p>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-medium mb-1">联系人</h4>
                                        <p class="text-sm">张三</p>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-medium mb-1">电话</h4>
                                        <p class="text-sm">13800138000</p>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-medium mb-1">电子邮箱</h4>
                                        <p class="text-sm">contact@supplierA.com</p>
                                    </div>
                                    <div class="col-span-2">
                                        <h4 class="text-sm font-medium mb-1">公司地址</h4>
                                        <p class="text-sm">北京市朝阳区</p>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-medium mb-1">开户行</h4>
                                        <p class="text-sm">中国银行</p>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-medium mb-1">行号</h4>
                                        <p class="text-sm">123456789</p>
                                    </div>
                                    <div class="col-span-2">
                                        <h4 class="text-sm font-medium mb-1">账号</h4>
                                        <p class="text-sm">987654321</p>
                                    </div>
                                    <div class="col-span-2">
                                        <h4 class="text-sm font-medium mb-1">备注</h4>
                                        <p class="text-sm">优质供应商</p>
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button class="btn btn-primary btn-sm">编辑</button>
                                    <button class="btn btn-danger btn-sm">删除</button>
                                </div>
                            </div>
                            <!-- 可根据需要复制多个卡片 -->
                        </div>

                    </div>
                </div>
                
                <!-- 数据统计页面 -->
                <div id="reports-page" class="page hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
                        <h2 class="text-xl font-bold mb-4 md:mb-0">数据统计</h2>
                    </div>
                    
                    <!-- 报表统计卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div class="stat-card">
                            <div>
                                <p class="stat-label">采购总额</p>
                                <p id="purchaseTotalAmount" class="stat-value text-primary">¥0.00</p>
                                <p class="text-xs text-success"><i class="fa fa-arrow-up"></i> 12.5% 较上月</p>
                            </div>
                            <div class="stat-icon bg-primary/20">
                                <i class="fa fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div>
                                <p class="stat-label">发票总额</p>
                                <p id="invoiceTotalAmount" class="stat-value text-success">¥0.00</p>
                                <p class="text-xs text-success"><i class="fa fa-arrow-up"></i> 8.3% 较上月</p>
                            </div>
                            <div class="stat-icon bg-success/20">
                                <i class="fa fa-file-text"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div>
                                <p class="stat-label">付款总额</p>
                                <p id="paymentTotalAmount" class="stat-value text-warning">¥0.00</p>
                                <p class="text-xs text-danger"><i class="fa fa-arrow-down"></i> 3.2% 较上月</p>
                            </div>
                            <div class="stat-icon bg-warning/20">
                                <i class="fa fa-credit-card"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div>
                                <p class="stat-label">未付款金额</p>
                                <p id="dashboardUnpaidAmount" class="stat-value text-danger">¥0.00</p>
                                <p class="text-xs text-success"><i class="fa fa-arrow-down"></i> 5.8% 较上月</p>
                            </div>
                            <div class="stat-icon bg-danger/20">
                                <i class="fa fa-exclamation-circle"></i>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div>
                                <p class="stat-label">缺票总额</p>
                                <p id="missingInvoiceAmount" class="stat-value text-warning">¥0.00</p>
                                <p class="text-xs text-danger"><i class="fa fa-arrow-up"></i> 8.2% 较上月</p>
                            </div>
                            <div class="stat-icon bg-warning/20">
                                <i class="fa fa-file-text-o"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 图表区域已移除 -->
                    

                    
                    <!-- 采购汇总表 -->
                    <div class="card">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">采购汇总表</h3>

                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>供应商</th>
                                        <th>采购订单数</th>
                                        <th>采购金额</th>
                                        <th>发票金额</th>
                                        <th>付款金额</th>
                                        <th>欠票金额</th>
                                        <th>未付款金额</th>
                                    </tr>
                                </thead>
                                <tbody id="detailedReportBody">
                                    <!-- 数据已清空 -->
                                </tbody>
                                <tfoot>
                                    <tr class="bg-gray-50">
                                        <td class="font-medium">合计</td>
                                        <td>0</td>
                                        <td>¥0.00</td>
                                        <td>¥0.00</td>
                                        <td>¥0.00</td>
                                        <td>¥0.00</td>
                                        <td>¥0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </main>
    </div>
    
    <!-- JavaScript -->
    <script>
        // 侧边栏折叠功能
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const toggleArrow = toggleBtn.querySelector('.toggle-arrow');
            
            // 从本地存储读取状态
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            
            // 初始化侧边栏状态
            if (isCollapsed) {
                sidebar.style.width = '0';
                sidebar.style.opacity = '0';
                toggleArrow.style.transform = 'rotate(0deg)';
            }
            
            // 点击切换侧边栏
            toggleBtn.addEventListener('click', function() {
                const isCurrentlyCollapsed = sidebar.style.width === '0' || sidebar.style.opacity === '0';
                
                if (isCurrentlyCollapsed) {
                    // 展开侧边栏
                    sidebar.style.width = '16rem';
                    sidebar.style.opacity = '1';
                    toggleArrow.style.transform = 'rotate(180deg)';
                    localStorage.setItem('sidebarCollapsed', 'false');
                } else {
                    // 收起侧边栏
                    sidebar.style.width = '0';
                    sidebar.style.opacity = '0';
                    toggleArrow.style.transform = 'rotate(0deg)';
                    localStorage.setItem('sidebarCollapsed', 'true');
                }
            });
            
            // 导航菜单点击事件
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const pageTitle = document.getElementById('page-title');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    // 检查是否是外部链接或带有target="_blank"的链接
                    if (this.getAttribute('target') === '_blank' || this.getAttribute('href') && this.getAttribute('href').endsWith('.html')) {
                        return; // 让外部链接正常跳转，不阻止默认行为
                    }
                    
                    e.preventDefault();
                    
                    // 移除所有导航项的active类
                    navLinks.forEach(item => item.classList.remove('active'));
                    
                    // 添加当前导航项的active类
                    this.classList.add('active');
                    
                    // 获取目标页面ID
                    const targetPageId = this.getAttribute('data-page');
                    
                    // 隐藏所有页面
                    pages.forEach(page => page.classList.add('hidden'));
                    
                    // 显示目标页面
                    const targetPage = document.getElementById(`${targetPageId}-page`);
                    if (targetPage) {
                        targetPage.classList.remove('hidden');
                        targetPage.classList.add('active');
                        
                        // 更新页面标题
                        pageTitle.textContent = this.querySelector('span').textContent;
                        
                        // 如果是采购管理页面，渲染采购订单列表
                        if (targetPageId === 'procurement' && typeof renderPurchaseOrderList === 'function') {
                            renderPurchaseOrderList();
                        }
                        // 如果是发票页面，渲染发票列表
                        if (targetPageId === 'invoices' && typeof renderInvoiceList === 'function') {
                            renderInvoiceList();
                        } 
                        // 如果是付款页面，渲染付款列表
                        if (targetPageId === 'payments' && typeof renderPaymentList === 'function') {
                            renderPaymentList(document.getElementById('payment-search-input').value);
                        }
                        // 如果是数据统计页面，更新详细采购报表
                        if (targetPageId === 'dashboard' && typeof updateDetailedPurchaseReport === 'function') {
                            updateDetailedPurchaseReport();
                        }
                    }
                });
            });
            
            // 恢复上次激活的页面
            const savedPage = localStorage.getItem('lastActivePage');
            if (savedPage) {

                const savedNavLink = document.querySelector(`.nav-link[data-page="${savedPage}"]`);
                if (savedNavLink) {
                    // 移除所有导航项的active类
                    navLinks.forEach(item => item.classList.remove('active'));
                    
                    // 添加当前导航项的active类
                    savedNavLink.classList.add('active');
                    
                    // 隐藏所有页面
                    pages.forEach(page => page.classList.add('hidden'));
                    
                    // 显示目标页面
                    const targetPage = document.getElementById(`${savedPage}-page`);
                    if (targetPage) {
                        targetPage.classList.remove('hidden');
                        targetPage.classList.add('active');
                        
                        // 更新页面标题
                        pageTitle.textContent = savedNavLink.querySelector('span').textContent;
                        
                        // 如果是采购管理页面，渲染采购订单列表
                        if (savedPage === 'procurement' && typeof renderPurchaseOrderList === 'function') {
                            renderPurchaseOrderList();
                        }
                        // 如果是发票页面，渲染发票列表
                        if (savedPage === 'invoices' && typeof renderInvoiceList === 'function') {
                            renderInvoiceList();
                        } 
                        // 如果是付款页面，渲染付款列表
                        if (savedPage === 'payments' && typeof renderPaymentList === 'function') {
                            renderPaymentList(document.getElementById('payment-search-input').value);
                        }
                    }
                }
            }
            
            // 设置选项卡切换
            const tabs = document.querySelectorAll('.tab');
            const settingsTabs = document.querySelectorAll('.settings-tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有选项卡的active类
                    tabs.forEach(item => item.classList.remove('active'));
                    
                    // 添加当前选项卡的active类
                    this.classList.add('active');
                    
                    // 获取目标设置内容ID
                    const targetTabId = this.getAttribute('data-tab');
                    
                    // 隐藏所有设置内容
                    settingsTabs.forEach(content => content.classList.add('hidden'));
                    
                    // 显示目标设置内容
                    const targetContent = document.getElementById(`${targetTabId}-settings`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        targetContent.classList.add('active');
                    }
                });
            });
            
            // 初始化图表
            initCharts();
            

        });
        
        // 初始化图表
        function initCharts() {
            // 图表初始化函数已移除
        }
    </script>

    <!-- 新建供应商模态框 -->
    <div id="newSupplierModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">添加供应商</h2>
                    <button id="closeNewSupplierModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="newSupplierForm">
                    <!-- 供应商编号和名称 -->
                    <div class="flex gap-4 mb-4">
                        <!-- 自动编号 -->
                        <div class="form-group" style="width: 25%;">
                            <label class="form-label">供应商编号</label>
                            <input type="text" id="supplierNumber" class="form-input" value="" readonly>
                        </div>
                        
                        <!-- 供应商名称 -->
                        <div class="form-group" style="width: 70%;">
                            <label class="form-label">供应商名称</label>
                            <input type="text" id="supplierName" class="form-input" placeholder="请输入供应商名称" required>
                        </div>
                    </div>
                    
                    <!-- 联系人、电话和电子邮箱 -->
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <!-- 联系人 -->
                        <div class="form-group">
                            <label class="form-label">联系人</label>
                            <input type="text" id="contactPerson" class="form-input" placeholder="请输入联系人姓名" required>
                        </div>
                        
                        <!-- 电话 -->
                        <div class="form-group">
                            <label class="form-label">电话</label>
                            <input type="tel" id="phoneNumber" class="form-input" placeholder="请输入联系电话" required>
                        </div>
                        
                        <!-- 电子邮箱 -->
                        <div class="form-group">
                            <label class="form-label">电子邮箱</label>
                            <input type="email" id="email" class="form-input" placeholder="请输入电子邮箱">
                        </div>
                    </div>
                    
                    <!-- 公司地址 -->
                    <div class="form-group">
                        <label class="form-label">公司地址</label>
                        <textarea id="companyAddress" class="form-input" placeholder="请输入公司地址" rows="3" required></textarea>
                    </div>
                    
                    <!-- 开户行 -->
                    <div class="form-group mb-4">
                        <label class="form-label">开户行</label>
                        <input type="text" id="bankName" class="form-input" placeholder="请输入开户行名称">
                    </div>
                    
                    <!-- 行号和账号 -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- 行号 -->
                        <div class="form-group">
                            <label class="form-label">行号</label>
                            <input type="text" id="bankCode" class="form-input" placeholder="请输入开户行行号">
                        </div>
                        
                        <!-- 账号 -->
                        <div class="form-group">
                            <label class="form-label">账号</label>
                            <input type="text" id="bankAccount" class="form-input" placeholder="请输入银行账号">
                        </div>
                    </div>
                    
                    <!-- 备注 -->
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea id="supplierRemarks" class="form-input" placeholder="请输入备注信息" rows="2"></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" id="cancelNewSupplierModal" class="btn btn-white border border-gray-300">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 新建采购订单模态框 -->
    <div id="newPurchaseOrderModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">新建采购订单</h2>
                    <button id="closeNewPurchaseOrderModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="newPurchaseOrderForm">
                    <!-- 供应商 -->
                    <div class="form-group">
                        <label class="form-label">供应商</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <input type="text" id="supplier" class="form-input" placeholder="请输入供应商名称" required>
                                <div id="supplier-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto mt-1"></div>
                            </div>
                            <button type="button" id="newSupplierBtn" class="btn btn-secondary">
                                <i class="fa fa-plus mr-1"></i>新建供应商
                            </button>
                        </div>
                    </div>
                    
                    <!-- 合同号和成本类别（一行显示） -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- 合同号（自动生成） -->
                        <div class="form-group">
                            <label class="form-label">合同号</label>
                            <input type="text" id="contractNumber" class="form-input" value="" readonly>
                        </div>
                        
                        <!-- 成本类别 -->
                        <div class="form-group">
                            <label class="form-label">成本类别</label>
                            <select id="costCategory" class="form-input" required>
                                <option value="" disabled selected>请选择成本类别</option>
                                <option value="前期账面余额">前期账面余额</option>
                                <option value="原材料">原材料</option>
                                <option value="辅助材料">辅助材料</option>
                                <option value="电镀费">电镀费</option>
                                <option value="包装箱费用">包装箱费用</option>
                                <option value="易耗品材料">易耗品材料</option>
                                <option value="外协加工费">外协加工费</option>
                                <option value="运杂费">运杂费</option>
                                <option value="维修或模具费">维修或模具费</option>
                                <option value="水电费">水电费</option>
                                <option value="工资">工资</option>
                                <option value="税">税</option>
                                <option value="银行还贷">银行还贷</option>
                                <option value="银行手续费">银行手续费</option>
                                <option value="利息">利息</option>
                                <option value="员工报销">员工报销</option>
                                <option value="员工餐费用">员工餐费用</option>
                                <option value="员工福利">员工福利</option>
                                <option value="通信费">通信费</option>
                                <option value="调账">调账</option>
                                <option value="其它支出">其它支出</option>
                                <option value="贸易往来">贸易往来</option>
                                <option value="借款">借款</option>
                                <option value="固定资产设备">固定资产设备</option>
                                <option value="贸易产品">贸易产品</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 日期字段（一行显示） -->
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <!-- 下单日期 -->
                        <div class="form-group">
                            <label class="form-label">下单日期</label>
                            <input type="date" id="orderDate" class="form-input" required>
                        </div>
                        
                        <!-- 交货期 -->
                        <div class="form-group">
                            <label class="form-label">交货期</label>
                            <input type="date" id="deliveryDate" class="form-input" required>
                        </div>
                        
                        <!-- 实际到货期 -->
                        <div class="form-group">
                            <label class="form-label">实际到货期</label>
                            <input type="date" id="actualArrivalDate" class="form-input">
                        </div>
                    </div>
                    
                    <!-- 备注 -->
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea id="remarks" class="form-input" rows="3" placeholder="请输入备注"></textarea>
                    </div>
                    
                    <!-- 产品列表 -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-medium">产品列表</h3>
                            <a href="ply box.html" target="_blank" class="btn btn-info">
                                <i class="fa fa-calculator mr-1"></i>木箱计算
                            </a>
                        </div>
                        <div id="productList" class="space-y-4">
                            <!-- 第一个产品行 -->
                            <div class="grid grid-cols-12 gap-2 p-3 bg-gray-50 rounded-md product-row">
                                <div class="col-span-2">
                                    <div class="relative">
                                        <input type="text" class="form-input product-name" placeholder="产品名称" required>
                                        <div class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto mt-1 product-dropdown"></div>
                                    </div>
                                </div>
                                <div class="col-span-3">
                                    <div class="relative">
                                        <input type="text" class="form-input product-specification" placeholder="规格型号" required>
                                        <div class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto mt-1 spec-dropdown"></div>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <input type="number" class="form-input product-unit-price" placeholder="单价" min="0" step="0.01" required>
                                </div>
                                <div class="col-span-2">
                                    <input type="number" class="form-input product-quantity" placeholder="数量" min="1" step="1" required>
                                </div>
                                <div class="col-span-1">
                                    <select class="form-input product-unit" required>
                                        <option value="只">只</option>
                                        <option value="卷">卷</option>
                                        <option value="箱">箱</option>
                                        <option value="吨">吨</option>
                                        <option value="公斤">公斤</option>
                                        <option value="套">套</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <input type="number" class="form-input product-amount" placeholder="金额" min="0" step="0.01" readonly>
                                </div>
                                <div class="col-span-1 flex items-center">
                                    <button type="button" class="remove-product-btn text-red-500 hover:text-red-700" disabled>
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 添加产品按钮 -->
                        <button type="button" id="addProductBtn" class="btn btn-secondary mt-2">
                            <i class="fa fa-plus mr-1"></i>添加产品
                        </button>
                    </div>
                    
                    <!-- 总金额 -->
                    <div class="form-group">
                        <label class="form-label">总金额（含税）</label>
                        <input type="number" id="totalAmount" class="form-input" placeholder="0.00" min="0" step="0.01" readonly>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button" id="cancelPurchaseOrderBtn" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存采购订单</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 自动生成合同号
        function generateContractNumber() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const random = Math.floor(1000 + Math.random() * 9000);
            return `PO-${year}${month}${day}-${random}`;
        }
        
        // 初始化新建采购订单模态框
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;
            
            // 设置默认交货日期为今天
            const deliveryDateInput = document.getElementById('deliveryDate');
            if (deliveryDateInput) {
                deliveryDateInput.value = today;
            }
            
            // 自动生成合同号
            const contractNumber = generateContractNumber();
            document.getElementById('contractNumber').value = contractNumber;
            
            // 绑定事件
            bindNewPurchaseOrderEvents();
        });
        
        // 根据产品名称获取历史采购记录中的规格型号和单价
        function getProductHistory(productName) {
            if (!productName) return [];
            
            const storageKey = `purchaseOrders_${currentCompany}`;
            const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
            const productData = {};
            
            // 遍历所有采购订单，收集产品信息
            purchaseOrders.forEach(order => {
                if (order.products && Array.isArray(order.products)) {
                    order.products.forEach(product => {
                        if (product.productName && product.productName.includes(productName)) {
                            // 使用产品名称+规格型号作为键，避免重复
                            const key = `${product.productName}_${product.specification}`;
                            if (!productData[key]) {
                                productData[key] = {
                                    productName: product.productName,
                                    specification: product.specification,
                                    unitPrice: product.unitPrice
                                };
                            }
                        }
                    });
                }
            });
            
            // 转换为数组并返回
            return Object.values(productData);
        }
        
        // 显示产品规格型号建议
        function showSpecificationSuggestions(specInput, productName) {
            const history = getProductHistory(productName);
            const specDropdown = specInput.parentElement.querySelector('.spec-dropdown');
            
            if (!specDropdown || history.length === 0) {
                return;
            }
            
            // 清空并填充下拉框
            specDropdown.innerHTML = '';
            history.forEach(item => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100';
                option.textContent = item.specification;
                option.addEventListener('click', function() {
                    specInput.value = item.specification;
                    // 自动填充对应的单价
                    const priceInput = specInput.closest('.product-row').querySelector('.product-unit-price');
                    if (priceInput) {
                        priceInput.value = item.unitPrice;
                        // 触发数量变化事件以更新金额
                        const quantityInput = specInput.closest('.product-row').querySelector('.product-quantity');
                        if (quantityInput && quantityInput.value) {
                            calculateProductAmount(specInput.closest('.product-row'));
                            calculateTotalAmount();
                        }
                    }
                });
                specDropdown.appendChild(option);
            });
            
            // 显示下拉框
            specDropdown.classList.remove('hidden');
        }
        
        // 显示产品单价建议
        function showUnitPriceSuggestions(priceInput, productName) {
            const history = getProductHistory(productName);
            const specInput = priceInput.closest('.product-row').querySelector('.product-specification');
            const selectedSpec = specInput ? specInput.value : '';
            
            // 过滤出与当前规格匹配的价格
            const filteredHistory = history.filter(item => 
                selectedSpec ? item.specification === selectedSpec : true
            );
            
            if (filteredHistory.length === 0) {
                return;
            }
            
            // 创建临时下拉框（如果不存在）
            let priceDropdown = priceInput.parentElement.querySelector('.price-dropdown');
            if (!priceDropdown) {
                priceDropdown = document.createElement('div');
                priceDropdown.className = 'absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto mt-1 price-dropdown';
                priceInput.parentElement.appendChild(priceDropdown);
            }
            
            // 清空并填充下拉框
            priceDropdown.innerHTML = '';
            filteredHistory.forEach(item => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100';
                option.innerHTML = `
                    <div>¥${item.unitPrice.toFixed(2)}</div>
                    <div class="text-xs text-gray-500">规格: ${item.specification}</div>
                `;
                option.addEventListener('click', function() {
                    priceInput.value = item.unitPrice;
                    // 如果规格未填写，自动填充规格
                    if (!selectedSpec && specInput) {
                        specInput.value = item.specification;
                    }
                    // 触发数量变化事件以更新金额
                    const quantityInput = priceInput.closest('.product-row').querySelector('.product-quantity');
                    if (quantityInput && quantityInput.value) {
                        calculateProductAmount(priceInput.closest('.product-row'));
                        calculateTotalAmount();
                    }
                });
                priceDropdown.appendChild(option);
            });
            
            // 显示下拉框
            priceDropdown.classList.remove('hidden');
        }
        
        // 绑定新建采购订单模态框的事件
        function bindNewPurchaseOrderEvents() {
            // 打开新建供应商模态框的按钮事件
            const newSupplierBtn = document.getElementById('newSupplierBtn');
            if (newSupplierBtn) {
                newSupplierBtn.addEventListener('click', function() {
                    // 先关闭新建采购订单模态框
                    const newPurchaseOrderModal = document.getElementById('newPurchaseOrderModal');
                    newPurchaseOrderModal.classList.add('hidden');
                    
                    // 生成并设置供应商编号
                    const supplierNumberInput = document.getElementById('supplierNumber');
                    const newSupplierModal = document.getElementById('newSupplierModal');
                    
                    // 定义generateSupplierNumber函数（复制自供应商管理模块）
                    function generateSupplierNumber() {
                        const prefix = 'SUP-';
                        const random = Math.floor(1000 + Math.random() * 9000); // 4位随机数
                        return prefix + random;
                    }
                    
                    supplierNumberInput.value = generateSupplierNumber();
                    newSupplierModal.classList.remove('hidden');
                });
            }
            
            // 打开模态框 - 使用数据属性查找按钮（更可靠）
            const openModalBtn = document.querySelector('button[data-action="new-purchase-order"]');
            if (openModalBtn) {
                openModalBtn.addEventListener('click', function() {
                    // 重新生成合同号
                    const contractNumber = generateContractNumber();
                    document.getElementById('contractNumber').value = contractNumber;
                    
                    document.getElementById('newPurchaseOrderModal').classList.remove('hidden');
                });
            }
            
            // 关闭模态框
            document.getElementById('closeNewPurchaseOrderModal').addEventListener('click', function() {
                document.getElementById('newPurchaseOrderModal').classList.add('hidden');
                document.getElementById('newPurchaseOrderForm').reset();
                resetProductList();
            });
            
            // 取消按钮
            document.getElementById('cancelPurchaseOrderBtn').addEventListener('click', function() {
                document.getElementById('newPurchaseOrderModal').classList.add('hidden');
                document.getElementById('newPurchaseOrderForm').reset();
                resetProductList();
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('newPurchaseOrderModal');
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    document.getElementById('newPurchaseOrderForm').reset();
                    resetProductList();
                }
            });
            
            // 点击外部关闭下拉框
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('product-name') && !e.target.classList.contains('product-specification') && !e.target.classList.contains('product-unit-price') && !e.target.closest('.product-dropdown') && !e.target.closest('.spec-dropdown') && !e.target.closest('.price-dropdown')) {
                    const dropdowns = document.querySelectorAll('.product-dropdown, .spec-dropdown, .price-dropdown');
                    dropdowns.forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });
                }
            });
            
            // 为规格型号输入框添加鼠标悬停事件
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('product-specification')) {
                    const specInput = e.target;
                    const productRow = specInput.closest('.product-row');
                    const productNameInput = productRow.querySelector('.product-name');
                    const productName = productNameInput ? productNameInput.value.trim() : '';
                    
                    if (productName) {
                        showSpecificationSuggestions(specInput, productName);
                    }
                }
            });
            
            // 为单价输入框添加鼠标悬停事件
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('product-unit-price')) {
                    const priceInput = e.target;
                    const productRow = priceInput.closest('.product-row');
                    const productNameInput = productRow.querySelector('.product-name');
                    const productName = productNameInput ? productNameInput.value.trim() : '';
                    
                    if (productName) {
                        showUnitPriceSuggestions(priceInput, productName);
                    }
                }
            });
            
            // 计算金额
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('product-unit-price') || e.target.classList.contains('product-quantity')) {
                    const productRow = e.target.closest('.product-row');
                    calculateProductAmount(productRow);
                    calculateTotalAmount();
                } else if (e.target.classList.contains('product-name')) {
                    // 产品名称模糊搜索逻辑
                    const input = e.target;
                    const productRow = input.closest('.product-row');
                    const dropdown = productRow.querySelector('.product-dropdown');
                    const searchTerm = input.value.trim().toLowerCase();
                    
                    // 获取所有已保存的采购订单数据
                    const storageKey = `purchaseOrders_${currentCompany}`;
const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                    
                    // 提取所有产品名称
                    const productNames = new Set();
                    purchaseOrders.forEach(order => {
                        if (order.products && order.products.length > 0) {
                            order.products.forEach(product => {
                                if (product.productName && product.productName.trim() !== '') {
                                    productNames.add(product.productName.trim());
                                }
                            });
                        }
                    });
                    
                    // 过滤匹配的产品名称
                    const filteredNames = Array.from(productNames).filter(name => name.toLowerCase().includes(searchTerm));
                    
                    // 显示下拉框
                    if (filteredNames.length > 0 && searchTerm !== '') {
                        dropdown.innerHTML = filteredNames.map(name => `<div class="p-2 cursor-pointer hover:bg-gray-100">${name}</div>`).join('');
                        dropdown.classList.remove('hidden');
                    } else {
                        dropdown.classList.add('hidden');
                    }
                    
                    // 点击下拉框选项自动填充输入框
                    dropdown.querySelectorAll('div').forEach(item => {
                        item.addEventListener('click', function() {
                            input.value = this.textContent;
                            dropdown.classList.add('hidden');
                        });
                    });
                } else if (e.target.classList.contains('product-specification')) {
                    // 规格型号模糊搜索逻辑
                    const input = e.target;
                    const productRow = input.closest('.product-row');
                    const dropdown = productRow.querySelector('.spec-dropdown');
                    const searchTerm = input.value.trim().toLowerCase();
                    
                    // 获取所有已保存的采购订单数据
                    const storageKey = `purchaseOrders_${currentCompany}`;
const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                    
                    // 提取所有规格型号
                    const specifications = new Set();
                    purchaseOrders.forEach(order => {
                        if (order.products && order.products.length > 0) {
                            order.products.forEach(product => {
                                if (product.specification && product.specification.trim() !== '') {
                                    specifications.add(product.specification.trim());
                                }
                            });
                        }
                    });
                    
                    // 过滤匹配的规格型号
                    const filteredSpecs = Array.from(specifications).filter(spec => spec.toLowerCase().includes(searchTerm));
                    
                    // 显示下拉框
                    if (filteredSpecs.length > 0 && searchTerm !== '') {
                        dropdown.innerHTML = filteredSpecs.map(spec => `<div class="p-2 cursor-pointer hover:bg-gray-100">${spec}</div>`).join('');
                        dropdown.classList.remove('hidden');
                    } else {
                        dropdown.classList.add('hidden');
                    }
                    
                    // 点击下拉框选项自动填充输入框
                    dropdown.querySelectorAll('div').forEach(item => {
                        item.addEventListener('click', function() {
                            input.value = this.textContent;
                            dropdown.classList.add('hidden');
                        });
                    });
                }
            });
            
            // 添加产品
            document.getElementById('addProductBtn').addEventListener('click', function() {
                const productList = document.getElementById('productList');
                const productRowTemplate = productList.firstElementChild.cloneNode(true);
                
                // 重置输入值
                const inputs = productRowTemplate.querySelectorAll('input');
                inputs.forEach(input => {
                    if (input.type !== 'readonly') {
                        input.value = '';
                    }
                });
                
                // 启用删除按钮
                const removeBtn = productRowTemplate.querySelector('.remove-product-btn');
                if (removeBtn) {
                    removeBtn.disabled = false;
                    removeBtn.addEventListener('click', function() {
                        productRowTemplate.remove();
                        calculateTotalAmount();
                    });
                }
                
                productList.appendChild(productRowTemplate);
            });
            
            // 保存采购订单
            document.getElementById('newPurchaseOrderForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 收集表单数据
                const purchaseOrderData = {
                    id: Date.now(), // 生成唯一ID
                    contractNumber: document.getElementById('contractNumber').value,
                    supplier: document.getElementById('supplier').value,
                    orderDate: document.getElementById('orderDate').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    actualArrivalDate: document.getElementById('actualArrivalDate').value || null,
                    costCategory: document.getElementById('costCategory').value || null,
                    remarks: document.getElementById('remarks').value || null,
                    products: []
                };
                
                // 收集产品数据
                const productRows = document.querySelectorAll('.product-row');
                productRows.forEach((productRow, index) => {
                    const product = {
                        productName: productRow.querySelector('.product-name').value,
                        specification: productRow.querySelector('.product-specification').value,
                        unitPrice: parseFloat(productRow.querySelector('.product-unit-price').value),
                        quantity: parseInt(productRow.querySelector('.product-quantity').value),
                        unit: productRow.querySelector('.product-unit').value,
                        amount: parseFloat(productRow.querySelector('.product-amount').value)
                    };
                    purchaseOrderData.products.push(product);
                });
                
                // 收集总金额
                purchaseOrderData.totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
                
                // 保存到localStorage，按公司隔离
                const storageKey = `purchaseOrders_${currentCompany}`;
                let purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                purchaseOrders.push(purchaseOrderData);
                localStorage.setItem(storageKey, JSON.stringify(purchaseOrders));
                
                // 关闭模态框
                document.getElementById('newPurchaseOrderModal').classList.add('hidden');
                document.getElementById('newPurchaseOrderForm').reset();
                resetProductList();
                
                // 重新渲染采购订单列表
                renderPurchaseOrderList();
                
                alert('采购订单保存成功！');
            });
        }
        
        // 计算单个产品的金额
        function calculateProductAmount(productRow) {
            const unitPrice = parseFloat(productRow.querySelector('.product-unit-price').value) || 0;
            const quantity = parseInt(productRow.querySelector('.product-quantity').value) || 0;
            const amount = unitPrice * quantity;
            productRow.querySelector('.product-amount').value = amount.toFixed(2);
        }
        
        // 计算总金额
        function calculateTotalAmount() {
            const productRows = document.querySelectorAll('.product-row');
            let totalAmount = 0;
            
            productRows.forEach(productRow => {
                const amount = parseFloat(productRow.querySelector('.product-amount').value) || 0;
                totalAmount += amount;
            });
            
            document.getElementById('totalAmount').value = totalAmount.toFixed(2);
        }
        
        // 重置产品列表
        function resetProductList() {
            const productList = document.getElementById('productList');
            const firstProductRow = productList.firstElementChild;
            
            // 移除所有产品行，只保留第一个
            while (productList.children.length > 1) {
                productList.removeChild(productList.lastElementChild);
            }
            
            // 重置第一个产品行的输入值
            const inputs = firstProductRow.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type !== 'readonly') {
                    input.value = '';
                }
            });
            

            
            // 禁用第一个产品行的删除按钮
            const removeBtn = firstProductRow.querySelector('.remove-product-btn');
            if (removeBtn) {
                removeBtn.disabled = true;
            }
            
            // 重置总金额
            calculateTotalAmount();
        }

        // 查看采购订单

        // 初始化详细采购报表
        function initDetailedPurchaseReport() {
                // 页面加载时更新报表
                updateDetailedPurchaseReport();
                
                // 监听localStorage变化，实现数据实时更新
                window.addEventListener('storage', function(e) {
                    const currentCompany = getCurrentCompany();
                    const relevantKeys = [
                        `purchaseOrders_${currentCompany}`,
                        `${currentCompany}-invoices`,
                        `${currentCompany}-payments`
                    ];
                    
                    if (relevantKeys.includes(e.key)) {
                        updateDetailedPurchaseReport();
                    }
                });
                
                // 测试详细采购报表功能
                testDetailedPurchaseReport();
            }
            
            // 测试详细采购报表功能
            function testDetailedPurchaseReport() {
                // 验证报表计算逻辑的正确性
                console.log('正在测试详细采购报表功能...');
                
                try {
                    const currentCompany = getCurrentCompany();
                    console.log('当前公司:', currentCompany);
                    
                    // 检查localStorage中的数据
                    const orderKey = `purchaseOrders_${currentCompany}`;
                    const invoiceKey = `${currentCompany}-invoices`;
                    const paymentKey = `${currentCompany}-payments`;
                    
                    console.log('采购订单存储键:', orderKey);
                    console.log('发票存储键:', invoiceKey);
                    console.log('付款存储键:', paymentKey);
                    
                    const purchaseOrders = JSON.parse(localStorage.getItem(orderKey) || '[]');
                    const invoices = JSON.parse(localStorage.getItem(invoiceKey) || '[]');
                    const payments = JSON.parse(localStorage.getItem(paymentKey) || '[]');
                    
                    console.log(`找到 ${purchaseOrders.length} 个采购订单`);
                    console.log(`找到 ${invoices.length} 个发票`);
                    console.log(`找到 ${payments.length} 个付款记录`);
                    
                    // 注意：已删除示例数据生成代码，不再自动创建示例数据
                    
                    // 手动执行一次更新来测试
                    updateDetailedPurchaseReport();
                    
                    console.log('详细采购报表测试完成，功能正常!');
                } catch (error) {
                    console.error('详细采购报表测试失败:', error);
                }
            }
            
            // 更新仪表盘统计数据
            function updateDashboardStats() {
            const currentCompany = getCurrentCompany();
            
            // 计算采购总额
            const contractStorageKey = `${currentCompany}-contracts`;
            const contracts = JSON.parse(localStorage.getItem(contractStorageKey)) || [];
            
            let purchaseTotal = 0;
            contracts.forEach(contract => {
                if (contract.totalAmount && typeof contract.totalAmount === 'number') {
                    purchaseTotal += contract.totalAmount;
                }
            });
            
            // 更新采购总额统计卡片
            const purchaseTotalElement = document.getElementById('purchaseTotalAmount');
            if (purchaseTotalElement) {
                purchaseTotalElement.textContent = `¥${purchaseTotal.toFixed(2)}`;
            }
            
            // 计算发票总额
            const invoiceStorageKey = `${currentCompany}-invoices`;
            const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
            
            let invoiceTotal = 0;
            invoices.forEach(invoice => {
                if (invoice.amount && typeof invoice.amount === 'number') {
                    invoiceTotal += invoice.amount;
                }
            });
            
            // 更新发票总额统计卡片
            const invoiceTotalElement = document.getElementById('invoiceTotalAmount');
            if (invoiceTotalElement) {
                invoiceTotalElement.textContent = `¥${invoiceTotal.toFixed(2)}`;
            }
            
            // 计算付款总额
            const paymentStorageKey = `${currentCompany}-payments`;
            const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
            
            let paymentTotal = 0;
            payments.forEach(payment => {
                if (payment.amount && typeof payment.amount === 'number') {
                    paymentTotal += payment.amount;
                }
            });
            
            // 更新付款总额统计卡片
            const paymentTotalElement = document.getElementById('paymentTotalAmount');
            if (paymentTotalElement) {
                paymentTotalElement.textContent = `¥${paymentTotal.toFixed(2)}`;
            }

            // 计算未付款总额（发票总额 - 付款总额）
            const unpaidAmount = invoiceTotal - paymentTotal;
                const dashboardUnpaidElement = document.getElementById('dashboardUnpaidAmount');
                if (dashboardUnpaidElement) {
                    dashboardUnpaidElement.textContent = `¥${unpaidAmount.toFixed(2)}`;
                }

                // 计算缺票总额（采购总额 - 发票总额）
                const missingInvoiceAmount = purchaseTotal - invoiceTotal;
                const missingInvoiceElement = document.getElementById('missingInvoiceAmount');
                if (missingInvoiceElement) {
                    missingInvoiceElement.textContent = `¥${missingInvoiceAmount.toFixed(2)}`;
                }
                
                // 更新详细采购报表
                updateDetailedPurchaseReport();
            }
            
            // 更新详细采购报表
            function updateDetailedPurchaseReport() {
                const currentCompany = getCurrentCompany();
                
                // 获取各数据源数据
                const orderStorageKey = `purchaseOrders_${currentCompany}`;
                const invoiceStorageKey = `${currentCompany}-invoices`;
                const paymentStorageKey = `${currentCompany}-payments`;
                
                const purchaseOrders = JSON.parse(localStorage.getItem(orderStorageKey)) || [];
                const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
                const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
                
                // 按供应商分组统计数据
                const supplierData = {};
                
                // 统计采购订单数据
                purchaseOrders.forEach(order => {
                    if (!supplierData[order.supplier]) {
                        supplierData[order.supplier] = {
                            supplier: order.supplier,
                            orderCount: 0,
                            orderAmount: 0,
                            invoiceCount: 0,
                            invoiceAmount: 0,
                            paymentCount: 0,
                            paymentAmount: 0
                        };
                    }
                    supplierData[order.supplier].orderCount++;
                    supplierData[order.supplier].orderAmount += parseFloat(order.totalAmount || 0);
                });
                
                // 统计发票数据
                invoices.forEach(invoice => {
                    if (!supplierData[invoice.supplier]) {
                        supplierData[invoice.supplier] = {
                            supplier: invoice.supplier,
                            orderCount: 0,
                            orderAmount: 0,
                            invoiceCount: 0,
                            invoiceAmount: 0,
                            paymentCount: 0,
                            paymentAmount: 0
                        };
                    }
                    supplierData[invoice.supplier].invoiceCount++;
                    supplierData[invoice.supplier].invoiceAmount += parseFloat(invoice.amount || 0);
                });
                
                // 统计付款数据
                payments.forEach(payment => {
                    if (!supplierData[payment.supplier]) {
                        supplierData[payment.supplier] = {
                            supplier: payment.supplier,
                            orderCount: 0,
                            orderAmount: 0,
                            invoiceCount: 0,
                            invoiceAmount: 0,
                            paymentCount: 0,
                            paymentAmount: 0
                        };
                    }
                    supplierData[payment.supplier].paymentCount++;
                    supplierData[payment.supplier].paymentAmount += parseFloat(payment.amount || 0);
                });
                
                // 转换为数组并排序，按未付款金额和欠票金额降序排列
                const sortedSupplierData = Object.values(supplierData).sort((a, b) => {
                    // 计算未付款金额
                    const aUnpaidAmount = a.orderAmount - a.paymentAmount;
                    const bUnpaidAmount = b.orderAmount - b.paymentAmount;
                    
                    // 如果未付款金额不同，按未付款金额降序排序
                    if (aUnpaidAmount !== bUnpaidAmount) {
                        return bUnpaidAmount - aUnpaidAmount;
                    }
                    
                    // 如果未付款金额相同，按欠票金额降序排序
                    const aMissingInvoiceAmount = a.orderAmount - a.invoiceAmount;
                    const bMissingInvoiceAmount = b.orderAmount - b.invoiceAmount;
                    return bMissingInvoiceAmount - aMissingInvoiceAmount;
                });
                
                // 更新报表表格
                const reportBody = document.getElementById('detailedReportBody');
                if (reportBody) {
                    reportBody.innerHTML = '';
                    
                    if (sortedSupplierData.length === 0) {
                        const emptyRow = document.createElement('tr');
                        emptyRow.innerHTML = `<td colspan="8" class="text-center py-4 text-gray-500">暂无数据</td>`;
                        reportBody.appendChild(emptyRow);
                    } else {
                        sortedSupplierData.forEach(data => {
                            const row = document.createElement('tr');
                            
                            const missingInvoiceAmount = data.orderAmount - data.invoiceAmount;
                            const unpaidAmount = data.orderAmount - data.paymentAmount;
                            
                            // 如果欠票金额或未付款金额大于0，添加血红色背景
                            let rowClass = 'border-b border-gray-200 hover:bg-gray-50';
                            if (missingInvoiceAmount > 0 || unpaidAmount > 0) {
                                rowClass += ' bg-red-200';
                            }
                            row.className = rowClass;
                            
                            row.innerHTML = `
                                <td class="py-3 px-4">${data.supplier}</td>
                                <td class="py-3 px-4">${data.orderCount}</td>
                                <td class="py-3 px-4">${formatCurrency(data.orderAmount)}</td>
                                <td class="py-3 px-4">${formatCurrency(data.invoiceAmount)}</td>
                                <td class="py-3 px-4">${formatCurrency(data.paymentAmount)}</td>
                                <td class="py-3 px-4 ${missingInvoiceAmount > 0 ? 'text-orange-500' : 'text-green-500'}">
                                    ${formatCurrency(missingInvoiceAmount)}
                                </td>
                                <td class="py-3 px-4 ${unpaidAmount > 0 ? 'text-red-500' : 'text-green-500'}">
                                    ${formatCurrency(unpaidAmount)}
                                </td>
                            `;
                            
                            reportBody.appendChild(row);
                        });
                    }
                    
                    // 更新合计行
                    updateReportFooter(sortedSupplierData);
                }
            }
            
            // 更新报表合计行
            function updateReportFooter(supplierData) {
                // 计算合计值
                let totalOrderCount = 0;
                let totalOrderAmount = 0;
                let totalInvoiceCount = 0;
                let totalInvoiceAmount = 0;
                let totalPaymentCount = 0;
                let totalPaymentAmount = 0;
                
                supplierData.forEach(data => {
                    totalOrderCount += data.orderCount;
                    totalOrderAmount += data.orderAmount;
                    totalInvoiceCount += data.invoiceCount;
                    totalInvoiceAmount += data.invoiceAmount;
                    totalPaymentCount += data.paymentCount;
                    totalPaymentAmount += data.paymentAmount;
                });
                
                const totalMissingInvoiceAmount = totalOrderAmount - totalInvoiceAmount;
                const totalUnpaidAmount = totalOrderAmount - totalPaymentAmount;
                
                // 获取并更新合计行
                const footerRow = document.querySelector('#detailedReportBody + tfoot tr');
                if (footerRow) {
                    const cells = footerRow.querySelectorAll('td');
                    if (cells.length >= 7) {
                        cells[1].textContent = totalOrderCount.toString();
                        cells[2].textContent = formatCurrency(totalOrderAmount);
                        cells[3].textContent = formatCurrency(totalInvoiceAmount);
                        cells[4].textContent = formatCurrency(totalPaymentAmount);
                        cells[5].textContent = formatCurrency(totalMissingInvoiceAmount);
                        cells[6].textContent = formatCurrency(totalUnpaidAmount);
                        cells[5].className = `py-3 px-4 font-medium ${totalMissingInvoiceAmount > 0 ? 'text-orange-500' : 'text-green-500'}`;
                        cells[6].className = `py-3 px-4 font-medium ${totalUnpaidAmount > 0 ? 'text-red-500' : 'text-green-500'}`;
                    }
                    
                    // 更新页面上方的统计卡片
                    const purchaseTotalElement = document.getElementById('purchaseTotalAmount');
                    if (purchaseTotalElement) {
                        purchaseTotalElement.textContent = formatCurrency(totalOrderAmount);
                    }
                    
                    const invoiceTotalElement = document.getElementById('invoiceTotalAmount');
                    if (invoiceTotalElement) {
                        invoiceTotalElement.textContent = formatCurrency(totalInvoiceAmount);
                    }
                    
                    // 更新付款总额统计卡片
                    const paymentTotalElement = document.getElementById('paymentTotalAmount');
                    if (paymentTotalElement) {
                        paymentTotalElement.textContent = formatCurrency(totalPaymentAmount);
                    }
                    
                    // 同时更新表格中的付款合计（如果需要）
                    const paymentTotalTableElement = document.getElementById('paymentTotalAmountTable');
                    if (paymentTotalTableElement) {
                        paymentTotalTableElement.textContent = formatCurrency(totalPaymentAmount);
                    }
                    
                    const dashboardUnpaidElement = document.getElementById('dashboardUnpaidAmount');
                    if (dashboardUnpaidElement) {
                        dashboardUnpaidElement.textContent = formatCurrency(totalUnpaidAmount);
                    }
                    
                    const missingInvoiceElement = document.getElementById('missingInvoiceAmount');
                    if (missingInvoiceElement) {
                        missingInvoiceElement.textContent = formatCurrency(totalMissingInvoiceAmount);
                    }
                }
            }
        
        // 确保getCurrentCompany函数存在

        // 更新采购订单选中合计
        function updatePurchaseOrderSelectionTotal() {
            // 直接从localStorage获取采购订单数据
            const currentCompany = getCurrentCompany();
            const storageKey = `purchaseOrders_${currentCompany}`;
            const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
            
            const checkboxes = document.querySelectorAll('#purchaseOrderTableBody input[type="checkbox"]:checked');
            
            // 如果没有选中项，恢复原合计
            if (checkboxes.length === 0) {
                // 计算所有订单的总数量和总金额
                let totalQuantity = 0;
                let totalAmount = 0;
                
                purchaseOrders.forEach(order => {
                    if (Array.isArray(order.products)) {
                        order.products.forEach(product => {
                            totalQuantity += parseFloat(product.quantity || 0);
                        });
                    }
                    totalAmount += parseFloat(order.totalAmount || 0);
                });
                
                document.getElementById('totalAmountSum').textContent = formatCurrency(totalAmount);
                document.getElementById('totalQuantitySum').textContent = formatQuantity(totalQuantity);
                return;
            }
            
            // 计算选中项合计
            let selectedTotalAmount = 0;
            let selectedTotalQuantity = 0;
            
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                const contractNumber = row.querySelector('td:nth-child(2)').textContent;
                
                // 查找对应的采购订单
                const order = purchaseOrders.find(o => o.contractNumber === contractNumber);
                if (order) {
                    selectedTotalAmount += parseFloat(order.totalAmount || 0);
                    
                    if (Array.isArray(order.products)) {
                        order.products.forEach(product => {
                            selectedTotalQuantity += parseFloat(product.quantity || 0);
                        });
                    }
                }
            });
            
            // 更新合计显示
            document.getElementById('totalAmountSum').textContent = formatCurrency(selectedTotalAmount);
            document.getElementById('totalQuantitySum').textContent = formatQuantity(selectedTotalQuantity);
        }

        function viewPurchaseOrder(id) {
            // 确保id参数正确
            if (!id) {
                console.error('Missing purchase order ID');
                return;
            }
            
            const storageKey = `purchaseOrders_${getCurrentCompany()}`;
            try {
                // 获取并验证采购订单数据
                const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                const order = purchaseOrders.find(o => o.id === id);
                
                if (!order) {
                    alert('未找到指定的采购订单');
                    return;
                }
                
                // 移除之前可能存在的模态框
                const existingModal = document.getElementById('viewPurchaseOrderModal');
                if (existingModal) existingModal.remove();
                
                // 创建查看采购订单模态框
                const modalHtml = `
                    <div id="viewPurchaseOrderModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-xl font-bold">查看采购订单</h2>
                                    <button id="closeViewPurchaseOrderModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">

                                    <div class="form-group">
                                        <label class="form-label font-medium">合同号</label>
                                        <div class="form-input">${order.contractNumber || 'N/A'}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label font-medium">供应商</label>
                                        <div class="form-input">${order.supplier || 'N/A'}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label font-medium">合同日期</label>
                                        <div class="form-input">${order.orderDate || 'N/A'}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label font-medium">交货期</label>
                                        <div class="form-input">${order.deliveryDate || 'N/A'}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label font-medium">实际到货期</label>
                                        <div class="form-input">${order.actualArrivalDate || '-'}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label font-medium">成本类别</label>
                                        <div class="form-input">${order.costCategory || '-'}</div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label font-medium">总金额（含税）</label>
                                        <div class="form-input">${formatCurrency(order.totalAmount || 0)}</div>
                                    </div>
                                    <div class="form-group md:col-span-2">
                                        <label class="form-label font-medium">备注</label>
                                        <div class="form-input">${order.remarks || '-'}</div>
                                    </div>
                                </div>
                                
                                <h3 class="text-lg font-medium mb-3">产品列表</h3>
                                <div class="overflow-x-auto">
                                    <table class="table w-full">
                                        <thead>
                                            <tr>
                                                <th>产品名称</th>
                                                <th>规格型号</th>
                                                <th>单价</th>
                                                <th>数量</th>
                                                <th>单位</th>
                                                <th>金额</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(order.products || []).map(product => `
                                                <tr>
                                                    <td>${product.productName || '-'}</td>
                                                    <td>${product.specification || '-'}</td>
                                                    <td>${formatCurrency(product.unitPrice || 0)}</td>
                                                    <td>${formatQuantity(product.quantity || 0)}</td>
                                                    <td>${product.unit || '-'}</td>
                                                    <td>${formatCurrency(product.amount || 0)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="4" class="text-right font-bold">总金额：</td>
                                                <td>${formatCurrency(order.totalAmount || 0)}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                
                                <div class="flex justify-end mt-6">
                                    <button class="btn btn-primary" id="closeViewPurchaseOrderBtn">关闭</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加到页面
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 关闭模态框函数
                const closeModal = () => {
                    const modal = document.getElementById('viewPurchaseOrderModal');
                    if (modal) {
                        modal.remove();
                    }
                };
                
                // 绑定关闭事件
                setTimeout(() => {
                    const closeXBtn = document.getElementById('closeViewPurchaseOrderModal');
                    const closeBtn = document.getElementById('closeViewPurchaseOrderBtn');
                    const modal = document.getElementById('viewPurchaseOrderModal');
                    
                    if (closeXBtn) closeXBtn.addEventListener('click', closeModal);
                    if (closeBtn) closeBtn.addEventListener('click', closeModal);
                    
                    // 点击模态框外部关闭
                    const handleClickOutside = function(e) {
                        if (e.target === modal) closeModal();
                    };
                    
                    window.addEventListener('click', handleClickOutside);
                    
                    // 确保在模态框关闭时移除事件监听器
                    const originalCloseModal = closeModal;
                    closeModal = function() {
                        window.removeEventListener('click', handleClickOutside);
                        originalCloseModal();
                    };
                }, 0);
                
            } catch (error) {
                console.error('Error viewing purchase order:', error);
                alert('查看采购订单时出错');
            }
        }
        
        // 将函数暴露到全局作用域
        window.viewPurchaseOrder = viewPurchaseOrder;

        // 编辑采购订单
        function editPurchaseOrder(id) {
            console.log('Editing purchase order with ID:', id);
            
            // 参数验证
            if (!id && id !== 0) {
                console.error('Invalid purchase order ID');
                alert('编辑失败：无效的订单ID');
                return;
            }
            
            try {
                const storageKey = `purchaseOrders_${currentCompany}`;
                console.log('Using storage key:', storageKey);
                
                // 获取当前订单列表
                const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                const order = purchaseOrders.find(o => o.id === id);
                
                if (!order) {
                    console.error('Order with ID', id, 'not found');
                    alert('编辑失败：未找到指定的采购订单');
                    return;
                }
                
                // 获取DOM元素
                const modal = document.getElementById('newPurchaseOrderModal');
                const productList = document.getElementById('productList');
                const form = document.getElementById('newPurchaseOrderForm');
                
                if (!modal || !productList || !form) {
                    console.error('Modal or form elements not found');
                    alert('编辑失败：界面元素加载错误');
                    return;
                }
                
                // 打开模态框
                modal.classList.remove('hidden');
                // 修改模态框标题为"编辑采购合同"
                const modalTitle = modal.querySelector('h2');
                if (modalTitle) {
                    modalTitle.textContent = '编辑采购合同';
                }
                console.log('Edit modal displayed');
                // 保存原始标题，以便取消时恢复
                modal.dataset.originalTitle = modalTitle.textContent;
                
                // 填充表单数据，添加空值检查
                const contractNumberInput = document.getElementById('contractNumber');
                contractNumberInput.value = order.contractNumber || '';
                contractNumberInput.readOnly = true; // 编辑模式下合同号只读
                
                document.getElementById('supplier').value = order.supplier || '';
                document.getElementById('orderDate').value = order.orderDate || '';
                document.getElementById('deliveryDate').value = order.deliveryDate || '';
                document.getElementById('actualArrivalDate').value = order.actualArrivalDate || '';
                
                // 填充成本类别
                document.getElementById('costCategory').value = order.costCategory || '';
                
                document.getElementById('remarks').value = order.remarks || '';
                document.getElementById('totalAmount').value = order.totalAmount ? order.totalAmount.toFixed(2) : '0.00';
                
                // 清空现有产品行
                while (productList.children.length > 1) {
                    productList.removeChild(productList.lastElementChild);
                }
                
                // 填充产品数据
                if (Array.isArray(order.products)) {
                    order.products.forEach((product, index) => {
                        if (product) { // 确保产品对象有效
                            if (index === 0) {
                                // 第一个产品行
                                const firstRow = productList.firstElementChild;
                                if (firstRow) {
                                    firstRow.querySelector('.product-name').value = product.productName || '';
                                    firstRow.querySelector('.product-specification').value = product.specification || '';
                                    firstRow.querySelector('.product-unit-price').value = product.unitPrice || '';
                                    firstRow.querySelector('.product-quantity').value = product.quantity || '';
                                    firstRow.querySelector('.product-unit').value = product.unit || '只';
                                    firstRow.querySelector('.product-amount').value = product.amount ? product.amount.toFixed(2) : '0.00';
                                    
                                    // 启用第一个产品行的删除按钮并绑定事件
                                    const removeBtn = firstRow.querySelector('.remove-product-btn');
                                    if (removeBtn) {
                                        removeBtn.disabled = false;
                                        removeBtn.addEventListener('click', function() {
                                            firstRow.remove();
                                            calculateTotalAmount();
                                        });
                                    }
                                }
                            } else {
                                // 添加新的产品行
                                const addBtn = document.getElementById('addProductBtn');
                                if (addBtn) {
                                    addBtn.click();
                                    
                                    const rows = document.querySelectorAll('.product-row');
                                    const newRow = rows[rows.length - 1];
                                    if (newRow) {
                                        newRow.querySelector('.product-name').value = product.productName || '';
                                        newRow.querySelector('.product-specification').value = product.specification || '';
                                        newRow.querySelector('.product-unit-price').value = product.unitPrice || '';
                                        newRow.querySelector('.product-quantity').value = product.quantity || '';
                                        newRow.querySelector('.product-unit').value = product.unit || '只';
                                        newRow.querySelector('.product-amount').value = product.amount ? product.amount.toFixed(2) : '0.00';
                                    }
                                }
                            }
                        }
                    });
                }
                
                // 重新计算总金额
                if (typeof calculateTotalAmount === 'function') {
                    calculateTotalAmount();
                }
                
                // 使用更可靠的方式处理表单提交，避免与原始的addEventListener冲突
                // 首先，移除所有可能的submit事件监听器
                const newForm = form.cloneNode(true);
                
                // 在替换表单之前，保存成本类别的值
                const costCategoryValue = document.getElementById('costCategory').value;
                
                // 替换表单
                form.parentNode.replaceChild(newForm, form);
                
                // 重新获取引用
                const updatedForm = newForm;
                
                // 重新设置成本类别的值
                document.getElementById('costCategory').value = costCategoryValue;
                
                // 重新绑定取消按钮事件
                const cancelBtn = document.getElementById('cancelPurchaseOrderBtn');
                if (cancelBtn) {
                    cancelBtn.onclick = function() {
                        const modal = document.getElementById('newPurchaseOrderModal');
                        modal.classList.add('hidden');
                        // 恢复原始标题
                        const modalTitle = modal.querySelector('h2');
                        if (modalTitle && modal.dataset.originalTitle) {
                            modalTitle.textContent = modal.dataset.originalTitle;
                        }
                        // 恢复合同号输入框的可编辑状态
                        document.getElementById('contractNumber').readOnly = false;
                    };
                }
                
                // 为所有产品行的删除按钮绑定事件
                function bindDeleteEvents() {
                    const productRows = document.querySelectorAll('.product-row');
                    productRows.forEach((row, index) => {
                        const removeBtn = row.querySelector('.remove-product-btn');
                        if (removeBtn) {
                            // 如果不是唯一的一行，则启用删除按钮
                            removeBtn.disabled = productRows.length <= 1;
                            
                            // 先移除可能存在的事件监听器，避免重复绑定
                            removeBtn.onclick = null;
                            
                            // 绑定新的删除事件
                            removeBtn.onclick = function() {
                                if (productRows.length > 1) {
                                    row.remove();
                                    calculateTotalAmount();
                                    // 重新绑定剩余行的删除事件，确保状态正确
                                    bindDeleteEvents();
                                }
                            };
                        }
                    });
                }
                
                // 绑定初始删除事件
                bindDeleteEvents();
                
                // 重新绑定添加产品按钮事件
                const addProductBtn = document.getElementById('addProductBtn');
                if (addProductBtn) {
                    addProductBtn.onclick = function() {
                        const productList = document.getElementById('productList');
                        const productRowTemplate = productList.firstElementChild.cloneNode(true);
                        
                        // 重置输入值
                        const inputs = productRowTemplate.querySelectorAll('input');
                        inputs.forEach(input => {
                            if (input.type !== 'readonly') {
                                input.value = '';
                            }
                        });
                        
                        // 添加新行
                        productList.appendChild(productRowTemplate);
                        
                        // 重新绑定所有删除事件
                        bindDeleteEvents();
                    };
                }
                
                // 添加编辑模式的提交处理函数
                updatedForm.addEventListener('submit', function editSubmitHandler(e) {
                    e.preventDefault();
                    
                    try {
                        // 收集表单数据
                        const updatedOrder = {
                            ...order, // 保留原有ID
                            contractNumber: document.getElementById('contractNumber').value,
                            supplier: document.getElementById('supplier').value,
                            orderDate: document.getElementById('orderDate').value,
                            deliveryDate: document.getElementById('deliveryDate').value,
                            actualArrivalDate: document.getElementById('actualArrivalDate').value || null,
                            costCategory: document.getElementById('costCategory').value || null,
                            remarks: document.getElementById('remarks').value || null,
                            products: []
                        };
                        
                        // 表单验证
                        if (!updatedOrder.contractNumber || !updatedOrder.supplier || !updatedOrder.orderDate) {
                            alert('请填写必要字段（合同编号、供应商、订单日期）');
                            return;
                        }
                        
                        // 收集产品数据
                        const productRows = document.querySelectorAll('.product-row');
                        productRows.forEach((productRow, index) => {
                            const product = {
                                productName: productRow.querySelector('.product-name').value,
                                specification: productRow.querySelector('.product-specification').value,
                                unitPrice: parseFloat(productRow.querySelector('.product-unit-price').value) || 0,
                                quantity: parseInt(productRow.querySelector('.product-quantity').value) || 0,
                                unit: productRow.querySelector('.product-unit').value,
                                amount: parseFloat(productRow.querySelector('.product-amount').value) || 0
                            };
                            updatedOrder.products.push(product);
                        });
                        
                        // 收集总金额
                        updatedOrder.totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
                        
                        // 更新localStorage
                        let updatedOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                        // 首先确保没有重复的记录，如果有则删除旧记录
                        updatedOrders = updatedOrders.filter(o => o.id !== id);
                        // 然后添加更新后的记录
                        updatedOrders.push(updatedOrder);
                        localStorage.setItem(storageKey, JSON.stringify(updatedOrders));
                        console.log('Successfully updated order in localStorage');
                        
                        // 移除提交事件监听器
                        updatedForm.removeEventListener('submit', editSubmitHandler);
                        
                        // 恢复合同号输入框的可编辑状态
                        document.getElementById('contractNumber').readOnly = false;
                        // 恢复原始标题
                        const modalTitle = modal.querySelector('h2');
                        if (modalTitle && modal.dataset.originalTitle) {
                            modalTitle.textContent = modal.dataset.originalTitle;
                        }
                        
                        // 关闭模态框并重置表单
                        modal.classList.add('hidden');
                        updatedForm.reset();
                        if (typeof resetProductList === 'function') {
                            resetProductList();
                        }
                        
                        // 重新渲染采购订单列表
                        if (typeof renderPurchaseOrderList === 'function') {
                            renderPurchaseOrderList();
                            console.log('Successfully re-rendered purchase order list');
                        } else {
                            console.error('renderPurchaseOrderList function not found');
                            location.reload();
                        }
                        
                        alert('采购订单更新成功！');
                    } catch (submitError) {
                        console.error('Error submitting edit form:', submitError);
                        alert('更新采购订单时发生错误');
                        // 移除提交事件监听器
                        updatedForm.removeEventListener('submit', editSubmitHandler);
                        // 恢复合同号输入框的可编辑状态
                        document.getElementById('contractNumber').readOnly = false;
                        // 恢复原始标题
                        const modal = document.getElementById('newPurchaseOrderModal');
                        const modalTitle = modal.querySelector('h2');
                        if (modalTitle && modal.dataset.originalTitle) {
                            modalTitle.textContent = modal.dataset.originalTitle;
                        }
                    }
                });
            } catch (error) {
                console.error('Error editing purchase order:', error);
                alert('打开编辑界面时发生错误');
            }
        }
        
        // 将函数暴露到全局作用域
        window.editPurchaseOrder = editPurchaseOrder;
        
        // 删除采购订单
        function deletePurchaseOrder(id) {
            console.log('Attempting to delete purchase order with ID:', id);
            
            // 参数验证
            if (!id && id !== 0) {
                console.error('Invalid purchase order ID');
                alert('删除失败：无效的订单ID');
                return;
            }
            
            if (confirm('确定要删除该采购订单吗？此操作不可恢复。')) {
                try {
                    const storageKey = `purchaseOrders_${currentCompany}`;
                    console.log('Using storage key:', storageKey);
                    
                    // 获取当前订单列表
                    let purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                    console.log('Current orders before deletion:', purchaseOrders.length);
                    
                    // 记录删除前的订单数量
                    const originalLength = purchaseOrders.length;
                    
                    // 过滤掉要删除的订单
                    purchaseOrders = purchaseOrders.filter(order => order.id !== id);
                    console.log('Orders after deletion:', purchaseOrders.length);
                    
                    // 验证是否成功删除
                    if (purchaseOrders.length === originalLength) {
                        console.error('Order with ID', id, 'not found');
                        alert('删除失败：未找到指定的采购订单');
                        return;
                    }
                    
                    // 更新localStorage
                    localStorage.setItem(storageKey, JSON.stringify(purchaseOrders));
                    console.log('Successfully updated localStorage');
                    
                    // 重新渲染采购订单列表
                    if (typeof renderPurchaseOrderList === 'function') {
                        renderPurchaseOrderList();
                        console.log('Successfully re-rendered purchase order list');
                    } else {
                        console.error('renderPurchaseOrderList function not found');
                        // 如果函数不存在，刷新页面以更新列表
                        location.reload();
                    }
                    
                    alert('采购订单删除成功！');
                    
                } catch (error) {
                    console.error('Error deleting purchase order:', error);
                    alert('删除采购订单时发生错误');
                }
            }
        }
        
        // 将函数暴露到全局作用域
        window.deletePurchaseOrder = deletePurchaseOrder;
        
        // 生成采购合同
        function generateContract(id) {
            console.log('Generating contract for purchase order ID:', id);
            
            // 参数验证
            if (!id && id !== 0) {
                console.error('Invalid purchase order ID');
                alert('生成合同失败：无效的订单ID');
                return;
            }
            
            try {
                const storageKey = `purchaseOrders_${currentCompany}`;
                console.log('Using storage key:', storageKey);
                
                // 获取当前订单列表
                const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                const order = purchaseOrders.find(o => o.id === id);
                
                if (!order) {
                    console.error('Order with ID', id, 'not found');
                    alert('生成合同失败：未找到指定的采购订单');
                    return;
                }
                
                // 获取供应商完整信息
                const suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
                let supplierInfo = null;
                
                if (order.supplier) {
                    supplierInfo = suppliers.find(supplier => {
                        // 尝试多种匹配方式
                        return supplier.supplierName === order.supplier || 
                               supplier.name === order.supplier || 
                               supplier.supplierId === order.supplier;
                    });
                }
                
                // 获取当前公司名称
                let companyName = '默认公司';
                const companySelect = document.getElementById('company-select');
                
                if (companySelect) {
                    companyName = companySelect.options[companySelect.selectedIndex].text || '默认公司';
                } else {
                    console.warn('Company select element not found, using default company name');
                }
                
                // 根据公司名称设置公司地址、联系人和电话
                let buyerCompanyAddress = 'XX省XX市XX区XX路XX号';
                let buyerContactPerson = 'XXX';
                let buyerPhoneNumber = 'XXX-XXXXXXX';
                
                if (companyName.includes('无锡龙力')) {
                    buyerCompanyAddress = '无锡市新吴区龙山路4号c幢603';
                    buyerContactPerson = '吴小英';
                    buyerPhoneNumber = '139 5159 9291';
                } else if (companyName.includes('普利美')) {
                    buyerCompanyAddress = '常州市武进区雪堰镇周南路8号6-1（中南高科常州雪堰智造产业园）';
                    buyerContactPerson = 'AlonZhang';
                    buyerPhoneNumber = '136 6511 9291';
                }
                
                // 编码合同数据，排除不需要的字段
                const contractData = { ...order };
                
                // 安全删除属性
                if (contractData.hasOwnProperty('actualArrivalDate')) {
                    delete contractData.actualArrivalDate;
                }
                if (contractData.hasOwnProperty('costCategory')) {
                    delete contractData.costCategory;
                }
                // 保留remarks字段并将其赋值给orderRemark，用于在合同页面显示订单备注
                if (contractData.hasOwnProperty('remarks')) {
                    contractData.orderRemark = contractData.remarks;
                }
                
                // 添加供应商完整信息和当前公司信息
                contractData.supplierInfo = supplierInfo || { supplierName: order.supplier || '未知供应商' };
                contractData.companyName = companyName;
                contractData.buyerCompanyAddress = buyerCompanyAddress;
                contractData.buyerContactPerson = buyerContactPerson;
                contractData.buyerPhoneNumber = buyerPhoneNumber;
                
                // 验证合同数据完整性
                if (!contractData.contractNumber || !contractData.supplier) {
                    console.error('Incomplete order data for contract generation:', contractData);
                    alert('生成合同失败：订单数据不完整');
                    return;
                }
                
                // 序列化并编码数据
                let encodedData;
                try {
                    encodedData = encodeURIComponent(JSON.stringify(contractData));
                    console.log('Successfully encoded contract data');
                } catch (jsonError) {
                    console.error('Error encoding contract data:', jsonError);
                    alert('生成合同失败：数据编码错误');
                    return;
                }
                
                // 打开新合同页面
                const contractPageUrl = `procurement contract.html?data=${encodedData}`;
                
                // 检查window.open是否可用
                if (typeof window.open === 'function') {
                    try {
                        window.open(contractPageUrl, '_blank');
                        console.log('Contract page opened successfully');
                        alert('采购合同生成成功！');
                    } catch (windowError) {
                        console.error('Error opening contract page:', windowError);
                        // 提供备用方案
                        alert('采购合同生成成功！请复制以下链接在新标签页中打开：\n' + contractPageUrl);
                    }
                } else {
                    // 备用方案
                    alert('采购合同生成成功！请复制以下链接在新标签页中打开：\n' + contractPageUrl);
                }
            } catch (error) {
                console.error('Error generating contract:', error);
                alert('生成采购合同时发生错误');
            }
        }
        
        // 将函数暴露到全局作用域
        window.generateContract = generateContract;

        // 渲染采购订单列表
        // 分页相关变量
        let currentPage = 1;
        let pageSize = 10;
        let searchKeyword = '';
        // 查询相关变量
        let currentQueryParams = {};
        let isInQueryMode = false;

        // 获取采购订单的发票状态
        function getOrderInvoiceStatus(contractNumber) {
            const invoiceStorageKey = `${getCurrentCompany()}-invoices`;
            const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
            
            // 查找关联到此合同号的所有发票，支持单个合同号、数组或多个合同号的字符串
            const relatedInvoices = invoices.filter(invoice => {
                // 处理数组类型
                if (Array.isArray(invoice.purchaseOrder)) {
                    return invoice.purchaseOrder.includes(contractNumber);
                }
                // 处理字符串类型，支持逗号分隔或空格分隔的多个合同号
                else if (typeof invoice.purchaseOrder === 'string') {
                    // 拆分字符串为数组并检查是否包含目标合同号
                    const purchaseOrders = invoice.purchaseOrder.split(/[,，\s]+/).map(p => p.trim());
                    return purchaseOrders.includes(contractNumber);
                }
                // 处理单个合同号
                return invoice.purchaseOrder === contractNumber;
            });
            
            if (relatedInvoices.length === 0) {
                return { status: '未开票', cssClass: 'badge-warning' };
            }
            
            // 检查是否所有发票都已付清
            const allPaid = relatedInvoices.every(invoice => invoice.status === '已付清');
            const hasPartial = relatedInvoices.some(invoice => invoice.status === '部分付款');
            const hasUnpaid = relatedInvoices.some(invoice => invoice.status === '未付款');
            
            if (allPaid) {
                return { status: '已开票-已付清', cssClass: 'badge-success' };
            } else if (hasPartial && !hasUnpaid) {
                return { status: '已开票-部分付款', cssClass: 'badge-info' };
            } else if (hasUnpaid) {
                return { status: '已开票-未付款', cssClass: 'badge-danger' };
            } else {
                return { status: '已开票', cssClass: 'badge-primary' };
            }
        }
        
        // 获取采购订单的付款状态
        function getOrderPaymentStatus(contractNumber) {
            const paymentStorageKey = `${getCurrentCompany()}-payments`;
            const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
            
            // 查找关联到此合同号的所有付款记录，支持单个合同号、数组或多个合同号的字符串
            const relatedPayments = payments.filter(payment => {
                // 处理凭合同付款模式，使用contractNumber字段
                if (payment.paymentType === 'contract-first' && payment.contractNumber) {
                    return payment.contractNumber === contractNumber;
                }
                
                // 处理其他情况，使用purchaseOrder字段
                // 处理数组类型
                if (Array.isArray(payment.purchaseOrder)) {
                    return payment.purchaseOrder.includes(contractNumber);
                }
                // 处理字符串类型，支持逗号分隔或空格分隔的多个合同号
                else if (typeof payment.purchaseOrder === 'string') {
                    // 拆分字符串为数组并检查是否包含目标合同号
                    const purchaseOrders = payment.purchaseOrder.split(/[,，\s]+/).map(p => p.trim());
                    return purchaseOrders.includes(contractNumber);
                }
                // 处理单个合同号
                return payment.purchaseOrder === contractNumber;
            });
            
            if (relatedPayments.length === 0) {
                return { status: '未付款', cssClass: 'badge-danger' };
            }
            
            // 计算总付款金额
            const totalPaid = relatedPayments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
            
            // 获取订单信息以计算总金额
            let orderAmount = 0;
            
            // 先尝试从contracts中获取合同信息（凭合同付款模式）
            const contractStorageKey = `${currentCompany}-contracts`;
            const contracts = JSON.parse(localStorage.getItem(contractStorageKey)) || [];
            const contract = contracts.find(c => c.contractNumber === contractNumber);
            
            if (contract && contract.amount) {
                orderAmount = parseFloat(contract.amount);
            } else {
                // 如果contracts中没有，尝试从purchaseOrders中获取
                const orderStorageKey = `purchaseOrders_${currentCompany}`;
                const orders = JSON.parse(localStorage.getItem(orderStorageKey)) || [];
                const order = orders.find(o => o.contractNumber === contractNumber);
                
                if (!order || !order.totalAmount) {
                    return { status: '部分付款', cssClass: 'badge-warning' };
                }
                
                orderAmount = parseFloat(order.totalAmount);
            }
            
            const paymentRatio = (totalPaid / orderAmount) * 100;
            
            if (paymentRatio >= 100) {
                return { status: '已全额付款', cssClass: 'badge-success' };
            } else if (paymentRatio > 0) {
                return { status: `部分付款 (${paymentRatio.toFixed(1)}%)`, cssClass: 'badge-warning' };
            } else {
                return { status: '未付款', cssClass: 'badge-danger' };
            }
        }
        
        // 获取合同号的产品状态
        function getContractProductStatus(contractNumber) {
            // 从contract-inventory.html的localStorage中读取合同数据
            const currentCompany = getCurrentCompany();
            const contractStorageKey = `contracts_${currentCompany}`;
            const contracts = JSON.parse(localStorage.getItem(contractStorageKey)) || [];
            
            // 查找对应合同号的合同
            const contract = contracts.find(c => c.contractNumber === contractNumber);
            if (!contract) {
                return { status: '', cssClass: '' };
            }
            
            // 根据合同状态确定CSS类
            let cssClass = '';
            switch (contract.status) {
                case '未开始':
                    cssClass = 'badge-info';
                    break;
                case '执行中':
                    cssClass = 'badge-warning';
                    break;
                case '执行完毕':
                    cssClass = 'badge-success';
                    break;
                default:
                    cssClass = '';
            }
            
            // 返回合同状态和CSS类
            return { status: contract.status, cssClass: cssClass };
        }
        
        // 获取采购订单的合并状态（产品状态 + 发票状态 + 付款状态）
        function getOrderCombinedStatus(contractNumber) {
            // 获取产品状态
            const productStatus = getContractProductStatus(contractNumber);
            
            // 获取发票状态
            const invoiceStatus = getOrderInvoiceStatus(contractNumber);
            
            // 获取付款状态
            const paymentStatus = getOrderPaymentStatus(contractNumber);
            
            // 检查发票状态是否已经包含付款信息（凭发票付款模式）
            // 如果发票状态包含"已付清"、"部分付款"、"未付款"等关键词，则表示已经包含付款信息
            const invoiceContainsPaymentInfo = invoiceStatus.status.includes('已付清') || 
                                              invoiceStatus.status.includes('部分付款') || 
                                              invoiceStatus.status.includes('未付款');
            
            // 生成合并状态
            let combinedStatus;
            if (invoiceContainsPaymentInfo) {
                // 发票状态已经包含付款信息，只合并产品状态和发票状态
                combinedStatus = productStatus.status ? `${getStatusText(productStatus.status)}-${invoiceStatus.status}` : invoiceStatus.status;
            } else {
                // 发票状态不包含付款信息，合并产品状态、发票状态和付款状态
                combinedStatus = productStatus.status ? `${getStatusText(productStatus.status)}-${invoiceStatus.status}-${paymentStatus.status}` : `${invoiceStatus.status} + ${paymentStatus.status}`;
            }
            
            // 确定合并后的CSS类
            let combinedCssClass;
            
            // 特殊处理：只有"执行完毕-已开票-已付清"使用深绿色
            if (combinedStatus === '执行完毕-已开票-已付清') {
                combinedCssClass = 'badge-success';
            } else {
                // 其他所有状态都使用除了绿色以外的颜色
                // 直接根据具体状态设置颜色，而不是依赖于优先级
                if (combinedStatus.includes('未付款') || combinedStatus.includes('部分付款')) {
                    combinedCssClass = 'badge-danger';
                } else if (combinedStatus.includes('未开票')) {
                    combinedCssClass = 'badge-warning';
                } else if (combinedStatus.includes('执行中')) {
                    combinedCssClass = 'badge-info';
                } else {
                    combinedCssClass = 'badge-primary';
                }
            }
            
            return { status: combinedStatus, cssClass: combinedCssClass };
        }
        
        function renderPurchaseOrderList() {
            // 更新查询状态显示
            const queryStatus = document.getElementById('queryStatus');
            if (queryStatus) {
                if (isInQueryMode) {
                    queryStatus.classList.remove('hidden');
                } else {
                    queryStatus.classList.add('hidden');
                }
            }
            
            const currentCompany = getCurrentCompany();
            const storageKey = `purchaseOrders_${currentCompany}`;
            console.log('Rendering orders for company:', currentCompany);
            console.log('Using storage key:', storageKey);
            let purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
            console.log('Orders found:', purchaseOrders.length);
            const tableBody = document.getElementById('purchaseOrderTableBody');
            
            // 搜索过滤
            if (searchKeyword) {
                const keyword = searchKeyword.toLowerCase();
                purchaseOrders = purchaseOrders.filter(order => {
                    // 基本字段搜索
                    const basicFieldsMatch = (order.contractNumber && order.contractNumber.toLowerCase().includes(keyword)) ||
                                           (order.supplier && order.supplier.toLowerCase().includes(keyword)) ||
                                           (order.costCategory && order.costCategory.toLowerCase().includes(keyword)) ||
                                           (order.remarks && order.remarks.toLowerCase().includes(keyword));
                    
                    // 产品字段搜索
                    let productFieldsMatch = false;
                    if (Array.isArray(order.products)) {
                        productFieldsMatch = order.products.some(product => {
                            return (product.productName && product.productName.toLowerCase().includes(keyword)) ||
                                   (product.specification && product.specification.toLowerCase().includes(keyword)) ||
                                   (product.unitPrice && product.unitPrice.toString().includes(keyword)) ||
                                   (product.quantity && product.quantity.toString().includes(keyword));
                        });
                    }
                    
                    return basicFieldsMatch || productFieldsMatch;
                });
            }
            
            // 查询参数过滤
            if (isInQueryMode && Object.keys(currentQueryParams).length > 0) {
                purchaseOrders = purchaseOrders.filter(order => {
                    // 供应商过滤
                    if (currentQueryParams.supplier && 
                        (!order.supplier || !order.supplier.toLowerCase().includes(currentQueryParams.supplier.toLowerCase()))) {
                        return false;
                    }
                    
                    // 成本类型过滤
                    if (currentQueryParams.costType && 
                        (!order.costCategory || !order.costCategory.toLowerCase().includes(currentQueryParams.costType.toLowerCase()))) {
                        return false;
                    }
                    
                    // 分类过滤
                    if (currentQueryParams.category && 
                        (!order.category || !order.category.toLowerCase().includes(currentQueryParams.category.toLowerCase()))) {
                        return false;
                    }
                    
                    // 日期范围过滤
                    if (currentQueryParams.startDate || currentQueryParams.endDate) {
                        const orderDate = order.orderDate ? new Date(order.orderDate) : null;
                        if (!orderDate) {
                            return false;
                        }
                        
                        if (currentQueryParams.startDate && orderDate < new Date(currentQueryParams.startDate)) {
                            return false;
                        }
                        
                        if (currentQueryParams.endDate) {
                            const endDate = new Date(currentQueryParams.endDate);
                            endDate.setHours(23, 59, 59, 999); // 设置为当天结束时间
                            if (orderDate > endDate) {
                                return false;
                            }
                        }
                    }
                    
                    // 产品名称过滤 - 需要检查订单中的所有产品
                    if (currentQueryParams.productName) {
                        const productName = currentQueryParams.productName.toLowerCase();
                        if (!Array.isArray(order.products)) {
                            return false;
                        }
                        const hasMatchingProduct = order.products.some(product => {
                            return product.productName && product.productName.toLowerCase().includes(productName);
                        });
                        if (!hasMatchingProduct) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }
            
            // 按合同日期倒序排序
            purchaseOrders.sort((a, b) => {
                const dateA = a.orderDate ? new Date(a.orderDate) : new Date(0);
                const dateB = b.orderDate ? new Date(b.orderDate) : new Date(0);
                return dateB - dateA; // 倒序排序
            });
            
            // 清空表格
            tableBody.innerHTML = '';
            
            if (purchaseOrders.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="10" class="text-center py-4 text-gray-500">暂无采购订单数据</td>`;
                tableBody.appendChild(emptyRow);
                
                // 更新统计信息
                document.getElementById('totalRecords').textContent = '0';
                document.getElementById('currentPage').textContent = '1';
                document.getElementById('totalPages').textContent = '1';
                
                // 更新合计
                document.getElementById('totalAmountSum').textContent = '¥0.00';
                
                return;
            }
            
            // 更新记录条数
            document.getElementById('totalRecords').textContent = purchaseOrders.length;
            
            // 分页计算
            const totalPages = Math.ceil(purchaseOrders.length / pageSize);
            document.getElementById('totalPages').textContent = totalPages;
            
            // 确保当前页在有效范围内
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            
            // 获取当前页的数据
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const currentPageOrders = purchaseOrders.slice(startIndex, endIndex);
            
            // 渲染每个采购订单
            currentPageOrders.forEach(order => {
                // 格式化日期
                const formatDate = (dateString) => {
                    if (!dateString) return '-';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date)) return '-';
                        return date.toISOString().split('T')[0];
                    } catch (error) {
                        return '-';
                    }
                };
                
                // 获取产品列表（如果有）
                const products = Array.isArray(order.products) ? order.products : [];
                
                // 为每个产品创建表格行
                products.forEach((product, index) => {
                    const row = document.createElement('tr');
                    
                    // 判断是否为第一个产品
                    const isFirstProduct = index === 0;
                    
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="rounded text-primary focus:ring-primary">
                        </td>

                        <td>${isFirstProduct ? (order.contractNumber || 'N/A') : ''}</td>
                        <td>
                            ${isFirstProduct ? `<span class="badge ${getOrderCombinedStatus(order.contractNumber).cssClass}">${getOrderCombinedStatus(order.contractNumber).status}</span>` : ''}
                        </td>
                        <td>${isFirstProduct ? (order.supplier || 'N/A') : ''}</td>
                        <td>${isFirstProduct ? formatDate(order.orderDate) : ''}</td>
                        <td>${isFirstProduct ? formatDate(order.deliveryDate) : ''}</td>
                        <td>${isFirstProduct ? formatDate(order.actualArrivalDate) : ''}</td>
                        <td>${product.productName || '-'}</td>
                        <td>${product.specification || '-'}</td>
                        <td>${formatCurrency(product.unitPrice || 0)}</td>
                        <td>${formatQuantity(product.quantity || '-')}</td>
                        <td>${product.unit || '-'}</td>
                        <td style="width: 140px !important; min-width: 140px !important; max-width: 140px !important;">${isFirstProduct ? formatCurrency(order.totalAmount) : ''}</td>
                        <td>${isFirstProduct ? (order.costCategory || '-') : ''}</td>
                        <td>${isFirstProduct ? (order.remarks || '-') : ''}</td>
                        <td class="action-buttons">
                            ${isFirstProduct ? `
                            <button class="btn btn-small btn-primary" onclick="viewPurchaseOrder(${order.id})" title="查看">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="editPurchaseOrder(${order.id})" title="编辑">
                                <i class="fa fa-pencil"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deletePurchaseOrder(${order.id})" title="删除">
                                <i class="fa fa-trash"></i>
                            </button>
                            <button class="btn btn-small btn-success" onclick="generateContract(${order.id})" title="生成采购合同">
                                <i class="fa fa-file-text-o"></i>
                            </button>` : ''}
                        </td>
                    `;
                        
                        tableBody.appendChild(row);
                 
                 // 为复选框添加选中行背景色功能
                 const checkbox = row.querySelector('input[type="checkbox"]');
                 if (checkbox) {
                     checkbox.addEventListener('change', function() {
                         if (this.checked) {
                             row.classList.add('bg-blue-50'); // 选中时添加浅蓝色背景
                         } else {
                             row.classList.remove('bg-blue-50'); // 取消选中时移除背景色
                         }
                     });
                 }
                 
                 // 为行添加双击事件 - 打开查看模态框
                 row.classList.add('cursor-pointer');
                 row.addEventListener('dblclick', function() {
                     if (order && order.id !== undefined) {
                         viewPurchaseOrder(order.id);
                     }
                 });
                    });
            });
            
            // 计算总金额合计
            const totalAmount = purchaseOrders.reduce((sum, order) => sum + parseFloat(order.totalAmount || 0), 0);
            document.getElementById('totalAmountSum').textContent = formatCurrency(totalAmount);
            
            // 计算总数量合计
            let totalQuantity = 0;
            purchaseOrders.forEach(order => {
                if (Array.isArray(order.products)) {
                    order.products.forEach(product => {
                        totalQuantity += parseFloat(product.quantity || 0);
                    });
                }
            });
            document.getElementById('totalQuantitySum').textContent = formatQuantity(totalQuantity);

            // 添加复选框事件监听，实现选中合计功能
            const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updatePurchaseOrderSelectionTotal);
            });
            
            // 渲染分页控件
            renderPaginationControls();
        }
        
        function renderPaginationControls() {
            const storageKey = `purchaseOrders_${currentCompany}`;
            const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
            const totalPages = Math.ceil(purchaseOrders.length / pageSize);
            const paginationContainer = document.querySelector('#paginationControls .flex.items-center.gap-1');
            
            // 清空现有页码按钮
            paginationContainer.innerHTML = '';
            
            // 生成页码按钮
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.className = `btn btn-small ${i === currentPage ? 'btn-primary' : 'btn-secondary'}`;
                button.textContent = i;
                button.onclick = () => {
                    currentPage = i;
                    renderPurchaseOrderList();
                };
                paginationContainer.appendChild(button);
            }
            
            // 更新当前页显示
            document.getElementById('currentPage').textContent = currentPage;
            
            // 控制导航按钮状态
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            lastPageBtn.disabled = currentPage === totalPages;
        }
        // 供应商管理模态框处理
        // 查询功能相关函数
        function initQueryFunctionality() {
            const queryModal = document.getElementById('queryModal');
            const queryBtn = document.getElementById('query-orders-btn');
            const closeQueryModal = document.getElementById('closeQueryModal');
            const queryForm = document.getElementById('queryForm');
            const resetQueryBtn = document.getElementById('resetQueryBtn');
            const cancelQueryBtn = document.getElementById('cancelQueryBtn');
            
            // 取消查询按钮事件
            if (cancelQueryBtn) {
                cancelQueryBtn.addEventListener('click', clearQuery);
            }
            
            // 显示查询模态框
            if (queryBtn && queryModal) {
                queryBtn.addEventListener('click', function() {
                    queryModal.classList.remove('hidden');
                });
            }
            
            // 关闭查询模态框
            if (closeQueryModal && queryModal) {
                closeQueryModal.addEventListener('click', function() {
                    queryModal.classList.add('hidden');
                });
            }
            
            // 点击模态框外部关闭
            if (queryModal) {
                queryModal.addEventListener('click', function(e) {
                    if (e.target === queryModal) {
                        queryModal.classList.add('hidden');
                    }
                });
            }
            
            // 重置查询表单
            if (resetQueryBtn) {
                resetQueryBtn.addEventListener('click', function() {
                    document.getElementById('querySupplier').value = '';
                    document.getElementById('queryProductName').value = '';
                    document.getElementById('queryCostType').value = '';
                    document.getElementById('queryCategory').value = '';
                    document.getElementById('queryStartDate').value = '';
                    document.getElementById('queryEndDate').value = '';
                });
            }
            
            // 提交查询表单
            if (queryForm) {
                queryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    executeQuery();
                    if (queryModal) {
                        queryModal.classList.add('hidden');
                    }
                });
            }
        }
        
        // 执行查询
        function executeQuery() {
            // 获取查询参数
            const supplier = document.getElementById('querySupplier').value.trim();
            const productName = document.getElementById('queryProductName').value.trim();
            const costType = document.getElementById('queryCostType').value.trim();
            const category = document.getElementById('queryCategory').value.trim();
            const startDate = document.getElementById('queryStartDate').value;
            const endDate = document.getElementById('queryEndDate').value;
            
            // 保存查询参数
            currentQueryParams = {
                supplier,
                productName,
                costType,
                category,
                startDate,
                endDate
            };
            
            // 设置查询模式
            isInQueryMode = true;
            
            // 重置到第一页
            currentPage = 1;
            
            // 重新渲染列表
            renderPurchaseOrderList();
        }
        
        // 清除查询条件
        function clearQuery() {
            currentQueryParams = {};
            isInQueryMode = false;
            currentPage = 1;
            renderPurchaseOrderList();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化查询功能
            initQueryFunctionality();
            
            // 页面加载完成后渲染采购订单列表
            renderPurchaseOrderList();
            
            // 分页导航按钮事件
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            const pageSizeSelect = document.getElementById('pageSize');
            
            if (firstPageBtn) {
                firstPageBtn.addEventListener('click', () => {
                    currentPage = 1;
                    renderPurchaseOrderList();
                });
            }
            
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderPurchaseOrderList();
                    }
                });
            }
            
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const storageKey = `purchaseOrders_${currentCompany}`;
                    const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                    const totalPages = Math.ceil(purchaseOrders.length / pageSize);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderPurchaseOrderList();
                    }
                });
            }
            
            if (lastPageBtn) {
                lastPageBtn.addEventListener('click', () => {
                    const storageKey = `purchaseOrders_${currentCompany}`;
                    const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                    const totalPages = Math.ceil(purchaseOrders.length / pageSize);
                    currentPage = totalPages;
                    renderPurchaseOrderList();
                });
            }
            
            // 每页显示条数事件
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', (e) => {
                    pageSize = parseInt(e.target.value);
                    currentPage = 1;
                    renderPurchaseOrderList();
                });
            }
            
            const newSupplierModal = document.getElementById('newSupplierModal');
            const closeNewSupplierModal = document.getElementById('closeNewSupplierModal');
            const cancelNewSupplierModal = document.getElementById('cancelNewSupplierModal');
            const newSupplierForm = document.getElementById('newSupplierForm');
            const supplierNumberInput = document.getElementById('supplierNumber');
            
            // 自动生成供应商编号
            function generateSupplierNumber() {
                const prefix = 'SUP-';
                const random = Math.floor(1000 + Math.random() * 9000); // 4位随机数
                return prefix + random;
            }
            
            // 打开新建供应商模态框
            const newSupplierBtn = document.querySelector('[data-action="new-supplier"]');
            if (newSupplierBtn) {
                newSupplierBtn.addEventListener('click', function() {
                    // 生成并设置供应商编号
                    supplierNumberInput.value = generateSupplierNumber();
                    newSupplierModal.classList.remove('hidden');
                });
            }
            
            // 关闭新建供应商模态框
            if (closeNewSupplierModal) {
                closeNewSupplierModal.addEventListener('click', function() {
                    newSupplierModal.classList.add('hidden');
                    if (newSupplierForm) {
                        newSupplierForm.reset();
                        // 重新启用供应商编号字段
                        document.getElementById('supplierNumber').disabled = false;
                    }
                });
            }
            
            if (cancelNewSupplierModal) {
                cancelNewSupplierModal.addEventListener('click', function() {
                    newSupplierModal.classList.add('hidden');
                    if (newSupplierForm) {
                        newSupplierForm.reset();
                        // 重新启用供应商编号字段
                        document.getElementById('supplierNumber').disabled = false;
                    }
                });
            }
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target == newSupplierModal) {
                    newSupplierModal.classList.add('hidden');
                    newSupplierForm.reset();
                    // 重新启用供应商编号字段
                    document.getElementById('supplierNumber').disabled = false;
                }
            });
            
            // 保存供应商
            newSupplierForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 收集表单数据
                const supplierData = {
                    supplierNumber: document.getElementById('supplierNumber').value,
                    supplierName: document.getElementById('supplierName').value,
                    contactPerson: document.getElementById('contactPerson').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    email: document.getElementById('email').value,
                    companyAddress: document.getElementById('companyAddress').value,
                    bankName: document.getElementById('bankName').value,
                    bankCode: document.getElementById('bankCode').value,
                    bankAccount: document.getElementById('bankAccount').value,
                    remarks: document.getElementById('supplierRemarks').value
                };
                
                if (isEditing) {
                    // 更新现有供应商
                    const index = suppliers.findIndex(item => item.supplierNumber === supplierData.supplierNumber);
                    if (index !== -1) {
                        suppliers[index] = supplierData;
                    }
                    isEditing = false;
                    console.log('更新供应商:', supplierData);
                } else {
                    // 添加新供应商
                    suppliers.push(supplierData);
                    console.log('保存供应商:', supplierData);
                }
                
                // 关闭模态框并重置表单
                newSupplierModal.classList.add('hidden');
                newSupplierForm.reset();
                
                // 重新渲染供应商列表
                renderSuppliers();
                // 保存到localStorage
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                
                // 重新启用供应商编号字段
                document.getElementById('supplierNumber').disabled = false;
            });
        });
        
        // 扩展String.prototype.contains方法
        if (!String.prototype.contains) {
            String.prototype.contains = function() {
                return String.prototype.indexOf.apply(this, arguments) !== -1;
            };
        }

        // 从localStorage加载供应商数据，如果不存在则使用默认数据
        let suppliers = localStorage.getItem('suppliers') ? JSON.parse(localStorage.getItem('suppliers')) : [
            {
                supplierNumber: 'SUP-1234',
                supplierName: '供应商A',
                contactPerson: '张三',
                phoneNumber: '13800138000',
                email: 'contact@supplierA.com',
                companyAddress: '北京市朝阳区',
                bankName: '中国银行',
                bankCode: '123456789',
                bankAccount: '987654321',
                remarks: '优质供应商'
            },
            {
                supplierNumber: 'SUP-5678',
                supplierName: '供应商B',
                contactPerson: '李四',
                phoneNumber: '13900139000',
                email: 'contact@supplierB.com',
                companyAddress: '上海市浦东新区',
                bankName: '工商银行',
                bankCode: '987654321',
                bankAccount: '123456789',
                remarks: '长期合作伙伴'
            }
        ];

        // 搜索供应商
        function setupSearchFunctionality() {
            const searchInput = document.getElementById('supplier-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredSuppliers = suppliers.filter(supplier => {
                        // 检查所有供应商属性是否包含搜索词
                        for (const key in supplier) {
                            if (supplier.hasOwnProperty(key) && typeof supplier[key] === 'string') {
                                if (supplier[key].toLowerCase().includes(searchTerm)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                    renderSuppliers(filteredSuppliers);
                });
            }
        }

        // 渲染供应商列表
        function renderSuppliers(filteredSuppliers = suppliers) {
            const supplierCardsContainer = document.querySelector('.supplier-cards');
            if (!supplierCardsContainer) return;

            // 清空现有卡片
            supplierCardsContainer.innerHTML = '';

            // 生成新卡片
            filteredSuppliers.forEach(supplier => {
                const supplierCard = document.createElement('div');
                supplierCard.className = 'supplier-card card p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow';
                supplierCard.dataset.supplierNumber = supplier.supplierNumber;
                supplierCard.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold" style="font-size: 6pt;">供应商编号</h3>
                            <p class="text-sm text-gray-600 supplier-number">${supplier.supplierNumber}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <span class="text-sm text-green-700">启用</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-2">
                            <h4 class="text-sm font-medium mb-1">供应商名称</h4>
                            <p class="text-sm bg-green-50 p-2 rounded supplier-name">${supplier.supplierName}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium mb-1">联系人</h4>
                            <p class="text-sm bg-green-50 p-2 rounded contact-person">${supplier.contactPerson}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium mb-1">电话</h4>
                            <p class="text-sm bg-green-50 p-2 rounded phone-number">${supplier.phoneNumber}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium mb-1">电子邮箱</h4>
                            <p class="text-sm email">${supplier.email}</p>
                        </div>
                        <div class="col-span-2">
                            <h4 class="text-sm font-medium mb-1">公司地址</h4>
                            <p class="text-sm company-address">${supplier.companyAddress}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium mb-1">开户行</h4>
                            <p class="text-sm bank-name">${supplier.bankName}</p>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium mb-1">行号</h4>
                            <p class="text-sm bank-code">${supplier.bankCode}</p>
                        </div>
                        <div class="col-span-2">
                            <h4 class="text-sm font-medium mb-1">账号</h4>
                            <p class="text-sm bank-account">${supplier.bankAccount}</p>
                        </div>
                        <div class="col-span-2">
                            <h4 class="text-sm font-medium mb-1">备注</h4>
                            <p class="text-sm remarks">${supplier.remarks}</p>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button class="btn btn-primary btn-sm edit-btn">编辑</button>
                        <button class="btn btn-danger btn-sm delete-btn">删除</button>
                    </div>
                `;
                supplierCardsContainer.appendChild(supplierCard);

                // 为编辑和删除按钮添加事件监听器
                const editBtn = supplierCard.querySelector('.edit-btn');
                const deleteBtn = supplierCard.querySelector('.delete-btn');

                editBtn.addEventListener('click', () => {
                    handleEditSupplier(supplierCard, supplier);
                });

                deleteBtn.addEventListener('click', () => {
                    handleDeleteSupplier(supplier.supplierNumber);
                });
            });
        }

        // 处理编辑供应商
        function handleEditSupplier(supplierCard, supplier) {
            const editBtn = supplierCard.querySelector('.edit-btn');
            
            // 如果已经在编辑状态，则保存修改
            if (editBtn.textContent === '保存') {
                saveSupplierChanges(supplierCard, supplier);
                return;
            }
            
            // 切换到编辑状态
            editBtn.textContent = '保存';
            
            // 转换字段为可编辑状态
            const fields = [
                { className: 'supplier-name', type: 'text' },
                { className: 'contact-person', type: 'text' },
                { className: 'phone-number', type: 'tel' },
                { className: 'email', type: 'email' },
                { className: 'company-address', type: 'text' },
                { className: 'bank-name', type: 'text' },
                { className: 'bank-code', type: 'text' },
                { className: 'bank-account', type: 'text' },
                { className: 'remarks', type: 'textarea' }
            ];
            
            fields.forEach(field => {
                const element = supplierCard.querySelector(`.${field.className}`);
                if (element) {
                    const value = element.textContent || '';
                    let newElement;
                    
                    if (field.type === 'textarea') {
                        newElement = document.createElement('textarea');
                        newElement.className = `${field.className} text-sm w-full p-2 border border-gray-300 rounded`;
                        newElement.value = value;
                    } else {
                        newElement = document.createElement('input');
                        newElement.type = field.type;
                        newElement.className = `${field.className} text-sm w-full p-2 border border-gray-300 rounded`;
                        newElement.value = value;
                    }
                    
                    // 替换原元素
                    element.parentNode.replaceChild(newElement, element);
                }
            });
        }
        
        // 保存供应商修改
        function saveSupplierChanges(supplierCard, supplier) {
            const editBtn = supplierCard.querySelector('.edit-btn');
            
            // 获取所有修改后的值
            const updatedData = {
                supplierNumber: supplier.supplierNumber,
                supplierName: supplierCard.querySelector('.supplier-name').value || '',
                contactPerson: supplierCard.querySelector('.contact-person').value || '',
                phoneNumber: supplierCard.querySelector('.phone-number').value || '',
                email: supplierCard.querySelector('.email').value || '',
                companyAddress: supplierCard.querySelector('.company-address').value || '',
                bankName: supplierCard.querySelector('.bank-name').value || '',
                bankCode: supplierCard.querySelector('.bank-code').value || '',
                bankAccount: supplierCard.querySelector('.bank-account').value || '',
                remarks: supplierCard.querySelector('.remarks').value || ''
            };
            
            // 更新供应商数据
            const index = suppliers.findIndex(s => s.supplierNumber === supplier.supplierNumber);
            if (index > -1) {
                suppliers[index] = updatedData;
                
                // 保存到localStorage
                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                
                // 重新渲染供应商列表，这会将所有字段恢复为不可编辑状态，并将按钮恢复为"编辑"
                renderSuppliers();
            }
        }

        // 处理删除供应商
        function handleDeleteSupplier(supplierNumber) {
            // 检查参数类型，如果是事件则获取供应商编号
            if (typeof supplierNumber === 'object' && supplierNumber.target) {
                const supplierCard = supplierNumber.target.closest('.supplier-card');
                supplierNumber = supplierCard.dataset.supplierNumber;
            }

            if (confirm('确定要删除该供应商吗？')) {
                // 从数组中删除
                const index = suppliers.findIndex(s => s.supplierNumber === supplierNumber);
                if (index > -1) {
                    suppliers.splice(index, 1);
                    // 保存到localStorage
                    localStorage.setItem('suppliers', JSON.stringify(suppliers));
                    renderSuppliers();
                }
            }
        }

        // 标记是否正在编辑
        let isEditing = false;

        // 确保DOM完全加载后调用渲染函数
        document.addEventListener('DOMContentLoaded', () => {
            renderSuppliers();
            setupSearchFunctionality();
        });

        // 导出Excel功能
        const exportExcelBtn = document.getElementById('exportExcel');
        if (exportExcelBtn) {
            exportExcelBtn.addEventListener('click', function() {
                // 准备Excel数据
                const exportData = suppliers.map(supplier => {
                    return [
                        supplier.supplierNumber,
                        supplier.supplierName,
                        supplier.contactPerson,
                        supplier.phoneNumber,
                        supplier.email,
                        supplier.companyAddress,
                        supplier.bankName,
                        supplier.bankCode,
                        supplier.bankAccount,
                        supplier.remarks
                    ];
                });

                // 添加表头
                exportData.unshift(['编号', '供应商名称', '联系人', '电话', '电子邮箱', '公司地址', '开户行', '行号', '账号', '备注']);

                // 创建工作簿
                const worksheet = XLSX.utils.aoa_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, '供应商列表');

                // 导出文件
                XLSX.writeFile(workbook, '供应商列表.xlsx');
            });
        }

        // 导入Excel功能
        const importExcelBtn = document.getElementById('importExcelBtn');
        const importExcelInput = document.getElementById('importExcel');
        if (importExcelBtn && importExcelInput) {
            console.log('Import buttons found');
            importExcelBtn.addEventListener('click', function() {
                importExcelInput.click();
            });

            importExcelInput.addEventListener('change', function(e) {
                console.log('Change event triggered');
                console.log('File selected:', e.target.files[0]);
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('FileReader onload triggered');
                    const data = new Uint8Array(e.target.result);
                    let workbook;
                    try {
                        workbook = XLSX.read(data, { type: 'array' });
                        console.log('Workbook parsed:', workbook);
                    } catch (error) {
                        console.error('Error parsing Excel file:', error);
                        alert('解析Excel文件失败，请确保文件格式正确');
                        return;
                    }
                    console.log('Sheet names:', workbook.SheetNames);
                    let selectedSheetName;
                    if (workbook.SheetNames.length > 1) {
                        // If multiple sheets, let user select
                        selectedSheetName = prompt('请选择要导入的工作表:', workbook.SheetNames.join(', '));
                        // If user cancels or enters invalid name, use first sheet
                        if (!selectedSheetName || !workbook.SheetNames.includes(selectedSheetName)) {
                            selectedSheetName = workbook.SheetNames[0];
                            console.log('Using first sheet by default:', selectedSheetName);
                        }
                    } else {
                        selectedSheetName = workbook.SheetNames[0];
                    }
                    const worksheet = workbook.Sheets[selectedSheetName];
                    console.log('Selected worksheet:', selectedSheetName, worksheet);
                    let importedData;
                    try {
                        importedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        console.log('Imported data:', importedData);
                    } catch (error) {
                        console.error('Error converting worksheet to JSON:', error);
                        alert('转换Excel数据失败，请检查文件内容');
                        return;
                    }
                    if (!Array.isArray(importedData) || importedData.length === 0) {
                        console.error('Imported data is empty or not an array');
                        alert('Excel文件中没有可导入的数据');
                        return;
                    }
                    // 询问用户文件是否包含表头
                    const hasHeader = confirm("您的Excel文件包含表头行吗？\n（通常表头包含\"供应商编号\"、\"供应商名称\"等标题）");
                    const suppliersData = hasHeader ? importedData.slice(1) : importedData;
                    console.log('Suppliers data:', suppliersData);
                    console.log('Number of rows to process:', suppliersData.length);

                    // 更新供应商列表
                    let importedSuppliers = []; // 临时存储有效供应商
                    let validRowsFound = 0;
                    console.log('Updating suppliers list...');
                    suppliersData.forEach(row => {
                        console.log('Processing row:', row);
                        // 放宽列数限制，至少需要2列，且供应商编号或名称不为空
                        // 使用 != null 检查非空，确保0也能被导入
                        console.log('Row values:', JSON.stringify(row));
                        console.log('Row length:', row.length);
                        console.log('Row[0] (supplierNumber):', JSON.stringify(row[0]), 'Type:', typeof row[0], 'is null:', row[0] === null, 'is undefined:', row[0] === undefined, 'is empty string:', row[0] === '');
                        console.log('Row[1] (supplierName):', JSON.stringify(row[1]), 'Type:', typeof row[1], 'is null:', row[1] === null, 'is undefined:', row[1] === undefined, 'is empty string:', row[1] === '');
                        console.log('Row[0] or row[1] non-null?', (row[0] != null || row[1] != null));
                        // Check for any value in the row, not just first two columns
                        const hasAnyValue = row.some(cell => cell != null && cell !== '' && cell !== 0);
                        console.log('Row has any value?', hasAnyValue);
                        // Try more flexible validation
                        if (row.length >= 1) { // Accept at least 1 column
                            console.log('Row is valid, adding to suppliers');
                            validRowsFound++;
                            importedSuppliers.push({
                                supplierNumber: row[0] || '',
                                supplierName: row[1] || '',
                                contactPerson: row[2] || '',
                                phoneNumber: row[3] || '',
                                email: row[4] || '',
                                companyAddress: row[5] || '',
                                bankName: row[6] || '',
                                bankCode: row[7] || '',
                                bankAccount: row[8] || '',
                                remarks: row[9] || ''
                            });
                        } else if (row.length > 0) {
                            console.log('Row has too few columns:', row);
                        }
                    });

                    console.log('Total rows processed:', suppliersData.length);
                    console.log('Valid rows found:', validRowsFound);
                    console.log('Imported suppliers array:', importedSuppliers);
                    console.log('Imported suppliers count:', importedSuppliers.length);
                    // 渲染供应商列表
                    if (importedSuppliers.length > 0) {
                        // Ask user whether to replace or append data
                        const replaceData = confirm("是否替换现有供应商数据？\n选择'确定'将替换所有现有数据，\n选择'取消'将追加到现有数据后面");
                        
                        if (replaceData) {
                            // Replace supplier list with imported data
                            suppliers.length = 0;
                            suppliers.push(...importedSuppliers);
                        } else {
                            // Append imported data to existing list
                            suppliers.push(...importedSuppliers);
                        }
                        
                        console.log('Final suppliers array:', suppliers);
                        console.log('Total suppliers imported:', importedSuppliers.length);
                        console.log('Total suppliers in list:', suppliers.length);
                        renderSuppliers();
                        console.log('Suppliers list rendered');
                        // 保存到localStorage
                        localStorage.setItem('suppliers', JSON.stringify(suppliers));
                        console.log('Data saved to localStorage');
                        alert('供应商数据导入成功！共导入 ' + importedSuppliers.length + ' 条供应商信息');
                    } else {
                        // 没有有效数据，提示用户
                        console.log('No valid supplier data imported');
                        alert('未导入任何供应商数据，请检查Excel文件格式是否正确');
                    }

                    // 清空文件输入
                    importExcelInput.value = '';
                };
                reader.onerror = function(e) {
                    console.error('FileReader error:', e);
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // 搜索框事件监听和页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 重新渲染采购订单列表以显示当前公司的数据
            renderPurchaseOrderList();
            
            const searchInput = document.getElementById('purchaseOrderSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    searchKeyword = e.target.value.trim();
                    currentPage = 1; // 搜索后重置到第一页
                    renderPurchaseOrderList();
                });
            }
        });

        // 新建发票模态框功能
        document.addEventListener('DOMContentLoaded', function() {
            // 打开新建发票模态框
            const createInvoiceBtn = document.getElementById('create-invoice-btn');
            const createInvoiceModal = document.getElementById('create-invoice-modal');
            const cancelInvoiceBtn = document.getElementById('cancel-invoice-btn');
            const saveInvoiceBtn = document.getElementById('save-invoice-btn');
            const syncInvoiceBtn = document.getElementById('sync-invoice-btn');
            const purchaseOrderSelect = document.getElementById('purchase-order');
            const supplierNameInput = document.getElementById('supplier-name');
            const invoiceNumberInput = document.getElementById('invoice-number');
            const invoiceDateInput = document.getElementById('invoice-date');
            const invoiceAmountInput = document.getElementById('invoice-amount');
            // 发票状态下拉框已移除，不再获取该元素
            const invoiceRemarkTextarea = document.getElementById('invoice-remark');

            // 打开模态框
            if (createInvoiceBtn && createInvoiceModal) {
                createInvoiceBtn.addEventListener('click', function() {
                    // 生成自动发票编号功能已移除，默认无内容
                    const now = new Date();

                    // 设置默认发票日期为今天
                    invoiceDateInput.value = now.toISOString().split('T')[0];

                    // 合同号输入框，用户可直接输入

                    // 清空表单
                    invoiceNumberInput.value = '';
                    supplierNameInput.value = '';
                    invoiceAmountInput.value = '';
                    // 发票状态下拉框已移除，不再设置默认值
                    invoiceRemarkTextarea.value = '';

                    // 显示模态框
                    createInvoiceModal.classList.remove('hidden');
                });
            }

            // 金额输入框焦点事件：提示先输入供应商查找合同
            if (invoiceAmountInput) {
                invoiceAmountInput.addEventListener('focus', function() {
                    if (!supplierNameInput.value.trim()) {
                        alert('请先输入供应商查找合同并选择，若无匹配合同，先返回新增合同');
                        // 将焦点移到供应商输入框，避免无限循环
                        supplierNameInput.focus();
                    }
                });
            }

            // 关闭模态框
            if (cancelInvoiceBtn && createInvoiceModal) {
                cancelInvoiceBtn.addEventListener('click', function() {
                    createInvoiceModal.classList.add('hidden');
                });
            }
            
            // 同步至进销发票
            if (syncInvoiceBtn) {
                syncInvoiceBtn.addEventListener('click', function() {
                    // 验证表单数据
                    if (!invoiceNumberInput.value.trim()) {
                        alert('请输入发票编号');
                        return;
                    }
                    if (!purchaseOrderSelect.value) {
                        alert('请输入合同号');
                        return;
                    }
                    if (!invoiceAmountInput.value || parseFloat(invoiceAmountInput.value) <= 0) {
                        alert('请输入有效的发票金额');
                        return;
                    }
                    
                    // 公司映射关系：根据两个文件的公司选择下拉菜单确定正确映射
                    const companyMapping = {
                        'companyA': 'company2', // index.html的companyA(普利美)对应invoice.html的company2(普利美)
                        'companyB': 'company1'  // index.html的companyB(龙力)对应invoice.html的company1(龙力)
                    };
                    
                    // 直接获取公司选择下拉菜单的当前值，确保使用最新选择的公司
                    const companySelectElement = document.getElementById('company-select');
                    const currentCompanyFromSelect = companySelectElement ? companySelectElement.value : 'companyA';
                    const currentCompanyFromStorage = localStorage.getItem('currentCompany_index') || 'companyA';
                    
                    // 优先使用下拉菜单的当前值，避免localStorage可能未更新的问题
                    const currentCompany = currentCompanyFromSelect || currentCompanyFromStorage;
                    
                    // 明确获取映射后的公司值，避免使用逻辑或运算符可能带来的问题
                    let mappedCompany = 'company2'; // 默认值
                    if (currentCompany === 'companyA') {
                        mappedCompany = 'company2';
                    } else if (currentCompany === 'companyB') {
                        mappedCompany = 'company1';
                    }
                    
                    console.log('同步调试信息：', {
                        currentCompanyFromSelect: currentCompanyFromSelect,
                        currentCompanyFromStorage: currentCompanyFromStorage,
                        currentCompany: currentCompany,
                        mappedCompany: mappedCompany,
                        companyMapping: companyMapping
                    });
                    
                    // 收集表单数据并转换为invoice.html所需的格式
                    const invoiceData = {
                        id: Date.now(),
                        entryDate: new Date().toISOString().split('T')[0], // 录入日期为当前日期
                        date: invoiceDateInput.value, // 发票日期
                        invoiceNo: invoiceNumberInput.value, // 发票编号
                        supplier: supplierNameInput.value, // 供应商
                        amount: parseFloat(invoiceAmountInput.value), // 金额
                        taxRate: 13, // 默认税率为13%（可根据实际情况调整）
                        taxAmount: parseFloat(invoiceAmountInput.value) * 0.13 / 1.13, // 税额计算
                        status: 'approved', // 默认状态为已认证（使用invoice.html中定义的enum值）
                        remark: invoiceRemarkTextarea.value, // 备注
                        type: 'purchase', // 类型为进项发票
                        company: mappedCompany // 使用映射后的公司值
                    };
                    
                    // 将数据保存到localStorage中，以便invoice.html可以读取
                    const existingInvoices = JSON.parse(localStorage.getItem('invoices')) || [];
                    existingInvoices.push(invoiceData);
                    localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                    
                    console.log('同步发票数据到进销系统:', invoiceData);
                    
                    // 显示同步成功消息
                    alert('发票已同步至进销发票系统');
                    
                    // 可以选择是否关闭模态框，这里保持打开状态
                    
                    // 可以选择是否关闭模态框，这里保持打开状态
                });
            }

            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target === createInvoiceModal) {
                    createInvoiceModal.classList.add('hidden');
                }
            });

            // 合同号输入事件，自动填充供应商和金额
            if (purchaseOrderSelect && supplierNameInput && invoiceAmountInput) {
                purchaseOrderSelect.addEventListener('input', function(e) {
                    const contractNumber = e.target.value.trim();
                    const storageKey = `purchaseOrders_${currentCompany}`;
                    const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                    const selectedOrder = purchaseOrders.find(order => order.contractNumber === contractNumber);
                    
                    if (selectedOrder) {
                        supplierNameInput.value = selectedOrder.supplier;
                        invoiceAmountInput.value = selectedOrder.totalAmount.toFixed(2);
                    }
                });
            }

            // 供应商名称输入框模糊搜索功能
            if (supplierNameInput) {
                supplierNameInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const resultsContainer = document.getElementById('supplier-search-results');
                    resultsContainer.innerHTML = '';
                    
                    if (searchTerm === '') {
                        resultsContainer.classList.add('hidden');
                        return;
                    }
                    
                    // 从localStorage加载采购订单数据
                    const storageKey = `purchaseOrders_${currentCompany}`;
                    const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                    
                    // 加载现有发票数据，用于过滤已存在的合同号
                    const invoiceStorageKey = `${getCurrentCompany()}-invoices`;
                    const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
                    
                    // 创建现有合同号集合（处理单个和多个合同号的情况）
                    const existingContractNumbers = new Set();
                    invoices.forEach(invoice => {
                        if (invoice.purchaseOrder) {
                            // 处理多个合同号的情况（逗号分隔）
                            const contracts = invoice.purchaseOrder.split(',').map(contract => contract.trim().toLowerCase());
                            contracts.forEach(contract => existingContractNumbers.add(contract));
                        }
                    });
                    
                    // 过滤采购订单：包含搜索词且合同号不存在于发票列表
                    const filteredOrders = purchaseOrders.filter(order => {
                        // 首先排除已经存在于发票列表中的合同号
                        if (existingContractNumbers.has(order.contractNumber.toLowerCase())) {
                            return false;
                        }
                        // 然后检查采购订单的所有字段是否包含搜索词
                        for (const key in order) {
                            if (order.hasOwnProperty(key)) {
                                const value = order[key];
                                if (typeof value === 'string' && value.toLowerCase().includes(searchTerm)) {
                                    return true;
                                }
                            }
                        }
                        return false;
                    });
                    
                    // 显示搜索结果
                    if (filteredOrders.length > 0) {
                        filteredOrders.forEach(order => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100 transition-colors';
                            resultItem.innerHTML = `
                                <div class="flex items-start">
                                    <input type="checkbox" class="mt-1 mr-2 supplier-result-checkbox" data-contract="${order.contractNumber}" data-amount="${order.totalAmount}">
                                    <div>
                                        <div class="font-medium">${order.supplier || '无'}</div>
                                        <div class="text-sm text-gray-600">合同号: ${order.contractNumber || '无'}</div>
                                        <div class="text-sm text-gray-600">合同日期: ${order.orderDate || '无'}</div>
                                        <div class="text-sm text-gray-600">产品: ${order.products && order.products.length > 0 ? order.products.map(p => `${p.productName || '未命名产品'} x${formatQuantity(p.quantity || 0)}`).join(', ') : '无'}</div>
                                        <div class="text-xs text-gray-500">总金额: ¥${(order.totalAmount || 0).toFixed(2)}</div>
                                    </div>
                                </div>
                            `;
                            
                            // 点击搜索结果时更新供应商名称并切换复选框
                            resultItem.addEventListener('click', function(e) {
                                if (e.target.type === 'checkbox') return;
                                
                                // 更新供应商名称
                                supplierNameInput.value = order.supplier;
                                
                                // 切换复选框状态
                                const checkbox = this.querySelector('.supplier-result-checkbox');
                                checkbox.checked = !checkbox.checked;
                                
                                // 触发复选框变化事件更新合同号和金额
                                checkbox.dispatchEvent(new Event('change'));
                            });
                            
                            // 复选框变化时更新合同号和金额
                            const checkbox = resultItem.querySelector('.supplier-result-checkbox');
                            checkbox.addEventListener('change', function() {
                                const allCheckboxes = document.querySelectorAll('.supplier-result-checkbox');
                                const checkedCheckboxes = Array.from(allCheckboxes).filter(cb => cb.checked);
                                
                                // 收集所有合同号
                                const contractNumbers = checkedCheckboxes.map(cb => cb.dataset.contract).filter(Boolean);
                                
                                // 计算总金额
                                const totalAmount = checkedCheckboxes
                                    .map(cb => parseFloat(cb.dataset.amount))
                                    .filter(amount => !isNaN(amount))
                                    .reduce((sum, amount) => sum + amount, 0);
                                
                                // 填充合同号和金额
                                purchaseOrderSelect.value = contractNumbers.join(', ');
                                invoiceAmountInput.value = totalAmount.toFixed(2);
                            });
                            
                            resultsContainer.appendChild(resultItem);
                        });
                        resultsContainer.classList.remove('hidden');
                    } else {
                        resultsContainer.innerHTML = '<div class="px-4 py-2 text-gray-500">没有找到匹配的结果</div>';
                        resultsContainer.classList.remove('hidden');
                    }
                });
                
                // 供应商输入框点击事件：仅在搜索结果不可见时自动填充第一个合同号
                supplierNameInput.addEventListener('click', function() {
                    const resultsContainer = document.getElementById('supplier-search-results');
                    if (resultsContainer.classList.contains('hidden')) {
                        const supplierName = this.value.trim();
                        if (supplierName) {
                            const storageKey = `purchaseOrders_${currentCompany}`;
                            const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                            const filteredOrders = purchaseOrders.filter(order => 
                                order.status !== '已取消' && 
                                order.supplier.toLowerCase().includes(supplierName.toLowerCase())
                            );
                            if (filteredOrders.length > 0) {
                                const firstOrder = filteredOrders[0];
                                purchaseOrderSelect.value = firstOrder.contractNumber;
                                invoiceAmountInput.value = firstOrder.totalAmount.toFixed(2);
                            }
                        }
                    }
                });
                
                // 点击外部区域关闭搜索结果
                document.addEventListener('click', function(e) {
                    const resultsContainer = document.getElementById('supplier-search-results');
                    if (!supplierNameInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                        resultsContainer.innerHTML = '';
                        resultsContainer.classList.add('hidden');
                    }
                });
            }
            
            // 保存发票
            if (saveInvoiceBtn) {
                saveInvoiceBtn.addEventListener('click', function() {
                    // 验证表单
                    if (!invoiceNumberInput.value.trim()) {
                        alert('请输入发票编号');
                        return;
                    }
                    if (!purchaseOrderSelect.value) {
                        alert('请选择关联的采购订单');
                        return;
                    }
                    if (!invoiceAmountInput.value || parseFloat(invoiceAmountInput.value) <= 0) {
                        alert('请输入有效的发票金额');
                        return;
                    }

                    // 收集表单数据
                    // 生成唯一ID (基于时间戳和随机数)
                    const generateUniqueId = () => {
                        const timestamp = Date.now();
                        const random = Math.floor(Math.random() * 1000);
                        return `invoice_${timestamp}_${random}`;
                    };
                    
                    const invoiceData = {
                        id: generateUniqueId(),
                        invoiceNumber: invoiceNumberInput.value,
                        invoiceDate: invoiceDateInput.value,
                        purchaseOrder: purchaseOrderSelect.value,
                        supplier: supplierNameInput.value,
                        amount: parseFloat(invoiceAmountInput.value),
                        status: '未付款', // 默认状态，发票状态下拉框已移除
                        remark: invoiceRemarkTextarea.value,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    // 检查是否需要同步付款状态和更新付款记录的发票编号
                    const paymentStorageKey = `${getCurrentCompany()}-payments`;
                    const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
                    const contractNumbers = invoiceData.purchaseOrder.split(',').map(contract => contract.trim());
                    
                    // 查找包含相同合同号的付款记录（精确匹配）
                    const relatedPayments = payments.filter(payment => {
                        // 检查付款记录中的合同号是否与当前发票的任何一个合同号精确匹配
                        const paymentContractNum = payment.contractNumber?.trim() || '';
                        return contractNumbers.some(contractNumber => 
                            paymentContractNum === contractNumber
                        );
                    });
                    
                    // 如果有相关付款记录，进行数据同步
                    if (relatedPayments.length > 0) {
                        // 计算总付款金额
                        const totalPaymentAmount = relatedPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                        
                        // 更新发票状态
                        if (totalPaymentAmount >= invoiceData.amount) {
                            invoiceData.status = '已付清';
                        } else if (totalPaymentAmount > 0) {
                            invoiceData.status = '部分付款';
                        }
                        
                        // 记录总付款金额和差额
                        invoiceData.totalPaid = totalPaymentAmount;
                        invoiceData.paymentDifference = invoiceData.amount - totalPaymentAmount;
                        
                        // 将发票编号更新到付款记录中（使用invoiceNumbers字段保持一致）
                        relatedPayments.forEach(payment => {
                            // 如果付款记录没有发票编号或需要追加
                            if (!payment.invoiceNumbers || payment.invoiceNumbers.trim() === '') {
                                payment.invoiceNumbers = invoiceData.invoiceNumber;
                            } else if (!payment.invoiceNumbers.includes(invoiceData.invoiceNumber)) {
                                // 如果已有关联发票，追加到现有发票编号后面
                                payment.invoiceNumbers += `, ${invoiceData.invoiceNumber}`;
                            }
                        });
                        
                        // 保存更新后的付款记录
                        localStorage.setItem(paymentStorageKey, JSON.stringify(payments));
                // 调用更新仪表盘统计数据函数
                updateDashboardStats();
                    }
                    
                    // 保存到本地存储
                    const storageKey = `${getCurrentCompany()}-invoices`;
                    const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
                    invoices.push(invoiceData);
                    localStorage.setItem(storageKey, JSON.stringify(invoices));
                // 调用更新仪表盘统计数据函数
                updateDashboardStats();
                // 调用更新仪表盘统计数据函数
                updateDashboardStats();

                    // 关闭模态框
                    createInvoiceModal.classList.add('hidden');

                    // 刷新发票列表
                     renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
                     
                     // 重新渲染采购订单列表，确保发票状态同步更新到对应合同号
                     if (typeof renderPurchaseOrderList === 'function') {
                         renderPurchaseOrderList();
                     }

                     // 显示成功消息
                     alert('发票已创建成功');
                 });
             }
         });

         // 渲染发票列表
         // 发票列表分页变量
         let currentInvoicePage = 1;
         const invoicesPerPage = 10;

         function renderInvoiceList(searchTerm = '', startDate = null, endDate = null) {
             const invoiceTableBody = document.querySelector('#invoices-page .table tbody');
             if (!invoiceTableBody) return;
              
             // 在渲染前先更新发票付款状态
             updateInvoicePaymentStatus();

             // 获取当前公司的发票数据
             const storageKey = `${getCurrentCompany()}-invoices`;
             let invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
              
             // 搜索筛选
             if (searchTerm) {
                 const lowerCaseSearch = searchTerm.toLowerCase();
                 invoices = invoices.filter(invoice => {
                     // 搜索发票编号、合同号、供应商
                     return invoice.invoiceNumber?.toLowerCase().includes(lowerCaseSearch) || 
                            invoice.purchaseOrder?.toLowerCase().includes(lowerCaseSearch) || 
                            invoice.supplier?.toLowerCase().includes(lowerCaseSearch) || 
                            invoice.amount?.toString().includes(searchTerm) || 
                            invoice.status?.toLowerCase().includes(lowerCaseSearch);
                 });
             }
             
             // 日期范围筛选
             if (startDate || endDate) {
                 const startDateTime = startDate ? new Date(startDate) : new Date(0);
                 const endDateTime = endDate ? new Date(endDate) : new Date();
                 // 设置结束日期的时间为当天的23:59:59
                 endDateTime.setHours(23, 59, 59, 999);
                 
                 invoices = invoices.filter(invoice => {
                     if (!invoice.invoiceDate) return false;
                     const invoiceDateTime = new Date(invoice.invoiceDate);
                     return invoiceDateTime >= startDateTime && invoiceDateTime <= endDateTime;
                 });
             }
              
             // 按发票日期倒序排序
             invoices.sort((a, b) => {
                 const dateA = a.invoiceDate ? new Date(a.invoiceDate) : new Date(0);
                 const dateB = b.invoiceDate ? new Date(b.invoiceDate) : new Date(0);
                 return dateB - dateA; // 倒序排序
             });

             // 清空表格
             invoiceTableBody.innerHTML = '';

             // 如果没有发票数据
             if (invoices.length === 0) {
                 const row = document.createElement('tr');
                 row.innerHTML = `
                     <td colspan="8" class="text-center py-4 text-gray-500">
                         暂无发票数据
                     </td>
                 `;
                 invoiceTableBody.appendChild(row);
                 
                 // 为复选框添加选中行背景色功能
                 const checkbox = row.querySelector('input[type="checkbox"]');
                 if (checkbox) {
                     checkbox.addEventListener('change', function() {
                         if (this.checked) {
                             row.classList.add('bg-blue-50'); // 选中时添加浅蓝色背景
                         } else {
                             row.classList.remove('bg-blue-50'); // 取消选中时移除背景色
                         }
                     });
                 }
                 return;
             }

             // 确保所有发票都有唯一ID
             let updatedInvoices = false;
             invoices.forEach(invoice => {
                 if (!invoice.id) {
                     invoice.id = `invoice_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
                     updatedInvoices = true;
                 }
             });

             // 如果有发票被添加了ID，保存到localStorage
             if (updatedInvoices) {
                 localStorage.setItem(storageKey, JSON.stringify(invoices));
                 // 调用更新仪表盘统计数据函数
                 updateDashboardStats();
             }

             // 计算金额合计
             const totalAmount = invoices.reduce((sum, invoice) => sum + invoice.amount, 0);

             // 分页处理
             const indexOfLastInvoice = currentInvoicePage * invoicesPerPage;
             const indexOfFirstInvoice = indexOfLastInvoice - invoicesPerPage;
             const currentInvoices = invoices.slice(indexOfFirstInvoice, indexOfLastInvoice);
             const totalPages = Math.ceil(invoices.length / invoicesPerPage);

             // 渲染发票列表
             currentInvoices.forEach(invoice => {
                 const row = document.createElement('tr');
                 row.innerHTML = `
                     <td>
                         <input type="checkbox" class="rounded text-primary focus:ring-primary">
                     </td>
                     <td class="font-medium">${invoice.invoiceNumber}</td>
                     <td>${invoice.purchaseOrder || 'N/A'}</td>
                     <td>${invoice.supplier || 'N/A'}</td>
                     <td>${invoice.invoiceDate || 'N/A'}</td>
                     <td>${formatCurrency(invoice.amount)}</td>
                     <td>
                         <span class="badge badge-${(invoice.status && invoice.status !== '') ? (invoice.status === '已付清' ? 'success' : invoice.status === '部分付款' ? 'warning' : 'danger') : 'warning'}">
                    ${(invoice.status && invoice.status !== '') ? invoice.status : '部分付款'}
                    </span>
                     </td>
                     <td>
                         <button class="btn btn-sm btn-secondary mr-1" onclick="viewInvoice('${invoice.id}')" title="查看">
                             <i class="fa fa-eye"></i>
                         </button>
                         <button class="btn btn-sm btn-primary mr-1" onclick="editInvoice('${invoice.id}')" title="编辑">
                             <i class="fa fa-edit"></i>
                         </button>
                         <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${invoice.id}')" title="删除">
                             <i class="fa fa-trash"></i>
                         </button>
                     </td>
                 `;
                 invoiceTableBody.appendChild(row);
             });

             // 更新记录计数
             const recordCountSpan = document.getElementById('invoice-record-count');
             if (recordCountSpan) {
                 recordCountSpan.textContent = invoices.length;
             }

             // 更新金额合计
             const totalAmountSpan = document.getElementById('invoice-total-amount');
             if (totalAmountSpan) {
                 totalAmountSpan.textContent = formatCurrency(totalAmount);
             }

             // 添加复选框事件监听，实现选中合计功能
             const checkboxes = invoiceTableBody.querySelectorAll('input[type="checkbox"]');
             checkboxes.forEach(checkbox => {
                 checkbox.addEventListener('change', updateInvoiceSelectionTotal);
             });

             // 更新分页信息
             const currentPageSpan = document.getElementById('invoice-current-page');
             const totalPagesSpan = document.getElementById('invoice-total-pages');
             const prevBtn = document.getElementById('invoice-prev-page');
             const nextBtn = document.getElementById('invoice-next-page');

             if (currentPageSpan) {
                 currentPageSpan.textContent = currentInvoicePage;
             }
             if (totalPagesSpan) {
                 totalPagesSpan.textContent = totalPages;
             }

             // 设置上一页按钮状态
             if (prevBtn) {
                 prevBtn.disabled = currentInvoicePage === 1;
                 prevBtn.onclick = () => {
                     if (currentInvoicePage > 1) {
                         currentInvoicePage--;
                         renderInvoiceList();
                     }
                 };
             }

             // 设置下一页按钮状态
             if (nextBtn) {
                 nextBtn.disabled = currentInvoicePage === totalPages;
                 nextBtn.onclick = () => {
                     if (currentInvoicePage < totalPages) {
                         currentInvoicePage++;
                         renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
                     }
                 };
             }
         }
         
         // 更新发票选中合计
         function updateInvoiceSelectionTotal() {
             // 直接从localStorage获取发票数据
             const storageKey = `${getCurrentCompany()}-invoices`;
             const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
              
             const checkboxes = document.querySelectorAll('#invoices-page .table tbody input[type="checkbox"]:checked');
              
             // 如果没有选中项，恢复原合计
             if (checkboxes.length === 0) {
                 // 计算所有发票的总金额
                 const totalAmount = invoices.reduce((sum, invoice) => sum + parseFloat(invoice.amount || 0), 0);
                 const totalAmountSpan = document.getElementById('invoice-total-amount');
                 if (totalAmountSpan) {
                     totalAmountSpan.textContent = formatCurrency(totalAmount);
                 }
                 return;
             }
             
             // 计算选中项合计
             let selectedTotalAmount = 0;
             
             checkboxes.forEach(checkbox => {
                 const row = checkbox.closest('tr');
                 const invoiceNumber = row.querySelector('td:nth-child(2)').textContent;
                 
                 // 查找对应的发票
                const invoice = invoices.find(i => i.invoiceNumber === invoiceNumber);
                if (invoice) {
                    selectedTotalAmount += parseFloat(invoice.amount || 0);
                 }
             });
             
             // 更新合计显示
             const totalAmountSpan = document.getElementById('invoice-total-amount');
             if (totalAmountSpan) {
                 totalAmountSpan.textContent = formatCurrency(selectedTotalAmount);
             }
         }

         // 搜索框事件监听
         document.addEventListener('DOMContentLoaded', () => {
             const searchInput = document.getElementById('invoice-search-input');
             if (searchInput) {
                 searchInput.addEventListener('input', (e) => {
                     // 重置到第一页
                     currentInvoicePage = 1;
                     // 获取当前日期筛选条件
                     const startDate = document.getElementById('invoice-start-date')?.value;
                     const endDate = document.getElementById('invoice-end-date')?.value;
                     renderInvoiceList(e.target.value, startDate, endDate);
                 });
             }
             
             // 发票日期筛选按钮事件监听
             const filterBtn = document.getElementById('invoice-date-filter-btn');
             if (filterBtn) {
                 filterBtn.addEventListener('click', () => {
                     // 重置到第一页
                     currentInvoicePage = 1;
                     // 获取搜索关键词和日期筛选条件
                     const searchTerm = document.getElementById('invoice-search-input')?.value || '';
                     const startDate = document.getElementById('invoice-start-date')?.value;
                     const endDate = document.getElementById('invoice-end-date')?.value;
                     renderInvoiceList(searchTerm, startDate, endDate);
                 });
             }
             
             // 发票日期重置按钮事件监听
             const resetBtn = document.getElementById('invoice-date-reset-btn');
             if (resetBtn) {
                 resetBtn.addEventListener('click', () => {
                     // 重置到第一页
                     currentInvoicePage = 1;
                     // 清空日期输入框
                     const startDateInput = document.getElementById('invoice-start-date');
                     const endDateInput = document.getElementById('invoice-end-date');
                     if (startDateInput) startDateInput.value = '';
                     if (endDateInput) endDateInput.value = '';
                     // 获取搜索关键词
                     const searchTerm = document.getElementById('invoice-search-input')?.value || '';
                     renderInvoiceList(searchTerm, null, null);
                 });
             }
         });

         // 查看发票详情
         function viewInvoice(invoiceId) {
             const storageKey = `${getCurrentCompany()}-invoices`;
             const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
             const invoice = invoices.find(inv => inv.id === invoiceId);
             if (invoice) {
                 // 创建模态框
                 const modal = document.createElement('div');
                 modal.className = 'fixed z-50 inset-0 overflow-y-auto bg-gray-500 bg-opacity-75';
                 modal.innerHTML = `
                     <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                         <div class="fixed inset-0 transition-opacity" aria-hidden="true" onclick="this.closest('.bg-gray-500').remove()"></div>
                         <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                             <div class="sm:flex sm:items-start">
                                 <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                                     <i class="fa fa-file-text-o text-primary-600 text-lg"></i>
                                 </div>
                                 <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                     <h3 class="text-lg leading-6 font-medium text-gray-900">发票详情</h3>
                                     <div class="mt-4 space-y-3">
                                         <div class="grid grid-cols-2 gap-4">
                                             <div class="bg-gray-50 p-3 rounded">
                                                 <div class="text-sm font-medium text-gray-500">发票编号</div>
                                                 <div class="text-base font-semibold text-gray-900">${invoice.invoiceNumber}</div>
                                             </div>
                                             <div class="bg-gray-50 p-3 rounded">
                                                 <div class="text-sm font-medium text-gray-500">发票日期</div>
                                                 <div class="text-base font-semibold text-gray-900">${invoice.invoiceDate}</div>
                                             </div>
                                             <div class="bg-gray-50 p-3 rounded">
                                                 <div class="text-sm font-medium text-gray-500">发票金额</div>
                                                 <div class="text-base font-semibold text-gray-900">${formatCurrency(invoice.amount)}</div>
                                             </div>
                                             <div class="bg-gray-50 p-3 rounded">
                                                 <div class="text-sm font-medium text-gray-500">付款状态</div>
                                                 <div class="text-base font-semibold text-gray-900">${invoice.status || '部分付款'}</div>
                                             </div>
                                             <div class="bg-gray-50 p-3 rounded">
                                                 <div class="text-sm font-medium text-gray-500">合同号</div>
                                                 <div class="text-base font-semibold text-gray-900">${invoice.purchaseOrder || 'N/A'}</div>
                                             </div>
                                             <div class="bg-gray-50 p-3 rounded">
                                                 <div class="text-sm font-medium text-gray-500">供应商</div>
                                                 <div class="text-base font-semibold text-gray-900">${invoice.supplier || 'N/A'}</div>
                                             </div>
                                         </div>
                                         ${invoice.remark ? `
                                         <div class="bg-gray-50 p-3 rounded">
                                             <div class="text-sm font-medium text-gray-500">备注</div>
                                             <div class="text-base text-gray-900">${invoice.remark}</div>
                                         </div>` : ''}
                                     </div>
                                     <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                         <button type="button" class="btn btn-primary w-full sm:w-auto" onclick="this.closest('.bg-gray-500').remove()">
                                             关闭
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;
                 document.body.appendChild(modal);
             }
         }

         // 编辑发票
         function editInvoice(invoiceId) {
             const storageKey = `${getCurrentCompany()}-invoices`;
             const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
             const invoiceIndex = invoices.findIndex(inv => inv.id === invoiceId);
             const invoice = invoices[invoiceIndex];
             if (invoice) {
                 // 创建编辑模态框
                 const modal = document.createElement('div');
                 modal.className = 'fixed z-50 inset-0 overflow-y-auto bg-gray-500 bg-opacity-75';
                 modal.innerHTML = `
                     <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                         <div class="fixed inset-0 transition-opacity" aria-hidden="true" onclick="this.closest('.bg-gray-500').remove()"></div>
                         <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                             <div class="sm:flex sm:items-start">
                                 <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-primary-100 sm:mx-0 sm:h-10 sm:w-10">
                                     <i class="fa fa-edit text-primary-600 text-lg"></i>
                                 </div>
                                 <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                     <h3 class="text-lg leading-6 font-medium text-gray-900">编辑发票</h3>
                                     <div class="mt-4">
                                         <form class="space-y-4">
                                             <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                 <div class="form-group">
                                                     <label for="edit-invoice-number" class="form-label">发票编号</label>
                                                     <input type="text" id="edit-invoice-number" class="form-input" value="${invoice.invoiceNumber}" required>
                                                 </div>
                                                 <div class="form-group">
                                                     <label for="edit-invoice-date" class="form-label">发票日期</label>
                                                     <input type="date" id="edit-invoice-date" class="form-input" value="${invoice.invoiceDate}" required>
                                                 </div>
                                             </div>
                                             <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                                 <div class="form-group">
                                                     <label for="edit-invoice-amount" class="form-label">发票金额</label>
                                                     <div class="relative">
                                                         <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">¥</span>
                                                         <input type="number" id="edit-invoice-amount" class="form-input pl-8 text-center" value="${invoice.amount.toFixed(2)}" step="0.01" required>
                                                     </div>
                                                 </div>
                                                 <!-- 发票状态下拉框已移除 -->
                                             </div>
                                             <div class="form-group">
                                                 <label for="edit-purchase-order" class="form-label">合同号</label>
                                                 <input type="text" id="edit-purchase-order" class="form-input" value="${invoice.purchaseOrder || ''}" placeholder="请输入合同号" required>
                                             </div>
                                             <div class="form-group">
                                                 <label for="edit-supplier" class="form-label">供应商信息</label>
                                                 <input type="text" id="edit-supplier" class="form-input" value="${invoice.supplier || ''}" placeholder="供应商名称" required>
                                             </div>
                                             <div class="form-group">
                                                 <label for="edit-invoice-remark" class="form-label">备注</label>
                                                 <textarea id="edit-invoice-remark" class="form-textarea" rows="3" placeholder="请输入备注信息">${invoice.remark || ''}</textarea>
                                             </div>
                                         </form>
                                     </div>
                                     <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                                         <button type="button" class="btn btn-primary w-full sm:w-auto" onclick="saveEditedInvoice('${invoiceId}', this)">
                                             保存
                                         </button>
                                         <button type="button" class="btn btn-secondary w-full sm:w-auto mt-3 sm:mt-0 sm:ml-3" onclick="syncEditedInvoice('${invoiceId}', this)">
                                             同步至进销发票
                                         </button>
                                         <button type="button" class="btn btn-secondary w-full sm:w-auto mt-3 sm:mt-0 sm:ml-3" onclick="this.closest('.bg-gray-500').remove()">
                                             取消
                                         </button>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 `;
                 document.body.appendChild(modal);
             }
         }

         // 同步编辑后的发票至进销发票
         function syncEditedInvoice(invoiceId, button) {
             const storageKey = `${getCurrentCompany()}-invoices`;
             const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
             const invoiceIndex = invoices.findIndex(inv => inv.id === invoiceId);
              
             if (invoiceIndex !== -1) {
                 const modal = button.closest('.bg-gray-500');
                 const invoiceNumber = modal.querySelector('#edit-invoice-number').value;
                 const invoiceDate = modal.querySelector('#edit-invoice-date').value;
                 const amount = parseFloat(modal.querySelector('#edit-invoice-amount').value);
                 const purchaseOrder = modal.querySelector('#edit-purchase-order').value;
                 const supplier = modal.querySelector('#edit-supplier').value;
                 const remark = modal.querySelector('#edit-invoice-remark').value;
                 
                 // 验证表单数据
                 if (!invoiceNumber.trim()) {
                     alert('请输入发票编号');
                     return;
                 }
                 if (!purchaseOrder) {
                     alert('请输入合同号');
                     return;
                 }
                 if (isNaN(amount) || amount <= 0) {
                     alert('请输入有效的发票金额');
                     return;
                 }
                 
                 // 公司映射关系：根据两个文件的公司选择下拉菜单确定正确映射
                 const companyMapping = {
                     'companyA': 'company2', // index.html的companyA(普利美)对应invoice.html的company2(普利美)
                     'companyB': 'company1'  // index.html的companyB(龙力)对应invoice.html的company1(龙力)
                 };
                 
                 // 直接获取公司选择下拉菜单的当前值，确保使用最新选择的公司
                 const companySelectElement = document.getElementById('company-select');
                 const currentCompanyFromSelect = companySelectElement ? companySelectElement.value : 'companyA';
                 const currentCompanyFromStorage = localStorage.getItem('currentCompany_index') || 'companyA';
                 
                 // 优先使用下拉菜单的当前值，避免localStorage可能未更新的问题
                 const currentCompany = currentCompanyFromSelect || currentCompanyFromStorage;
                 
                 // 明确获取映射后的公司值，避免使用逻辑或运算符可能带来的问题
                 let mappedCompany = 'company2'; // 默认值
                 if (currentCompany === 'companyA') {
                     mappedCompany = 'company2';
                 } else if (currentCompany === 'companyB') {
                     mappedCompany = 'company1';
                 }
                 
                 console.log('编辑发票同步调试信息：', {
                     currentCompanyFromSelect: currentCompanyFromSelect,
                     currentCompanyFromStorage: currentCompanyFromStorage,
                     currentCompany: currentCompany,
                     mappedCompany: mappedCompany,
                     companyMapping: companyMapping
                 });
                 
                 // 收集表单数据并转换为invoice.html所需的格式
                 const invoiceData = {
                     id: Date.now(), // 使用新ID避免与现有数据冲突
                     entryDate: new Date().toISOString().split('T')[0], // 录入日期为当前日期
                     date: invoiceDate, // 发票日期
                     invoiceNo: invoiceNumber, // 发票编号
                     supplier: supplier, // 供应商
                     amount: amount, // 金额
                     taxRate: 13, // 默认税率为13%（可根据实际情况调整）
                     taxAmount: amount * 0.13 / 1.13, // 税额计算
                     status: 'approved', // 默认状态为已认证（使用invoice.html中定义的enum值）
                     remark: remark, // 备注
                     type: 'purchase', // 类型为进项发票
                     company: mappedCompany // 使用映射后的公司信息
                 };
                 
                 // 将数据保存到localStorage中，以便invoice.html可以读取
                 const existingInvoices = JSON.parse(localStorage.getItem('invoices')) || [];
                 
                 // 检查是否已存在相同发票编号的发票，如果存在则更新，否则添加新的
                 const existingIndex = existingInvoices.findIndex(inv => inv.invoiceNo === invoiceNumber);
                 if (existingIndex !== -1) {
                     existingInvoices[existingIndex] = invoiceData;
                 } else {
                     existingInvoices.push(invoiceData);
                 }
                 
                 localStorage.setItem('invoices', JSON.stringify(existingInvoices));
                 
                 console.log('同步编辑后的发票数据到进销系统:', invoiceData);
                 
                 // 显示同步成功消息
                 alert('发票已同步至进销发票系统');
                 
                 // 可以选择是否关闭模态框，这里保持打开状态
             }
         }

         // 保存编辑后的发票
         function saveEditedInvoice(invoiceId, button) {
             const storageKey = `${getCurrentCompany()}-invoices`;
             const paymentStorageKey = `${getCurrentCompany()}-payments`;
             const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
             const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
             const invoiceIndex = invoices.findIndex(inv => inv.id === invoiceId);
             
             if (invoiceIndex !== -1) {
                 const modal = button.closest('.bg-gray-500');
                 const invoiceNumber = modal.querySelector('#edit-invoice-number').value;
                 const invoiceDate = modal.querySelector('#edit-invoice-date').value;
                 const amount = parseFloat(modal.querySelector('#edit-invoice-amount').value);
                 const purchaseOrder = modal.querySelector('#edit-purchase-order').value;
                 const supplier = modal.querySelector('#edit-supplier').value;
                 const remark = modal.querySelector('#edit-invoice-remark').value;
                 
                 const oldInvoice = invoices[invoiceIndex];
                 const oldInvoiceNumber = oldInvoice.invoiceNumber;
                 const oldContractNumbers = oldInvoice.purchaseOrder.split(',').map(contract => contract.trim());
                 const newContractNumbers = purchaseOrder.split(',').map(contract => contract.trim());
                 
                 // 1. 如果发票编号发生变化，更新所有付款记录中的发票编号
                 if (invoiceNumber !== oldInvoiceNumber) {
                     payments.forEach(payment => {
                         if (payment.invoiceNumbers) {
                             // 替换所有出现的旧发票编号为新发票编号
                             payment.invoiceNumbers = payment.invoiceNumbers.split(',').map(num => 
                                 num.trim() === oldInvoiceNumber ? invoiceNumber : num.trim()
                             ).join(', ');
                         }
                     });
                 }
                 
                 // 2. 如果合同号发生变化，需要重新同步
                 let paymentSyncNeeded = false;
                 if (purchaseOrder !== oldInvoice.purchaseOrder) {
                     paymentSyncNeeded = true;
                     
                     // 从旧合同号的付款记录中移除发票编号
                     payments.forEach(payment => {
                         if (payment.contractNumber) {
                             const paymentContractNum = payment.contractNumber.trim();
                             if (oldContractNumbers.includes(paymentContractNum) && payment.invoiceNumbers) {
                                 // 从发票编号列表中移除
                                 payment.invoiceNumbers = payment.invoiceNumbers.split(',').map(num => num.trim())
                                     .filter(num => num !== oldInvoiceNumber)
                                     .join(', ');
                             }
                         }
                     });
                 }
                 
                 // 更新发票数据
                 invoices[invoiceIndex] = {
                     ...oldInvoice,
                     invoiceNumber,
                     invoiceDate,
                     amount,
                     purchaseOrder,
                     supplier,
                     remark,
                     updatedAt: new Date().toISOString()
                 };
                 
                 // 如果需要重新同步，处理新合同号的付款记录
                 if (paymentSyncNeeded) {
                     const newInvoice = invoices[invoiceIndex];
                     
                     // 查找与新合同号匹配的付款记录
                     const relatedPayments = payments.filter(payment => {
                         const paymentContractNum = payment.contractNumber?.trim() || '';
                         return newContractNumbers.includes(paymentContractNum);
                     });
                     
                     if (relatedPayments.length > 0) {
                         // 计算总付款金额
                         const totalPaymentAmount = relatedPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                         
                         // 更新发票状态
                         if (totalPaymentAmount >= newInvoice.amount) {
                             newInvoice.status = '已付清';
                         } else if (totalPaymentAmount > 0) {
                             newInvoice.status = '部分付款';
                         } else {
                             newInvoice.status = '未付款';
                         }
                         
                         // 记录总付款金额和差额
                         newInvoice.totalPaid = totalPaymentAmount;
                         newInvoice.paymentDifference = newInvoice.amount - totalPaymentAmount;
                         
                         // 将发票编号添加到新合同号的付款记录中
                         relatedPayments.forEach(payment => {
                             if (!payment.invoiceNumbers || payment.invoiceNumbers.trim() === '') {
                                 payment.invoiceNumbers = invoiceNumber;
                             } else if (!payment.invoiceNumbers.includes(invoiceNumber)) {
                                 payment.invoiceNumbers += `, ${invoiceNumber}`;
                             }
                         });
                     }
                 }
                 
                 // 保存更新后的付款记录
                 localStorage.setItem(paymentStorageKey, JSON.stringify(payments));
                 // 调用更新仪表盘统计数据函数
                 updateDashboardStats();
                 
                 // 保存更新后的发票
                 localStorage.setItem(storageKey, JSON.stringify(invoices));
                 // 调用更新仪表盘统计数据函数
                 updateDashboardStats();

                 // 关闭模态框
                 modal.remove();

                 // 重新渲染发票列表
                 renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
                 
                 // 重新渲染付款列表，确保发票变更反映到付款记录
                 if (typeof renderPaymentList === 'function') {
                     renderPaymentList(document.getElementById('payment-search-input')?.value || '');
                 }
                 
                 // 重新渲染采购订单列表，确保发票状态同步更新到对应合同号
                 if (typeof renderPurchaseOrderList === 'function') {
                     renderPurchaseOrderList();
                 }
             }
         }

         // 删除发票
         function deleteInvoice(invoiceId) {
             if (confirm('确定要删除此发票吗？删除后无法恢复。')) {
                 const storageKey = `${getCurrentCompany()}-invoices`;
                 const paymentStorageKey = `${getCurrentCompany()}-payments`;
                 const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
                 const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
                 
                 // 查找要删除的发票，获取其发票编号
                 const invoiceToDelete = invoices.find(inv => inv.id === invoiceId);
                 const invoiceNumber = invoiceToDelete?.invoiceNumber;
                 
                 // 从付款记录中移除对应的发票编号
                 if (invoiceNumber) {
                     payments.forEach(payment => {
                         if (payment.invoiceNumbers) {
                             // 从发票编号列表中移除该发票编号
                             payment.invoiceNumbers = payment.invoiceNumbers.split(',').map(num => num.trim())
                                 .filter(num => num !== invoiceNumber)
                                 .join(', ');
                         }
                     });
                     
                     // 保存更新后的付款记录
                     localStorage.setItem(paymentStorageKey, JSON.stringify(payments));
                     // 调用更新仪表盘统计数据函数
                     updateDashboardStats();
                 }
                 
                 // 删除发票
                 const updatedInvoices = invoices.filter(inv => inv.id !== invoiceId);
                 localStorage.setItem(storageKey, JSON.stringify(updatedInvoices));
                 // 调用更新仪表盘统计数据函数
                 updateDashboardStats();
                 
                 // 重新渲染发票列表
                 renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
                 
                 // 重新渲染付款列表，确保删除发票后付款记录正确更新
                 if (typeof renderPaymentList === 'function') {
                     renderPaymentList(document.getElementById('payment-search-input')?.value || '');
                 }
                 
                 // 重新渲染采购订单列表，确保发票状态同步更新到对应合同号
                 if (typeof renderPurchaseOrderList === 'function') {
                     renderPurchaseOrderList();
                 }
             }
         }

 
         
         // 付款列表分页变量
         let paymentCurrentPage = 1;
         const paymentPageSize = 10;

         // 渲染付款列表
         // 根据合同号查找匹配的发票编号
         function findMatchingInvoiceNumbers(contractNumber) {
             if (!contractNumber) return null;
             
             const storageKey = `${getCurrentCompany()}-invoices`;
             const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
             
             // 查找与合同号匹配的发票
             const matchingInvoices = invoices.filter(invoice => 
                 invoice.purchaseOrder === contractNumber || 
                 invoice.purchaseOrder === contractNumber.trim()
             );
             
             if (matchingInvoices.length === 0) return null;
             
             // 提取并返回所有匹配的发票编号，用逗号分隔
             return matchingInvoices.map(inv => inv.invoiceNumber).join(', ');
         }
         
         function renderPaymentList(searchTerm = '', startDate = null, endDate = null) {
             const storageKey = `${getCurrentCompany()}-payments`;
             let payments = JSON.parse(localStorage.getItem(storageKey)) || [];

            // 应用搜索过滤器
            if (searchTerm.trim()) {
                const lowerCaseSearch = searchTerm.toLowerCase();
                payments = payments.filter(payment => 
                    (payment.paymentNumber?.toLowerCase().includes(lowerCaseSearch)) ||
                    (payment.invoiceNumber?.toLowerCase().includes(lowerCaseSearch)) ||
                    (payment.supplier?.toLowerCase().includes(lowerCaseSearch)) ||
                    (payment.amount?.toString().includes(lowerCaseSearch)) ||
                    (payment.status?.toLowerCase().includes(lowerCaseSearch))
                );
            }
            
            // 日期范围筛选
            if (startDate || endDate) {
                const startDateTime = startDate ? new Date(startDate) : new Date(0);
                const endDateTime = endDate ? new Date(endDate) : new Date();
                // 设置结束日期的时间为当天的23:59:59
                endDateTime.setHours(23, 59, 59, 999);
                
                payments = payments.filter(payment => {
                    if (!payment.paymentDate) return false;
                    const paymentDateTime = new Date(payment.paymentDate);
                    return paymentDateTime >= startDateTime && paymentDateTime <= endDateTime;
                });
            }
            
            // 按付款日期倒序排序
            payments.sort((a, b) => {
                const dateA = a.paymentDate ? new Date(a.paymentDate) : new Date(0);
                const dateB = b.paymentDate ? new Date(b.paymentDate) : new Date(0);
                return dateB - dateA; // 倒序排序
            });
             
            const tableBody = document.getElementById('paymentListTableBody');

             // 清空表格
             tableBody.innerHTML = '';

             if (payments.length === 0) {
                 const emptyRow = document.createElement('tr');
                 emptyRow.innerHTML = `<td colspan="11" class="text-center py-8 text-gray-500">暂无付款数据</td>`;
                 tableBody.appendChild(emptyRow);
                 
                 // 更新统计信息
                 document.getElementById('paymentTotalAmount').textContent = '¥0.00';
                 document.getElementById('paymentTotalRecords').textContent = '0';
                 document.getElementById('paymentPageInfo').textContent = '第 1/1 页';
                 return;
             }

             // 计算总金额合计
             const totalAmount = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
             document.getElementById('paymentTotalAmount').textContent = formatCurrency(totalAmount);

             // 更新记录条数
             document.getElementById('paymentTotalRecords').textContent = payments.length;

             // 更新表格中的付款合计
             const paymentTotalTableElement = document.getElementById('paymentTotalAmountTable');
             if (paymentTotalTableElement) {
                 paymentTotalTableElement.textContent = formatCurrency(totalAmount);
             }

             // 分页计算
             const totalPages = Math.ceil(payments.length / paymentPageSize);
              // 确保当前页在有效范围内
             if (paymentCurrentPage > totalPages) {
                 paymentCurrentPage = totalPages;
             }

             // 获取当前页的数据
             const startIndex = (paymentCurrentPage - 1) * paymentPageSize;
             const endIndex = startIndex + paymentPageSize;
             const currentPagePayments = payments.slice(startIndex, endIndex);

             // 渲染每个付款记录
             currentPagePayments.forEach(payment => {
                 const row = document.createElement('tr');
                 row.dataset.paymentId = payment.id;

                 // 格式化日期
                 const formatDate = (dateString) => {
                     if (!dateString) return '-';
                     const date = new Date(dateString);
                     return date.toISOString().split('T')[0];
                 };

                 // 获取发票状态 - 基于发票编号查找
                 const getInvoiceStatus = (invoiceNumbers) => {
                     if (!invoiceNumbers) return '部分付款';
                     const storageKey = `${getCurrentCompany()}-invoices`;
                     const invoices = JSON.parse(localStorage.getItem(storageKey)) || [];
                     
                     // 处理多个发票编号（逗号分隔）
                     const invoiceNumbersArray = invoiceNumbers.split(',')
                         .map(num => num.trim())
                         .filter(num => num);
                     
                     if (invoiceNumbersArray.length === 0) return '部分付款';
                     
                     // 查找所有匹配的发票
                     const matchingInvoices = invoices.filter(inv => 
                         invoiceNumbersArray.includes(inv.invoiceNumber)
                     );
                     
                     if (matchingInvoices.length === 0) return '部分付款';
                     
                     // 如果只有一个匹配的发票，直接返回其状态
                     if (matchingInvoices.length === 1) {
                         return matchingInvoices[0].status || '部分付款';
                     }
                     
                     // 多个发票时，基于状态进行汇总
                     const statuses = matchingInvoices.map(inv => inv.status || '部分付款');
                     
                     // 如果所有发票都已付清
                     if (statuses.every(status => status === '已付清')) {
                         return '已付清';
                     }
                     
                     // 如果有部分付款和未付款
                     if (statuses.some(status => status === '部分付款') || 
                         statuses.some(status => status === '未付款')) {
                         return '部分付款';
                     }
                     
                     // 默认返回第一个状态
                     return statuses[0] || '部分付款';
                 };

                 // 创建行元素
                 row.innerHTML = `
                     <td>
                         <input type="checkbox" class="rounded text-primary focus:ring-primary">
                     </td>
                     <td>${payment.contractNumber || payment.paymentNumber || 'N/A'}</td>
                     <td>${(() => {
                        // 首先检查是否已有发票编号
                        if (payment.invoiceNumbers && payment.invoiceNumbers.trim()) {
                            return payment.invoiceNumbers;
                        }
                        
                        // 如果是合同相关付款类型，尝试根据合同号查找匹配的发票编号
                        if ((payment.paymentType === 'contract-first' || payment.paymentType === 'payment-first') && 
                            payment.contractNumber) {
                            
                            const matchingInvoiceNumbers = findMatchingInvoiceNumbers(payment.contractNumber);
                            if (matchingInvoiceNumbers) {
                                // 有匹配的发票编号，直接显示
                                return matchingInvoiceNumbers;
                            } else {
                                // 没有匹配的发票编号，显示"缺票"
                                return `<span class="text-red-700 font-bold" style="background-color: #ffebee; padding: 2px 5px; border-radius: 3px;">缺票</span>`;
                            }
                        }
                        
                        return payment.invoiceNumbers || 'N/A';
                     })()}</td>
                     <td>${(() => {
                        // 确定使用的发票编号（优先使用已有的，没有则尝试匹配）
                        let invoiceNumbersToUse = payment.invoiceNumbers;
                        if (!invoiceNumbersToUse && payment.contractNumber) {
                            invoiceNumbersToUse = findMatchingInvoiceNumbers(payment.contractNumber);
                        }
                        
                        // 如果有发票编号，获取并显示其状态
                        if (invoiceNumbersToUse) {
                            const status = getInvoiceStatus(invoiceNumbersToUse);
                            if (status === '已付清') {
                                return `<span class="status-badge bg-green-800 text-white px-2 py-1 rounded text-sm">${status}</span>`;
                            } else if (status === '部分付款') {
                                return `<span class="status-badge bg-yellow-500 text-white px-2 py-1 rounded text-sm">${status}</span>`;
                            } else {
                                return status;
                            }
                        } else {
                            // 没有发票编号时的逻辑保持不变
                            if (payment.paymentType === 'payment-first') return '未生成';
                            if (payment.paymentType === 'contract-first' && payment.contractNumber) {
                                const statusInfo = getOrderPaymentStatus(payment.contractNumber);
                                if (statusInfo.status === '已全额付款') {
                                  return `<span class="status-badge bg-green-800 text-white px-2 py-1 rounded text-sm">已付清</span>`;
                                } else if (statusInfo.status === '部分付款') {
                                  return `<span class="status-badge bg-yellow-500 text-white px-2 py-1 rounded text-sm">部分付款</span>`;
                                }
                                return statusInfo.status;
                            }
                            return `<span class="status-badge bg-yellow-500 text-white px-2 py-1 rounded text-sm">部分付款</span>`;
                        }
                    })()}</td>
                     <td>${payment.paymentType === 'contract-first' ? 
                         `<span class="text-red-700 font-bold" style="background-color: #ffebee; padding: 2px 5px; border-radius: 3px;">先付款后票</span>` : 
                         (payment.paymentType === 'payment-first' ? '先付款再开票' : payment.paymentType === 'invoice-first' ? '先票后付款' : 'N/A')
                     }</td>
                     <td>${payment.supplier || 'N/A'}</td>
                     <td>${formatDate(payment.paymentDate)}</td>
                     <td>${formatCurrency(payment.amount)}</td>
                     <td>${payment.paymentMethod || 'N/A'}</td>
                     <td class="action-buttons">
                         <button class="btn btn-small btn-secondary mr-1 edit-payment-btn" title="编辑" data-payment-id="${payment.id}">
                             <i class="fa fa-pencil"></i>
                         </button>
                         <button class="btn btn-small btn-danger delete-payment-btn" title="删除" data-payment-id="${payment.id}">
                             <i class="fa fa-trash"></i>
                         </button>
                         <button class="btn btn-small btn-primary mr-1 add-to-balance-btn" title="添加到收支表" 
                             data-supplier="${payment.supplier || 'N/A'}" 
                             data-date="${formatDate(payment.paymentDate)}" 
                             data-amount="${payment.amount}">
                             <i class="fa fa-plus"></i>
                         </button>
                     </td>
                 `;

                 // 先添加到DOM再绑定事件
                 tableBody.appendChild(row);
                 
                 // 为复选框添加选中行背景色功能
                 const checkbox = row.querySelector('input[type="checkbox"]');
                 if (checkbox) {
                     checkbox.addEventListener('change', function() {
                         if (this.checked) {
                             row.classList.add('bg-blue-50'); // 选中时添加浅蓝色背景
                         } else {
                             row.classList.remove('bg-blue-50'); // 取消选中时移除背景色
                         }
                     });
                 }
                 
                 // 为按钮添加事件监听器
                 const editBtn = row.querySelector('.edit-payment-btn');
                 const deleteBtn = row.querySelector('.delete-payment-btn');
                 const addToBalanceBtn = row.querySelector('.add-to-balance-btn');
                 
                 if (editBtn) editBtn.onclick = function() { editPayment(payment.id); };
                 if (deleteBtn) deleteBtn.onclick = function() { deletePayment(payment.id); };
                 if (addToBalanceBtn) {
                     addToBalanceBtn.onclick = function() {
                         const supplier = this.getAttribute('data-supplier');
                         const date = this.getAttribute('data-date');
                         const amount = this.getAttribute('data-amount');
                         
                         // 构造URL参数
                         const params = new URLSearchParams();
                         params.append('type', 'expense');
                         params.append('unit', supplier);
                         params.append('date', date);
                         params.append('amount', amount);
                         params.append('autoOpen', 'true');
                         
                         // 打开收支表页面并传递参数
                         window.open(`收支表.html?${params.toString()}`, 'balance_sheet_window', 'noopener,noreferrer');
                     };
                 };
             });

             // 更新分页信息
             document.getElementById('paymentPageInfo').textContent = `第 ${paymentCurrentPage}/${totalPages} 页`;

             // 控制导航按钮状态

             // 添加复选框事件监听，实现选中合计功能
             const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]');
             checkboxes.forEach(checkbox => {
                 checkbox.addEventListener('change', updatePaymentSelectionTotal);
             });
             const firstPageBtn = document.getElementById('paymentFirstPage');
             const prevPageBtn = document.getElementById('paymentPrevPage');
             const nextPageBtn = document.getElementById('paymentNextPage');
             const lastPageBtn = document.getElementById('paymentLastPage');

             firstPageBtn.disabled = paymentCurrentPage === 1;
             prevPageBtn.disabled = paymentCurrentPage === 1;
             nextPageBtn.disabled = paymentCurrentPage === totalPages;
             lastPageBtn.disabled = paymentCurrentPage === totalPages;
         }

         // 更新付款选中合计
         function updatePaymentSelectionTotal() {
             const checkboxes = document.querySelectorAll('#paymentListTableBody input[type="checkbox"]:checked');
             
             if (checkboxes.length === 0) {
                 // 没有选中项，恢复原合计
                 const storageKey = `${getCurrentCompany()}-payments`;
                 const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
                 const totalAmount = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
                 
                 const paymentTotalTableElement = document.getElementById('paymentTotalAmountTable');
                 if (paymentTotalTableElement) {
                     paymentTotalTableElement.textContent = formatCurrency(totalAmount);
                 }
                 return;
             }
             
             // 计算选中项合计
             let selectedTotalAmount = 0;
             
             checkboxes.forEach(checkbox => {
                 const row = checkbox.closest('tr');
                 const paymentId = row.dataset.paymentId;
                 
                 // 查找对应的付款记录
                 const storageKey = `${getCurrentCompany()}-payments`;
                 const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
                 const payment = payments.find(p => p.id === paymentId);
                 
                 if (payment) {
                     selectedTotalAmount += parseFloat(payment.amount || 0);
                 }
             });
             
             // 更新合计显示
             const paymentTotalTableElement = document.getElementById('paymentTotalAmountTable');
             if (paymentTotalTableElement) {
                 paymentTotalTableElement.textContent = formatCurrency(selectedTotalAmount);
             }
         }

         // 查看付款详情功能
         function viewPayment(paymentId) {
             // 直接使用alert显示详情，确保功能正常工作
             const storageKey = `${getCurrentCompany()}-payments`;
             const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
             const payment = payments.find(p => p.id === paymentId);
             
             if (payment) {
                 let detailStr = '付款详情:\n';
                 detailStr += `合同号: ${payment.contractNumber || payment.paymentNumber || 'N/A'}\n`;
                 detailStr += `发票编号: ${payment.invoiceNumbers || 'N/A'}\n`;
                 detailStr += `付款类型: ${payment.paymentType === 'payment-first' ? '先付款再开票' : payment.paymentType === 'invoice-first' ? '先票后付款' : 'N/A'}\n`;
                 detailStr += `供应商: ${payment.supplier || 'N/A'}\n`;
                 detailStr += `付款日期: ${formatDate(payment.paymentDate)}\n`;
                 detailStr += `金额: ¥${payment.amount.toFixed(2)}\n`;
                 detailStr += `付款方式: ${payment.paymentMethod || 'N/A'}\n`;
                 detailStr += `状态: ${payment.status || '部分付款'}\n`;
                 if (payment.remark) {
                     detailStr += `备注: ${payment.remark}`;
                 }
                 
                 alert(detailStr);
             } else {
                 alert('未找到该付款记录');
             }
         }

         // 编辑付款功能
         function editPayment(paymentId) {
             const storageKey = `${getCurrentCompany()}-payments`;
             const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
             const payment = payments.find(p => p.id === paymentId);
             
             if (payment) {
                 // 创建编辑模态框
                 const modal = document.createElement('div');
                 modal.className = 'modal-overlay';
                 modal.innerHTML = `
                     <div class="modal-content w-full max-w-lg">
                         <div class="modal-header">
                             <h3 class="text-lg font-medium">编辑付款信息</h3>
                             <button class="close-btn" title="关闭">&times;</button>
                         </div>
                         <div class="modal-body p-4">
                             <form id="edit-payment-form" class="space-y-4">
                                 <input type="hidden" id="edit-payment-id" value="${payment.id}">
                                 <div class="grid grid-cols-2 gap-4">
                                     <div>
                                         <label class="block text-sm font-medium mb-1">付款日期</label>
                                         <input type="date" id="edit-payment-date" value="${payment.paymentDate}" class="form-input w-full">
                                     </div>
                                     <div>
                                         <label class="block text-sm font-medium mb-1">金额</label>
                                         <input type="number" id="edit-amount" value="${payment.amount}" step="0.01" min="0" class="form-input w-full">
                                     </div>
                                 </div>
                                 <div>
                                     <label class="block text-sm font-medium mb-1">付款方式</label>
                                     <input type="text" id="edit-payment-method" value="${payment.paymentMethod || ''}" class="form-input w-full">
                                 </div>
                                
                                 <div>
                                     <label class="block text-sm font-medium mb-1">备注</label>
                                     <textarea id="edit-remark" rows="3" class="form-input w-full">${payment.remark || ''}</textarea>
                                 </div>
                             </form>
                         </div>
                         <div class="modal-footer">
                             <button type="button" class="btn btn-default close-btn">取消</button>
                             <button type="button" id="save-payment-btn" class="btn btn-primary">保存修改</button>
                         </div>
                     </div>
                 `;
                 
                 document.body.appendChild(modal);
                 
                 // 保存修改事件
                 modal.querySelector('#save-payment-btn').addEventListener('click', () => {
                     const form = modal.querySelector('#edit-payment-form');
                     const id = form.querySelector('#edit-payment-id').value;
                     const paymentDate = form.querySelector('#edit-payment-date').value;
                     const amount = parseFloat(form.querySelector('#edit-amount').value);
                     const paymentMethod = form.querySelector('#edit-payment-method').value;
                     const remark = form.querySelector('#edit-remark').value;
                     
                     // 验证必填字段
                     if (!paymentDate || isNaN(amount) || amount <= 0) {
                         alert('请填写有效的付款日期和金额');
                         return;
                     }
                     
                     // 更新付款记录
                     const updatedPayments = payments.map(p => {
                         if (p.id === id) {
                             return {
                                 ...p,
                                 paymentDate,
                                 amount,
                                 paymentMethod,
                                 remark: remark.trim(),
                                 updatedAt: new Date().toISOString()
                             };
                         }
                         return p;
                     });
                     
                     // 保存到localStorage
                     localStorage.setItem(storageKey, JSON.stringify(updatedPayments));
                     // 调用更新仪表盘统计数据函数
                     updateDashboardStats();
                      
                     // 在保存付款后调用更新状态函数
                     updateInvoicePaymentStatus();
                     
                     // 重新渲染付款列表以更新显示
                     if (typeof renderPaymentList === 'function') {
                         renderPaymentList(document.getElementById('payment-search-input')?.value || '');
                     }
                      
                     // 关闭模态框
                     document.body.removeChild(modal);
                     
                     // 重新渲染发票列表，确保付款变更反映到发票状态
                     try {
                         if (typeof renderInvoiceList === 'function') {
                             renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
                         }
                     } catch (e) {
                         console.log('更新发票列表时出错:', e);
                     }
                     
                     // 重新渲染付款列表
                     renderPaymentList(document.getElementById('payment-search-input')?.value || '');
                      
                     // 重新渲染采购订单列表，确保付款状态同步更新到对应合同号
                     if (typeof renderPurchaseOrderList === 'function') {
                         renderPurchaseOrderList();
                     }
                     
                     // 显示成功消息
                     showMessage('付款信息更新成功');
                 });
                 
                 // 关闭事件
                 modal.querySelectorAll('.close-btn').forEach(btn => {
                     btn.addEventListener('click', () => {
                         document.body.removeChild(modal);
                     });
                 });
                 
                 // 点击模态框外部关闭
                 modal.addEventListener('click', (e) => {
                     if (e.target === modal) {
                         document.body.removeChild(modal);
                     }
                 });
             }
         }

         // 删除付款功能
         function deletePayment(paymentId) {
             // 确认删除
             if (confirm('确定要删除这条付款记录吗？此操作不可撤销。')) {
                 const storageKey = `${getCurrentCompany()}-payments`;
                 const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
                 
                 // 过滤掉要删除的付款记录
                 const updatedPayments = payments.filter(p => p.id !== paymentId);
                 
                 // 保存到localStorage
                 localStorage.setItem(storageKey, JSON.stringify(updatedPayments));
                 // 调用更新仪表盘统计数据函数
                 updateDashboardStats();
                  
                 // 在删除付款后调用更新状态函数
                 updateInvoicePaymentStatus();
                  
                 // 重新渲染发票列表，确保付款变更反映到发票状态
                 try {
                     if (typeof renderInvoiceList === 'function') {
                         renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
                     }
                 } catch (e) {
                     console.log('更新发票列表时出错:', e);
                 }
                  
                 // 重新渲染付款列表
                 renderPaymentList(document.getElementById('payment-search-input')?.value || '');
                  
                 // 重新渲染采购订单列表，确保付款状态同步更新到对应合同号 - 安全检查
                 try {
                     if (typeof renderPurchaseOrderList === 'function') {
                         renderPurchaseOrderList();
                     }
                 } catch (e) {
                     console.log('未找到采购订单列表渲染函数，跳过更新');
                 }
                 
                 // 显示成功消息
                 showMessage('付款记录已成功删除');
             }
         }

         // 添加模态框基础样式
         const style = document.createElement('style');
         style.textContent = `
             .modal-overlay {
                 position: fixed;
                 top: 0;
                 left: 0;
                 right: 0;
                 bottom: 0;
                 background-color: rgba(0, 0, 0, 0.5);
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 z-index: 1000;
             }
             
             .modal-content {
                 background-color: white;
                 border-radius: 0.375rem;
                 box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                 overflow: hidden;
                 max-height: 90vh;
                 overflow-y: auto;
             }
             
             .modal-header {
                 display: flex;
                 justify-content: space-between;
                 align-items: center;
                 padding: 1rem;
                 border-bottom: 1px solid #e5e7eb;
             }
             
             .modal-body {
                 padding: 1rem;
             }
             
             .modal-footer {
                 display: flex;
                 justify-content: flex-end;
                 gap: 0.5rem;
                 padding: 1rem;
                 border-top: 1px solid #e5e7eb;
             }
             
             .close-btn {
                 background: none;
                 border: none;
                 font-size: 1.5rem;
                 cursor: pointer;
                 color: #6b7280;
             }
             
             .message-toast {
                 position: fixed;
                 top: 1rem;
                 right: 1rem;
                 background-color: #10b981;
                 color: white;
                 padding: 0.75rem 1rem;
                 border-radius: 0.375rem;
                 box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                 z-index: 50;
             }
         `;
         document.head.appendChild(style);

         // 显示消息提示函数
         function showMessage(message) {
             // 创建消息元素
             const msgElement = document.createElement('div');
             msgElement.className = 'message-toast fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50';
             msgElement.textContent = message;
             
             // 添加到页面
             document.body.appendChild(msgElement);
             
             // 3秒后自动移除
             setTimeout(() => {
                 // 添加淡出动画
                 msgElement.style.transition = 'opacity 0.3s ease';
                 msgElement.style.opacity = '0';
                 
                 // 动画结束后移除元素
                 setTimeout(() => {
                     if (msgElement.parentNode) {
                         document.body.removeChild(msgElement);
                     }
                 }, 300);
             }, 3000);
         }

         // 加载发票数据并创建复选框的函数
         function loadInvoiceDataForCheckboxes(supplierName) {
             const checkboxContainer = document.getElementById('invoice-checkboxes-container');
             const invoiceInput = document.getElementById('payment-invoice-id');
             
             if (!checkboxContainer || !invoiceInput) return;
             
             // 清空容器
             checkboxContainer.innerHTML = '';
             
             // 如果没有提供供应商，显示提示信息
             if (!supplierName || supplierName.trim() === '') {
                 checkboxContainer.innerHTML = '<div class="text-gray-500 text-sm">请先选择供应商</div>';
                 return;
             }
             
             // 从localStorage加载发票数据
             const invoiceStorageKey = `${getCurrentCompany()}-invoices`;
             const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
             
             // 根据供应商筛选发票
             const filteredInvoices = invoices.filter(invoice => 
                 invoice.supplier && invoice.supplier.toLowerCase() === supplierName.toLowerCase()
             );
             
             if (filteredInvoices.length === 0) {
                 checkboxContainer.innerHTML = `<div class="text-gray-500 text-sm">该供应商"${supplierName}"暂无可用发票</div>`;
                 return;
             }
             
             // 创建发票复选框
             filteredInvoices.forEach(invoice => {
                 if (invoice.invoiceNumber) {
                     const checkboxWrapper = document.createElement('div');
                     checkboxWrapper.className = 'flex items-center space-x-2 mb-2';
                     
                     const checkbox = document.createElement('input');
                     checkbox.type = 'checkbox';
                     checkbox.id = `invoice-checkbox-${invoice.invoiceNumber}`;
                     checkbox.value = invoice.invoiceNumber;
                     checkbox.className = 'form-checkbox h-4 w-4 text-blue-600';
                     
                     const label = document.createElement('label');
                     label.htmlFor = `invoice-checkbox-${invoice.invoiceNumber}`;
                     label.className = 'text-sm text-gray-700 cursor-pointer';
                     label.textContent = `${invoice.invoiceNumber} - ¥${invoice.amount || 0}`;
                     
                     checkboxWrapper.appendChild(checkbox);
                     checkboxWrapper.appendChild(label);
                     checkboxContainer.appendChild(checkboxWrapper);
                     
                     // 添加事件监听器
                     checkbox.addEventListener('change', updateInvoiceInput);
                 }
             });
         }
         
         // 根据复选框选中状态更新关联发票输入框
         function updateInvoiceInput() {
             const invoiceInput = document.getElementById('payment-invoice-id');
             const checkboxes = document.querySelectorAll('#invoice-checkboxes-container input[type="checkbox"]:checked');
             
             if (!invoiceInput) return;
             
             // 获取所有选中的发票编号
             const selectedInvoices = Array.from(checkboxes).map(cb => cb.value);
             
             // 将选中的发票编号用逗号分隔填充到输入框
             invoiceInput.value = selectedInvoices.join(', ');
         }
         
         // 付款列表分页控制
         document.addEventListener('DOMContentLoaded', function() {
             // 新建付款按钮事件
             // 切换付款表单函数
             function togglePaymentForm(paymentType) {
                 const invoiceSection = document.getElementById('invoice-payment-section');
                 const contractSection = document.getElementById('contract-payment-section');
                 
                 if (paymentType === 'invoice') {
                     // 显示凭发票付款部分，隐藏凭合同付款部分
                     invoiceSection.classList.remove('hidden');
                     contractSection.classList.add('hidden');
                 } else {
                     // 显示凭合同付款部分，隐藏凭发票付款部分
                     invoiceSection.classList.add('hidden');
                     contractSection.classList.remove('hidden');
                     // 初始化合同付款部分的供应商选择功能
                     initContractPaymentSupplierSelection();
                 }
             }
             
             // 初始化合同付款部分的供应商选择功能
             function initContractPaymentSupplierSelection() {
                 const contractPaymentSupplierInput = document.getElementById('contract-payment-supplier');
                 const contractPaymentSupplierResults = document.getElementById('contract-payment-supplier-search-results');
                 const contractPaymentNumberInput = document.getElementById('contract-payment-number');
                 const contractSelectionContainer = document.getElementById('contract-selection-container');
                 const contractSelectionList = document.getElementById('contract-selection-list');
                 
                 // 防止重复绑定事件
                 const hasInitAttribute = contractPaymentSupplierInput.getAttribute('data-initialized');
                 if (hasInitAttribute) return;
                 
                 if (contractPaymentSupplierInput && contractPaymentSupplierResults) {
                     // 标记为已初始化
                     contractPaymentSupplierInput.setAttribute('data-initialized', 'true');
                     
                     // 供应商输入事件
                     contractPaymentSupplierInput.addEventListener('input', function(e) {
                         const searchTerm = e.target.value.toLowerCase().trim();
                         contractPaymentSupplierResults.innerHTML = '';
                         
                         if (searchTerm === '') {
                             contractPaymentSupplierResults.classList.add('hidden');
                             return;
                         }
                         
                         // 从localStorage加载采购订单数据
                         const storageKey = `purchaseOrders_${getCurrentCompany()}`;
                         const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                         
                         // 创建所有供应商的集合
                         const suppliers = new Set();
                         
                         // 从采购订单中提取供应商
                         purchaseOrders.forEach(order => {
                             if (order.supplier) {
                                 suppliers.add(order.supplier);
                             }
                         });
                         
                         // 过滤供应商
                         const filteredSuppliers = Array.from(suppliers).filter(supplier => 
                             supplier.toLowerCase().includes(searchTerm)
                         );
                         
                         // 显示搜索结果
                         if (filteredSuppliers.length > 0) {
                             filteredSuppliers.forEach(supplier => {
                                 const resultItem = document.createElement('div');
                                 resultItem.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100 transition-colors';
                                 resultItem.textContent = supplier;
                                 
                                 // 点击搜索结果时更新供应商名称
                                 resultItem.addEventListener('click', function() {
                                     contractPaymentSupplierInput.value = supplier;
                                     contractPaymentSupplierResults.classList.add('hidden');
                                     
                                     // 加载该供应商的合同数据
                                     loadContractDataForCheckboxes(supplier);
                                 });
                                 
                                 contractPaymentSupplierResults.appendChild(resultItem);
                             });
                             
                             contractPaymentSupplierResults.classList.remove('hidden');
                         } else {
                             contractPaymentSupplierResults.classList.add('hidden');
                         }
                     });
                 }
                 
                 // 点击页面其他地方关闭搜索结果
                 document.addEventListener('click', function(e) {
                     if (contractPaymentSupplierInput && contractPaymentSupplierResults && 
                         !contractPaymentSupplierInput.contains(e.target) && 
                         !contractPaymentSupplierResults.contains(e.target)) {
                         contractPaymentSupplierResults.classList.add('hidden');
                     }
                 });
             }
             
             // 加载合同数据并创建复选框的函数
             function loadContractDataForCheckboxes(supplierName) {
                 const contractSelectionContainer = document.getElementById('contract-selection-container');
                 const contractSelectionList = document.getElementById('contract-selection-list');
                 const contractPaymentNumberInput = document.getElementById('contract-payment-number');
                 
                 if (!contractSelectionContainer || !contractSelectionList || !contractPaymentNumberInput) return;
                 
                 // 清空容器
                 contractSelectionList.innerHTML = '';
                 
                 // 如果没有提供供应商，隐藏容器
                 if (!supplierName || supplierName.trim() === '') {
                     contractSelectionContainer.classList.add('hidden');
                     return;
                 }
                 
                 // 从localStorage加载采购订单数据
                 const storageKey = `purchaseOrders_${getCurrentCompany()}`;
                 const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                 
                 // 加载现有发票数据
                 const invoiceStorageKey = `${getCurrentCompany()}-invoices`;
                 const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
                 
                 // 加载现有付款数据
                 const paymentStorageKey = `${getCurrentCompany()}-payments`;
                 const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
                 
                 // 获取发票和付款中已存在的合同号
                 const existingContractNumbers = new Set();
                 
                 // 1. 从发票中提取合同号 - 多种可能的关联方式
                 invoices.forEach(invoice => {
                     // 方法1：通过purchaseOrder字段关联到采购订单
                     if (invoice.purchaseOrder) {
                         const order = purchaseOrders.find(o => o.id === invoice.purchaseOrder);
                         if (order && order.contractNumber) {
                             existingContractNumbers.add(order.contractNumber);
                         }
                     }
                     
                     // 方法2：直接使用发票中的purchaseOrder字段作为合同号
                     if (invoice.purchaseOrder && invoice.purchaseOrder.startsWith('PO')) {
                         existingContractNumbers.add(invoice.purchaseOrder);
                     }
                 });
                 
                 // 2. 从付款中提取合同号
                 payments.forEach(payment => {
                     // 方法1：通过invoiceNumbers关联到发票，再关联到采购订单
                     if (payment.invoiceNumbers) {
                         // 处理可能是逗号分隔的多个发票编号
                         const invoiceNumbers = payment.invoiceNumbers.split(',').map(num => num.trim());
                         invoiceNumbers.forEach(invoiceNumber => {
                             // 查找对应的发票
                             const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);
                             if (invoice && invoice.purchaseOrder) {
                                 // 查找对应的采购订单
                                 const order = purchaseOrders.find(o => o.id === invoice.purchaseOrder || o.purchaseOrderNumber === invoice.purchaseOrder);
                                 if (order && order.contractNumber) {
                                     existingContractNumbers.add(order.contractNumber);
                                 } else if (invoice.purchaseOrder.startsWith('PO')) {
                                     // 如果找不到订单，但purchaseOrder看起来像合同号，直接添加
                                     existingContractNumbers.add(invoice.purchaseOrder);
                                 }
                             }
                         });
                     }
                     
                     // 方法2：直接检查付款记录中的contractNumber或paymentNumber字段
                     if (payment.contractNumber) {
                         existingContractNumbers.add(payment.contractNumber);
                     }
                     if (payment.paymentNumber && payment.paymentNumber.includes('-')) {
                         // 如果paymentNumber格式包含连字符，可能包含合同信息
                         existingContractNumbers.add(payment.paymentNumber);
                     }
                 });
                 
                 // 3. 额外检查：确保正确从采购订单中提取合同号
                 // 创建采购订单ID到合同号的映射
                 const orderIdToContractMap = new Map();
                 purchaseOrders.forEach(order => {
                     if (order.id && order.contractNumber) {
                         orderIdToContractMap.set(order.id, order.contractNumber);
                     }
                     if (order.purchaseOrderNumber && order.contractNumber) {
                         orderIdToContractMap.set(order.purchaseOrderNumber, order.contractNumber);
                     }
                 });
                 
                 // 4. 根据供应商筛选采购订单，并过滤掉已存在于发票和付款中的合同
                 const filteredOrders = purchaseOrders.filter(order => {
                     // 供应商名称模糊匹配
                     const supplierMatch = order.supplier && 
                                           order.supplier.toLowerCase().includes(supplierName.toLowerCase());
                     
                     // 确保有合同号且不在已存在的合同号集合中
                     const hasValidContract = order.contractNumber && 
                                             !existingContractNumbers.has(order.contractNumber);
                     
                     return supplierMatch && hasValidContract;
                 });
                 
                 // 按合同号分组 - 使用全局变量以便其他函数访问
                 window.contractsByNumber = {};
                 filteredOrders.forEach(order => {
                     if (!window.contractsByNumber[order.contractNumber]) {
                         window.contractsByNumber[order.contractNumber] = [];
                     }
                     window.contractsByNumber[order.contractNumber].push(order);
                 });
                 
                 // 计算每个合同号的已支付金额 - 定义为全局函数以便其他函数访问
                 window.calculatePaidAmount = function(contractNumber) {
                     let paidAmount = 0;
                     
                     // 从付款记录中查找已支付金额
                     payments.forEach(payment => {
                         // 如果付款记录中有直接关联的合同号
                         if (payment.contractNumber === contractNumber || 
                             (payment.paymentNumber && payment.paymentNumber.includes(contractNumber))) {
                             paidAmount += parseFloat(payment.amount) || 0;
                         }
                         
                         // 通过发票关联的方式查找已支付金额
                         if (payment.invoiceNumbers) {
                             const invoiceNumbers = payment.invoiceNumbers.split(',').map(num => num.trim());
                             invoiceNumbers.forEach(invoiceNumber => {
                                 const invoice = invoices.find(inv => inv.invoiceNumber === invoiceNumber);
                                 if (invoice && invoice.purchaseOrder) {
                                     const relatedOrder = purchaseOrders.find(o => 
                                         o.id === invoice.purchaseOrder || 
                                         o.purchaseOrderNumber === invoice.purchaseOrder
                                     );
                                     if (relatedOrder && relatedOrder.contractNumber === contractNumber) {
                                         paidAmount += parseFloat(payment.amount) || 0;
                                     }
                                 }
                             });
                         }
                     });
                     
                     return paidAmount;
                 }
                 
                 if (Object.keys(window.contractsByNumber).length === 0) {
                     contractSelectionList.innerHTML = `<div class="text-gray-500 text-sm">该供应商"${supplierName}"暂无可用合同</div>`;
                     contractSelectionContainer.classList.remove('hidden');
                     return;
                 }
                 
                 // 初始化选中的合同数组
                 let selectedContracts = [];
                 
                 // 创建合同复选框
                 Object.keys(window.contractsByNumber).forEach(contractNumber => {
                     const orders = window.contractsByNumber[contractNumber];
                     const totalAmount = orders.reduce((sum, order) => sum + (parseFloat(order.totalAmount) || 0), 0);
                     const paidAmount = calculatePaidAmount(contractNumber);
                     const outstandingAmount = totalAmount - paidAmount;
                     
                     const checkboxWrapper = document.createElement('div');
                     checkboxWrapper.className = 'flex items-center space-x-2 mb-2';
                     
                     const checkbox = document.createElement('input');
                     checkbox.type = 'checkbox';
                     checkbox.className = 'rounded text-primary focus:ring-primary';
                     checkbox.value = contractNumber;
                     
                     // 合同信息标签
                     const label = document.createElement('label');
                     label.className = 'flex-1 flex items-center justify-between cursor-pointer';
                     label.appendChild(checkbox);
                     
                     const infoSpan = document.createElement('span');
                     infoSpan.className = 'ml-2 text-sm';
                     infoSpan.innerHTML = `合同号: ${contractNumber} <span class="text-gray-500">(合同金额: ¥${totalAmount.toFixed(2)}, 欠款金额: ¥${outstandingAmount.toFixed(2)})</span>`;
                     label.appendChild(infoSpan);
                     
                     checkboxWrapper.appendChild(label);
                     contractSelectionList.appendChild(checkboxWrapper);
                     
                     // 复选框变化事件
                     checkbox.addEventListener('change', function() {
                         if (this.checked) {
                             selectedContracts.push(contractNumber);
                         } else {
                             selectedContracts = selectedContracts.filter(c => c !== contractNumber);
                         }
                         
                         // 更新合同号输入框
                         contractPaymentNumberInput.value = selectedContracts.join(', ');
                     });
                 });
                 
                 // 显示合同选择容器
                 contractSelectionContainer.classList.remove('hidden');
             }
             
             document.getElementById('create-payment-btn').addEventListener('click', function() {
                 // 清空表单
                 document.getElementById('create-payment-form').reset();
                 
                 // 隐藏新发票信息部分
                 document.getElementById('new-invoice-section').classList.add('hidden');
                 
                 // 设置付款日期为当日
                 const today = new Date().toISOString().split('T')[0];
                 document.getElementById('payment-date').value = today;
                 document.getElementById('contract-payment-date').value = today;
                 
                 // 默认选择凭发票付款
                 document.querySelector('input[name="payment-method-option"][value="invoice"]').checked = true;
                 
                 // 初始化显示凭发票付款表单
                 togglePaymentForm('invoice');
                 
                 // 添加单选框change事件监听器
                 document.querySelectorAll('input[name="payment-method-option"]').forEach(radio => {
                     radio.addEventListener('change', function() {
                         togglePaymentForm(this.value);
                     });
                 });
                 
                 // 显示模态框
                 document.getElementById('create-payment-modal').classList.remove('hidden');
                 
                 // 显示提示并将焦点设置到供应商输入框
                 alert('请先输入供应商进行查找并选择合同选项');
                 document.getElementById('payment-supplier').focus();
                 // 现在发票数据将在选择供应商后加载
                 
                 // 添加付款比例自动计算功能
                 const setupPaymentPercentageCalculation = () => {
                     const paymentPercentageInput = document.getElementById('payment-percentage');
                     const paymentAmountInput = document.getElementById('contract-payment-amount');
                     
                     // 确保元素存在
                     if (!paymentPercentageInput || !paymentAmountInput) return;
                     
                     // 移除可能存在的旧监听器，避免重复绑定
                     const newPercentageInput = paymentPercentageInput.cloneNode(true);
                     paymentPercentageInput.parentNode.replaceChild(newPercentageInput, paymentPercentageInput);
                     
                     // 计算选中合同的总欠款金额（支持多个合同）
                     const calculateTotalOutstanding = () => {
                         console.log('开始计算总欠款金额');
                         let totalOutstanding = 0;
                         const contractNumberInput = document.getElementById('contract-payment-number');
                         
                         console.log('contractNumberInput是否存在:', !!contractNumberInput);
                         if (contractNumberInput && contractNumberInput.value) {
                             console.log('合同号输入框值:', contractNumberInput.value);
                             // 解析逗号分隔的合同号字符串
                             const contractNumbers = contractNumberInput.value
                                 .split(',')
                                 .map(num => num.trim())
                                 .filter(num => num !== '');
                                 
                             console.log('解析后的合同号数组:', contractNumbers);
                             console.log('window.contractsByNumber是否存在:', !!window.contractsByNumber);
                             if (!window.contractsByNumber) {
                                 console.error('window.contractsByNumber变量未定义或不可访问');
                             }
                             
                             // 计算每个合同的欠款金额并累加
                             contractNumbers.forEach(contractNumber => {
                                 console.log('处理合同号:', contractNumber);
                                 if (window.contractsByNumber && window.contractsByNumber[contractNumber]) {
                                     const orders = window.contractsByNumber[contractNumber];
                                     console.log('合同对应的订单:', orders);
                                     const totalAmount = orders.reduce((sum, order) => sum + (parseFloat(order.totalAmount) || 0), 0);
                                     console.log('合同总金额:', totalAmount);
                                     
                                     // 调用全局的calculatePaidAmount函数
                                     let paidAmount = 0;
                                     try {
                                         paidAmount = window.calculatePaidAmount(contractNumber);
                                         console.log('合同已支付金额:', paidAmount);
                                     } catch (e) {
                                         console.error('计算已支付金额时出错:', e);
                                     }
                                     
                                     const outstanding = totalAmount - paidAmount;
                                     console.log('合同欠款金额:', outstanding);
                                     totalOutstanding += outstanding;
                                 } else {
                                     console.log(`未找到合同号 ${contractNumber} 的数据`);
                                 }
                             });
                         }
                         console.log('最终总欠款金额:', totalOutstanding);
                         return totalOutstanding;
                     };
                     
                     // 付款比例变化时自动计算付款金额
                     newPercentageInput.addEventListener('input', function() {
                         console.log('付款比例输入框事件触发');
                         const percentage = parseFloat(this.value);
                         console.log('当前付款比例:', percentage);
                         
                         if (!isNaN(percentage) && percentage >= 0 && percentage <= 100) {
                             console.log('付款比例有效，开始计算付款金额');
                             const totalOutstanding = calculateTotalOutstanding();
                             console.log('总欠款金额:', totalOutstanding);
                             const calculatedAmount = (totalOutstanding * percentage) / 100;
                             console.log('计算出的付款金额:', calculatedAmount);
                             paymentAmountInput.value = calculatedAmount.toFixed(2);
                             console.log('更新付款金额输入框值:', paymentAmountInput.value);
                         } else {
                             console.log('无效的付款比例');
                         }
                     });
                      
                     // 合同选择变化时自动重新计算付款金额
                     const contractNumberInput = document.getElementById('contract-payment-number');
                     if (contractNumberInput) {
                         // 创建一个函数来重新计算付款金额
                         const recalculatePaymentAmount = () => {
                             const percentage = parseFloat(newPercentageInput.value);
                             if (!isNaN(percentage) && percentage >= 0 && percentage <= 100) {
                                 const totalOutstanding = calculateTotalOutstanding();
                                 const calculatedAmount = (totalOutstanding * percentage) / 100;
                                 paymentAmountInput.value = calculatedAmount.toFixed(2);
                             }
                         };
                         
                         // 使用MutationObserver监听输入框内容变化
                         const observer = new MutationObserver(recalculatePaymentAmount);
                         observer.observe(contractNumberInput, { attributes: true, attributeFilter: ['value'] });
                         
                         // 同时监听input事件，确保直接修改也能触发计算
                         contractNumberInput.addEventListener('input', recalculatePaymentAmount);
                     }
                 };
                 
                 // 初始设置
                 setupPaymentPercentageCalculation();
                 
                 // 在切换到合同付款模式时重新设置
                 document.querySelectorAll('input[name="payment-method-option"]').forEach(radio => {
                     radio.addEventListener('change', function() {
                         if (this.value === 'contract') {
                             setTimeout(setupPaymentPercentageCalculation, 100); // 延迟执行确保DOM已更新
                         }
                     });
                 });
                 
                 // 供应商名称输入框模糊搜索功能
                 const paymentSupplierInput = document.getElementById('payment-supplier');
                 const paymentSupplierResults = document.getElementById('payment-supplier-search-results');
                 const paymentContractNumberInput = document.getElementById('payment-number');
                 let invoicePaymentAmountInput = document.getElementById('payment-amount');
                 
                 if (paymentSupplierInput && paymentSupplierResults) {
                     // 供应商输入事件
                     paymentSupplierInput.addEventListener('input', function(e) {
                         const searchTerm = e.target.value.toLowerCase().trim();
                         paymentSupplierResults.innerHTML = '';
                         
                         if (searchTerm === '') {
                             paymentSupplierResults.classList.add('hidden');
                             return;
                         }
                         
                         // 从localStorage加载采购订单数据
                         const storageKey = `purchaseOrders_${getCurrentCompany()}`;
                         const purchaseOrders = JSON.parse(localStorage.getItem(storageKey)) || [];
                         
                         // 加载现有发票数据
                         const invoiceStorageKey = `${getCurrentCompany()}-invoices`;
                         const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
                         
                         // 创建所有供应商的集合
                         const suppliers = new Set();
                         
                         // 从采购订单中提取供应商
                         purchaseOrders.forEach(order => {
                             if (order.supplier) {
                                 suppliers.add(order.supplier);
                             }
                         });
                         
                         // 从发票中提取供应商
                         invoices.forEach(invoice => {
                             if (invoice.supplier) {
                                 suppliers.add(invoice.supplier);
                             }
                         });
                         
                         // 过滤供应商
                         const filteredSuppliers = Array.from(suppliers).filter(supplier => 
                             supplier.toLowerCase().includes(searchTerm)
                         );
                         
                         // 显示搜索结果
                         if (filteredSuppliers.length > 0) {
                             filteredSuppliers.forEach(supplier => {
                                 const resultItem = document.createElement('div');
                                 resultItem.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100 transition-colors';
                                 resultItem.textContent = supplier;
                                 
                                 // 点击搜索结果时更新供应商名称
                                 resultItem.addEventListener('click', function() {
                                     paymentSupplierInput.value = supplier;
                                     paymentSupplierResults.classList.add('hidden');
                                      
                                     // 加载该供应商的发票数据
                                     loadInvoiceDataForCheckboxes(supplier);
                                     
                                     // 根据选中的供应商，查找相关的合同号和金额信息
                                     // 查找该供应商的所有未付清发票
                                         const supplierInvoices = invoices.filter(inv => inv.supplier === supplier && inv.status !== '已付清');
                                     
                                     if (supplierInvoices.length > 0) {
                                         // 创建发票选择区域
                                         const invoiceSelectionContainer = document.createElement('div');
                                         invoiceSelectionContainer.id = 'invoice-selection-container';
                                         invoiceSelectionContainer.className = 'mt-3 p-4 border border-gray-200 rounded-md bg-gray-50';
                                         
                                         // 标题
                                         const title = document.createElement('h4');
                                         title.className = 'text-sm font-medium text-gray-700 mb-2';
                                         title.textContent = '请选择要付款的发票：';
                                         invoiceSelectionContainer.appendChild(title);
                                         
                                         // 发票列表容器
                                         const invoiceList = document.createElement('div');
                                         invoiceList.id = 'invoice-selection-list';
                                         invoiceList.className = 'space-y-2 max-h-40 overflow-y-auto';
                                         invoiceSelectionContainer.appendChild(invoiceList);
                                         
                                         // 清除之前的发票选择容器
                                         const existingContainer = document.getElementById('invoice-selection-container');
                                         if (existingContainer) {
                                             existingContainer.remove();
                                         }
                                         
                                         // 在供应商输入框下方添加发票选择容器
                                         paymentSupplierInput.parentNode.appendChild(invoiceSelectionContainer);
                                         
                                         // 初始化选中的发票数组
                                         let selectedInvoices = [];
                                         
                                         // 计算发票的已付款金额函数
                                        function calculatePaidAmount(invoiceId) {
                                            const storageKey = `${getCurrentCompany()}-payments`;
                                            const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
                                            
                                            // 查找与该发票相关的所有付款记录
                                            const relatedPayments = payments.filter(payment => 
                                                payment.invoiceId === invoiceId || 
                                                (payment.invoiceNumbers && payment.invoiceNumbers.includes(invoiceId))
                                            );
                                            
                                            // 计算已付款总额
                                            return relatedPayments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
                                        }
                                        
                                        // 计算发票的欠款余额函数
                                        function calculateRemainingAmount(invoice) {
                                            const totalAmount = parseFloat(invoice.amount) || 0;
                                            const paidAmount = calculatePaidAmount(invoice.id);
                                            return Math.max(0, totalAmount - paidAmount); // 确保欠款余额不为负数
                                        }
                                        
                                        // 验证付款金额函数
                                        function validatePaymentAmount() {
                                            const paymentAmount = parseFloat(this.value) || 0;
                                            const totalRemainingField = document.getElementById('total-remaining-amount');
                                            const totalRemainingAmount = totalRemainingField ? parseFloat(totalRemainingField.value) || 0 : 0;
                                            
                                            // 清除之前的提示信息
                                            let warningElement = document.getElementById('payment-amount-warning');
                                            if (warningElement) {
                                                warningElement.remove();
                                            }
                                            
                                            // 如果付款金额超过总欠款余额，显示警告
                                            if (paymentAmount > totalRemainingAmount) {
                                                warningElement = document.createElement('div');
                                                warningElement.id = 'payment-amount-warning';
                                                warningElement.className = 'text-red-500 text-sm mt-1 animate-fadeIn';
                                                warningElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                                warningElement.style.opacity = '0';
                                                warningElement.style.transform = 'translateY(-5px)';
                                                warningElement.innerHTML = `
                                                    <div class="flex items-center gap-1">
                                                        <i class="fa fa-exclamation-circle"></i>
                                                        <span>付款金额不能超过总欠款余额 ¥${totalRemainingAmount.toFixed(2)}</span>
                                                    </div>
                                                    <div class="mt-1 text-xs text-gray-500">
                                                        建议调整付款金额，避免超额支付
                                                    </div>
                                                `;
                                                this.parentNode.appendChild(warningElement);
                                                
                                                // 添加动画效果
                                                setTimeout(() => {
                                                    warningElement.style.opacity = '1';
                                                    warningElement.style.transform = 'translateY(0)';
                                                }, 10);
                                                
                                                this.classList.add('border-red-500');
                                                return false;
                                            } else {
                                                this.classList.remove('border-red-500');
                                                return true;
                                            }
                                        }
                                         
                                         // 创建计算选中发票信息的函数
                                         function updateSelectedInvoicesInfo() {
                                             if (selectedInvoices.length > 0) {
                                                 // 收集合同号
                                                 const contractNumbers = selectedInvoices
                                                     .map(inv => inv.purchaseOrder)
                                                     .filter(Boolean)
                                                     .join(', ');
                                                  
                                                 // 计算总欠款金额
                                                 const totalRemainingAmount = selectedInvoices
                                                     .reduce((sum, inv) => sum + calculateRemainingAmount(inv), 0);
                                                  
                                                 // 收集发票编号
                                                 const invoiceNumbers = selectedInvoices
                                                     .map(inv => inv.invoiceNumber)
                                                     .filter(Boolean)
                                                     .join(', ');
                                                   
                                                 // 填充表单字段
                                                 const paymentInvoiceInput = document.getElementById('payment-invoice-id');
                                                 if (paymentContractNumberInput && contractNumbers) {
                                                     paymentContractNumberInput.value = contractNumbers;
                                                 }
                                                    
                                                 if (invoicePaymentAmountInput) {
                                                     invoicePaymentAmountInput.value = totalRemainingAmount.toFixed(2);
                                                 }
                                                 
                                                 // 将选中的发票编号填充到关联发票输入框
                                                 if (paymentInvoiceInput) {
                                                     paymentInvoiceInput.value = invoiceNumbers;
                                                 }
                                                 
                                                 // 保存总欠款金额到隐藏字段，用于后续验证
                                                 let totalRemainingField = document.getElementById('total-remaining-amount');
                                                 if (!totalRemainingField) {
                                                     totalRemainingField = document.createElement('input');
                                                     totalRemainingField.type = 'hidden';
                                                     totalRemainingField.id = 'total-remaining-amount';
                                                     document.getElementById('create-payment-form').appendChild(totalRemainingField);
                                                 }
                                                 totalRemainingField.value = totalRemainingAmount;
                                                 
                                                 // 确保付款金额输入框存在
                                                 if (invoicePaymentAmountInput) {
                                                     // 为付款金额输入框添加验证事件
                                                     invoicePaymentAmountInput.oninput = validatePaymentAmount;
                                                     invoicePaymentAmountInput.onblur = validatePaymentAmount;
                                                 }
                                                  
                                                // 关联发票输入框已移除，不再需要设置发票号
                                                 
                                                 // 显示总欠款金额
                                                 let totalInfoElement = document.getElementById('selected-invoices-total');
                                                 if (!totalInfoElement) {
                                                     totalInfoElement = document.createElement('div');
                                                     totalInfoElement.id = 'selected-invoices-total';
                                                     totalInfoElement.className = 'mt-3 pt-3 border-t border-gray-200 flex justify-between items-center';
                                                     invoiceSelectionContainer.appendChild(totalInfoElement);
                                                 }
                                                 totalInfoElement.innerHTML = `
                                                     <span class="font-medium">已选发票总欠款:</span>
                                                     <span class="text-lg font-bold text-red-600">¥${totalRemainingAmount.toFixed(2)}</span>
                                                 `;
                                             } else {
                                                 // 清空表单字段
                                                 if (paymentContractNumberInput) {
                                                     paymentContractNumberInput.value = '';
                                                 }
                                                 if (invoicePaymentAmountInput) {
                                                     invoicePaymentAmountInput.value = '';
                                                 }
                                                // 关联发票输入框已移除，不再需要清空
                                                 
                                                 // 移除总欠款显示
                                                 const totalInfoElement = document.getElementById('selected-invoices-total');
                                                 if (totalInfoElement) {
                                                     totalInfoElement.remove();
                                                 }
                                             }
                                         }
                                         
                                         // 为每个发票创建带复选框的条目
                                         supplierInvoices.forEach(invoice => {
                                             const invoiceItem = document.createElement('div');
                                             invoiceItem.className = 'flex items-center p-2 hover:bg-gray-100 rounded';
                                              
                                             const checkbox = document.createElement('input');
                                             checkbox.type = 'checkbox';
                                             checkbox.className = 'mr-2';
                                             checkbox.value = JSON.stringify(invoice);
                                              
                                             // 计算发票欠款余额
                                             const remainingAmount = calculateRemainingAmount(invoice);
                                             
                                             // 发票信息文本
                                             const invoiceInfo = document.createElement('div');
                                             // 尝试从不同可能的日期字段获取日期信息
                                             const invoiceDate = invoice.invoiceDate || invoice.date || '未提供';
                                             const totalAmount = parseFloat(invoice.amount) || 0;
                                             const paidAmount = calculatePaidAmount(invoice.id);
                                             
                                             invoiceInfo.innerHTML = `
                                                 <div class="font-medium text-sm">发票号: ${invoice.invoiceNumber || '未提供'}</div>
                                                 <div class="grid grid-cols-2 gap-2 mt-1 text-xs">
                                                     <div class="flex justify-between">
                                                         <span>日期:</span>
                                                         <span>${invoiceDate}</span>
                                                     </div>
                                                     <div class="flex justify-between">
                                                         <span>总金额:</span>
                                                         <span>¥${totalAmount.toFixed(2)}</span>
                                                     </div>
                                                     <div class="flex justify-between">
                                                         <span>已付清:</span>
                                                         <span class="bg-green-800 text-white px-2 py-0.5 rounded">¥${paidAmount.toFixed(2)}</span>
                                                     </div>
                                                     <div class="flex justify-between">
                                                         <span class="font-medium">欠款余额:</span>
                                                         <span class="text-red-600 font-bold">¥${remainingAmount.toFixed(2)}</span>
                                                     </div>
                                                 </div>
                                             `;
                                             invoiceInfo.className = 'ml-2';
                                              
                                             // 复选框点击事件
                                             checkbox.addEventListener('change', function() {
                                                 if (this.checked) {
                                                     selectedInvoices.push(invoice);
                                                 } else {
                                                     selectedInvoices = selectedInvoices.filter(inv => inv.invoiceNumber !== invoice.invoiceNumber);
                                                 }
                                                 // 更新选中的发票信息
                                                 updateSelectedInvoicesInfo();
                                             });
                                              
                                             invoiceItem.appendChild(checkbox);
                                             invoiceItem.appendChild(invoiceInfo);
                                             invoiceList.appendChild(invoiceItem);
                                         });
                                         
                                         // 默认选中所有发票
                                         const checkboxes = invoiceList.querySelectorAll('input[type="checkbox"]');
                                         checkboxes.forEach(checkbox => {
                                             checkbox.checked = true;
                                             const invoice = JSON.parse(checkbox.value);
                                             selectedInvoices.push(invoice);
                                         });
                                         
                                         // 初始化时更新选中的发票信息
                                         updateSelectedInvoicesInfo();
                                     }
                                 });
                                 
                                 paymentSupplierResults.appendChild(resultItem);
                             });
                             
                             paymentSupplierResults.classList.remove('hidden');
                         } else {
                             paymentSupplierResults.classList.add('hidden');
                         }
                     });
                     
                     // 点击外部区域关闭搜索结果
                     document.addEventListener('click', function(e) {
                         if (!paymentSupplierInput.contains(e.target) && !paymentSupplierResults.contains(e.target)) {
                             paymentSupplierResults.classList.add('hidden');
                         }
                     });
                 }
             });
             
             // 凭发票付款内部的付款类型选择事件
             document.querySelectorAll('input[name="invoice-payment-type"]').forEach(radio => {
                 radio.addEventListener('change', function() {
                     const newInvoiceSection = document.getElementById('new-invoice-section');
                     
                     // 对于先款后票模式，显示新发票信息
                     if (this.value === 'payment-first') {
                         newInvoiceSection.classList.remove('hidden');
                     } else {
                         // 对于先票后款模式，隐藏新发票信息
                         newInvoiceSection.classList.add('hidden');
                     }
                 });
             });
             
         // 通用的保存付款函数
         function handleSavePayment() {
             // 获取当前选中的付款模式
             const selectedPaymentType = document.querySelector('input[name="payment-method-option"]:checked').value;
             let paymentData;
             
             if (selectedPaymentType === 'invoice') {
                 // 凭发票付款模式
                 const paymentNumber = document.getElementById('payment-number').value;
                 const paymentDate = document.getElementById('payment-date').value;
                 const amount = parseFloat(document.getElementById('payment-amount').value);
                 const paymentMethod = document.getElementById('payment-method').value;
                 const supplier = document.getElementById('payment-supplier').value;

                 const remark = document.getElementById('payment-remark').value;
                 
                 // 表单验证
                 if (!paymentNumber || !paymentDate || isNaN(amount) || amount <= 0 || !supplier) {
                     alert('请填写必填项，包括合同号、付款日期、金额和供应商');
                     return;
                 }
                 
                 // 验证付款金额是否超过总欠款余额
                 const totalRemainingField = document.getElementById('total-remaining-amount');
                 if (totalRemainingField) {
                     const totalRemainingAmount = parseFloat(totalRemainingField.value) || 0;
                     if (amount > totalRemainingAmount) {
                         alert(`付款金额不能超过总欠款余额 ¥${totalRemainingAmount.toFixed(2)}`);
                         return;
                     }
                 }
                 
                 // 获取关联发票输入框的值
                 const invoiceInput = document.getElementById('payment-invoice-id');
                 const invoiceNumbers = invoiceInput ? invoiceInput.value : '';
                 
                 // 对于兼容性，设置第一个发票编号作为invoiceId
                 let invoiceId = null;
                 if (invoiceNumbers) {
                     const firstInvoice = invoiceNumbers.split(',')[0].trim();
                     if (firstInvoice) {
                         invoiceId = firstInvoice;
                     }
                 }
                 
                 paymentData = {
                     id: `payment-${Date.now()}`,
                     paymentNumber: paymentNumber,
                     invoiceId: invoiceId,  // 保留单个ID字段用于兼容性
                     invoiceNumbers: invoiceNumbers,  // 关联发票编号，多个用逗号分隔
                     paymentType: 'invoice-first',
                     supplier: supplier,
                     paymentDate: paymentDate,
                     amount: amount,
                     paymentMethod: paymentMethod,
                     remark: remark,
                     createdAt: new Date().toISOString(),
                     updatedAt: new Date().toISOString()
                 };
             } else {
                 // 凭合同付款模式
                 const contractNumbers = document.getElementById('contract-payment-number').value;
                 const paymentDate = document.getElementById('contract-payment-date').value;
                 const amount = parseFloat(document.getElementById('contract-payment-amount').value);
                 const paymentMethod = document.getElementById('contract-payment-method').value;
                 const supplier = document.getElementById('contract-payment-supplier').value;

                 const remark = document.getElementById('contract-payment-remark').value;
                 
                 // 表单验证
                 if (!contractNumbers || !paymentDate || isNaN(amount) || amount <= 0 || !supplier) {
                     alert('请填写必填项，包括合同号、付款日期、金额和供应商');
                     return;
                 }
                 
                 // 生成付款编号（可以基于合同号和时间戳）
                 const paymentNumber = `PMT-${Date.now()}`;
                 
                 paymentData = {
                     id: `payment-${Date.now()}`,
                     paymentNumber: paymentNumber,
                     contractNumber: contractNumbers,  // 合同编号，多个用逗号分隔
                     paymentType: 'contract-first',
                     supplier: supplier,
                     paymentDate: paymentDate,
                     amount: amount,
                     paymentMethod: paymentMethod,
                     remark: remark,
                     createdAt: new Date().toISOString(),
                     updatedAt: new Date().toISOString()
                 };
             }
             
             // 保存付款记录到localStorage
             const paymentStorageKey = `${getCurrentCompany()}-payments`;
             const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
             payments.push(paymentData);
             localStorage.setItem(paymentStorageKey, JSON.stringify(payments));
             // 调用更新仪表盘统计数据函数
             updateDashboardStats();
             
             // 在保存付款后调用更新状态函数
             updateInvoicePaymentStatus();
             
             // 关闭模态框
             document.getElementById('create-payment-modal').classList.add('hidden');
              
             // 重新渲染发票列表，确保付款变更反映到发票状态
             try {
                 if (typeof renderInvoiceList === 'function') {
                     renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
                     console.log('已更新发票列表');
                 }
             } catch (e) {
                 console.log('更新发票列表时出错:', e);
             }
              
             // 重新渲染付款列表
             renderPaymentList(document.getElementById('payment-search-input').value);
                 
                 // 重新渲染采购订单列表，确保付款状态同步更新到对应合同号 - 安全检查
                 try {
                     if (typeof renderPurchaseOrderList === 'function') {
                         renderPurchaseOrderList();
                     }
                 } catch (e) {
                     console.log('未找到采购订单列表渲染函数，跳过更新');
                 }
         }
             
         // 计算并更新发票状态（基于付款金额与发票金额的比较）
         function updateInvoicePaymentStatus() {
             console.log('开始更新发票付款状态');
             const invoiceStorageKey = `${getCurrentCompany()}-invoices`;
             const paymentStorageKey = `${getCurrentCompany()}-payments`;
              
             const invoices = JSON.parse(localStorage.getItem(invoiceStorageKey)) || [];
             const payments = JSON.parse(localStorage.getItem(paymentStorageKey)) || [];
             console.log('当前付款记录数量:', payments.length);
             console.log('部分付款记录样本:', payments.filter(p => p.paymentType === 'contract-first').slice(0, 3));
             let hasChanges = false; // 跟踪是否有状态变化
             
             // 对每个发票计算已付款总额
             const updatedInvoices = invoices.map(invoice => {
                 const oldStatus = invoice.status || '';
                 // 确保发票有status字段，如果没有则默认为'未付款'
                 if (!invoice.status) {
                     invoice.status = '未付款';
                 }
                 // 查找所有关联到此发票的付款记录
                 let totalPaid = 0;
                 
                 payments.forEach(payment => {
                     // 情况1: 凭发票付款 - 通过invoiceNumbers关联
                     if (payment.paymentType === 'invoice-first') {
                         // 处理多个发票编号（逗号分隔）
                         const paymentInvoiceNumbers = payment.invoiceNumbers
                             ? payment.invoiceNumbers.split(',').map(num => num.trim()).filter(num => num)
                             : [];
                          
                         // 如果付款关联到此发票，累加金额
                         if (paymentInvoiceNumbers.includes(invoice.invoiceNumber)) {
                             totalPaid += parseFloat(payment.amount) || 0;
                         }
                     }
                     // 情况2: 凭合同付款 - 通过contractNumber关联
                     else if (payment.paymentType === 'contract-first' && payment.contractNumber) {
                         // 检查发票是否关联到该合同号
                         const isInvoiceRelatedToContract = () => {
                             // 处理数组类型
                             if (Array.isArray(invoice.purchaseOrder)) {
                                 return invoice.purchaseOrder.includes(payment.contractNumber);
                             }
                             // 处理字符串类型，支持逗号分隔或空格分隔的多个合同号
                             else if (typeof invoice.purchaseOrder === 'string') {
                                 // 拆分字符串为数组并检查是否包含目标合同号
                                 const purchaseOrders = invoice.purchaseOrder.split(/[,，\s]+/).map(p => p.trim());
                                 return purchaseOrders.includes(payment.contractNumber);
                             }
                             // 处理单个合同号
                             return invoice.purchaseOrder === payment.contractNumber;
                         };
                          
                         // 如果发票关联到此合同的付款，累加金额
                         if (isInvoiceRelatedToContract()) {
                             totalPaid += parseFloat(payment.amount) || 0;
                         }
                     }
                 });
                 
                 // 计算差值 - 确保类型一致性
                 const invoiceAmount = parseFloat(invoice.amount) || 0;
                 const difference = invoiceAmount - totalPaid;
                 
                 // 详细日志记录
                 console.log('发票状态计算:', invoice.invoiceNumber || '未知', 
                     '发票金额:', invoiceAmount, 
                     '已付金额:', totalPaid, 
                     '差值:', difference);
                 
                 // 更新状态 - 使用更严格的判断条件
                 let newStatus;
                 if (difference <= 0) {
                    newStatus = '已付清';
                    console.log('设置状态为已付清:', invoice.invoiceNumber || '未知');
                } else if (totalPaid > 0) {
                    newStatus = '部分付款';
                    console.log('设置状态为部分付款:', invoice.invoiceNumber || '未知');
                } else {
                    newStatus = '未付款';
                    console.log('设置状态为未付款:', invoice.invoiceNumber || '未知');
                }
                 
                 // 返回更新后的发票对象，添加已付金额和差值字段
                 const updatedInvoice = {
                     ...invoice,
                     status: newStatus,
                     totalPaid: totalPaid,
                     paymentDifference: difference
                 };
                 
                 // 检查状态是否发生变化
                 if (oldStatus !== newStatus) {
                     hasChanges = true;
                     console.log('更新发票状态:', invoice.invoiceNumber || '未知', '状态从', oldStatus, '变为', newStatus);
                 }
                 
                 return updatedInvoice;
             });
             
             // 保存更新后的发票数据
                 localStorage.setItem(invoiceStorageKey, JSON.stringify(updatedInvoices));
                 // 调用更新仪表盘统计数据函数
                 updateDashboardStats();
                 
                 // 更新付款记录状态
                 const updatedPayments = payments.map(payment => {
                     // 对于凭合同付款模式的付款记录
                     if (payment.paymentType === 'contract-first' && payment.contractNumber) {
                         // 获取相关的合同信息以获取合同金额
                         const contractStorageKey = `${getCurrentCompany()}-contracts`;
                         const contracts = JSON.parse(localStorage.getItem(contractStorageKey)) || [];
                         
                         // 查找对应的合同
                         const contract = contracts.find(c => c.contractNumber === payment.contractNumber);
                         
                         // 如果找到合同，计算总付款金额和状态
                         if (contract && contract.amount) {
                             // 计算该合同的总付款金额
                             const contractTotalPaid = payments
                                 .filter(p => p.paymentType === 'contract-first' && p.contractNumber === payment.contractNumber)
                                 .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                             
                             // 计算差值 - 确保类型一致性
                             const contractAmount = parseFloat(contract.amount) || 0;
                             const difference = contractAmount - contractTotalPaid;
                              
                             // 详细日志记录
                             console.log('合同付款状态计算:', payment.contractNumber || '未知', 
                                 '合同金额:', contractAmount, 
                                 '已付金额:', contractTotalPaid, 
                                 '差值:', difference);
                              
                             // 根据差值设置付款状态
                             let paymentStatus;
                             if (difference <= 0) {
                                 paymentStatus = '已付清';
                                 console.log('设置合同付款状态为已付清:', payment.contractNumber || '未知');
                             } else {
                                 paymentStatus = '部分付款';
                                 console.log('设置合同付款状态为部分付款:', payment.contractNumber || '未知');
                             }
                             
                             return {
                                 ...payment,
                                 status: paymentStatus,
                                 totalPaidForContract: contractTotalPaid,
                                 contractAmount: contract.amount
                             };
                         }
                     }
                     
                     // 确保所有付款记录都有状态，且不为"未付款"或"N/A"
                     let finalStatus = payment.status || '';
                     const oldStatus = finalStatus;
                     // 只有在状态为空、'N/A'或'未付款'时才修改为'部分付款'
                     // 保留已经设置的'已付清'状态
                     if (!finalStatus || finalStatus === 'N/A' || finalStatus === '未付款') {
                         finalStatus = '部分付款';
                         console.log('修复付款记录状态:', payment.id || '未知', '类型:', payment.paymentType, '状态从', oldStatus || 'undefined', '变为', finalStatus);
                     } else if (finalStatus === '已付清') {
                         console.log('保留付款记录已付清状态:', payment.id || '未知', '类型:', payment.paymentType);
                     }
                     
                     return {
                         ...payment,
                         status: finalStatus
                     };
                 });
                 
                 localStorage.setItem(paymentStorageKey, JSON.stringify(updatedPayments));
                 // 调用更新仪表盘统计数据函数
                 updateDashboardStats();
                 
                 // 如果有状态变化，自动更新相关列表
                 if (hasChanges) {
                     console.log('检测到发票状态变化，自动更新UI');
                     
                     // 自动更新发票列表
                     try {
                         if (typeof renderInvoiceList === 'function') {
                             const searchInput = document.getElementById('invoice-search-input');
                             renderInvoiceList(searchInput ? searchInput.value : '');
                             console.log('已更新发票列表');
                         }
                     } catch (e) {
                         console.log('更新发票列表时出错:', e);
                     }
                     
                     // 自动更新付款列表
                     try {
                         if (typeof renderPaymentList === 'function') {
                             const paymentSearchInput = document.getElementById('payment-search-input');
                             renderPaymentList(paymentSearchInput ? paymentSearchInput.value : '');
                             console.log('已更新付款列表');
                         }
                     } catch (e) {
                         console.log('更新付款列表时出错:', e);
                     }
                 }
                 
                 // 重新渲染采购订单列表，确保发票状态和付款状态同步更新到对应合同号 - 安全检查
                 try {
                     if (typeof renderPurchaseOrderList === 'function') {
                         renderPurchaseOrderList();
                     }
                 } catch (e) {
                     console.log('未找到采购订单列表渲染函数，跳过更新');
                 }
                 
                 return { updatedInvoices, updatedPayments };
         }
             
         // 为凭发票付款表单的保存按钮添加事件监听
         document.getElementById('save-payment-btn').addEventListener('click', handleSavePayment);
         
         // 为凭合同付款表单的保存按钮添加事件监听
         document.getElementById('save-contract-payment-btn').addEventListener('click', handleSavePayment);
         
         // 通用的取消付款函数
         function handleCancelPayment() {
             document.getElementById('create-payment-modal').classList.add('hidden');
         }
         
         // 为凭发票付款表单的取消按钮添加事件监听
         document.getElementById('cancel-payment-btn').addEventListener('click', handleCancelPayment);
         
         // 为凭合同付款表单的取消按钮添加事件监听
         document.getElementById('cancel-contract-payment-btn').addEventListener('click', handleCancelPayment);
             
         // 付款列表分页按钮事件
         const firstPageBtn = document.getElementById('paymentFirstPage');
         const prevPageBtn = document.getElementById('paymentPrevPage');
         const nextPageBtn = document.getElementById('paymentNextPage');
         const lastPageBtn = document.getElementById('paymentLastPage');

             firstPageBtn.addEventListener('click', () => {
                 if (paymentCurrentPage > 1) {
                     paymentCurrentPage = 1;
                     renderPaymentList(document.getElementById('payment-search-input').value);
                 }
             });

             prevPageBtn.addEventListener('click', () => {
                 if (paymentCurrentPage > 1) {
                     paymentCurrentPage--;
                     renderPaymentList(document.getElementById('payment-search-input').value);
                 }
             });

             nextPageBtn.addEventListener('click', () => {
                 const storageKey = `${getCurrentCompany()}-payments`;
                 const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
                 const searchTerm = document.getElementById('payment-search-input').value;
                 // 应用搜索过滤
                 let filteredPayments = [...payments];
                 if (searchTerm.trim()) {
                     const lowerCaseSearch = searchTerm.toLowerCase();
                     filteredPayments = filteredPayments.filter(payment => 
                         (payment.paymentNumber?.toLowerCase().includes(lowerCaseSearch)) ||
                         (payment.invoiceNumber?.toLowerCase().includes(lowerCaseSearch)) ||
                         (payment.supplier?.toLowerCase().includes(lowerCaseSearch)) ||
                         (payment.amount?.toString().includes(lowerCaseSearch)) ||
                         (payment.status?.toLowerCase().includes(lowerCaseSearch))
                     );
                 }
                 const totalPages = Math.ceil(filteredPayments.length / paymentPageSize);
                 if (paymentCurrentPage < totalPages) {
                     paymentCurrentPage++;
                     renderPaymentList(document.getElementById('payment-search-input').value);
                 }
             });

             lastPageBtn.addEventListener('click', () => {
                 const storageKey = `${getCurrentCompany()}-payments`;
                 const payments = JSON.parse(localStorage.getItem(storageKey)) || [];
                 const totalPages = Math.ceil(payments.length / paymentPageSize);
                 if (paymentCurrentPage < totalPages) {
                     paymentCurrentPage = totalPages;
                     renderPaymentList(document.getElementById('payment-search-input').value);
                 }
             });

             // 付款搜索功能
             const paymentSearchInput = document.getElementById('payment-search-input');
             const paymentStartDate = document.getElementById('payment-start-date');
             const paymentEndDate = document.getElementById('payment-end-date');
             const paymentDateFilterBtn = document.getElementById('payment-date-filter-btn');
             const paymentDateResetBtn = document.getElementById('payment-date-reset-btn');
              
             paymentSearchInput.addEventListener('input', () => {
                 // 重置到第一页
                 paymentCurrentPage = 1;
                 renderPaymentList(paymentSearchInput.value, paymentStartDate.value, paymentEndDate.value);
             });
              
             // 付款日期筛选功能
             if (paymentDateFilterBtn) {
                 paymentDateFilterBtn.addEventListener('click', () => {
                     paymentCurrentPage = 1;
                     renderPaymentList(paymentSearchInput.value, paymentStartDate.value, paymentEndDate.value);
                 });
             }
              
             // 付款日期重置功能
             if (paymentDateResetBtn) {
                 paymentDateResetBtn.addEventListener('click', () => {
                     paymentCurrentPage = 1;
                     paymentStartDate.value = '';
                     paymentEndDate.value = '';
                     renderPaymentList(paymentSearchInput.value, '', '');
                 });
             }

             // 如果当前页面是付款页面，渲染付款列表
            const currentPage = document.querySelector('.page:not(.hidden)');
            if (currentPage && currentPage.id === 'payments-page') {
                renderPaymentList('');
            }

             // 初始渲染发票列表
             if (currentPage && currentPage.id === 'invoices-page') {
                 renderInvoiceList(document.getElementById('invoice-search-input')?.value || '');
             }
             
             // 清空所有采购订单函数
             function clearAllOrders() {
                 console.log('开始清空所有采购订单...');
                 
                 try {
                     // 获取当前公司
                     const currentCompany = getCurrentCompany();
                     const storageKey = `purchaseOrders_${currentCompany}`;
                     
                     // 获取当前订单数量用于验证
                     const currentOrders = JSON.parse(localStorage.getItem(storageKey) || '[]');
                     const orderCount = currentOrders.length;
                     
                     if (orderCount === 0) {
                         alert('当前没有采购订单记录，无需清空！');
                         return;
                     }
                     
                     // 添加二次确认对话框
                     const confirmMessage = `确认要清空所有 ${orderCount} 条采购订单记录吗？\n此操作不可撤销！`;
                     
                     // 使用自定义确认对话框而不是默认的confirm
                     if (!window.confirm(confirmMessage)) {
                         console.log('用户取消了清空操作');
                         return;
                     }
                     
                     // 执行清空操作
                     localStorage.setItem(storageKey, JSON.stringify([]));
                     
                     // 验证清空是否成功
                     const afterClearOrders = JSON.parse(localStorage.getItem(storageKey) || '[]');
                     if (afterClearOrders.length === 0) {
                         console.log('采购订单已成功清空');
                         alert('所有采购订单记录已成功清空！');
                         
                         // 重新渲染列表
                         if (typeof renderPurchaseOrderList === 'function') {
                             renderPurchaseOrderList();
                         }
                     } else {
                         console.error('清空失败，仍有', afterClearOrders.length, '条记录');
                         alert('清空失败，请重试！');
                     }
                 } catch (error) {
                     console.error('清空采购订单时发生错误:', error);
                     alert('清空操作发生错误，请刷新页面重试！');
                 }
             }
             
             // 将函数暴露到全局作用域
             window.clearAllOrders = clearAllOrders;
             
             // 绑定清空按钮事件
             const clearBtn = document.getElementById('clear-all-orders-btn');
             if (clearBtn) {
                 clearBtn.addEventListener('click', function() {
                     clearAllOrders();
                 });
                 console.log('清空按钮事件绑定成功');
             }
         });
    </script>
    <!-- 待办事项功能脚本 -->
    <script>
        // 待办事项数据
        let todos = [];
        
        // DOM元素
        const todoList = document.getElementById('todo-list');
        const emptyTodo = document.getElementById('empty-todo');
        const todoModal = document.getElementById('todo-modal');
        const addTodoBtn = document.getElementById('add-todo-btn');
        const cancelTodoBtn = document.getElementById('cancel-todo-btn');
        const saveTodoBtn = document.getElementById('save-todo-btn');
        const todoContent = document.getElementById('todo-content');
        
        // 初始化
        function init() {
            // 加载本地存储的待办事项
            loadTodos();
            renderTodos();
            setupEventListeners();
        }
        
        // 加载待办事项
        function loadTodos() {
            const currentCompany = getCurrentCompany();
            const storageKey = `procurementTodos_${currentCompany}`;
            const oldStorageKey = 'procurementTodos'; // 旧的存储键名
            
            // 数据迁移：检查旧键是否存在数据，如果存在则迁移到新键
            if (localStorage.getItem(oldStorageKey) && !localStorage.getItem(storageKey)) {
                localStorage.setItem(storageKey, localStorage.getItem(oldStorageKey));
                // 保留旧数据以确保兼容性
            }
            
            const savedTodos = localStorage.getItem(storageKey);
            if (savedTodos) {
                todos = JSON.parse(savedTodos);
            }
        }
        
        // 保存待办事项到本地存储
        function saveTodos() {
            const currentCompany = getCurrentCompany();
            const storageKey = `procurementTodos_${currentCompany}`;
            localStorage.setItem(storageKey, JSON.stringify(todos));
        }
        
        // 渲染待办事项列表
        function renderTodos() {
            todoList.innerHTML = '';
            
            // 更新序号并渲染每个待办事项
            todos.forEach((todo, index) => {
                const li = document.createElement('li');
                li.className = `flex items-center p-3 border rounded-md ${todo.completed ? 'bg-gray-100' : 'bg-white'}`;
                
                // 序号
                const indexSpan = document.createElement('span');
                indexSpan.className = 'w-8 h-8 flex items-center justify-center bg-primary text-white rounded-full mr-3 flex-shrink-0';
                indexSpan.textContent = (index + 1).toString();
                li.appendChild(indexSpan);
                
                // 内容
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-1';
                const contentP = document.createElement('p');
                contentP.className = todo.completed ? 'text-gray-500 line-through' : '';
                contentP.textContent = todo.content;
                contentDiv.appendChild(contentP);
                li.appendChild(contentDiv);
                
                // 操作按钮
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-2';
                
                // 完成/取消完成按钮
                const toggleBtn = document.createElement('button');
                toggleBtn.className = `btn btn-sm ${todo.completed ? 'btn-secondary' : 'btn-success'}`;
                toggleBtn.innerHTML = todo.completed ? 
                    '<i class="fa fa-undo mr-1"></i>撤销' : 
                    '<i class="fa fa-check mr-1"></i>完成';
                toggleBtn.addEventListener('click', () => toggleTodo(todo.id));
                actionsDiv.appendChild(toggleBtn);
                
                // 删除按钮
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.innerHTML = '<i class="fa fa-trash mr-1"></i>删除';
                deleteBtn.addEventListener('click', () => deleteTodo(todo.id));
                actionsDiv.appendChild(deleteBtn);
                
                li.appendChild(actionsDiv);
                todoList.appendChild(li);
            });
            
            // 显示或隐藏空状态提示
            if (todos.length === 0) {
                emptyTodo.classList.remove('hidden');
            } else {
                emptyTodo.classList.add('hidden');
            }
        }
        
        // 添加待办事项
        function addTodo(content) {
            const newTodo = {
                id: Date.now().toString(),
                content: content,
                completed: false
            };
            
            todos.push(newTodo);
            saveTodos();
            renderTodos();
        }
        
        // 切换待办事项状态
        function toggleTodo(id) {
            const todoIndex = todos.findIndex(todo => todo.id === id);
            if (todoIndex !== -1) {
                todos[todoIndex].completed = !todos[todoIndex].completed;
                saveTodos();
                renderTodos();
            }
        }
        
        // 删除待办事项
        function deleteTodo(id) {
            todos = todos.filter(todo => todo.id !== id);
            saveTodos();
            renderTodos();
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 添加待办事项按钮
            addTodoBtn.addEventListener('click', () => {
                todoContent.value = '';
                todoModal.classList.remove('hidden');
            });
            
            // 取消按钮
            cancelTodoBtn.addEventListener('click', () => {
                todoModal.classList.add('hidden');
            });
            
            // 保存按钮
            saveTodoBtn.addEventListener('click', () => {
                const content = todoContent.value.trim();
                if (content) {
                    addTodo(content);
                    todoModal.classList.add('hidden');
                } else {
                    alert('请输入待办事项内容');
                }
            });
            
            // 点击模态框外部关闭
            todoModal.addEventListener('click', (e) => {
                if (e.target === todoModal) {
                    todoModal.classList.add('hidden');
                }
            });
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>
        // 记事本功能实现
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const noteContent = document.getElementById('note-content');
            const noteStats = document.getElementById('note-stats');
            const saveNoteBtn = document.getElementById('save-note-btn');
            const clearNoteBtn = document.getElementById('clear-note-btn');
            
            // 获取当前公司，构建与公司关联的存储键
            const currentCompany = getCurrentCompany();
            const LOCAL_STORAGE_KEY = `procurement-notepad-content_${currentCompany}`;
            const OLD_LOCAL_STORAGE_KEY = 'procurement-notepad-content'; // 旧的存储键名
            
            // 数据迁移：检查旧键是否存在数据，如果存在则迁移到新键
            if (localStorage.getItem(OLD_LOCAL_STORAGE_KEY) && !localStorage.getItem(LOCAL_STORAGE_KEY)) {
                localStorage.setItem(LOCAL_STORAGE_KEY, localStorage.getItem(OLD_LOCAL_STORAGE_KEY));
                // 保留旧数据以确保兼容性
            }
            
            // 初始化加载笔记
            const savedNote = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedNote) {
                noteContent.value = savedNote;
                updateStats();
            }
            
            // 更新统计信息
            function updateStats() {
                const charCount = noteContent.value.length;
                noteStats.textContent = `${charCount} 个字符`;
            }
            
            // 保存笔记
            function saveNote() {
                const content = noteContent.value;
                localStorage.setItem(LOCAL_STORAGE_KEY, content);
                
                // 显示保存成功提示
                const originalText = saveNoteBtn.innerHTML;
                saveNoteBtn.innerHTML = '<i class="fa fa-check mr-1"></i>已保存';
                saveNoteBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    saveNoteBtn.innerHTML = originalText;
                    saveNoteBtn.classList.remove('btn-success');
                }, 1500);
            }
            
            // 清空笔记
            function clearNote() {
                if (confirm('确定要清空记事本吗？此操作不可撤销。')) {
                    noteContent.value = '';
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    updateStats();
                    
                    // 显示清空成功提示
                    const originalText = clearNoteBtn.innerHTML;
                    clearNoteBtn.innerHTML = '<i class="fa fa-check mr-1"></i>已清空';
                    clearNoteBtn.classList.remove('btn-danger');
                    clearNoteBtn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        clearNoteBtn.innerHTML = originalText;
                        clearNoteBtn.classList.remove('btn-success');
                        clearNoteBtn.classList.add('btn-danger');
                    }, 1500);
                }
            }
            
            // 事件监听
            noteContent.addEventListener('input', updateStats);
            saveNoteBtn.addEventListener('click', saveNote);
            clearNoteBtn.addEventListener('click', clearNote);
            
            // 自动保存功能 (3秒无操作后自动保存)
            let autoSaveTimer;
            noteContent.addEventListener('input', function() {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(saveNote, 3000);
            });
            
            // 页面关闭前提示保存
            window.addEventListener('beforeunload', function(e) {
                // 检查是否有未保存的更改（这里简单判断内容不为空即可）
                if (noteContent.value.trim() !== localStorage.getItem(LOCAL_STORAGE_KEY)?.trim()) {
                    const confirmationMessage = '您的笔记可能尚未保存，确定要离开吗？';
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });
        });
    </script>
    
    <script>
        // 合同迁移功能函数
        function migrateContracts() {
            const sourceCompany = document.getElementById('source-company').value;
            const targetCompany = document.getElementById('target-company').value;
            
            // 验证源公司和目标公司是否不同
            if (sourceCompany === targetCompany) {
                alert('源公司和目标公司不能相同！');
                return;
            }
            
            // 获取选中的合同行
            const selectedCheckboxes = document.querySelectorAll('#purchaseOrderTableBody input[type="checkbox"]:checked');
            const selectedRows = Array.from(selectedCheckboxes).map(checkbox => checkbox.closest('tr'));
            if (selectedRows.length === 0) {
                alert('请先选择需要迁移的合同！');
                return;
            }
            
            // 获取当前公司的合同数据（源公司就是当前公司）
            const currentCompany = localStorage.getItem('currentCompany') || 'companyA';
            const sourceStorageKey = `purchaseOrders_${currentCompany}`;
            const currentCompanyContracts = JSON.parse(localStorage.getItem(sourceStorageKey) || '[]');
            
            // 从选中行获取合同信息
            const selectedContractNumbers = [];
            selectedRows.forEach(row => {
                const contractNumberCell = row.querySelector('td:nth-child(2)');
                if (contractNumberCell && contractNumberCell.textContent.trim() !== '') {
                    selectedContractNumbers.push(contractNumberCell.textContent.trim());
                }
            });
            
            // 找到对应的合同数据
            const selectedContracts = currentCompanyContracts.filter(contract => 
                selectedContractNumbers.includes(contract.contractNumber)
            );
            
            // 确认迁移操作
            if (!confirm(`确定要将选中的${selectedContracts.length}个合同迁移到${targetCompany === 'companyA' ? '普利美（常州）环境工程科技有限公司' : '无锡龙力印铁设备制造有限公司'}吗？\n\n此操作会将选中的合同数据复制到目标公司，\n目标公司中已存在的同名合同将被覆盖！`)) {
                return;
            }
            
            try {
                // 获取目标公司的合同数据
                const targetStorageKey = `purchaseOrders_${targetCompany}`;
                const targetContracts = JSON.parse(localStorage.getItem(targetStorageKey) || '[]');
                
                // 创建映射表，避免重复合同
                const targetContractMap = new Map();
                targetContracts.forEach(contract => {
                    targetContractMap.set(contract.contractNumber, contract);
                });
                
                // 合并合同数据，源公司合同覆盖目标公司同名合同
                let migratedCount = 0;
                let newCount = 0;
                let updatedCount = 0;
                
                selectedContracts.forEach(sourceContract => {
                    if (targetContractMap.has(sourceContract.contractNumber)) {
                        // 更新现有合同
                        const index = targetContracts.findIndex(contract => 
                            contract.contractNumber === sourceContract.contractNumber
                        );
                        if (index !== -1) {
                            targetContracts[index] = sourceContract;
                            updatedCount++;
                        }
                    } else {
                        // 添加新合同
                        targetContracts.push(sourceContract);
                        targetContractMap.set(sourceContract.contractNumber, sourceContract);
                        newCount++;
                    }
                    migratedCount++;
                });
                
                // 保存合并后的合同数据到目标公司
                localStorage.setItem(targetStorageKey, JSON.stringify(targetContracts));
                
                // 从源公司删除已迁移的合同
                const remainingContracts = currentCompanyContracts.filter(contract => 
                    !selectedContractNumbers.includes(contract.contractNumber)
                );
                localStorage.setItem(sourceStorageKey, JSON.stringify(remainingContracts));
                
                // 显示迁移结果
                alert(`合同迁移成功！\n\n总迁移合同数: ${migratedCount}\n新增合同数: ${newCount}\n更新合同数: ${updatedCount}\n已从源公司删除: ${selectedContracts.length}个合同`);
                
                // 刷新采购订单列表
                renderPurchaseOrderList();
                
                // 关闭模态框
                document.getElementById('contract-migration-modal').classList.add('hidden');
                
                // 取消所有选中状态
                document.querySelectorAll('#purchaseOrderTableBody input[type="checkbox"]:checked').forEach(checkbox => {
                    checkbox.checked = false;
                    const row = checkbox.closest('tr');
                    if (row) {
                        row.classList.remove('bg-blue-50');
                    }
                });
                
            } catch (error) {
                console.error('合同迁移失败:', error);
                alert('合同迁移失败，请重试！');
            }
        }
        
        // 数据备份与恢复功能
        document.addEventListener('DOMContentLoaded', function() {
            // 合同迁移功能
            const contractMigrationBtn = document.getElementById('contract-migration-btn');
            const migrateSelectedBtn = document.getElementById('migrate-selected-btn');
            const contractMigrationModal = document.getElementById('contract-migration-modal');
            
            function openMigrationModal() {
                // 检查是否有选中的合同
                const selectedCheckboxes = document.querySelectorAll('#purchaseOrderTableBody input[type="checkbox"]:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('请先选择要迁移的合同！');
                    return;
                }
                
                // 设置默认的源公司为当前公司
                const currentCompany = localStorage.getItem('currentCompany') || 'companyA';
                document.getElementById('source-company').value = currentCompany;
                
                // 如果当前公司是companyA，默认目标公司设为companyB，反之亦然
                const defaultTargetCompany = currentCompany === 'companyA' ? 'companyB' : 'companyA';
                document.getElementById('target-company').value = defaultTargetCompany;
                
                // 打开模态框
                contractMigrationModal.classList.remove('hidden');
                
                // 初始化拖拽功能
                dragModal(contractMigrationModal);
            }
            
            // 模态框拖拽功能
            function dragModal(modalElement) {
                const modalContent = modalElement.querySelector('.inline-block');
                if (!modalContent) return;
                
                let isDragging = false;
                let startX, startY, initialX, initialY;
                
                // 鼠标按下事件
                modalContent.addEventListener('mousedown', (e) => {
                    // 只允许在模态框头部区域拖拽
                    // 修改条件，允许在标题或头部区域拖拽
                    const isHeaderArea = e.target.closest('#modal-title') || 
                                       e.target.closest('h3') || 
                                       (e.target.parentElement && e.target.parentElement.querySelector('#modal-title'));
                    
                    if (isHeaderArea) {
                        isDragging = true;
                        modalContent.style.cursor = 'grabbing';
                        
                        // 获取初始位置
                        startX = e.clientX;
                        startY = e.clientY;
                        
                        // 获取当前位置
                        const rect = modalContent.getBoundingClientRect();
                        initialX = rect.left;
                        initialY = rect.top;
                        
                        // 阻止文本选择
                        e.preventDefault();
                    }
                });
                
                // 鼠标移动事件
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    // 计算移动距离
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    // 设置模态框位置（使用绝对定位）
                    modalContent.style.position = 'absolute';
                    modalContent.style.left = `${initialX + deltaX}px`;
                    modalContent.style.top = `${initialY + deltaY}px`;
                    modalContent.style.transform = 'none'; // 重置transform
                });
                
                // 鼠标释放事件
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        modalContent.style.cursor = 'grab';
                    }
                });
                
                // 鼠标离开窗口事件
                document.addEventListener('mouseleave', () => {
                    if (isDragging) {
                        isDragging = false;
                        modalContent.style.cursor = 'grab';
                    }
                });
            }
            
            // 合同迁移按钮已从备份数据菜单移至采购订单列表页面
            
            if (migrateSelectedBtn && contractMigrationModal) {
                migrateSelectedBtn.addEventListener('click', openMigrationModal);
            }
            
            // 导出JSON备份功能
            const exportDataBtn = document.getElementById('export-data-btn');
            
            if (exportDataBtn) {
                // 导出数据功能
                exportDataBtn.addEventListener('click', function() {
                    try {
                        // 获取当前公司信息
                        const currentCompany = localStorage.getItem('currentCompany') || 'companyA';
                        
                        // 获取所有公司列表
                        const companies = ['companyA', 'companyB', 'company1', 'company2'];
                        
                        // 收集所有需要备份的数据
                        const backupData = {
                            version: '2.1',
                            exportDate: new Date().toISOString(),
                            currentCompany: currentCompany,
                            companies: companies,
                            data: {
                                // 待办事项数据（按公司分组）
                                todos: {},
                                // 记事本数据（按公司分组）
                                notepad: {},
                                // 供应商数据（通用数据）
                                suppliers: JSON.parse(localStorage.getItem('suppliers') || '[]'),
                                // 采购订单数据（按公司分组）
                                purchaseOrders: {},
                                // 发票数据（按公司分组）
                                invoices: {},
                                // 付款记录数据（按公司分组）
                                payments: {},
                                // 合同数据（按公司分组）
                                contracts: {},
                                // 合同库存管理数据（按公司分组）
                                contractInventory: {},
                                // 系统设置
                                lastActivePage: localStorage.getItem('lastActivePage') || '',
                                // 发票页面的待办事项数据
                                invoiceTodoList: JSON.parse(localStorage.getItem('todoList') || '[]'),
                                invoiceTodoIdCounter: parseInt(localStorage.getItem('todoIdCounter') || '1'),
                                invoiceNotepadContent: localStorage.getItem('notepadContent') || '',
                                // 发票列表页面数据
                                invoiceData: localStorage.getItem('invoiceData') || '',
                                // 全局发票数据（invoice.html和普票登记系统.html使用）
                                globalInvoices: JSON.parse(localStorage.getItem('invoice_management_invoices') || '[]'),
                                // 普票登记系统发票数据
                                generalInvoices: JSON.parse(localStorage.getItem('invoices') || '[]'),
                                // 普票登记系统高级过滤设置
                                advancedFilters: JSON.parse(localStorage.getItem('advancedFilters') || '{}'),
                                // 普票登记系统公司名称（上传发票页面的两个抬头公司名称）
                                companyName1: localStorage.getItem('companyName1') || '',
                                companyName2: localStorage.getItem('companyName2') || '',
                                
                                // 收支表页面数据
                                balanceSheet: {
                                    // 交易记录（按公司分组）
                                    transactions: {},
                                    // 待办事项
                                    todos: JSON.parse(localStorage.getItem('todos') || '[]'),
                                    // 最后更新时间（按公司分组）
                                    lastUpdated: {},
                                    // 自动备份数据
                                    autoBackups: JSON.parse(localStorage.getItem('backupData') || '[]')
                                }
                            }
                        };
                        
                        // 为每个公司收集数据
                        companies.forEach(company => {
                            backupData.data.todos[company] = JSON.parse(localStorage.getItem(`procurementTodos_${company}`) || '[]');
                            backupData.data.notepad[company] = localStorage.getItem(`procurement-notepad-content_${company}`) || '';
                            backupData.data.purchaseOrders[company] = JSON.parse(localStorage.getItem(`purchaseOrders_${company}`) || '[]');
                            backupData.data.invoices[company] = JSON.parse(localStorage.getItem(`${company}-invoices`) || '[]');
                            backupData.data.payments[company] = JSON.parse(localStorage.getItem(`${company}-payments`) || '[]');
                            backupData.data.contracts[company] = JSON.parse(localStorage.getItem(`${company}-contracts`) || '[]');
                            
                            // 收集合同库存管理数据
                            backupData.data.contractInventory[company] = JSON.parse(localStorage.getItem(`contracts_${company}`) || '[]');
                            
                            // 收集收支表数据
                            backupData.data.balanceSheet.transactions[company] = JSON.parse(localStorage.getItem(`transactions_${company}`) || '[]');
                            backupData.data.balanceSheet.lastUpdated[company] = localStorage.getItem(`lastUpdated_${company}`) || '';
                        });
                        
                        // 生成备份文件名 - 使用通用名称而不是当前公司
                        const exportDate = new Date().toISOString().replace(/[:.]/g, '-');
                        const fileName = `采购系统备份_所有公司_${exportDate}.json`;
                        
                        // 创建JSON文件并下载
                        const jsonContent = JSON.stringify(backupData, null, 2);
                        const blob = new Blob([jsonContent], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        alert('数据导出成功！备份文件已下载到您的设备。');
                    } catch (error) {
                        console.error('导出数据时出错:', error);
                        alert('数据导出失败，请重试。');
                    }
                });
            }
            
            // 导入数据功能
            const importDataInput = document.getElementById('import-data-input');
            
            if (importDataInput) {
                importDataInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // 验证文件类型
                    if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                        alert('请选择有效的JSON文件！');
                        importDataInput.value = '';
                        return;
                    }
                    
                    // 确认导入操作
                    if (!confirm('导入备份将覆盖当前所有数据！\n请确保您已备份重要数据。\n\n确定要继续导入吗？')) {
                        importDataInput.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            
                            // 验证备份数据结构
                            if (!backupData.version || !backupData.data) {
                                throw new Error('无效的备份文件格式');
                            }
                            
                            // 获取备份中的公司信息
                            const backupCompany = backupData.currentCompany || 'default';
                            
                            // 恢复所有数据到LocalStorage
                            const data = backupData.data;
                            
                            // 获取当前公司
                            const currentCompany = localStorage.getItem('currentCompany') || 'default';
                            
                            // 询问用户是否要切换公司（如果备份中的公司不同）
                            let targetCompany = backupCompany;
                            if (backupCompany !== currentCompany) {
                                if (!confirm(`备份文件是针对公司 "${backupCompany}" 的，但当前正在使用 "${currentCompany}"。\n是否要切换到公司 "${backupCompany}"？\n\n选择"确定"将切换到该公司并恢复其数据。\n选择"取消"将在保持当前公司的情况下恢复数据。`)) {
                                    targetCompany = currentCompany;
                                }
                            }
                            
                            // 恢复非空数据，避免覆盖现有数据为空白
                            
                            // 恢复供应商数据（通用数据）
                            if (data.suppliers !== undefined && data.suppliers.length > 0) {
                                localStorage.setItem('suppliers', JSON.stringify(data.suppliers));
                            }
                            
                            // 获取备份中的公司列表
                            const backupCompanies = backupData.companies || ['companyA', 'companyB', 'company1', 'company2'];
                            
                            // 为每个公司恢复数据
                            backupCompanies.forEach(company => {
                                // 恢复待办事项数据（按公司）
                                if (data.todos && data.todos[company] !== undefined) {
                                    localStorage.setItem(`procurementTodos_${company}`, JSON.stringify(data.todos[company]));
                                }
                                
                                // 恢复记事本数据（按公司）
                                if (data.notepad && data.notepad[company] !== undefined) {
                                    localStorage.setItem(`procurement-notepad-content_${company}`, data.notepad[company]);
                                }
                                
                                // 恢复采购订单数据（按公司）
                                if (data.purchaseOrders && data.purchaseOrders[company] !== undefined) {
                                    localStorage.setItem(`purchaseOrders_${company}`, JSON.stringify(data.purchaseOrders[company]));
                                }
                                
                                // 恢复发票数据（按公司）
                                if (data.invoices && data.invoices[company] !== undefined) {
                                    localStorage.setItem(`${company}-invoices`, JSON.stringify(data.invoices[company]));
                                }
                                
                                // 恢复付款记录数据（按公司）
                                if (data.payments && data.payments[company] !== undefined) {
                                    localStorage.setItem(`${company}-payments`, JSON.stringify(data.payments[company]));
                                }
                                
                                // 恢复合同数据（按公司）
                                if (data.contracts && data.contracts[company] !== undefined) {
                                    localStorage.setItem(`${company}-contracts`, JSON.stringify(data.contracts[company]));
                                }
                                
                                // 恢复合同库存管理数据（按公司）
                                if (data.contractInventory && data.contractInventory[company] !== undefined) {
                                    localStorage.setItem(`contracts_${company}`, JSON.stringify(data.contractInventory[company]));
                                }
                                
                                // 恢复收支表数据（按公司）
                                if (data.balanceSheet && data.balanceSheet.transactions && data.balanceSheet.transactions[company] !== undefined) {
                                    localStorage.setItem(`transactions_${company}`, JSON.stringify(data.balanceSheet.transactions[company]));
                                }
                                
                                if (data.balanceSheet && data.balanceSheet.lastUpdated && data.balanceSheet.lastUpdated[company] !== undefined) {
                                    localStorage.setItem(`lastUpdated_${company}`, data.balanceSheet.lastUpdated[company]);
                                }
                            });
                            
                            // 恢复发票页面的待办事项数据
                            if (data.invoiceTodoList !== undefined) {
                                localStorage.setItem('todoList', JSON.stringify(data.invoiceTodoList));
                            }
                            
                            if (data.invoiceTodoIdCounter !== undefined) {
                                localStorage.setItem('todoIdCounter', data.invoiceTodoIdCounter.toString());
                            }
                            
                            if (data.invoiceNotepadContent !== undefined) {
                                localStorage.setItem('notepadContent', data.invoiceNotepadContent);
                            }
                            
                            // 恢复发票列表页面数据
                            if (data.invoiceData !== undefined) {
                                localStorage.setItem('invoiceData', data.invoiceData);
                            }
                            
                            // 恢复全局发票数据（invoice.html使用）
                            if (data.globalInvoices !== undefined) {
                                localStorage.setItem('invoice_management_invoices', JSON.stringify(data.globalInvoices));
                            }
                            
                            // 恢复普票登记系统发票数据
                            if (data.generalInvoices !== undefined) {
                                localStorage.setItem('invoices', JSON.stringify(data.generalInvoices));
                            }
                            
                            // 恢复普票登记系统高级过滤设置
                            if (data.advancedFilters !== undefined) {
                                localStorage.setItem('advancedFilters', JSON.stringify(data.advancedFilters));
                            }
                            
                            // 恢复普票登记系统公司名称（上传发票页面的两个抬头公司名称）
                            if (data.companyName1 !== undefined) {
                                localStorage.setItem('companyName1', data.companyName1);
                            }
                            
                            if (data.companyName2 !== undefined) {
                                localStorage.setItem('companyName2', data.companyName2);
                            }
                            
                            // 恢复收支表非公司特定数据
                            if (data.balanceSheet) {
                                if (data.balanceSheet.todos !== undefined) {
                                    localStorage.setItem('todos', JSON.stringify(data.balanceSheet.todos));
                                }
                                
                                if (data.balanceSheet.autoBackups !== undefined) {
                                    localStorage.setItem('backupData', JSON.stringify(data.balanceSheet.autoBackups));
                                }
                            }
                            
                            // 恢复系统设置（可选，避免强制跳转）
                            if (data.lastActivePage !== undefined && data.lastActivePage.trim() !== '') {
                                if (confirm('是否要恢复备份中的页面设置？')) {
                                    localStorage.setItem('lastActivePage', data.lastActivePage);
                                }
                            }
                            
                            // 恢复公司设置（如果用户同意切换）
                            if (targetCompany !== currentCompany) {
                                localStorage.setItem('currentCompany', targetCompany);
                            }
                            
                            alert('数据导入成功！系统数据已恢复。');
                            
                            // 刷新页面以显示导入的数据
                            location.reload();
                        } catch (error) {
                            console.error('导入数据时出错:', error);
                            alert('数据导入失败！请检查文件是否为有效的备份文件。');
                        } finally {
                            // 清空文件选择器
                            importDataInput.value = '';
                        }
                    };
                    
                    reader.onerror = function() {
                        alert('读取文件时出错，请重试。');
                        importDataInput.value = '';
                    };
                    
                    reader.readAsText(file);
                });
            }
        });
    </script>
    </body>
</html>
