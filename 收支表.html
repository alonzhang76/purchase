<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>收支管理系统 - 多公司财务追踪</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- SheetJS - Excel处理库 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        light: '#f3f4f6',
                        dark: '#1f2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                @apply bg-white bg-opacity-80 backdrop-blur-md;
            }
            .card-shadow {
                @apply shadow-lg hover:shadow-xl transition-shadow duration-300;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-secondary/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-secondary focus:ring-opacity-50;
            }
            .btn-danger {
                @apply bg-danger hover:bg-danger/90 text-white font-medium py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-danger focus:ring-opacity-50;
            }
            .input-field {
                @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300;
            }
            .text-center-input {
                text-align: center;
            }
            .income-tag {
            }
            .search-transaction-input {
                width: 100%;
                min-width: 200px;
                max-width: 250px;
                transition: width 0.2s ease;
            }
            @screen md {
                .search-transaction-input {
                    width: auto;
                    min-width: 200px;
                    max-width: 250px;
                }
            }
            @screen lg {
                .search-transaction-input {
                    width: auto;
                    min-width: 200px;
                    max-width: 250px;
                }
            }
            .input-field {
                @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-300;
                min-width: 140px;
                max-width: 180px;
            }
            /* 模态框中的输入框，占满整个宽度 */
            #transaction-modal .input-field {
                max-width: none;
            }
            /* 金额和支付方式输入框保持原有宽度 */
            #transaction-modal .flex-1 .input-field {
                max-width: 180px;
            }
            @screen md {
                .input-field {
                    min-width: 140px;
                    max-width: 180px;
                }
                #transaction-modal .input-field {
                    max-width: none;
                }
                #transaction-modal .flex-1 .input-field {
                    max-width: 180px;
                }
            }
            @screen lg {
                .input-field {
                    min-width: 140px;
                    max-width: 180px;
                }
                #transaction-modal .input-field {
                    max-width: none;
                }
                #transaction-modal .flex-1 .input-field {
                    max-width: 180px;
                }
            }
            .income-tag {
                @apply bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full;
            }
            .expense-tag {
                @apply bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full;
            }
            .transaction-item {
                @apply flex items-center justify-between p-4 border-b border-gray-200 hover:bg-gray-50 transition-colors duration-200;
            }
            .category-icon {
                @apply flex items-center justify-center w-10 h-10 rounded-full mr-3 text-white;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    
    <!-- 主应用容器 -->
    <div id="app-container">
        <!-- 隐藏的文件输入框，用于导入Excel -->
        <input type="file" id="file-input" accept=".xlsx,.xls" class="hidden">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center">
                <svg width="80" height="80" viewBox="0 0 100 100" class="mr-2 animate-bounce">
                    <!-- 会动的美钞 -->
                    <style>
                        @keyframes float {
                            0%, 100% { transform: translateY(0) rotate(0deg); }
                            25% { transform: translateY(-3px) rotate(2deg); }
                            50% { transform: translateY(0) rotate(0deg); }
                            75% { transform: translateY(-3px) rotate(-2deg); }
                        }
                        @keyframes shine {
                            0% { opacity: 0; transform: translateX(-100%) rotate(45deg); }
                            50% { opacity: 0.6; }
                            100% { opacity: 0; transform: translateX(100%) rotate(45deg); }
                        }
                        .floating-bill {
                            animation: float 2s ease-in-out infinite;
                        }
                        .shine-effect {
                            animation: shine 3s ease-in-out infinite;
                        }
                    </style>
                    
                    <!-- 美钞 -->
                    <g class="floating-bill">
                        <!-- 纸币主体 -->
                        <rect x="15" y="20" width="70" height="50" rx="2" ry="2" fill="#85BB65" stroke="#000000" stroke-width="0.5"/>
                        
                        <!-- 水印效果 -->
                        <rect x="18" y="23" width="64" height="44" rx="1" ry="1" fill="none" stroke="#008000" stroke-width="0.2" opacity="0.3"/>
                        
                        <!-- 美元符号 -->
                        <text x="50" y="45" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="#008000" text-anchor="middle">$</text>
                        <text x="50" y="65" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#008000" text-anchor="middle">100</text>
                        
                        <!-- 装饰线条 -->
                        <path d="M18,30 L82,30" stroke="#008000" stroke-width="0.5" opacity="0.7"/>
                        <path d="M18,70 L82,70" stroke="#008000" stroke-width="0.5" opacity="0.7"/>
                        
                        <!-- 角落数字 -->
                        <text x="22" y="30" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#008000">100</text>
                        <text x="78" y="30" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#008000" text-anchor="end">100</text>
                        <text x="22" y="68" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#008000">100</text>
                        <text x="78" y="68" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#008000" text-anchor="end">100</text>
                        
                        <!-- 发光效果 -->
                        <path class="shine-effect" d="M0,25 L100,25" stroke="#FFFFFF" stroke-width="40" stroke-opacity="0.3" stroke-linecap="round"/>
                        
                        <!-- 安全线 -->
                        <rect x="48" y="25" width="4" height="40" fill="#006400" opacity="0.5"/>
                    </g>
                </svg>
                    
                    <!-- 腮红 -->
                    <circle cx="25" cy="60" r="6" fill="#FFCCCC" opacity="0.7"/>
                    <circle cx="75" cy="60" r="6" fill="#FFCCCC" opacity="0.7"/>
                </svg>
                <h1 class="text-xl font-bold text-gray-800">常州收支表</h1>
                <p class="text-lg font-cursive text-gray-700 bg-blue-50 p-2 rounded-lg inline-block mt-1">Designed By AlonZhang</p>
            </div>
            <!-- 公司切换按钮 -->
            <div class="flex space-x-2">
                <button id="company1-btn" class="company-btn px-3 py-1.5 bg-primary text-white rounded-lg font-medium text-sm whitespace-nowrap transition-colors duration-300 hover:bg-primary/90">
                    普利美（常州）环境工程科技有限公司
                </button>
                <button id="company2-btn" class="company-btn px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg font-medium text-sm whitespace-nowrap transition-colors duration-300 hover:bg-gray-300">
                    无锡龙力印铁设备制造有限公司
                </button>
            </div>
            <div class="flex items-center space-x-4">


                <div class="relative">
                    <button id="account-menu" class="flex items-center space-x-1 p-2 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-user-circle text-gray-600"></i>
                        <span class="text-sm font-medium text-gray-700">我的账户</span>
                    </button>
                    <div id="account-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10 hidden animate-fade-in">
                        <a href="#" id="account-settings" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">清空所有交易记录</a>
                        <a href="#" id="export-excel" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出Excel</a>
                        <a href="#" id="import-excel" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导入Excel</a>
                        <a href="#" id="export-json" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导出JSON</a>
                        <a href="#" id="import-json" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">导入JSON</a>
                        <div class="border-t border-gray-200 my-1"></div>

                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 财务概览卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">总余额</h3>
                    <i class="fa fa-balance-scale text-primary text-xl"></i>
                </div>
                <p class="text-3xl font-bold text-gray-900" id="total-balance">¥0.00</p>
                <div class="flex items-center mt-2 text-sm">
                    <span class="text-gray-500">更新于:</span>
                    <span class="text-gray-700 ml-1" id="last-updated">2023-07-21</span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">本月收入</h3>
                    <i class="fa fa-arrow-up text-secondary text-xl"></i>
                </div>
                <p class="text-3xl font-bold text-secondary" id="monthly-income">¥0.00</p>
                <div class="flex items-center mt-2 text-sm">
                    <span class="text-gray-500">较上月:</span>
                    <span class="text-secondary ml-1 flex items-center">
                        <i class="fa fa-arrow-up mr-1"></i>
                        <span id="income-change">0%</span>
                    </span>
                </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">本月支出</h3>
                    <i class="fa fa-arrow-down text-danger text-xl"></i>
                </div>
                <p class="text-3xl font-bold text-danger" id="monthly-expense">¥0.00</p>
                <div class="flex items-center mt-2 text-sm">
                    <span class="text-gray-500">较上月:</span>
                    <span class="text-danger ml-1 flex items-center">
                        <i class="fa fa-arrow-up mr-1"></i>
                        <span id="expense-change">0%</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- 添加交易按钮 -->
        <div class="flex justify-center mb-8">
            <button id="add-transaction-btn" class="btn-primary flex items-center space-x-2">
                <i class="fa fa-plus"></i>
                <span>添加新交易</span>
            </button>
        </div>
        
        <!-- 图表和交易记录区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 左侧：图表和待办事项区域 -->
            <div class="lg:col-span-1 space-y-6">
                <!-- 待办事项 -->
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">待办事项</h3>
                        <button id="add-todo-btn" class="text-secondary hover:text-secondary-dark">
                            <i class="fa fa-plus-circle text-xl"></i>
                        </button>
                    </div>
                    <div id="todos-container" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- 待办事项将通过JavaScript动态生成 -->
                        <div class="text-center text-gray-500 py-4" id="empty-todos">暂无待办事项</div>
                    </div>
                </div>
                <!-- 收入支出分布图表 -->
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h3 class="text-lg font-semibold text-gray-700">收支分布</h3>
                        <div class="flex flex-wrap gap-2">
                            <div class="flex space-x-2">
                                <select id="distribution-year-select" class="border border-gray-300 rounded-md px-2 py-1 text-sm">
                                    <!-- 年份选项将通过JavaScript动态生成 -->
                                </select>
                                <select id="distribution-month-select" class="border border-gray-300 rounded-md px-2 py-1 text-sm">
                                    <option value="-1">全部月份</option>
                                    <option value="0">一月</option>
                                    <option value="1">二月</option>
                                    <option value="2">三月</option>
                                    <option value="3">四月</option>
                                    <option value="4">五月</option>
                                    <option value="5">六月</option>
                                    <option value="6">七月</option>
                                    <option value="7">八月</option>
                                    <option value="8">九月</option>
                                    <option value="9">十月</option>
                                    <option value="10">十一月</option>
                                    <option value="11">十二月</option>
                                </select>
                            </div>
                            <div class="flex space-x-2">
                                <button class="chart-period-btn px-3 py-1 text-sm rounded-full bg-primary text-white" data-period="month">月</button>
                                <button class="chart-period-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700" data-period="quarter">季</button>
                                <button class="chart-period-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700" data-period="year">年</button>
                                <button class="chart-period-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700" data-period="all">统计</button>
                            </div>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="distribution-chart"></canvas>
                    </div>
                </div>
                
                <!-- 分类占比图表 -->
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 md:mb-0">分类占比</h3>
                        <div class="flex flex-wrap gap-2 w-full md:w-auto">
                            <div class="flex space-x-1">
                                <button class="category-type-btn px-3 py-1 text-sm rounded-full bg-danger text-white" data-type="expense">支出</button>
                                <button class="category-type-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700" data-type="income">收入</button>
                            </div>
                            <div class="flex space-x-1">
                                <select id="year-select" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700 border-none focus:outline-none focus:ring-2 focus:ring-primary">
                                    <!-- 年份选项将通过JavaScript动态生成 -->
                                </select>
                                <select id="month-select" class="px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-700 border-none focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="-1">全部月份</option>
                                    <option value="0">一月</option>
                                    <option value="1">二月</option>
                                    <option value="2">三月</option>
                                    <option value="3">四月</option>
                                    <option value="4">五月</option>
                                    <option value="5">六月</option>
                                    <option value="6">七月</option>
                                    <option value="7">八月</option>
                                    <option value="8">九月</option>
                                    <option value="9">十月</option>
                                    <option value="10">十一月</option>
                                    <option value="11">十二月</option>
                                </select>
                            </div>
                            <div class="flex space-x-1">
                                <button class="category-period-btn px-3 py-1 text-sm rounded-full bg-primary text-white" data-period="month">本月</button>
                                <button class="category-period-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700" data-period="quarter">本季</button>
                                <button class="category-period-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700" data-period="year">本年</button>
                                <button class="category-period-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700" data-period="all">统计</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="h-64 w-full">
                            <canvas id="category-chart"></canvas>
                        </div>
                        <div class="w-full p-4 text-center mt-4">
                            <div class="flex justify-center items-center space-x-2 whitespace-nowrap mb-2">
                                <span class="text-sm text-gray-700">总收入：</span>
                                <span id="annual-total-income" class="text-base font-bold text-green-600">¥0.00</span>
                            </div>
                            <div class="flex justify-center items-center space-x-2 whitespace-nowrap">
                                <span class="text-sm text-gray-700">总支出：</span>
                                <span id="annual-total-expense" class="text-base font-bold text-red-600">¥0.00</span>
                            </div>
                        </div>
                        <!-- 费用列表 -->
                        <div class="w-full p-4 mt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">费用明细</h4>
                            <div id="expense-list" class="space-y-2 max-h-64 overflow-y-auto">
                                <!-- 费用列表项将动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：交易记录区域 -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">筛选条件</h3>
                        <div class="flex flex-col sm:flex-row gap-2 w-full">
                            <div class="relative flex-shrink-0">
                                <input type="text" id="search-transactions" placeholder="搜索交易、分类或单位名称..." class="input-field pl-10 w-full search-transaction-input text-center-input">
                                <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                                <span id="search-width-measure" class="absolute left-0 top-0 opacity-0 invisible whitespace-nowrap" style="font-size: inherit; font-family: inherit; padding: inherit;"></span>
                            </div>
                            <select id="filter-transactions" class="input-field flex-shrink-0">
                                <option value="all">所有交易</option>
                                <option value="income">仅收入</option>
                                <option value="expense">仅支出</option>
                            </select>
                            <select id="expense-category-filter" class="input-field flex-shrink-0">
                                <option value="all">所有支出项目</option>
                                <!-- 支出项目将通过JavaScript动态生成 -->
                            </select>
                            <select id="income-category-filter" class="input-field flex-shrink-0">
                                <option value="all">所有收入项目</option>
                                <!-- 收入项目将通过JavaScript动态生成 -->
                            </select>
                        </div>
                    </div>
                    
                    <!-- 财务对账功能 -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-6">
                        <h3 class="text-lg font-medium text-blue-800 mb-3 flex items-center">
                            <i class="fa fa-balance-scale mr-2"></i>财务对账
                        </h3>
                        <div class="flex flex-col md:flex-row gap-4 items-start">
                            <div class="w-full md:w-auto">
                                <label for="reconciliation-unit" class="block text-sm font-medium text-gray-700 mb-1">收款/付款单位</label>
                                <div class="relative">
                                    <div class="inline-block">
                                        <input type="text" id="reconciliation-unit" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white min-w-[200px] max-w-full" placeholder="请输入单位名称" autocomplete="off">
                                        <input type="hidden" id="reconciliation-unit-value" value="">
                                    </div>
                                    <div id="reconciliation-unit-suggestions" class="absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto hidden">
                                        <!-- 单位建议将动态生成 -->
                                    </div>
                                </div>
                            </div>
                            <div class="w-full md:w-auto">
                                <label for="reconciliation-start-date" class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
                                <input type="date" id="reconciliation-start-date" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white w-full">
                            </div>
                            <div class="w-full md:w-auto">
                                <label for="reconciliation-end-date" class="block text-sm font-medium text-gray-700 mb-1">结束日期</label>
                                <input type="date" id="reconciliation-end-date" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white w-full">
                            </div>
                            <div class="w-full md:w-auto flex flex-col items-end space-y-2">
                                <button id="reset-reconciliation-btn" class="btn-secondary w-full md:w-auto text-sm whitespace-nowrap min-w-[120px]" onclick="resetReconciliation()">
                                    <i class="fa fa-refresh mr-1"></i> 重置
                                </button>
                                <button id="reconciliation-btn" class="btn-primary w-full md:w-auto text-sm whitespace-nowrap min-w-[120px]" onclick="performReconciliation()">
                                    <i class="fa fa-search mr-1"></i> 对账
                                </button>
                                <button id="generate-reconciliation-btn" class="btn-secondary w-full md:w-auto text-sm whitespace-nowrap min-w-[120px]" onclick="generateReconciliationReport()">
                                    <i class="fa fa-file-text-o mr-1"></i> 生成对账单
                                </button>
                            </div>
                        </div>
                        
                        <!-- 对账结果区域 -->
                        <div id="reconciliation-results" class="mt-4 hidden">
                            <div class="bg-white p-4 rounded-lg border border-gray-200">
                                <div id="company-header" class="text-center mb-6">
                                    <h2 class="text-2xl font-bold text-gray-800">公司名称</h2>
                                    <p class="text-sm text-gray-500">财务对账单</p>
                                </div>
                                
                                <!-- 交易明细表格 -->
                                <div class="mt-4">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">交易明细</h5>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-gray-200">
                                            <thead>
                                                <tr>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">说明</th>
                                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                                </tr>
                                            </thead>
                                            <tbody id="reconciliation-details" class="bg-white divide-y divide-gray-200">
                                                <!-- 对账结果将动态生成 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- 对账结果（移到交易明细下方） -->
                                <div class="mt-4">
                                    <h4 class="text-md font-medium text-gray-800 mb-3">交易记录汇总</h4>
                                    <div class="flex flex-wrap gap-4">
                                        <div class="flex-1 min-w-[160px]">
                                            <div class="text-sm text-gray-500 mb-1">总收入</div>
                                            <div id="reconciliation-income" class="text-xl font-bold text-secondary">¥0.00</div>
                                        </div>
                                        <div class="flex-1 min-w-[160px]">
                                            <div class="text-sm text-gray-500 mb-1">总支出</div>
                                            <div id="reconciliation-expense" class="text-xl font-bold text-danger">¥0.00</div>
                                        </div>
                                        <div class="flex-1 min-w-[160px]">
                                            <div class="text-sm text-gray-500 mb-1">净额</div>
                                            <div id="reconciliation-balance" class="text-xl font-bold">¥0.00</div>
                                        </div>
                                        <div class="flex-1 min-w-[160px]">
                                            <div class="text-sm text-gray-500 mb-1">交易笔数</div>
                                            <div id="reconciliation-count" class="text-xl font-bold text-gray-700">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 交易记录列表 -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">说明</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日期</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">金额</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list" class="bg-white divide-y divide-gray-200">
                                <!-- 交易记录将通过JavaScript动态生成 -->
                                <tr class="text-center">
                                    <td colspan="5" class="px-4 py-8 text-gray-500">
                                        <div class="flex flex-col items-center">
                                            <i class="fa fa-credit-card text-4xl mb-2 text-gray-300"></i>
                                            <p>暂无交易记录</p>
                                            <p class="text-sm">点击"添加新交易"开始记录</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="flex justify-between items-center mt-6">
                        <div class="text-sm text-gray-500">
                            显示 <span id="showing-transactions">0</span> 条，共 <span id="total-transactions">0</span> 条
                        </div>
                        <div class="flex space-x-2 items-center">
                            <button id="prev-page" class="px-3 py-1 rounded border border-gray-300 text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <span class="text-sm text-gray-600">
                                第 <span id="current-page">1</span>/<span id="total-pages">1</span> 页
                            </span>
                            <div class="flex items-center space-x-1">
                                <input type="number" id="page-input" min="1" value="1" class="w-12 px-2 py-1 border border-gray-300 rounded text-center text-sm">
                                <button id="go-to-page" class="px-2 py-1 rounded border border-gray-300 text-gray-600 hover:bg-gray-50 text-sm">
                                    跳转
                                </button>
                            </div>
                            <button id="next-page" class="px-3 py-1 rounded border border-gray-300 text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- 待办事项编辑模态框 -->
        <div id="todo-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden animate-fade-in">
            <div class="bg-white rounded-xl p-6 w-full max-w-md card-shadow">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="todo-modal-title" class="text-xl font-bold text-gray-800">添加待办事项</h2>
                    <button id="close-todo-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                <form id="todo-form">
                    <input type="hidden" id="todo-id">
                    <div class="mb-4">
                        <label for="todo-text" class="block text-sm font-medium text-gray-700 mb-1">待办内容</label>
                        <textarea id="todo-text" rows="3" class="input-field" placeholder="请输入待办事项内容" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="todo-priority" class="block text-sm font-medium text-gray-700 mb-1">优先级</label>
                        <select id="todo-priority" class="input-field">
                            <option value="low">低</option>
                            <option value="medium" selected>中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-todo-btn" class="btn-secondary px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">取消</button>
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg hover:bg-secondary-dark transition-colors">保存</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 添加/编辑交易模态框 -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center hidden">
        <div class="glass-effect rounded-xl p-6 w-full max-w-md mx-4 animate-slide-in border border-gray-200 shadow-xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">添加新交易</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="transaction-form">
                <input type="hidden" id="transaction-id">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">交易类型</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="transaction-type" value="income" class="w-4 h-4 text-secondary focus:ring-secondary" checked onchange="updateUnitLabel()">
                            <span class="text-gray-700">收入</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="radio" name="transaction-type" value="expense" class="w-4 h-4 text-danger focus:ring-danger" onchange="updateUnitLabel()">
                            <span class="text-gray-700">支出</span>
                        </label>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-4">
                    <div class="flex-1">
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">金额 (¥)</label>
                        <input type="number" id="transaction-amount" step="0.01" min="0" class="input-field" placeholder="请输入金额" required>
                    </div>
                    <div class="flex-1">
                        <label for="transaction-payment-method" class="block text-sm font-medium text-gray-700 mb-1">支付方式</label>
                        <select id="transaction-payment-method" class="input-field">
                            <option value="">请选择支付方式</option>
                            <option value="电子承兑">电子承兑</option>
                            <option value="电汇" selected>电汇</option>
                            <option value="微信">微信</option>
                            <option value="支付宝">支付宝</option>
                            <option value="现金">现金</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="transaction-unit" class="block text-sm font-medium text-gray-700 mb-1">
                        <span id="unit-label">付款单位</span> (可选)
                    </label>
                    <div class="relative">
                        <input type="text" id="transaction-unit" class="input-field" placeholder="请输入单位名称" autocomplete="off">
                        <div id="unit-suggestions" class="absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto hidden">
                            <!-- 单位建议将动态生成 -->
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                    <select id="transaction-category" class="input-field" required>
                        <!-- 分类选项将根据交易类型动态生成 -->
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="transaction-date" class="block text-sm font-medium text-gray-700 mb-1">日期</label>
                    <input type="date" id="transaction-date" class="input-field" required>
                </div>
                
                <div class="mb-6">
                    <label for="transaction-description" class="block text-sm font-medium text-gray-700 mb-1">描述 (可选)</label>
                    <textarea id="transaction-description" rows="2" class="input-field" placeholder="请输入交易描述"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-transaction" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="btn-primary">保存交易</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 确认删除模态框 -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm mx-4 animate-slide-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800">确认删除</h3>
                <p class="text-gray-600 mt-2">您确定要删除这条交易记录吗？此操作无法撤销。</p>
            </div>
            
            <div class="flex justify-center space-x-3">
                <button id="cancel-delete" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                <button id="confirm-delete" class="btn-danger">删除</button>
            </div>
        </div>
    </div>
    

    
    <!-- 通知提示 -->
    <div id="notification" class="fixed top-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-sm transform translate-x-full transition-transform duration-300 z-50 flex items-center space-x-3">
        <div id="notification-icon" class="w-8 h-8 rounded-full flex items-center justify-center">
            <i id="notification-icon-i" class="fa"></i>
        </div>
        <div>
            <h4 id="notification-title" class="font-medium text-gray-800"></h4>
            <p id="notification-message" class="text-sm text-gray-600"></p>
        </div>
        <button id="close-notification" class="text-gray-400 hover:text-gray-600">
            <i class="fa fa-times"></i>
        </button>
    </div>

    <script>
        // 分类数据
        window.categories = {
            income: [
                { id: 'salary', name: '前期账面余额', icon: 'fa-briefcase', color: '#10b981' },
                { id: 'bonus', name: '无锡龙力', icon: 'fa-trophy', color: '#f59e0b' },
                { id: 'investment', name: '货款', icon: 'fa-line-chart', color: '#3b82f6' },
                { id: 'side-income', name: '个人垫资', icon: 'fa-coffee', color: '#8b5cf6' },
                { id: 'gift', name: '还款', icon: 'fa-gift', color: '#ec4899' },
                { id: 'adjustment', name: '调账', icon: 'fa-balance-scale', color: '#ef4444' },
                { id: 'other-income', name: '其他收入', icon: 'fa-ellipsis-h', color: '#6b7280' }
            ],
            expense: [
                { id: 'previous-balance', name: '前期账面余额', icon: 'fa-briefcase', color: '#10b981' },
                { id: 'raw-materials', name: '原材料', icon: 'fa-cutlery', color: '#ef4444' },
                { id: 'auxiliary-materials', name: '辅助材料', icon: 'fa-car', color: '#3b82f6' },
                { id: 'plating', name: '电镀费', icon: 'fa-cogs', color: '#3b82f6' },
                { id: 'packaging', name: '包装箱费用', icon: 'fa-box', color: '#f59e0b' },
                { id: 'consumables', name: '易耗品材料', icon: 'fa-shopping-bag', color: '#10b981' },
                { id: 'outsourcing', name: '外协加工费', icon: 'fa-home', color: '#8b5cf6' },
                { id: 'shipping', name: '运杂费', icon: 'fa-truck', color: '#ec4899' },
                { id: 'repair-mold', name: '维修或模具费', icon: 'fa-wrench', color: '#ef4444' },
                { id: 'utilities', name: '水电费', icon: 'fa-tint', color: '#3b82f6' },
                { id: 'salary', name: '工资', icon: 'fa-money', color: '#10b981' },
                { id: 'tax', name: '税', icon: 'fa-file-text', color: '#3b82f6' },
                { id: 'bank-repayment', name: '银行还贷', icon: 'fa-university', color: '#10b981' },
                { id: 'bank-fee', name: '银行手续费', icon: 'fa-credit-card', color: '#f59e0b' },
                { id: 'interest', name: '利息', icon: 'fa-percent', color: '#ef4444' },
                { id: 'employee-reimbursement', name: '员工报销', icon: 'fa-graduation-cap', color: '#3b82f6' },
                { id: 'employee-meal', name: '员工餐费用', icon: 'fa-users', color: '#ef4444' },
                { id: 'employee-welfare', name: '员工福利', icon: 'fa-gift', color: '#f59e0b' },
                { id: 'communication', name: '通信费', icon: 'fa-phone', color: '#8b5cf6' },
                { id: 'adjustment', name: '调账', icon: 'fa-balance-scale', color: '#ef4444' },
                { id: 'other-expense', name: '其它支出', icon: 'fa-ellipsis-h', color: '#6b7280' },
                { id: 'trade-transaction', name: '贸易往来', icon: 'fa-exchange', color: '#ec4899' },
                { id: 'loan', name: '借款', icon: 'fa-handshake-o', color: '#f59e0b' },
                { id: 'fixed-assets', name: '固定资产设备', icon: 'fa-building', color: '#ec4899' },
                { id: 'trade-product', name: '贸易产品', icon: 'fa-shopping-cart', color: '#10b981' }
            ]
        };

        // 初始化应用
        function initializeApp() {
            // 确保本地存储中的公司信息已初始化
            if (!localStorage.getItem('currentCompany')) {
                localStorage.setItem('currentCompany', 'company1');
            }
            
            // 初始化默认公司
            const currentCompany = getCurrentCompany();
            
            // 确保本地存储已初始化
            initializeLocalStorage(currentCompany);
            
            // 等待DOM完全加载后再设置公司按钮样式
            setTimeout(() => {
                // 设置当前公司按钮样式
                const companyBtns = document.querySelectorAll('.company-btn');
                if (companyBtns.length > 0) {
                    companyBtns.forEach(btn => {
                        btn.classList.remove('bg-primary', 'text-white', 'bg-gray-200', 'text-gray-700');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    
                    const currentCompanyBtn = document.getElementById(`${currentCompany}-btn`);
                    if (currentCompanyBtn) {
                        currentCompanyBtn.classList.remove('bg-gray-200', 'text-gray-700');
                        currentCompanyBtn.classList.add('bg-primary', 'text-white');
                        
                        // 更新页面标题
                        const companyName = currentCompanyBtn.textContent.trim();
                        const pageTitle = document.querySelector('h1.text-xl.font-bold');
                        if (pageTitle) {
                            pageTitle.textContent = `${companyName}收支表`;
                        }
                    }
                }
            }, 50);
            
            // 初始化UI事件监听
            initializeEventListeners();
            
            // 初始化图表
            initializeCharts();
            
            // 加载交易数据
            loadTransactions();
            
            // 加载待办事项
            loadTodos();
            
            // 更新财务概览
            updateFinancialSummary();
            
            // 设置当前日期为默认交易日期
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateInput = document.getElementById('transaction-date');
            if (dateInput) {
                dateInput.value = `${year}-${month}-${day}`;
            }
            
            // 初始化单位自动完成功能
            initUnitAutocomplete();
            
            // 初始化搜索框自动宽度调整
            initSearchAutoWidth();
            
            // 初始化财务对账单位下拉框
            initReconciliationUnits();
            
            // 初始化分布图表年份和月份下拉框
            initDistributionYearSelect();
            
            // 初始化支出和收入分类下拉框
            initCategoryFilters();
        }
        
        // 检查URL参数并自动填充表单
        function checkUrlParams() {
            // 获取URL参数
            const params = new URLSearchParams(window.location.search);
            const type = params.get('type');
            const unit = params.get('unit');
            const date = params.get('date');
            const amount = params.get('amount');
            const autoOpen = params.get('autoOpen');
            const refresh = params.get('refresh');
            const selectFirstCompany = params.get('selectFirstCompany');
            
            // 检查是否需要选中第一个公司
            if (selectFirstCompany === 'true') {
                // 选中第一个公司按钮
                const firstCompanyBtn = document.getElementById('company1-btn');
                if (firstCompanyBtn && !firstCompanyBtn.classList.contains('bg-primary')) {
                    firstCompanyBtn.click();
                }
            }
            
            // 检查是否需要刷新页面（避免无限循环）
            if (refresh === 'true') {
                // 只在页面完全加载后处理刷新请求
                if (document.readyState === 'complete') {
                    // 设置一个标志，避免无限循环
                    sessionStorage.setItem('refreshDone', 'true');
                    
                    // 延迟刷新页面，让所有初始化完成
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                } else {
                    // 如果页面还没加载完成，等加载完成后再刷新
                    window.addEventListener('load', () => {
                        sessionStorage.setItem('refreshDone', 'true');
                        setTimeout(() => {
                            window.location.reload();
                        }, 100);
                    });
                }
                return; // 退出函数，等待页面刷新
            }
            
            // 如果有参数且需要自动打开模态框
            if (autoOpen === 'true') {
                // 设置交易类型为支出
                if (type === 'expense') {
                    document.querySelector('input[name="transaction-type"][value="expense"]').checked = true;
                    updateUnitLabel();
                }
                
                // 填充单位名称
                if (unit && unit !== 'N/A') {
                    document.getElementById('transaction-unit').value = unit;
                }
                
                // 填充日期
                if (date && date !== '-') {
                    document.getElementById('transaction-date').value = date;
                }
                
                // 填充金额
                if (amount) {
                    document.getElementById('transaction-amount').value = amount;
                }
                
                // 更新分类选项
                updateCategoryOptions();
                
                // 设置默认支付方式为电汇
                document.getElementById('transaction-payment-method').value = '电汇';
                
                // 显示模态框
                document.getElementById('transaction-modal').classList.remove('hidden');
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 公司切换按钮事件监听
            if (document.getElementById('company1-btn') && document.getElementById('company2-btn')) {
                document.getElementById('company1-btn').addEventListener('click', function() {
                    switchCompany('company1');
                });
                
                document.getElementById('company2-btn').addEventListener('click', function() {
                    switchCompany('company2');
                });
            }
            
            // 初始化应用
            initializeApp();
            
            // 检查URL参数并处理
            checkUrlParams();
        });

        // 获取当前选中的公司
        function getCurrentCompany() {
            return localStorage.getItem('currentCompany') || 'company1';
        }
        
        // 初始化本地存储
        function initializeLocalStorage(company) {
            // 确保公司参数存在
            company = company || getCurrentCompany();
            
            // 按公司初始化交易数据
            const transactionKey = `transactions_${company}`;
            if (!localStorage.getItem(transactionKey)) {
                localStorage.setItem(transactionKey, JSON.stringify([]));
            }
            
            // 按公司初始化更新时间
            const lastUpdatedKey = `lastUpdated_${company}`;
            if (!localStorage.getItem(lastUpdatedKey)) {
                const today = new Date().toISOString().split('T')[0];
                localStorage.setItem(lastUpdatedKey, today);
            }
            
            // 更新UI显示
            document.getElementById('last-updated').textContent = localStorage.getItem(lastUpdatedKey);
        }
        
        // 切换公司
        function switchCompany(companyId) {
            // 保存当前选中的公司
            localStorage.setItem('currentCompany', companyId);
            
            // 更新按钮样式
            document.querySelectorAll('.company-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white', 'bg-gray-200', 'text-gray-700');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`${companyId}-btn`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`${companyId}-btn`).classList.add('bg-primary', 'text-white');
            
            // 更新页面标题
            const companyName = document.getElementById(`${companyId}-btn`).textContent.trim();
            document.querySelector('h1.text-xl.font-bold').textContent = `${companyName}收支表`;
            
            // 初始化本地存储并重新加载数据
            initializeLocalStorage(companyId);
            loadTransactions();
            updateFinancialSummary();
            updateDistributionChart('month');
            updateCategoryChart('expense', 'month');
            
            // 初始化财务对账单位下拉框
            if (typeof initReconciliationUnits === 'function') {
                initReconciliationUnits();
            }
            
            // 显示切换成功通知
            showNotification('公司切换', `已切换至${companyName}`, 'success');
        }

        // 待办事项相关函数
        let todos = [];
        
        // 加载待办事项
        function loadTodos() {
            try {
                const savedTodos = localStorage.getItem('todos');
                todos = savedTodos ? JSON.parse(savedTodos) : [];
                displayTodos();
            } catch (error) {
                console.error('加载待办事项失败:', error);
                todos = [];
                displayTodos();
            }
        }
        
        // 显示待办事项列表
        function displayTodos() {
            const todosContainer = document.getElementById('todos-container');
            const emptyTodos = document.getElementById('empty-todos');
            
            // 清空容器
            while (todosContainer.firstChild) {
                if (todosContainer.firstChild.id !== 'empty-todos') {
                    todosContainer.removeChild(todosContainer.firstChild);
                } else {
                    break;
                }
            }
            
            // 检查是否有待办事项
            if (todos.length === 0) {
                emptyTodos.classList.remove('hidden');
                return;
            } else {
                emptyTodos.classList.add('hidden');
            }
            
            // 按优先级和创建时间排序
            todos.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // 创建并添加待办事项
            todos.forEach(todo => {
                const todoElement = document.createElement('div');
                todoElement.className = `flex items-center p-3 rounded-lg border ${todo.completed ? 'bg-gray-100 border-gray-200' : 'bg-white border-gray-300'}`;
                todoElement.dataset.id = todo.id;
                
                // 优先级标记
                const priorityColor = {
                    high: 'bg-red-500',
                    medium: 'bg-yellow-500',
                    low: 'bg-green-500'
                };
                
                todoElement.innerHTML = `
                    <div class="mr-3">
                        <div class="w-2 h-2 rounded-full ${priorityColor[todo.priority]}"></div>
                    </div>
                    <div class="flex-grow">
                        <p class="${todo.completed ? 'line-through text-gray-500' : 'text-gray-800'}" title="${todo.text}">${todo.text}</p>
                        <p class="text-xs text-gray-500">${formatDate(todo.createdAt.split('T')[0])}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="complete-todo p-1.5 rounded-md hover:bg-gray-200 transition-colors" title="${todo.completed ? '标记为未完成' : '标记为已完成'}">
                            <i class="fa fa-check-circle ${todo.completed ? 'text-secondary' : 'text-gray-400'}"></i>
                        </button>
                        <button class="edit-todo p-1.5 rounded-md hover:bg-gray-200 transition-colors" title="编辑待办事项">
                            <i class="fa fa-pencil text-gray-400 hover:text-gray-600"></i>
                        </button>
                        <button class="delete-todo p-1.5 rounded-md hover:bg-gray-200 transition-colors" title="删除待办事项">
                            <i class="fa fa-trash text-gray-400 hover:text-danger"></i>
                        </button>
                    </div>
                `;
                
                todosContainer.insertBefore(todoElement, emptyTodos);
            });
        }
        
        // 保存待办事项
        function saveTodo() {
            const todoId = document.getElementById('todo-id').value;
            const todoText = document.getElementById('todo-text').value.trim();
            const todoPriority = document.getElementById('todo-priority').value;
            
            const todo = {
                id: todoId || generateId(),
                text: todoText,
                priority: todoPriority,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            // 如果是编辑现有待办事项，保留completed状态
            if (todoId) {
                const existingTodo = todos.find(t => t.id === todoId);
                if (existingTodo) {
                    todo.completed = existingTodo.completed;
                }
            }
            
            // 更新或添加待办事项
            const existingIndex = todos.findIndex(t => t.id === todoId);
            if (existingIndex >= 0) {
                todos[existingIndex] = todo;
            } else {
                todos.push(todo);
            }
            
            // 保存到localStorage
            localStorage.setItem('todos', JSON.stringify(todos));
            
            // 更新显示
            displayTodos();
            
            // 关闭模态框
            document.getElementById('todo-modal').classList.add('hidden');
        }
        
        // 切换待办事项完成状态
        function toggleTodoComplete(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (todo) {
                todo.completed = !todo.completed;
                localStorage.setItem('todos', JSON.stringify(todos));
                displayTodos();
            }
        }
        
        // 删除待办事项
        function deleteTodo(todoId) {
            if (confirm('确定要删除这条待办事项吗？')) {
                todos = todos.filter(t => t.id !== todoId);
                localStorage.setItem('todos', JSON.stringify(todos));
                displayTodos();
            }
        }
        
        // 打开添加待办事项模态框
        function openAddTodoModal() {
            document.getElementById('todo-modal-title').textContent = '添加待办事项';
            document.getElementById('todo-id').value = '';
            document.getElementById('todo-form').reset();
            document.getElementById('todo-modal').classList.remove('hidden');
        }
        
        // 打开编辑待办事项模态框
        function openEditTodoModal(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (todo) {
                document.getElementById('todo-modal-title').textContent = '编辑待办事项';
                document.getElementById('todo-id').value = todo.id;
                document.getElementById('todo-text').value = todo.text;
                document.getElementById('todo-priority').value = todo.priority;
                document.getElementById('todo-modal').classList.remove('hidden');
            }
        }
        
        // 清空所有交易记录
        function clearAllTransactions() {
            // 获取当前公司
            const company = getCurrentCompany();
            const companyName = document.getElementById(`${company}-btn`).textContent.trim();
            
            // 显示确认对话框
            if (confirm(`警告：此操作将永久删除${companyName}的所有交易记录！\n删除后将无法恢复，是否继续？`)) {
                try {
                    // 清空本地存储中的当前公司交易数据
                    localStorage.removeItem(`transactions_${company}`);
                    
                    // 重置交易数组
                    transactions = [];
                    
                    // 重新加载和渲染交易列表
                    loadTransactions();
                    
                    // 更新财务概览
                    updateFinancialSummary();
                    
                    // 显示成功通知
                    showNotification('所有交易记录已成功清空', 'success');
                } catch (error) {
                    console.error('清空交易记录时出错:', error);
                    showNotification('清空失败，请稍后重试', 'error');
                }
            }
        }
        
        // 初始化事件监听

        
        function initializeEventListeners() {
            // 账户菜单下拉
            document.getElementById('account-menu').addEventListener('click', function() {
                document.getElementById('account-dropdown').classList.toggle('hidden');
            });
            

            
            // 清空所有交易记录按钮点击事件
            document.getElementById('account-settings').addEventListener('click', function(e) {
                e.preventDefault();
                clearAllTransactions();
                document.getElementById('account-dropdown').classList.add('hidden');
            });
            
            // 待办事项相关事件监听
            // 添加待办事项按钮
            document.getElementById('add-todo-btn').addEventListener('click', openAddTodoModal);
            
            // 关闭待办事项模态框
            document.getElementById('close-todo-modal').addEventListener('click', function() {
                document.getElementById('todo-modal').classList.add('hidden');
            });
            
            // 取消按钮
            document.getElementById('cancel-todo-btn').addEventListener('click', function() {
                document.getElementById('todo-modal').classList.add('hidden');
            });
            
            // 待办事项表单提交
            document.getElementById('todo-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTodo();
            });
            
            // 使用事件委托处理待办事项列表中的按钮点击
            document.getElementById('todos-container').addEventListener('click', function(e) {
                const todoElement = e.target.closest('[data-id]');
                if (!todoElement) return;
                
                const todoId = todoElement.dataset.id;
                
                // 检查点击的是哪个按钮
                if (e.target.closest('.complete-todo')) {
                    toggleTodoComplete(todoId);
                } else if (e.target.closest('.edit-todo')) {
                    openEditTodoModal(todoId);
                } else if (e.target.closest('.delete-todo')) {
                    deleteTodo(todoId);
                }
            });
            
            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', function(event) {
                const accountMenu = document.getElementById('account-menu');
                const accountDropdown = document.getElementById('account-dropdown');
                
                if (!accountMenu.contains(event.target) && !accountDropdown.contains(event.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });
            

            
            // 添加交易按钮
            document.getElementById('add-transaction-btn').addEventListener('click', function() {
                openAddTransactionModal();
            });
            
            // Excel导入导出功能
            document.getElementById('export-excel').addEventListener('click', function(e) {
                e.preventDefault();
                exportToExcel();
                document.getElementById('account-dropdown').classList.add('hidden');
            });
            
            document.getElementById('import-excel').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('file-input').click();
                document.getElementById('account-dropdown').classList.add('hidden');
            });
            
            document.getElementById('file-input').addEventListener('change', function(e) {
                importFromExcel(e.target.files[0]);
                // 重置文件输入，以便可以重复导入同一文件
                this.value = '';
            });
            
            // 关闭交易模态框
            document.getElementById('close-modal').addEventListener('click', closeTransactionModal);
            document.getElementById('cancel-transaction').addEventListener('click', closeTransactionModal);
            
            // 导出JSON功能
            document.getElementById('export-json').addEventListener('click', function(e) {
                e.preventDefault();
                exportToJson();
                document.getElementById('account-dropdown').classList.add('hidden');
            });
            
            // 导入JSON功能
            document.getElementById('import-json').addEventListener('click', function(e) {
                e.preventDefault();
                // 创建隐藏的文件输入框用于导入JSON
                let jsonInput = document.getElementById('json-file-input');
                if (!jsonInput) {
                    jsonInput = document.createElement('input');
                    jsonInput.type = 'file';
                    jsonInput.id = 'json-file-input';
                    jsonInput.accept = '.json';
                    jsonInput.className = 'hidden';
                    jsonInput.addEventListener('change', function(e) {
                        importFromJson(e.target.files[0]);
                        // 重置文件输入，以便可以重复导入同一文件
                        this.value = '';
                    });
                    document.body.appendChild(jsonInput);
                }
                jsonInput.click();
                document.getElementById('account-dropdown').classList.add('hidden');
            });
            
            // 交易表单提交
            document.getElementById('transaction-form').addEventListener('submit', function(event) {
                event.preventDefault();
                saveTransaction();
            });
            
            // 交易类型切换
            document.querySelectorAll('input[name="transaction-type"]').forEach(radio => {
                radio.addEventListener('change', updateCategoryOptions);
            });
            
            // 关闭删除模态框
            document.getElementById('cancel-delete').addEventListener('click', closeDeleteModal);
            document.getElementById('close-notification').addEventListener('click', closeNotification);
            
            // 确认删除
            document.getElementById('confirm-delete').addEventListener('click', confirmDeleteTransaction);
            
            // 搜索交易
            document.getElementById('search-transactions').addEventListener('input', filterTransactions);
            

            
            // 筛选交易
            document.getElementById('filter-transactions').addEventListener('change', filterTransactions);
            
            // 支出分类筛选
            document.getElementById('expense-category-filter').addEventListener('change', filterTransactions);
            // 收入分类筛选
            document.getElementById('income-category-filter').addEventListener('change', filterTransactions);
            
            // 分页控制
            document.getElementById('prev-page').addEventListener('click', goToPrevPage);
            document.getElementById('next-page').addEventListener('click', goToNextPage);
            document.getElementById('go-to-page').addEventListener('click', goToPage);
            document.getElementById('page-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    goToPage();
                }
            });
            
            // 图表周期切换
            document.querySelectorAll('.chart-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-period-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    this.classList.remove('bg-gray-200', 'text-gray-700');
                    this.classList.add('bg-primary', 'text-white');
                    updateDistributionChart(this.dataset.period);
                });
            });
            
            // 分类类型切换
            document.querySelectorAll('.category-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-type-btn').forEach(b => {
                        b.classList.remove('bg-danger', 'text-white', 'bg-secondary');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    this.classList.remove('bg-gray-200', 'text-gray-700');
                    
                    if (this.dataset.type === 'expense') {
                        this.classList.add('bg-danger', 'text-white');
                    } else {
                        this.classList.add('bg-secondary', 'text-white');
                    }
                    
                    // 获取当前选中的时间段
                    const currentPeriod = document.querySelector('.category-period-btn.bg-primary').dataset.period;
                    updateCategoryChart(this.dataset.type, currentPeriod);
                });
            });
            
            // 分类时间段切换
            document.querySelectorAll('.category-period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-period-btn').forEach(b => {
                        b.classList.remove('bg-primary', 'text-white');
                        b.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    this.classList.remove('bg-gray-200', 'text-gray-700');
                    this.classList.add('bg-primary', 'text-white');
                    
                    // 获取当前选中的类型
                    const currentType = document.querySelector('.category-type-btn.bg-danger, .category-type-btn.bg-secondary').dataset.type;
                    updateCategoryChart(currentType, this.dataset.period);
                });
            });
        }

        // 初始化图表
        function initializeCharts() {
            // 初始化分布图表
            const distributionCtx = document.getElementById('distribution-chart').getContext('2d');
            window.distributionChart = new Chart(distributionCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '收入',
                            data: [],
                            backgroundColor: '#10b981',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: '支出',
                            data: [],
                            backgroundColor: '#ef4444',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value;
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                  label: function(context) {
                                      const formatted = formatAmount(context.raw);
                                      return context.dataset.label + ': ' + formatted;
                                  }
                              }
                        },
                        datalabels: {
                            display: true,
                            color: '#000',
                            font: {
                                size: 10
                            },
                            formatter: function(value) {
                                return formatAmount(value);
                            },
                            anchor: 'top'
                        }
                    }
                }
            });
            
            // 初始化分类图表
            const categoryCtx = document.getElementById('category-chart').getContext('2d');
            window.categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom', // 将图例位置从右侧改为底部
                            labels: {
                                boxWidth: 12,
                                padding: 10, // 调整内边距
                                font: {
                                    size: 11 // 适当减小字体大小
                                },
                                maxWidth: 150, // 设置标签最大宽度
                                textAlign: 'left',
                                usePointStyle: true,
                                // 自定义图例标签，显示分类名称和百分比
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        const dataset = data.datasets[0];
                                        const total = dataset.data.reduce((a, b) => a + b, 0);
                                        
                                        return data.labels.map((label, i) => {
                                            const value = dataset.data[i];
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                            const formattedAmount = formatAmount(value);
                                            
                                            return {
                                                text: label + ' (' + percentage + '%, ' + formattedAmount + ')',
                                                fillStyle: dataset.backgroundColor[i],
                                                strokeStyle: dataset.borderColor || '#fff',
                                                lineWidth: dataset.borderWidth || 1,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                      const value = context.raw;
                                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                      const percentage = ((value / total) * 100).toFixed(2);
                                      const formatted = formatAmount(value);
                                      return context.label + ': ' + formatted + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
            
            // 更新图表数据
            updateDistributionChart('month');
            updateCategoryChart('expense', 'month');
            
            // 初始化年份下拉框
            initYearSelect();
        }

        // 加载交易数据
        function loadTransactions() {
            const company = getCurrentCompany();
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            window.allTransactions = transactions;
            
            // 应用当前筛选和排序
            filterTransactions();
        }

        // 初始化支出和收入分类下拉框
        function initCategoryFilters() {
            // 初始化支出分类下拉框
            const expenseFilter = document.getElementById('expense-category-filter');
            expenseFilter.innerHTML = '<option value="all">所有支出项目</option>';
            window.categories.expense.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                expenseFilter.appendChild(option);
            });
            
            // 初始化收入分类下拉框
            const incomeFilter = document.getElementById('income-category-filter');
            incomeFilter.innerHTML = '<option value="all">所有收入项目</option>';
            window.categories.income.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                incomeFilter.appendChild(option);
            });
            
            // 添加联动逻辑事件监听
            const filterType = document.getElementById('filter-transactions');
            
            // 支出分类下拉框变化时
            expenseFilter.addEventListener('change', function() {
                const filterType = document.getElementById('filter-transactions');
                const incomeFilter = document.getElementById('income-category-filter');
                
                // 如果选择了具体的支出分类，自动调整为仅支出，并重置收入分类
                if (this.value !== 'all') {
                    filterType.value = 'expense';
                    incomeFilter.value = 'all';
                    filterTransactions();
                }
            });
            
            // 收入分类下拉框变化时
            incomeFilter.addEventListener('change', function() {
                const filterType = document.getElementById('filter-transactions');
                const expenseFilter = document.getElementById('expense-category-filter');
                
                // 如果选择了具体的收入分类，自动调整为仅收入，并重置支出分类
                if (this.value !== 'all') {
                    filterType.value = 'income';
                    expenseFilter.value = 'all';
                    filterTransactions();
                }
            });
            
            // 交易类型下拉框变化时
            filterType.addEventListener('change', function() {
                const expenseFilter = document.getElementById('expense-category-filter');
                const incomeFilter = document.getElementById('income-category-filter');
                
                // 根据选择的交易类型，重置对应的分类下拉框
                if (this.value === 'income') {
                    expenseFilter.value = 'all';
                    filterTransactions();
                } else if (this.value === 'expense') {
                    incomeFilter.value = 'all';
                    filterTransactions();
                }
            });
        }
        
        // 筛选和排序交易
        function filterTransactions() {
            const searchTerm = document.getElementById('search-transactions').value.toLowerCase();
            const filterType = document.getElementById('filter-transactions').value;
            const expenseCategoryFilter = document.getElementById('expense-category-filter').value;
            const incomeCategoryFilter = document.getElementById('income-category-filter').value;
            
            // 应用筛选
            let filteredTransactions = window.allTransactions.filter(transaction => {
                // 搜索筛选 - 包括分类名称、交易说明和单位名称
                const matchesSearch = 
                    (transaction.description && transaction.description.toLowerCase().includes(searchTerm)) ||
                    (transaction.categoryName && transaction.categoryName.toLowerCase().includes(searchTerm)) ||
                    (transaction.unit && transaction.unit.toLowerCase().includes(searchTerm));
                
                // 类型筛选
                const matchesType = filterType === 'all' || transaction.type === filterType;
                
                // 分类筛选
                let matchesCategory = true;
                if (transaction.type === 'expense') {
                    matchesCategory = expenseCategoryFilter === 'all' || transaction.categoryId === expenseCategoryFilter;
                } else if (transaction.type === 'income') {
                    matchesCategory = incomeCategoryFilter === 'all' || transaction.categoryId === incomeCategoryFilter;
                }
                
                return matchesSearch && matchesType && matchesCategory;
            });
            
            // 按日期降序排序（默认）
            filteredTransactions.sort((a, b) => {
                const dateDiffDesc = new Date(b.date) - new Date(a.date);
                return dateDiffDesc !== 0 ? dateDiffDesc : new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // 保存筛选后的交易
            window.filteredTransactions = filteredTransactions;
            
            // 更新金额汇总信息
            updateAmountSummary(filteredTransactions);
            
            // 更新分页
            updatePagination();
            
            // 显示当前页交易
            displayTransactions();
        }
        
        // 更新搜索结果的金额汇总
        function updateAmountSummary(transactions) {
            // 初始化汇总变量
            let totalIncome = 0;
            let totalExpense = 0;
            let totalAmount = 0;
            
            // 计算汇总金额
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.amount;
                    totalAmount += transaction.amount;
                } else {
                    totalExpense += transaction.amount;
                    totalAmount -= transaction.amount;
                }
            });
            
            // 检查汇总元素是否存在，不存在则创建
            let summaryContainer = document.getElementById('search-summary');
            if (!summaryContainer) {
                // 找到交易记录列表表格，然后获取其父容器
                const transactionsTable = document.querySelector('#transactions-list').parentElement;
                const transactionsSection = transactionsTable.parentElement;
                summaryContainer = document.createElement('div');
                summaryContainer.id = 'search-summary';
                summaryContainer.className = 'mb-4 p-4 bg-primary/10 rounded-lg border border-primary/30 shadow-sm';
                transactionsSection.insertBefore(summaryContainer, transactionsSection.firstChild);
            }
            
            // 更新汇总显示
            const searchTerm = document.getElementById('search-transactions').value;
            const filterType = document.getElementById('filter-transactions').value;
            
            // 根据不同情况显示不同的标题
            let summaryTitle;
            if (searchTerm) {
                summaryTitle = `"${searchTerm}" 搜索结果汇总`;
            } else if (filterType !== 'all') {
                const typeText = filterType === 'income' ? '收入' : '支出';
                summaryTitle = `${typeText}汇总`;
            } else {
                // 初始状态（无搜索词且显示所有交易）
                summaryTitle = '交易记录汇总';
            }
            
            summaryContainer.innerHTML = `
                <div class="flex flex-col space-y-3">
                    <h4 class="font-bold text-primary">${summaryTitle}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <div class="text-sm text-gray-500 mb-1">记录笔数</div>
                            <div class="text-xl font-bold text-gray-800">${transactions.length}</div>
                        </div>
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <div class="text-sm text-gray-500 mb-1">总收入</div>
                            <div class="text-xl font-bold text-secondary">+${formatAmount(totalIncome).replace('¥', '')}</div>
                        </div>
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <div class="text-sm text-gray-500 mb-1">总支出</div>
                            <div class="text-xl font-bold text-danger">-${formatAmount(totalExpense).replace('¥', '')}</div>
                        </div>
                        <div class="bg-white p-3 rounded border border-gray-200">
                            <div class="text-sm text-gray-500 mb-1">净额</div>
                            <div class="text-xl font-bold ${totalAmount >= 0 ? 'text-secondary' : 'text-danger'}">
                                ${totalAmount >= 0 ? '+' : ''}${formatAmount(totalAmount).replace('¥', '')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 始终显示汇总容器，无论是否有交易记录
            summaryContainer.style.display = 'block';
        }

        // 更新分页
        function updatePagination() {
            const transactionsPerPage = 20;
            window.transactionsPerPage = transactionsPerPage;
            
            // 计算总页数
            window.totalPages = Math.ceil(window.filteredTransactions.length / transactionsPerPage);
            
            // 设置当前页（默认为第一页）
            if (!window.currentPage || window.currentPage > window.totalPages) {
                window.currentPage = 1;
            }
            
            // 更新分页信息
            document.getElementById('total-transactions').textContent = window.filteredTransactions.length;
            document.getElementById('current-page').textContent = window.currentPage;
            document.getElementById('total-pages').textContent = window.totalPages;
            document.getElementById('page-input').value = window.currentPage;
            document.getElementById('page-input').max = window.totalPages;
            
            // 更新分页按钮状态
            document.getElementById('prev-page').disabled = window.currentPage === 1;
            document.getElementById('next-page').disabled = window.currentPage === window.totalPages;
        }

        // 显示当前页交易
        function displayTransactions() {
            const transactionsList = document.getElementById('transactions-list');
            const transactionsPerPage = window.transactionsPerPage;
            const currentPage = window.currentPage;
            
            // 清空列表
            transactionsList.innerHTML = '';
            
            // 如果没有交易，显示空状态
            if (window.filteredTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <tr class="text-center">
                        <td colspan="5" class="px-4 py-8 text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fa fa-credit-card text-4xl mb-2 text-gray-300"></i>
                                <p>暂无交易记录</p>
                                <p class="text-sm">点击"添加新交易"开始记录</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // 计算当前页的交易范围
            const startIndex = (currentPage - 1) * transactionsPerPage;
            const endIndex = Math.min(startIndex + transactionsPerPage, window.filteredTransactions.length);
            const currentTransactions = window.filteredTransactions.slice(startIndex, endIndex);
            
            // 更新显示的交易数量
            document.getElementById('showing-transactions').textContent = currentTransactions.length;
            
            // 获取所有交易（不考虑过滤条件）
            const company = getCurrentCompany();
            const allTransactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            
            // 按时间顺序（从早到晚）排序所有交易
            const timeSortedTransactions = [...allTransactions].sort((a, b) => 
                new Date(a.date) - new Date(b.date)
            );
            
            // 预计算每条交易后的余额（按时间顺序，基于所有交易）
            const balanceByTransactionId = {};
            let cumulativeBalance = 0;
            
            timeSortedTransactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    cumulativeBalance += transaction.amount;  // 收入增加余额
                } else {
                    cumulativeBalance -= transaction.amount;  // 支出减少余额
                }
                balanceByTransactionId[transaction.id] = cumulativeBalance;
            });
            
            // 添加交易到列表
            currentTransactions.forEach(transaction => {
                const category = getCategoryById(transaction.type, transaction.categoryId);
                const row = document.createElement('tr');
                
                // 创建各个单元格
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-4 py-3 whitespace-nowrap';
                categoryCell.innerHTML = `
                    <div class="flex items-center">
                        <div class="category-icon" style="background-color: ${category.color}">
                            <i class="fa ${category.icon}"></i>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${category.name}</div>
                        </div>
                    </div>
                `;
                
                const descriptionCell = document.createElement('td');
                        descriptionCell.className = 'px-4 py-3 whitespace-nowrap';
                        
                        // 构建描述内容，包含单位和支付方式信息
                        let descriptionHTML = `<div class="text-sm text-gray-900">${transaction.description}</div>`;
                        if (transaction.unit) {
                            const unitLabel = transaction.type === 'income' ? '付款单位:' : '收款单位:';
                            descriptionHTML += `<div class="text-xs text-gray-500">${unitLabel} ${transaction.unit}</div>`;
                        }
                        if (transaction.paymentMethod) {
                            descriptionHTML += `<div class="text-xs text-gray-500">支付方式: ${transaction.paymentMethod}</div>`;
                        }
                        
                        descriptionCell.innerHTML = descriptionHTML;
                        
                        const dateCell = document.createElement('td');
                        dateCell.className = 'px-4 py-3 whitespace-nowrap';
                        dateCell.innerHTML = `<div class="text-sm text-gray-500">${formatDate(transaction.date)}</div>`;
                        
                        const amountCell = document.createElement('td');
                        amountCell.className = 'px-4 py-3 whitespace-nowrap text-right';
                        const amountClass = transaction.type === 'income' ? 'text-secondary' : 'text-danger';
                        const amountSign = transaction.type === 'income' ? '+' : '';
                        const formattedAmount = formatAmount(transaction.amount);
                        
                        // 获取该交易的预计算余额
                        const transactionBalance = balanceByTransactionId[transaction.id];
                        
                        // 格式化余额
                        const balanceClass = transactionBalance >= 0 ? 'text-secondary' : 'text-danger';
                        const formattedBalance = formatAmount(transactionBalance);
                        
                        // 将余额显示在金额下方
                        amountCell.innerHTML = `
                            <div class="text-sm font-medium ${amountClass}">${amountSign}${formattedAmount.replace('¥', '')}</div>
                            <div class="text-xs text-gray-500">余额: <span class="${balanceClass}">${formattedBalance.replace('¥', '')}</span></div>
                        `;
                        
                        const actionCell = document.createElement('td');
                        actionCell.className = 'px-4 py-3 whitespace-nowrap text-right text-sm font-medium';
                        
                        // 创建编辑按钮
                        const editBtn = document.createElement('button');
                        editBtn.className = 'edit-transaction text-primary hover:text-primary-dark mr-3';
                        editBtn.dataset.id = transaction.id;
                        editBtn.innerHTML = '<i class="fa fa-pencil"></i>';
                        editBtn.onclick = function() {
                            openEditTransactionModal(this.dataset.id);
                        };
                        
                        // 创建删除按钮
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-transaction text-danger hover:text-danger-dark';
                        deleteBtn.setAttribute('data-id', transaction.id);
                        deleteBtn.setAttribute('type', 'button');
                        deleteBtn.style.cursor = 'pointer'; // 鼠标指针样式为手型
                        deleteBtn.title = '删除此交易记录'; // 添加提示文本
                        
                        // 创建图标元素
                        const icon = document.createElement('i');
                        icon.className = 'fa fa-trash';
                        deleteBtn.appendChild(icon);
                        
                        // 为删除按钮添加点击事件处理
                        deleteBtn.onclick = function(e) {
                            e.stopPropagation();
                            const transactionId = this.getAttribute('data-id');
                            
                            // 直接使用原生确认对话框
                            if (confirm('确定要删除这条交易记录吗？此操作不可撤销。')) {
                                // 获取现有交易数据
                                const company = getCurrentCompany();
                                let transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
                                
                                // 过滤掉要删除的交易
                                transactions = transactions.filter(t => t.id !== transactionId);
                                
                                // 保存更新后的交易数据
                                localStorage.setItem(`transactions_${company}`, JSON.stringify(transactions));
                                
                                // 更新最后修改时间
                                const today = new Date().toISOString().split('T')[0];
                                localStorage.setItem(`lastUpdated_${company}`, today);
                                document.getElementById('last-updated').textContent = today;
                                
                                // 重新加载交易列表
                                loadTransactions();
                                
                                // 更新财务概览和图表
                                updateFinancialSummary();
                                updateDistributionChart(document.querySelector('.chart-period-btn.bg-primary').dataset.period);
                                updateCategoryChart(document.querySelector('.category-type-btn.bg-danger, .category-type-btn.bg-secondary').dataset.type);
                            }
                        };
                        
                        // 添加按钮到操作单元格
                        actionCell.appendChild(editBtn);
                        actionCell.appendChild(deleteBtn);
                        
                        // 添加所有单元格到行
                        row.appendChild(categoryCell);
                        row.appendChild(descriptionCell);
                        row.appendChild(dateCell);
                        row.appendChild(amountCell);
                        row.appendChild(actionCell);
                        
                        transactionsList.appendChild(row);
            });
        }

        // 打开添加交易模态框
        function openAddTransactionModal() {
            // 重置表单
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('modal-title').textContent = '添加新交易';
            document.getElementById('transaction-unit').value = '';
            
            // 设置默认日期为今天
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('transaction-date').value = `${year}-${month}-${day}`;
            
            // 更新分类选项
            updateCategoryOptions();
            
            // 更新单位标签
            updateUnitLabel();
            
            // 设置默认支付方式为电汇
            document.getElementById('transaction-payment-method').value = '电汇';
            
            // 显示模态框
            document.getElementById('transaction-modal').classList.remove('hidden');
        }

        // 打开编辑交易模态框
        function openEditTransactionModal(transactionId) {
            // 获取交易数据
            const transaction = window.allTransactions.find(t => t.id === transactionId);
            
            if (!transaction) return;
            
            // 填充表单 - 先设置基础信息
            document.getElementById('transaction-id').value = transaction.id;
            document.getElementById('modal-title').textContent = '编辑交易';
            
            // 设置交易类型
            document.querySelector(`input[name="transaction-type"][value="${transaction.type}"]`).checked = true;
            
            // 更新分类选项
            updateCategoryOptions();
            
            // 更新单位标签 (会清空输入框)
            updateUnitLabel();
            
            // 设置分类
            document.getElementById('transaction-category').value = transaction.categoryId;
            
            // 填充表单其余字段
            document.getElementById('transaction-amount').value = transaction.amount;
            document.getElementById('transaction-date').value = transaction.date;
            document.getElementById('transaction-description').value = transaction.description;
            
            // 最后加载单位信息，避免被updateUnitLabel()清空
            document.getElementById('transaction-unit').value = transaction.unit || '';
            
            // 显示模态框
            document.getElementById('transaction-modal').classList.remove('hidden');
        }

        // 关闭交易模态框
        function closeTransactionModal() {
            document.getElementById('transaction-modal').classList.add('hidden');
        }
        

        
        // 导出JSON功能
        function exportToJson() {
            try {
                // 收集所有需要备份的数据
                const backupData = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    data: {
                        // 待办事项数据
                        todos: JSON.parse(localStorage.getItem('todos') || '[]'),
                        // 交易记录数据（按公司分组）
                        transactions: {},
                        // 最后更新时间（按公司分组）
                        lastUpdated: {},
                        // 当前公司设置
                        currentCompany: localStorage.getItem('currentCompany') || 'company1'
                    }
                };
                
                // 收集所有公司的交易数据
                const companies = ['company1', 'company2'];
                companies.forEach(company => {
                    backupData.data.transactions[company] = JSON.parse(localStorage.getItem(`transactions_${company}`) || '[]');
                    backupData.data.lastUpdated[company] = localStorage.getItem(`lastUpdated_${company}`) || new Date().toISOString().split('T')[0];
                });
                
                // 创建JSON字符串
                const jsonString = JSON.stringify(backupData, null, 2);
                
                // 创建下载链接
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `收支表备份_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                // 显示成功提示
                showNotification('导出成功', '数据已成功导出为JSON文件', 'success');
            } catch (error) {
                console.error('导出JSON失败:', error);
                showNotification('导出失败', '数据导出失败，请重试', 'error');
            }
        }
        
        // 导入JSON功能
        function importFromJson(file) {
            if (!file) {
                showNotification('导入失败', '请选择一个JSON文件', 'error');
                return;
            }
            
            // 检查文件类型
            const fileType = file.name.split('.').pop().toLowerCase();
            if (fileType !== 'json') {
                showNotification('导入失败', '请选择JSON文件(.json)', 'error');
                return;
            }
            
            if (confirm('确定要导入此JSON文件吗？此操作将覆盖当前所有数据！')) {
                try {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            
                            // 检查备份数据格式
                            if (backupData.version && backupData.data) {
                                const data = backupData.data;
                                
                                // 恢复待办事项数据
                                if (data.todos && Array.isArray(data.todos)) {
                                    localStorage.setItem('todos', JSON.stringify(data.todos));
                                }
                                
                                // 恢复交易记录和最后更新时间（按公司分组）
                                if (data.transactions) {
                                    Object.keys(data.transactions).forEach(company => {
                                        localStorage.setItem(`transactions_${company}`, JSON.stringify(data.transactions[company] || []));
                                        
                                        // 恢复最后更新时间
                                        if (data.lastUpdated && data.lastUpdated[company]) {
                                            localStorage.setItem(`lastUpdated_${company}`, data.lastUpdated[company]);
                                        } else {
                                            const today = new Date().toISOString().split('T')[0];
                                            localStorage.setItem(`lastUpdated_${company}`, today);
                                        }
                                    });
                                }
                                
                                // 恢复当前公司设置
                                if (data.currentCompany) {
                                    localStorage.setItem('currentCompany', data.currentCompany);
                                }
                                
                                // 重新加载数据
                                loadTransactions();
                                
                                // 重新加载待办事项
                                if (typeof loadTodos === 'function') {
                                    loadTodos();
                                }
                                
                                // 更新财务概览
                                updateFinancialSummary();
                                
                                // 更新图表
                                updateDistributionChart(document.querySelector('.chart-period-btn.bg-primary').dataset.period);
                                updateCategoryChart(document.querySelector('.category-type-btn.bg-danger, .category-type-btn.bg-secondary').dataset.type);
                                
                                // 显示成功提示
                                showNotification('导入成功', '数据已成功导入', 'success');
                            } else {
                                throw new Error('无效的JSON文件格式');
                            }
                        } catch (error) {
                            console.error('解析JSON文件失败:', error);
                            showNotification('导入失败', 'JSON文件格式错误，请重试', 'error');
                        }
                    };
                    
                    reader.onerror = function(error) {
                        console.error('读取JSON文件失败:', error);
                        showNotification('导入失败', '文件读取失败，请重试', 'error');
                    };
                    
                    // 开始读取文件
                    reader.readAsText(file);
                } catch (error) {
                    console.error('导入JSON失败:', error);
                    showNotification('导入失败', '数据导入失败，请重试', 'error');
                }
            }
        }
        


        // 更新分类选项
        function updateCategoryOptions() {
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            const categorySelect = document.getElementById('transaction-category');
            
            // 清空现有选项
            categorySelect.innerHTML = '';
            
            // 添加新选项
            categories[transactionType].forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        // 保存交易
        function saveTransaction() {
            // 获取表单数据
            const transactionId = document.getElementById('transaction-id').value;
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const categoryId = document.getElementById('transaction-category').value;
            const date = document.getElementById('transaction-date').value;
            const description = document.getElementById('transaction-description').value;
            const unit = document.getElementById('transaction-unit').value.trim();
            const paymentMethod = document.getElementById('transaction-payment-method').value;
            
            // 获取分类名称
            const category = getCategoryById(transactionType, categoryId);
            const categoryName = category ? category.name : '';
            
            // 创建交易对象
            const transaction = {
                id: transactionId || generateId(),
                type: transactionType,
                amount: amount,
                categoryId: categoryId,
                categoryName: categoryName,
                date: date,
                description: description,
                unit: unit, // 添加单位信息
                paymentMethod: paymentMethod, // 添加支付方式
                createdAt: new Date().toISOString()
            };
            
            // 获取现有交易
            const company = getCurrentCompany();
            let transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            
            // 更新或添加交易
            const existingIndex = transactions.findIndex(t => t.id === transactionId);
            if (existingIndex >= 0) {
                transactions[existingIndex] = transaction;
            } else {
                transactions.push(transaction);
            }
            
            // 保存交易
            localStorage.setItem(`transactions_${company}`, JSON.stringify(transactions));
            
            // 更新最后更新时间
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem(`lastUpdated_${company}`, today);
            document.getElementById('last-updated').textContent = today;
            
            // 重新加载交易
            loadTransactions();
            
            // 更新财务概览
            updateFinancialSummary();
            
            // 更新图表
            updateDistributionChart(document.querySelector('.chart-period-btn.bg-primary').dataset.period);
            updateCategoryChart(document.querySelector('.category-type-btn.bg-danger, .category-type-btn.bg-secondary').dataset.type);
            
            // 关闭模态框
            closeTransactionModal();
            
            // 显示通知
            showNotification(
                '成功',
                transactionId ? '交易已更新' : '交易已添加',
                'success'
            );
        }

        // 打开删除模态框
        function openDeleteModal(transactionId) {
            // 保存要删除的交易ID
            window.transactionToDelete = transactionId;
            
            // 显示模态框
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // 关闭删除模态框
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            window.transactionToDelete = null;
        }

        // 确认删除交易
        function confirmDeleteTransaction() {
            const transactionId = window.transactionToDelete;
            
            if (!transactionId) return;
            
            // 获取现有交易
            const company = getCurrentCompany();
            let transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            
            // 删除交易
            transactions = transactions.filter(t => t.id !== transactionId);
            
            // 保存交易
            localStorage.setItem(`transactions_${company}`, JSON.stringify(transactions));
            
            // 更新最后更新时间
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem(`lastUpdated_${company}`, today);
            document.getElementById('last-updated').textContent = today;
            
            // 重新加载交易
            loadTransactions();
            
            // 更新财务概览
            updateFinancialSummary();
            
            // 更新图表
            updateDistributionChart(document.querySelector('.chart-period-btn.bg-primary').dataset.period);
            updateCategoryChart(document.querySelector('.category-type-btn.bg-danger, .category-type-btn.bg-secondary').dataset.type);
            
            // 关闭模态框
            closeDeleteModal();
            
            // 显示通知
            showNotification(
                '成功',
                '交易已删除',
                'success'
            );
        }

        // 格式化金额（添加千位分隔符）
        function formatAmount(amount) {
            return '¥' + parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // 更新财务概览
        function updateFinancialSummary() {
            const company = getCurrentCompany();
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            // 计算当前月收入和支出
            let currentMonthIncome = 0;
            let currentMonthExpense = 0;
            
            // 计算上月收入和支出
            let lastMonthIncome = 0;
            let lastMonthExpense = 0;
            
            // 计算总余额
            let totalBalance = 0;
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const transactionMonth = transactionDate.getMonth();
                const transactionYear = transactionDate.getFullYear();
                
                // 更新总余额
                if (transaction.type === 'income') {
                    totalBalance += transaction.amount;  // 收入增加余额
                } else {
                    totalBalance -= transaction.amount;  // 支出减少余额
                }
                
                // 更新当月收支
                if (transactionMonth === currentMonth && transactionYear === currentYear) {
                    if (transaction.type === 'income') {
                        currentMonthIncome += transaction.amount;
                    } else {
                        currentMonthExpense += transaction.amount;
                    }
                }
                
                // 更新上月收支
                if (transactionMonth === lastMonth && transactionYear === lastMonthYear) {
                    if (transaction.type === 'income') {
                        lastMonthIncome += transaction.amount;
                    } else {
                        lastMonthExpense += transaction.amount;
                    }
                }
            });
            
            // 更新UI
            document.getElementById('total-balance').textContent = formatAmount(totalBalance);
            document.getElementById('monthly-income').textContent = formatAmount(currentMonthIncome);
            document.getElementById('monthly-expense').textContent = formatAmount(currentMonthExpense);
            
            // 计算环比变化
            const incomeChange = calculatePercentageChange(currentMonthIncome, lastMonthIncome);
            const expenseChange = calculatePercentageChange(currentMonthExpense, lastMonthExpense);
            
            // 更新环比变化UI
            const incomeChangeElement = document.getElementById('income-change');
            const expenseChangeElement = document.getElementById('expense-change');
            
            incomeChangeElement.textContent = `${incomeChange >= 0 ? '+' : ''}${incomeChange.toFixed(1)}%`;
            expenseChangeElement.textContent = `${expenseChange >= 0 ? '+' : ''}${expenseChange.toFixed(1)}%`;
            
            // 更新环比变化图标
            const incomeChangeIcon = incomeChangeElement.previousElementSibling;
            const expenseChangeIcon = expenseChangeElement.previousElementSibling;
            
            if (incomeChange > 0) {
                incomeChangeIcon.className = 'fa fa-arrow-up mr-1';
                incomeChangeElement.parentElement.className = 'text-secondary ml-1 flex items-center';
            } else if (incomeChange < 0) {
                incomeChangeIcon.className = 'fa fa-arrow-down mr-1';
                incomeChangeElement.parentElement.className = 'text-danger ml-1 flex items-center';
            } else {
                incomeChangeIcon.className = 'fa fa-minus mr-1';
                incomeChangeElement.parentElement.className = 'text-gray-500 ml-1 flex items-center';
            }
            
            if (expenseChange > 0) {
                expenseChangeIcon.className = 'fa fa-arrow-up mr-1';
                expenseChangeElement.parentElement.className = 'text-danger ml-1 flex items-center';
            } else if (expenseChange < 0) {
                expenseChangeIcon.className = 'fa fa-arrow-down mr-1';
                expenseChangeElement.parentElement.className = 'text-secondary ml-1 flex items-center';
            } else {
                expenseChangeIcon.className = 'fa fa-minus mr-1';
                expenseChangeElement.parentElement.className = 'text-gray-500 ml-1 flex items-center';
            }
        }

        // 更新分布图表
        function updateDistributionChart(period) {
            const company = getCurrentCompany();
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            const today = new Date();
            let labels = [];
            let incomeData = [];
            let expenseData = [];
            
            // 获取选择的年份和月份
            const yearSelect = document.getElementById('distribution-year-select');
            const monthSelect = document.getElementById('distribution-month-select');
            const selectedYear = yearSelect ? parseInt(yearSelect.value) : today.getFullYear();
            const selectedMonth = monthSelect ? parseInt(monthSelect.value) : -1;
            
            if (period === 'month') {
                if (selectedMonth === -1) {
                    // 月度视图：显示所选年份的所有12个月
                    for (let month = 0; month < 12; month++) {
                        const monthLabel = getMonthLabel(month);
                        labels.push(monthLabel);
                        
                        // 计算该月收入和支出
                        let monthIncome = 0;
                        let monthExpense = 0;
                        
                        transactions.forEach(transaction => {
                            const transactionDate = new Date(transaction.date);
                            if (transactionDate.getMonth() === month && transactionDate.getFullYear() === selectedYear) {
                                if (transaction.type === 'income') {
                                    monthIncome += transaction.amount;
                                } else {
                                    monthExpense += transaction.amount;
                                }
                            }
                        });
                        
                        incomeData.push(monthIncome);
                        expenseData.push(monthExpense);
                    }
                } else {
                    // 选择了特定月份，只显示该月份
                    const monthLabel = getMonthLabel(selectedMonth);
                    labels.push(monthLabel);
                    
                    let monthIncome = 0;
                    let monthExpense = 0;
                    
                    transactions.forEach(transaction => {
                        const transactionDate = new Date(transaction.date);
                        if (transactionDate.getMonth() === selectedMonth && transactionDate.getFullYear() === selectedYear) {
                            if (transaction.type === 'income') {
                                monthIncome += transaction.amount;
                            } else {
                                monthExpense += transaction.amount;
                            }
                        }
                    });
                    
                    incomeData.push(monthIncome);
                    expenseData.push(monthExpense);
                }
            } else if (period === 'quarter') {
                if (selectedMonth === -1) {
                    // 季度视图：显示最近4个季度
                    for (let i = 3; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(today.getMonth() - i * 3);
                        
                        const quarter = Math.floor(date.getMonth() / 3) + 1;
                        const year = date.getFullYear();
                        const quarterLabel = `Q${quarter} ${year}`;
                        labels.push(quarterLabel);
                        
                        // 计算该季度收入和支出
                        let quarterIncome = 0;
                        let quarterExpense = 0;
                        
                        transactions.forEach(transaction => {
                            const transactionDate = new Date(transaction.date);
                            const transactionQuarter = Math.floor(transactionDate.getMonth() / 3) + 1;
                            const transactionYear = transactionDate.getFullYear();
                            
                            if (transactionQuarter === quarter && transactionYear === year) {
                                if (transaction.type === 'income') {
                                    quarterIncome += transaction.amount;
                                } else {
                                    quarterExpense += transaction.amount;
                                }
                            }
                        });
                        
                        incomeData.push(quarterIncome);
                        expenseData.push(quarterExpense);
                    }
                } else {
                    // 选择了特定月份，显示该月份所在季度
                    const quarter = Math.floor(selectedMonth / 3) + 1;
                    const quarterLabel = `Q${quarter} ${selectedYear}`;
                    labels.push(quarterLabel);
                    
                    let quarterIncome = 0;
                    let quarterExpense = 0;
                    
                    transactions.forEach(transaction => {
                        const transactionDate = new Date(transaction.date);
                        const transactionQuarter = Math.floor(transactionDate.getMonth() / 3) + 1;
                        const transactionYear = transactionDate.getFullYear();
                        
                        if (transactionQuarter === quarter && transactionYear === selectedYear) {
                            if (transaction.type === 'income') {
                                quarterIncome += transaction.amount;
                            } else {
                                quarterExpense += transaction.amount;
                            }
                        }
                    });
                    
                    incomeData.push(quarterIncome);
                    expenseData.push(quarterExpense);
                }
            } else if (period === 'year') {
                if (selectedMonth === -1) {
                    // 年度视图：显示最近3年
                    for (let i = 2; i >= 0; i--) {
                        const year = today.getFullYear() - i;
                        labels.push(year.toString());
                        
                        // 计算该年收入和支出
                        let yearIncome = 0;
                        let yearExpense = 0;
                        
                        transactions.forEach(transaction => {
                            const transactionDate = new Date(transaction.date);
                            if (transactionDate.getFullYear() === year) {
                                if (transaction.type === 'income') {
                                    yearIncome += transaction.amount;
                                } else {
                                    yearExpense += transaction.amount;
                                }
                            }
                        });
                        
                        incomeData.push(yearIncome);
                        expenseData.push(yearExpense);
                    }
                } else {
                    // 选择了特定月份，只显示该月份
                    const monthLabel = getMonthLabel(selectedMonth);
                    labels.push(`${monthLabel} ${selectedYear}`);
                    
                    let monthIncome = 0;
                    let monthExpense = 0;
                    
                    transactions.forEach(transaction => {
                        const transactionDate = new Date(transaction.date);
                        if (transactionDate.getMonth() === selectedMonth && transactionDate.getFullYear() === selectedYear) {
                            if (transaction.type === 'income') {
                                monthIncome += transaction.amount;
                            } else {
                                monthExpense += transaction.amount;
                            }
                        }
                    });
                    
                    incomeData.push(monthIncome);
                    expenseData.push(monthExpense);
                }
            } else if (period === 'all') {
                // 统计视图：根据选择的年份和月份显示
                if (selectedMonth === -1) {
                    // 显示全年数据
                    labels.push(`${selectedYear}年`);
                    
                    let yearIncome = 0;
                    let yearExpense = 0;
                    
                    transactions.forEach(transaction => {
                        const transactionDate = new Date(transaction.date);
                        if (transactionDate.getFullYear() === selectedYear) {
                            if (transaction.type === 'income') {
                                yearIncome += transaction.amount;
                            } else {
                                yearExpense += transaction.amount;
                            }
                        }
                    });
                    
                    incomeData.push(yearIncome);
                    expenseData.push(yearExpense);
                } else {
                    // 显示特定月份数据
                    const monthLabel = getMonthLabel(selectedMonth);
                    labels.push(`${selectedYear}年${monthLabel}`);
                    
                    let monthIncome = 0;
                    let monthExpense = 0;
                    
                    transactions.forEach(transaction => {
                        const transactionDate = new Date(transaction.date);
                        if (transactionDate.getMonth() === selectedMonth && transactionDate.getFullYear() === selectedYear) {
                            if (transaction.type === 'income') {
                                monthIncome += transaction.amount;
                            } else {
                                monthExpense += transaction.amount;
                            }
                        }
                    });
                    
                    incomeData.push(monthIncome);
                    expenseData.push(monthExpense);
                }
            }
            
            // 更新图表数据
            window.distributionChart.data.labels = labels;
            window.distributionChart.data.datasets[0].data = incomeData;
            window.distributionChart.data.datasets[1].data = expenseData;
            
            // 更新图表配置以显示柱形上方的金额
            window.distributionChart.options.plugins.tooltip.callbacks.label = function(context) {
                const formatted = formatAmount(context.raw);
                return context.dataset.label + ': ' + formatted;
            };
            
            // 添加数据标签配置
            if (!window.distributionChart.options.plugins.datalabels) {
                window.distributionChart.options.plugins.datalabels = {
                    display: true,
                    color: '#000',
                    font: {
                        size: 10
                    },
                    formatter: function(value) {
                        return formatAmount(value);
                    },
                    anchor: 'top'
                };
            }
            
            window.distributionChart.update();
        }

        // 初始化年份下拉框
        function initYearSelect() {
            const yearSelect = document.getElementById('year-select');
            const today = new Date();
            const currentYear = today.getFullYear();
            const startYear = 2025;
            const endYear = 3035;
            
            // 生成2025年到3035年的所有年份
            const years = [];
            for (let year = endYear; year >= startYear; year--) {
                years.push(year);
            }
            
            // 清空现有选项
            yearSelect.innerHTML = '';
            
            // 添加年份选项
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}年`;
                if (year === currentYear && year >= startYear && year <= endYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
            
            // 添加事件监听器
            yearSelect.addEventListener('change', () => {
                updateCategoryChart(getCurrentCategoryType(), getCurrentCategoryPeriod());
            });
            
            // 月份下拉框事件监听
            const monthSelect = document.getElementById('month-select');
            monthSelect.addEventListener('change', () => {
                updateCategoryChart(getCurrentCategoryType(), getCurrentCategoryPeriod());
            });
        }
        
        // 初始化分布图表年份下拉框
        function initDistributionYearSelect() {
            const yearSelect = document.getElementById('distribution-year-select');
            const monthSelect = document.getElementById('distribution-month-select');
            const today = new Date();
            const currentYear = today.getFullYear();
            const startYear = 2025;
            const endYear = 3035;
            
            // 生成2025年到3035年的所有年份
            const years = [];
            for (let year = endYear; year >= startYear; year--) {
                years.push(year);
            }
            
            // 清空现有选项
            yearSelect.innerHTML = '';
            
            // 添加年份选项
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}年`;
                if (year === currentYear && year >= startYear && year <= endYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
            
            // 添加月份选项
            const months = [
                { value: -1, text: '全部月份' },
                { value: 0, text: '一月' },
                { value: 1, text: '二月' },
                { value: 2, text: '三月' },
                { value: 3, text: '四月' },
                { value: 4, text: '五月' },
                { value: 5, text: '六月' },
                { value: 6, text: '七月' },
                { value: 7, text: '八月' },
                { value: 8, text: '九月' },
                { value: 9, text: '十月' },
                { value: 10, text: '十一月' },
                { value: 11, text: '十二月' }
            ];
            
            monthSelect.innerHTML = '';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.text;
                if (month.value === -1) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            });
            
            // 添加事件监听器
            yearSelect.addEventListener('change', () => {
                updateDistributionChart('all');
            });
            
            monthSelect.addEventListener('change', () => {
                updateDistributionChart('all');
            });
        }
        
        // 获取当前选择的年份
        function getCurrentYear() {
            const yearSelect = document.getElementById('year-select');
            return parseInt(yearSelect.value);
        }
        
        // 获取当前选择的月份
        function getCurrentMonth() {
            const monthSelect = document.getElementById('month-select');
            return parseInt(monthSelect.value);
        }
        
        // 更新年度总收入和总支出
        function updateAnnualTotals() {
            const company = getCurrentCompany();
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            const selectedYear = getCurrentYear();
            const selectedMonth = getCurrentMonth();
            
            // 计算筛选后的总收入和总支出
            let filteredTotalIncome = 0;
            let filteredTotalExpense = 0;
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const transactionYear = transactionDate.getFullYear();
                const transactionMonth = transactionDate.getMonth();
                
                // 根据选择的年份和月份筛选
                if (transactionYear === selectedYear) {
                    if (selectedMonth === -1 || transactionMonth === selectedMonth) {
                        if (transaction.type === 'income') {
                            filteredTotalIncome += transaction.amount;
                        } else {
                            filteredTotalExpense += transaction.amount;
                        }
                    }
                }
            });
            
            // 更新显示
            const incomeElement = document.getElementById('annual-total-income');
            const expenseElement = document.getElementById('annual-total-expense');
            
            if (incomeElement) {
                incomeElement.textContent = formatAmount(filteredTotalIncome);
            }
            
            if (expenseElement) {
                expenseElement.textContent = formatAmount(filteredTotalExpense);
            }
        }
        
        // 更新分类图表
        function updateCategoryChart(type, period = 'month') {
            const company = getCurrentCompany();
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // 获取选择的年份和月份
            const selectedYear = getCurrentYear();
            const selectedMonth = getCurrentMonth();
            
            // 更新年度总收入和总支出
            updateAnnualTotals();
            
            // 计算各类别收支
            const categoryAmounts = {};
            
            // 初始化所有分类的金额为0
            categories[type].forEach(category => {
                categoryAmounts[category.id] = 0;
            });
            
            transactions.forEach(transaction => {
                if (transaction.type !== type) return;
                
                const transactionDate = new Date(transaction.date);
                const transactionYear = transactionDate.getFullYear();
                const transactionMonth = transactionDate.getMonth();
                let isInPeriod = false;
                
                // 根据选择的年份和月份筛选
                if (selectedMonth === -1) {
                    // 选择了全部月份，根据period参数筛选
                    switch(period) {
                        case 'month':
                            // 使用选择的年份和当前月份
                            isInPeriod = transactionYear === selectedYear && transactionMonth === currentMonth;
                            break;
                        case 'quarter':
                            // 使用选择的年份和当前季度
                            const currentQuarter = Math.floor(currentMonth / 3);
                            const transactionQuarter = Math.floor(transactionMonth / 3);
                            isInPeriod = transactionYear === selectedYear && transactionQuarter === currentQuarter;
                            break;
                        case 'year':
                            // 使用选择的年份
                            isInPeriod = transactionYear === selectedYear;
                            break;
                        case 'all':
                            // 所有年份
                            isInPeriod = true;
                            break;
                    }
                } else {
                    // 选择了特定月份，忽略period参数
                    isInPeriod = transactionYear === selectedYear && transactionMonth === selectedMonth;
                }
                
                if (isInPeriod) {
                    if (!categoryAmounts[transaction.categoryId]) {
                        categoryAmounts[transaction.categoryId] = 0;
                    }
                    categoryAmounts[transaction.categoryId] += transaction.amount;
                }
            });
            
            // 计算总金额
            const totalAmount = Object.values(categoryAmounts).reduce((sum, amount) => sum + amount, 0);
            
            // 准备图表数据 - 过滤掉金额为0的分类
            const labels = [];
            const data = [];
            const backgroundColors = [];
            
            // 按金额降序排序分类
            const sortedCategories = [...categories[type]].sort((a, b) => {
                return categoryAmounts[b.id] - categoryAmounts[a.id];
            });
            
            sortedCategories.forEach(category => {
                const amount = categoryAmounts[category.id];
                if (amount > 0) {
                    labels.push(category.name);
                    data.push(amount);
                    backgroundColors.push(category.color);
                }
            });
            
            // 如果没有数据，显示提示
            if (labels.length === 0) {
                labels.push('暂无数据');
                data.push(1);
                backgroundColors.push('#e5e7eb');
            }
            
            // 优化图表配置
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom', // 将图例位置从右侧改为底部
                        labels: {
                            boxWidth: 12,
                            padding: 10, // 调整内边距
                            font: {
                                size: 11 // 适当减小字体大小
                            },
                            maxWidth: 150, // 设置标签最大宽度
                            textAlign: 'left',
                            // 自动换行处理长文本
                            usePointStyle: true,
                            // 自定义图例标签，显示分类名称和百分比
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    const dataset = data.datasets[0];
                                    const total = dataset.data.reduce((a, b) => a + b, 0);
                                    
                                    return data.labels.map((label, i) => {
                                        const value = dataset.data[i];
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                        const formattedAmount = formatAmount(value);
                                        
                                        return {
                                            text: label + ' (' + percentage + '%, ' + formattedAmount + ')',
                                            fillStyle: dataset.backgroundColor[i],
                                            strokeStyle: dataset.borderColor || '#fff',
                                            lineWidth: dataset.borderWidth || 1,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                  const value = context.raw;
                                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                  const percentage = ((value / total) * 100).toFixed(2);
                                  const formatted = formatAmount(value);
                                  return context.label + ': ' + formatted + ' (' + percentage + '%)';
                            }
                        }
                    }
                },
                // 确保小型分类也能在图表上显示
                cutout: '50%',
                elements: {
                    arc: {
                        borderWidth: 2
                    }
                }
            };
            
            // 更新图表配置和数据
            window.categoryChart.options = chartOptions;
            window.categoryChart.data.labels = labels;
            window.categoryChart.data.datasets[0].data = data;
            window.categoryChart.data.datasets[0].backgroundColor = backgroundColors;
            window.categoryChart.update();
            
            // 生成费用列表
            const expenseListContainer = document.getElementById('expense-list');
            expenseListContainer.innerHTML = '';
            
            if (sortedCategories.length > 0 && totalAmount > 0) {
                sortedCategories.forEach(category => {
                    const amount = categoryAmounts[category.id];
                    if (amount > 0) {
                        const percentage = ((amount / totalAmount) * 100).toFixed(2);
                        const formattedAmount = formatAmount(amount);
                        
                        const listItem = document.createElement('div');
                        listItem.className = 'flex justify-between items-center py-2 px-3 bg-gray-50 rounded-lg';
                        
                        // 左侧：分类名称
                        const categoryName = document.createElement('div');
                        categoryName.className = 'flex items-center';
                        categoryName.innerHTML = `
                            <span class="inline-block w-3 h-3 rounded-full mr-2" style="background-color: ${category.color}"></span>
                            <span class="text-sm text-gray-700">${category.name}</span>
                        `;
                        
                        // 右侧：占比和金额
                        const amountInfo = document.createElement('div');
                        amountInfo.className = 'flex items-center space-x-3';
                        amountInfo.innerHTML = `
                            <span class="text-sm text-gray-600">${percentage}%</span>
                            <span class="text-sm font-medium ${type === 'income' ? 'text-green-600' : 'text-red-600'}">${formattedAmount}</span>
                        `;
                        
                        listItem.appendChild(categoryName);
                        listItem.appendChild(amountInfo);
                        expenseListContainer.appendChild(listItem);
                    }
                });
            } else {
                // 没有数据时显示提示
                const emptyItem = document.createElement('div');
                emptyItem.className = 'text-center py-4 text-sm text-gray-500';
                emptyItem.textContent = '暂无费用数据';
                expenseListContainer.appendChild(emptyItem);
            }
        }

        // 显示通知
        function showNotification(title, message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationIcon = document.getElementById('notification-icon');
            const notificationIconI = document.getElementById('notification-icon-i');
            
            // 设置通知内容
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // 设置通知类型
            if (type === 'success') {
                notificationIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-green-100';
                notificationIconI.className = 'fa fa-check text-green-500';
            } else if (type === 'error') {
                notificationIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-red-100';
                notificationIconI.className = 'fa fa-times text-red-500';
            } else if (type === 'warning') {
                notificationIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-yellow-100';
                notificationIconI.className = 'fa fa-exclamation text-yellow-500';
            } else {
                notificationIcon.className = 'w-8 h-8 rounded-full flex items-center justify-center bg-blue-100';
                notificationIconI.className = 'fa fa-info text-blue-500';
            }
            
            // 显示通知
            notification.classList.remove('translate-x-full');
            
            // 3秒后自动关闭
            setTimeout(() => {
                closeNotification();
            }, 3000);
        }

        // 关闭通知
        function closeNotification() {
            const notification = document.getElementById('notification');
            notification.classList.add('translate-x-full');
        }

        // 上一页
        function goToPrevPage() {
            if (window.currentPage > 1) {
                window.currentPage--;
                displayTransactions();
                updatePagination(); // 更新页码显示
            }
        }

        // 下一页
        function goToNextPage() {
            if (window.currentPage < window.totalPages) {
                window.currentPage++;
                displayTransactions();
                updatePagination(); // 更新页码显示
            }
        }

        // 跳转到指定页面
        function goToPage() {
            const pageInput = document.getElementById('page-input');
            let page = parseInt(pageInput.value);
            
            // 验证页码范围
            if (isNaN(page) || page < 1) {
                page = 1;
            } else if (page > window.totalPages) {
                page = window.totalPages;
            }
            
            // 更新当前页并重新显示交易
            window.currentPage = page;
            displayTransactions();
            updatePagination(); // 更新页码显示
        }

        // 辅助函数：生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 辅助函数：格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // 辅助函数：获取月份标签
        function getMonthLabel(month) {
            const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            return monthNames[month];
        }

        // 辅助函数：计算百分比变化
        function calculatePercentageChange(current, previous) {
            if (previous === 0) {
                return current > 0 ? 100 : 0;
            }
            return ((current - previous) / previous) * 100;
        }

        // 辅助函数：通过ID获取分类
        function getCategoryById(type, categoryId) {
            return categories[type].find(category => category.id === categoryId);
        }
    </script>
</div>
    
    <script>
        // 已经在页面早期初始化了应用，这里不再重复初始化
        
        // 更新单位标签函数
        function updateUnitLabel() {
            const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
            const unitLabel = document.getElementById('unit-label');
            const unitInput = document.getElementById('transaction-unit');
            
            if (transactionType === 'income') {
                unitLabel.textContent = '付款单位';
                unitInput.placeholder = '请输入付款单位名称';
            } else {
                unitLabel.textContent = '收款单位';
                unitInput.placeholder = '请输入收款单位名称';
            }
            
            // 清空输入和建议列表
            unitInput.value = '';
            document.getElementById('unit-suggestions').classList.add('hidden');
        }
        
        // 初始化搜索框自动宽度调整
        function initSearchAutoWidth() {
            const searchInput = document.getElementById('search-transactions');
            const measureSpan = document.getElementById('search-width-measure');
            
            if (searchInput && measureSpan) {
                // 设置初始宽度
                updateSearchWidth();
                
                // 监听输入事件
                searchInput.addEventListener('input', updateSearchWidth);
                
                // 监听窗口大小变化
                window.addEventListener('resize', updateSearchWidth);
            }
            
            function updateSearchWidth() {
                if (searchInput && measureSpan) {
                    // 获取输入内容，默认为placeholder
                    const text = searchInput.value || searchInput.placeholder;
                    
                    // 设置测量文本
                    measureSpan.textContent = text;
                    
                    // 计算宽度并设置给输入框
                    const measuredWidth = measureSpan.offsetWidth;
                    const minWidth = 300; // 最小宽度
                    const padding = 40; // 左右内边距 + 搜索图标
                    
                    // 计算实际宽度（加上适当的内边距和额外空间）
                    const newWidth = Math.max(minWidth, measuredWidth + padding);
                    
                    // 仅在中等及以上屏幕尺寸下自动调整宽度
                    if (window.innerWidth >= 768) {
                        searchInput.style.width = `${newWidth}px`;
                    } else {
                        // 在小屏幕上保持100%宽度
                        searchInput.style.width = '100%';
                    }
                }
            }
        }
        
        // 初始化单位自动完成功能
        function initUnitAutocomplete() {
            const unitInput = document.getElementById('transaction-unit');
            const suggestionsContainer = document.getElementById('unit-suggestions');
            
            // 监听输入事件
            unitInput.addEventListener('input', function() {
                const inputValue = this.value.toLowerCase().trim();
                const transactionType = document.querySelector('input[name="transaction-type"]:checked').value;
                
                if (inputValue.length < 1) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                
                // 获取并过滤单位建议
                const suggestions = getUnitSuggestions(inputValue, transactionType);
                
                if (suggestions.length > 0) {
                    // 显示建议列表
                    suggestionsContainer.innerHTML = '';
                    suggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                        suggestionItem.textContent = suggestion;
                        
                        // 单击选择功能
                        suggestionItem.addEventListener('click', function(event) {
                            event.stopPropagation(); // 阻止事件冒泡
                            unitInput.value = this.textContent;
                            suggestionsContainer.classList.add('hidden');
                            unitInput.focus();
                        });
                        
                        suggestionsContainer.appendChild(suggestionItem);
                    });
                    
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });
            

        
        // 点击外部关闭建议列表
        document.addEventListener('click', function(event) {
                if (!unitInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                    suggestionsContainer.classList.add('hidden');
                    // 确保输入框宽度适应内容
                    if (unitInput.value.trim()) {
                        adjustInputWidth(unitInput);
                    }
                }
            });
            
            // 添加函数：调整输入框宽度以适应内容
            function adjustInputWidth(inputElement) {
                // 创建临时元素用于测量文本宽度
                const tempSpan = document.createElement('span');
                tempSpan.textContent = inputElement.value;
                tempSpan.className = 'px-3';
                tempSpan.style.font = window.getComputedStyle(inputElement).font;
                tempSpan.style.visibility = 'hidden';
                tempSpan.style.position = 'absolute';
                document.body.appendChild(tempSpan);
                
                // 计算宽度并设置最小宽度
                const width = Math.max(200, tempSpan.offsetWidth + 16);
                inputElement.style.width = width + 'px';
                
                document.body.removeChild(tempSpan);
            }
            
            // 监听失焦事件，确保输入框宽度适应内容
            unitInput.addEventListener('blur', function() {
                if (this.value.trim()) {
                    adjustInputWidth(this);
                }
            });
            
            // 监听交易类型变化，刷新建议
            document.querySelectorAll('input[name="transaction-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateUnitLabel();
                });
            });
        }
        
        // 获取单位名称建议
        function getUnitSuggestions(inputValue, transactionType) {
            // 从当前公司的交易记录中获取数据
            const currentCompany = getCurrentCompany();
            const transactionKey = `transactions_${currentCompany}`;
            const transactions = JSON.parse(localStorage.getItem(transactionKey)) || [];
            
            // 提取指定交易类型的所有单位名称
            const allUnits = transactions
                .filter(t => t.type === transactionType && t.unit && t.unit.trim())
                .map(t => t.unit.trim());
            
            // 去重并过滤匹配的单位
            const uniqueUnits = [...new Set(allUnits)];
            const matchedUnits = uniqueUnits.filter(unit => 
                unit.toLowerCase().includes(inputValue)
            );
            
            // 最多返回10个建议
            return matchedUnits.slice(0, 10);
        }
        

        
        // 初始化财务对账单位下拉框
        function initReconciliationUnits() {
            // 初始化自动完成功能
            initReconciliationUnitAutocomplete();
            
            // 设置默认日期范围为当前月份
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            
            const startDateInput = document.getElementById('reconciliation-start-date');
            const endDateInput = document.getElementById('reconciliation-end-date');
            
            if (startDateInput) startDateInput.valueAsDate = firstDay;
            if (endDateInput) endDateInput.valueAsDate = today;
        }
        
        // 初始化财务对账单位自动完成功能
        function initReconciliationUnitAutocomplete() {
            const unitInput = document.getElementById('reconciliation-unit');
            const unitValueInput = document.getElementById('reconciliation-unit-value');
            const suggestionsContainer = document.getElementById('reconciliation-unit-suggestions');
            
            if (!unitInput || !unitValueInput || !suggestionsContainer) {
                return;
            }
            
            // 监听输入事件
            unitInput.addEventListener('input', function() {
                const inputValue = this.value.toLowerCase().trim();
                unitValueInput.value = ''; // 清除隐藏值
                
                if (inputValue.length < 1) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }
                
                // 获取所有交易记录中的单位名称
                const company = getCurrentCompany();
                const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
                
                // 收集所有唯一单位
                const uniqueUnits = new Set();
                transactions.forEach(transaction => {
                    if (transaction.unit && transaction.unit.trim()) {
                        uniqueUnits.add(transaction.unit.trim());
                    }
                });
                
                // 过滤匹配的单位
                const suggestions = Array.from(uniqueUnits)
                    .filter(unit => unit.toLowerCase().includes(inputValue))
                    .sort();
                
                if (suggestions.length > 0) {
                    // 显示建议列表
                    suggestionsContainer.innerHTML = '';
                    suggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                        suggestionItem.textContent = suggestion;
                        
                        // 单击选择功能
                        suggestionItem.addEventListener('click', function() {
                            unitInput.value = this.textContent;
                            unitValueInput.value = this.textContent;
                            // 调整输入框宽度以适应内容
                            adjustInputWidth(unitInput);
                            suggestionsContainer.classList.add('hidden');
                            unitInput.focus();
                        });
                        
                        suggestionsContainer.appendChild(suggestionItem);
                    });
                    
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            });
            
            // 点击外部关闭建议列表
            document.addEventListener('click', function(event) {
                if (!unitInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });
        }
        
        // 执行财务对账
        function performReconciliation() {
            const company = getCurrentCompany();
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            
            // 设置公司抬头
            const companyNames = {
                'company1': '普利美（常州）环境工程科技有限公司',
                'company2': '无锡龙力印铁设备制造有限公司'
            };
            const displayName = companyNames[company] || company;
            document.getElementById('company-header').querySelector('h2').textContent = displayName;
            
            // 获取筛选条件
            const unitValueInput = document.getElementById('reconciliation-unit-value');
            const unitInput = document.getElementById('reconciliation-unit');
            // 使用隐藏字段的值，如果没有，则使用输入框的值（用户手动输入的情况）
            const selectedUnit = unitValueInput ? unitValueInput.value : (unitInput ? unitInput.value : '');
            const startDateInput = document.getElementById('reconciliation-start-date');
            const endDateInput = document.getElementById('reconciliation-end-date');
            
            if (!startDateInput || !endDateInput) {
                showNotification('错误', '页面元素未找到', 'error');
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            // 验证日期
            if (isNaN(startDate.getTime())) {
                showNotification('日期错误', '请选择有效的开始日期', 'error');
                return;
            }
            
            if (isNaN(endDate.getTime())) {
                showNotification('日期错误', '请选择有效的结束日期', 'error');
                return;
            }
            
            if (startDate > endDate) {
                showNotification('日期错误', '开始日期不能晚于结束日期', 'error');
                return;
            }
            
            // 筛选交易
            const filteredTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                
                // 日期筛选
                const dateMatch = transactionDate >= startDate && transactionDate <= endDate;
                
                // 单位筛选
                const unitMatch = !selectedUnit || transaction.unit === selectedUnit;
                
                return dateMatch && unitMatch;
            });
            
            // 计算汇总数据
            let totalIncome = 0;
            let totalExpense = 0;
            
            filteredTransactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.amount;
                } else {
                    totalExpense += transaction.amount;
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // 更新结果显示
            const incomeElement = document.getElementById('reconciliation-income');
            const expenseElement = document.getElementById('reconciliation-expense');
            const balanceElement = document.getElementById('reconciliation-balance');
            const countElement = document.getElementById('reconciliation-count');
            const detailsContainer = document.getElementById('reconciliation-details');
            const resultsContainer = document.getElementById('reconciliation-results');
            
            if (incomeElement) incomeElement.textContent = formatAmount(totalIncome);
            if (expenseElement) expenseElement.textContent = formatAmount(totalExpense);
            
            if (balanceElement) {
                balanceElement.textContent = formatAmount(balance);
                balanceElement.className = balance >= 0 ? 'text-xl font-bold text-secondary' : 'text-xl font-bold text-danger';
            }
            
            if (countElement) countElement.textContent = filteredTransactions.length;
            
            // 显示交易明细
            if (detailsContainer) {
                detailsContainer.innerHTML = '';
                
                // 按日期降序排序，如果日期相同则按创建时间降序排序
                filteredTransactions.sort((a, b) => {
                    const dateDiff = new Date(b.date) - new Date(a.date);
                    return dateDiff !== 0 ? dateDiff : new Date(b.createdAt) - new Date(a.createdAt);
                });
                
                if (filteredTransactions.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            该时间段内没有符合条件的交易记录
                        </td>
                    `;
                    detailsContainer.appendChild(emptyRow);
                } else {
                    filteredTransactions.forEach(transaction => {
                        const category = getCategoryById(transaction.type, transaction.categoryId);
                        const row = document.createElement('tr');
                        
                        const typeClass = transaction.type === 'income' ? 'text-secondary' : 'text-danger';
                        const typeText = transaction.type === 'income' ? '收入' : '支出';
                        const amountSign = transaction.type === 'income' ? '+' : '-';
                        
                        row.innerHTML = `
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div class="text-sm text-gray-700">${formatDate(transaction.date)}</div>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div class="text-sm ${typeClass}">${typeText}</div>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="category-icon" style="background-color: ${category.color}; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                                        <i class="fa ${category.icon} text-white text-xs"></i>
                                    </div>
                                    <div class="text-sm text-gray-700">${category.name}</div>
                                </div>
                            </td>
                            <td class="px-3 py-2">
                                <div class="text-sm text-gray-700">${transaction.description}</div>
                                ${transaction.unit ? `<div class="text-xs text-gray-500">${transaction.type === 'income' ? '付款单位' : '收款单位'}: ${transaction.unit}</div>` : ''}
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-right">
                                <div class="text-sm font-medium ${typeClass}">${amountSign}${formatAmount(transaction.amount).replace('¥', '')}</div>
                            </td>
                        `;
                        
                        detailsContainer.appendChild(row);
                    });
                }
            }
            
            // 显示结果区域和打印按钮
            if (resultsContainer) {
                resultsContainer.classList.remove('hidden');
                
                // 滚动到结果区域
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // 不再清空收款/付款单位输入框，保留用户输入内容
            // if (unitInput) {
            //     unitInput.value = '';
            // }
            // if (unitValueInput) {
            //     unitValueInput.value = '';
            // }
        }
        
        // 重置财务对账筛选条件
        function resetReconciliation() {
            // 清空收/付款单位输入框
            const unitValueInput = document.getElementById('reconciliation-unit-value');
            const unitInput = document.getElementById('reconciliation-unit');
            if (unitValueInput) unitValueInput.value = '';
            if (unitInput) {
                unitInput.value = '';
                // 隐藏单位建议列表
                const suggestionsContainer = document.getElementById('reconciliation-unit-suggestions');
                if (suggestionsContainer) suggestionsContainer.classList.add('hidden');
            }
            
            // 清空日期下拉框
            const startDateInput = document.getElementById('reconciliation-start-date');
            const endDateInput = document.getElementById('reconciliation-end-date');
            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
            
            // 显示所有交易记录
            const company = getCurrentCompany();
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            
            // 设置公司抬头
            const companyNames = {
                'company1': '普利美（常州）环境工程科技有限公司',
                'company2': '无锡龙力印铁设备制造有限公司'
            };
            const displayName = companyNames[company] || company;
            document.getElementById('company-header').querySelector('h2').textContent = displayName;
            
            // 计算汇总数据（所有记录）
            let totalIncome = 0;
            let totalExpense = 0;
            
            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.amount;
                } else {
                    totalExpense += transaction.amount;
                }
            });
            
            const balance = totalIncome - totalExpense;
            
            // 更新结果显示
            const incomeElement = document.getElementById('reconciliation-income');
            const expenseElement = document.getElementById('reconciliation-expense');
            const balanceElement = document.getElementById('reconciliation-balance');
            const countElement = document.getElementById('reconciliation-count');
            const detailsContainer = document.getElementById('reconciliation-details');
            const resultsContainer = document.getElementById('reconciliation-results');
            
            if (incomeElement) incomeElement.textContent = formatAmount(totalIncome);
            if (expenseElement) expenseElement.textContent = formatAmount(totalExpense);
            
            if (balanceElement) {
                balanceElement.textContent = formatAmount(balance);
                balanceElement.className = balance >= 0 ? 'text-xl font-bold text-secondary' : 'text-xl font-bold text-danger';
            }
            
            if (countElement) countElement.textContent = transactions.length;
            
            // 显示所有交易明细
            if (detailsContainer) {
                detailsContainer.innerHTML = '';
                
                // 按日期降序排序，如果日期相同则按创建时间降序排序
                const sortedTransactions = [...transactions].sort((a, b) => {
                    const dateDiff = new Date(b.date) - new Date(a.date);
                    return dateDiff !== 0 ? dateDiff : new Date(b.createdAt) - new Date(a.createdAt);
                });
                
                if (sortedTransactions.length === 0) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = `
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            没有交易记录
                        </td>
                    `;
                    detailsContainer.appendChild(emptyRow);
                } else {
                    sortedTransactions.forEach(transaction => {
                        const category = getCategoryById(transaction.type, transaction.categoryId);
                        const row = document.createElement('tr');
                        
                        const typeClass = transaction.type === 'income' ? 'text-secondary' : 'text-danger';
                        const typeText = transaction.type === 'income' ? '收入' : '支出';
                        const amountSign = transaction.type === 'income' ? '+' : '-';
                        
                        row.innerHTML = `
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div class="text-sm text-gray-700">${formatDate(transaction.date)}</div>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div class="text-sm ${typeClass}">${typeText}</div>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="category-icon" style="background-color: ${category.color}; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                                        <i class="fa ${category.icon} text-white text-xs"></i>
                                    </div>
                                    <div class="text-sm text-gray-700">${category.name}</div>
                                </div>
                            </td>
                            <td class="px-3 py-2">
                                <div class="text-sm text-gray-700">${transaction.description}</div>
                                ${transaction.unit ? `<div class="text-xs text-gray-500">${transaction.type === 'income' ? '付款单位' : '收款单位'}: ${transaction.unit}</div>` : ''}
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap text-right">
                                <div class="text-sm font-medium ${typeClass}">${amountSign}${formatAmount(transaction.amount).replace('¥', '')}</div>
                            </td>
                        `;
                        
                        detailsContainer.appendChild(row);
                    });
                }
            }
            
            // 显示结果区域
            if (resultsContainer) {
                resultsContainer.classList.remove('hidden');
                
                // 滚动到结果区域
                resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // 显示重置成功提示
            showNotification('重置成功', '筛选条件已清空，列表已恢复所有记录', 'success');
        }
        
        // 生成对账单报告并跳转到对账单页面
        function generateReconciliationReport() {
            const company = getCurrentCompany();
            
            // 获取筛选条件
            const unitValueInput = document.getElementById('reconciliation-unit-value');
            const unitInput = document.getElementById('reconciliation-unit');
            const selectedUnit = unitValueInput ? unitValueInput.value : (unitInput ? unitInput.value : '');
            const startDateInput = document.getElementById('reconciliation-start-date');
            const endDateInput = document.getElementById('reconciliation-end-date');
            
            // 验证日期
            if (!startDateInput || !endDateInput || !startDateInput.value || !endDateInput.value) {
                showNotification('日期错误', '请选择完整的日期范围', 'error');
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                showNotification('日期错误', '请选择有效的日期', 'error');
                return;
            }
            
            if (startDate > endDate) {
                showNotification('日期错误', '开始日期不能晚于结束日期', 'error');
                return;
            }
            
            // 构建URL参数
            const params = new URLSearchParams();
            params.append('company', company);
            params.append('unit', selectedUnit);
            params.append('startDate', startDateInput.value);
            params.append('endDate', endDateInput.value);
            
            // 获取当前公司的交易数据并筛选
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            const filteredTransactions = transactions.filter(transaction => {
                const transactionDate = new Date(transaction.date);
                const dateMatch = transactionDate >= startDate && transactionDate <= endDate;
                const unitMatch = !selectedUnit || 
                                  (transaction.unit && transaction.unit.includes(selectedUnit)) ||
                                  (transaction.description && transaction.description.includes(selectedUnit));
                return dateMatch && unitMatch;
            });
            
            // 准备对账单页面所需的数据格式
            const preparedTransactions = filteredTransactions.map(transaction => {
                // 获取分类名称（尝试多种方式）
                let categoryName = transaction.categoryName || '未分类';
                
                // 如果没有直接的categoryName，尝试通过categoryId获取
                if (categoryName === '未分类' && transaction.categoryId) {
                    try {
                        // 尝试不同格式的分类数据存储
                        const categoriesKeys = [
                            `categories_${company}`,
                            `${company}-categories`,
                            'categories'
                        ];
                        
                        let categories = [];
                        for (const key of categoriesKeys) {
                            const catData = localStorage.getItem(key);
                            if (catData) {
                                categories = JSON.parse(catData);
                                break;
                            }
                        }
                        
                        if (Array.isArray(categories)) {
                            // 尝试直接查找
                            let category = categories.find(cat => cat.id === transaction.categoryId);
                            
                            // 如果找不到，尝试在收入/支出分类中查找
                            if (!category && categories.income && Array.isArray(categories.income)) {
                                category = categories.income.find(cat => cat.id === transaction.categoryId);
                            }
                            if (!category && categories.expense && Array.isArray(categories.expense)) {
                                category = categories.expense.find(cat => cat.id === transaction.categoryId);
                            }
                            
                            if (category) {
                                categoryName = category.name || '未分类';
                            }
                        }
                    } catch (e) {
                        console.error('获取分类名称失败:', e);
                    }
                }
                
                // 为了兼容可能的原始交易数据中的分类名称字段
                if (categoryName === '未分类') {
                    // 检查交易数据中可能存在的其他分类相关字段
                    if (transaction.category) {
                        categoryName = transaction.category;
                    } else if (transaction.type === 'income' && transaction.incomeCategory) {
                        categoryName = transaction.incomeCategory;
                    } else if (transaction.type === 'expense' && transaction.expenseCategory) {
                        categoryName = transaction.expenseCategory;
                    }
                }
                
                const preparedTransaction = {
                    date: transaction.date,
                    type: transaction.type,
                    amount: transaction.amount,
                    categoryName: categoryName,
                    description: transaction.description || '',
                    unit: transaction.unit || ''
                };
                
                return preparedTransaction;
            });
            
            // 保存筛选后的交易到localStorage，供对账单页面使用
            localStorage.setItem('reconciliation_transactions', JSON.stringify(preparedTransactions));
            localStorage.setItem('reconciliation_params', params.toString());
            
            // 跳转到对账单页面
            window.open(`对账单.html`, '_blank');
        }
        
        // 导出Excel功能
        function exportToExcel() {
            // 获取当前公司
            const company = getCurrentCompany();
            const companyName = document.getElementById(`${company}-btn`).textContent.trim();
            
            // 获取当前公司的交易数据
            const transactions = JSON.parse(localStorage.getItem(`transactions_${company}`)) || [];
            
            if (transactions.length === 0) {
                alert('没有交易数据可导出');
                return;
            }
            
            window.exportingExcel = true; // 标记正在导出中，防止重复触发关闭提示
            
            // 准备导出数据
            const exportData = transactions.map(transaction => {
                // 将类型转换为中文
                const type = transaction.type === 'income' ? '收入' : '支出';
                
                // 确保日期格式为Excel可识别的格式 (yyyy-mm-dd)
                const dateObj = new Date(transaction.date);
                const formattedDate = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                
                // 根据交易类型决定单位显示名称
                const unitLabel = transaction.type === 'income' ? '付款单位' : '收款单位';
                
                // 确保金额是数值类型
                const amount = parseFloat(transaction.amount) || 0;
                
                return {
                    '日期': formattedDate,
                    '类型': type,
                    '分类': transaction.categoryName || '',
                    '金额(¥)': amount,
                    '描述': transaction.description || '',
                    [unitLabel]: transaction.unit || ''
                };
            });
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建工作表，使用默认配置避免类型转换问题
            const ws = XLSX.utils.json_to_sheet(exportData);
            
            // 获取工作表范围
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            // 确保所有单元格都有正确的类型
            for (let r = range.s.r; r <= range.e.r; r++) {
                for (let c = range.s.c; c <= range.e.c; c++) {
                    const cellAddress = XLSX.utils.encode_cell({r, c});
                    const cell = ws[cellAddress];
                    
                    if (cell) {
                        // 处理金额列 (D列, 索引3)
                        if (c === 3) {
                            // 确保是数值类型
                            if (cell.t !== 'n') {
                                cell.t = 'n';
                                cell.v = parseFloat(cell.v) || 0;
                            }
                            // 设置为简单的数值格式，避免兼容性问题
                            cell.z = '0.00';
                        }
                        // 处理日期列 (A列, 索引0)
                        else if (c === 0) {
                            // 设置为文本类型，确保Excel正确显示
                            cell.t = 's';
                        }
                        // 处理其他列，确保是文本类型
                        else {
                            if (cell.t === 'n' && typeof cell.v === 'number') {
                                // 将数字转换为字符串
                                cell.t = 's';
                                cell.v = String(cell.v);
                            }
                        }
                    }
                }
            }
            
            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, ws, '交易记录');
            
            // 生成文件名，移除可能的特殊字符
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + 
                            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(today.getDate()).padStart(2, '0');
            
            // 处理公司名称，移除所有可能导致Excel问题的字符
            const safeCompanyName = companyName.replace(/[\\/:*?"<>|\[\]{}()!@#$%^&*+=~`]/g, '');
            const fileName = `${safeCompanyName}收支表_${dateStr}.xlsx`;
            
            // 简化导出选项，使用更兼容的设置
            XLSX.writeFile(wb, fileName, {
                bookType: 'xlsx',
                type: 'binary',
                // 移除可能导致问题的选项
                cellStyles: false,  // 禁用样式以避免兼容性问题
                cellDates: false,   // 禁用日期转换
                bookSST: false,     // 禁用共享字符串表
                compress: true      // 保持压缩以减少文件大小
            });
            
            alert(`${companyName}的数据已成功导出为Excel文件`);
            
            window.exportingExcel = false; // 重置导出状态
        }
        

        
        // Excel导入功能 - 增强版，真正解析Excel数据
        function importFromExcel(file) {
            if (!file) {
                alert('请选择一个文件');
                return;
            }
            
            // 检查文件类型
            const fileType = file.name.split('.').pop().toLowerCase();
            if (fileType !== 'xlsx' && fileType !== 'xls') {
                alert('请选择Excel文件(.xlsx或.xls)');
                return;
            }
            
            // 确认是否覆盖现有数据
            const company = getCurrentCompany();
            const companyName = document.getElementById(`${company}-btn`).textContent.trim();
            const currentTransactions = JSON.parse(localStorage.getItem(`transactions_${company}`) || '[]');
            if (currentTransactions.length > 0) {
                if (!confirm(`导入Excel会覆盖${companyName}的现有数据，是否继续？`)) {
                    return;
                }
            }
            
            // 创建调试信息面板
            const createDebugPanel = function() {
                let debugDiv = document.getElementById('excel-debug-panel');
                if (!debugDiv) {
                    debugDiv = document.createElement('div');
                    debugDiv.id = 'excel-debug-panel';
                    debugDiv.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 20px;
                        right: 20px;
                        background: #f8f9fa;
                        border: 2px solid #dee2e6;
                        border-radius: 8px;
                        padding: 15px;
                        z-index: 9999;
                        max-height: 300px;
                        overflow-y: auto;
                        font-family: Arial, sans-serif;
                        font-size: 12px;
                        color: #333;
                    `;
                    const title = document.createElement('div');
                    title.style.cssText = 'font-weight: bold; margin-bottom: 10px; color: #007bff;';
                    title.textContent = 'Excel导入调试信息';
                    debugDiv.appendChild(title);
                    document.body.appendChild(debugDiv);
                }
                return debugDiv;
            };
            
            const debugPanel = createDebugPanel();
            const log = function(message, type = 'info') {
                const logDiv = document.createElement('div');
                logDiv.style.marginBottom = '5px';
                
                if (type === 'error') {
                    logDiv.style.color = '#dc3545';
                    logDiv.textContent = 'ERROR: ' + message;
                } else if (type === 'success') {
                    logDiv.style.color = '#28a745';
                    logDiv.textContent = 'SUCCESS: ' + message;
                } else {
                    logDiv.textContent = message;
                }
                
                debugPanel.appendChild(logDiv);
                debugPanel.scrollTop = debugPanel.scrollHeight;
                console.log('[Excel Import] ' + message);
            };
            
            // 清空调试面板
            debugPanel.innerHTML = '';
            const title = document.createElement('div');
            title.style.cssText = 'font-weight: bold; margin-bottom: 10px; color: #007bff;';
            title.textContent = 'Excel导入调试信息';
            debugPanel.appendChild(title);
            
            log('开始导入文件: ' + file.name);
            log('文件大小: ' + (file.size / 1024).toFixed(2) + ' KB');
            
            // 创建文件读取器
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    log('文件读取完成，开始解析Excel...');
                    
                    // 读取Excel文件 - 优化日期处理配置
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { 
                        type: 'array',
                        cellDates: false,  // 禁用自动日期转换，保留原始日期序列号
                        cellNF: true,     // 使用数字格式以获得更好的格式化日期
                        cellText: false,  // 尝试使用原始值
                        raw: true,        // 使用原始数据，确保数字保持为数值类型
                        dateNF: 'yyyy-mm-dd', // 指定日期输出格式
                        dense: false,     // 不使用密集模式以获得更完整的单元格信息
                        bookDates: true   // 确保工作簿中的日期信息被保留
                    });
                    log('Excel配置: cellDates=false, dateNF=yyyy-mm-dd');
                    log('重要: 禁用了自动日期转换，将使用自定义日期序列号处理');
                    log('工作表信息: ' + wb.SheetNames.length + ' 个工作表');
                    
                    // 获取第一个工作表
                    const wsname = wb.SheetNames[0];
                    log('使用工作表: ' + wsname);
                    const ws = wb.Sheets[wsname];
                    
                    // 同时读取原始单元格信息，保留日期类型
                    const rawData = XLSX.utils.sheet_to_json(ws, {header: 1});
                    log('成功读取工作表，共 ' + rawData.length + ' 行数据');
                    
                    // 直接读取单元格信息，检查是否有日期单元格
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    log('工作表范围: 从A' + (range.s.r + 1) + '到' + XLSX.utils.encode_col(range.e.c) + (range.e.r + 1));
                    
                    // 检查前几行第一列是否有日期类型
                    for (let i = 0; i < Math.min(5, range.e.r + 1); i++) {
                        const cellAddress = XLSX.utils.encode_cell({r: i, c: 0});
                        const cell = ws[cellAddress];
                        if (cell) {
                            log(`单元格${cellAddress}: 值=${cell.v}, 类型=${cell.t || 'unknown'}, 格式化=${cell.f || 'none'}`);
                            
                            // 如果是日期类型，尝试直接转换
                            if (cell.t === 'd') {
                                const date = new Date(cell.v);
                                log(`  直接日期转换: ${date.toISOString().split('T')[0]}`);
                            } else if (cell.t === 'n' && typeof cell.w === 'string' && cell.w.match(/\d{4}/)) {
                                // 检查是否可能是日期序列号
                                try {
                                    const date = new Date(Math.round((cell.v - 25569) * 86400 * 1000));
                                    if (!isNaN(date.getTime())) {
                                        log(`  可能的日期序列号转换: ${date.toISOString().split('T')[0]}`);
                                    }
                                } catch (e) {
                                    log(`  日期序列号转换错误: ${e.message}`);
                                }
                            }
                        }
                    }
                    
                    // 显示前几行原始数据
                    for (let i = 0; i < Math.min(3, rawData.length); i++) {
                        const row = rawData[i];
                        if (row && Array.isArray(row)) {
                            log('第' + (i+1) + '行: [' + row.map(cell => typeof cell === 'string' ? '"' + cell + '"' : cell).join(', ') + ']');
                        }
                    }
                    
                    // 解析数据行
                    const transactions = [];
                    const successRows = [];
                    const skippedRows = [];
                    
                    // 跳过表头，从第2行开始处理
                    for (let i = 1; i < rawData.length; i++) {
                        try {
                            const row = rawData[i];
                            
                            // 如果行是空的，跳过
                            if (!row || !Array.isArray(row) || row.every(cell => cell === undefined || cell === null || cell === '')) {
                                skippedRows.push({row: i+1, reason: '空行'});
                                continue;
                            }
                            
                            log(`\n处理第${i+1}行数据:`, 'info');
                            
                            // 提取各个字段
                            // 位置0: 日期 - 重写为统一、健壮的日期处理逻辑
                            let date = '';
                            
                            // 核心日期处理函数 - 统一处理所有日期情况
                            const processDate = function(value, type, formattedValue) {
                                log(`  处理日期值: ${value}, 类型: ${type || typeof value}, 格式化值: ${formattedValue || '无'}`);
                                
                                // 1. 优先使用格式化值（如果有）
                                if (formattedValue && typeof formattedValue === 'string') {
                                    const dateObj = parseDateString(formattedValue);
                                    if (dateObj) {
                                        log(`  ✓ 使用格式化值解析: ${dateObj.toISOString().split('T')[0]}`);
                                        return dateObj;
                                    }
                                }
                                
                                // 2. 处理数字（Excel日期序列号）- 优先处理，避免日期对象转换错误
                                if (typeof value === 'number') {
                                    const dateObj = convertExcelSerialToDate(value);
                                    if (dateObj) {
                                        return dateObj;
                                    }
                                }
                                
                                // 3. 处理字符串
                                if (typeof value === 'string') {
                                    const dateObj = parseDateString(value);
                                    if (dateObj) {
                                        return dateObj;
                                    }
                                }
                                
                                // 4. 最后处理日期对象（仅当其他方法都失败时）
                                if (value instanceof Date && !isNaN(value.getTime())) {
                                    // 验证日期对象的有效性，避免XLSX.js转换错误
                                    const dateString = value.toISOString().split('T')[0];
                                    const verifiedDate = parseDateString(dateString);
                                    if (verifiedDate) {
                                        log(`  ✓ 验证日期对象: ${verifiedDate.toISOString().split('T')[0]}`);
                                        return verifiedDate;
                                    } else {
                                        log(`  ✓ 直接使用日期对象: ${dateString}`);
                                        return value;
                                    }
                                }
                                
                                return null;
                            };
                            
                            // Excel日期序列号转换函数
                            const convertExcelSerialToDate = function(serial) {
                                try {
                                    // Excel到JavaScript日期转换
                                    // 注意：Excel使用1900年日期系统，错误地将1900年视为闰年
                                    
                                    // 计算从1900-01-01到目标日期的天数
                                    let days = serial;
                                    
                                    // 创建UTC日期对象以避免时区问题
                                    // Excel的第1天是1900-01-01，第2天是1900-01-02，以此类推
                                    const baseDate = new Date(Date.UTC(1899, 11, 31)); // 使用UTC时间创建1899-12-31作为基准日期
                                    
                                    // 添加天数（使用setUTCDate确保在UTC时区计算）
                                    const resultDate = new Date(baseDate);
                                    resultDate.setUTCDate(resultDate.getUTCDate() + Math.round(days));
                                    
                                    // 调整1900年闰年错误
                                    // Excel错误地包含了1900年2月29日（序列号60）
                                    if (days >= 60) {
                                        resultDate.setUTCDate(resultDate.getUTCDate() - 1); // 跳过无效的1900年2月29日
                                    }
                                    
                                    // 验证日期有效性
                                    if (!isNaN(resultDate.getTime()) && resultDate.getUTCFullYear() >= 1900 && resultDate.getUTCFullYear() <= 2100) {
                                        log(`  ✓ Excel日期序列号转换成功: ${resultDate.toISOString().split('T')[0]}, 序列号: ${serial}`);
                                        return resultDate;
                                    } else {
                                        log(`  ✗ 数字${serial}不是有效的日期序列号`);
                                    }
                                } catch (e) {
                                    log(`  ✗ 日期序列号转换错误: ${e.message}`);
                                }
                                return null;
                            };
                            
                            // 智能日期字符串解析函数
                            const parseDateString = function(dateStr) {
                                if (!dateStr || typeof dateStr !== 'string') return null;
                                
                                const trimmedStr = dateStr.trim();
                                
                                // 尝试不同的日期格式模式（优先使用可靠的模式匹配）
                                const patterns = [
                                    // 常用日期格式模式
                                    /^(\d{4})[-/](\d{1,2})[-/](\d{1,2})/,  // YYYY-MM-DD
                                    /^(\d{4})[年](\d{1,2})[月](\d{1,2})[日]?/,  // YYYY年MM月DD日
                                    /^(\d{4})[.](\d{1,2})[.](\d{1,2})/,  // YYYY.MM.DD
                                    /^(\d{1,2})[-/](\d{1,2})[-/](\d{4})/,  // MM-DD-YYYY 或 DD-MM-YYYY
                                    /^(\d{1,2})[.](\d{1,2})[.](\d{4})/,  // MM.DD.YYYY 或 DD.MM.YYYY
                                    /^(\d{1,2})[-/](\d{1,2})[-/](\d{2})/,  // MM-DD-YY 或 DD-MM-YY
                                    /^(\d{4})(\d{2})(\d{2})/               // YYYYMMDD
                                ];
                                
                                for (const pattern of patterns) {
                                    const match = trimmedStr.match(pattern);
                                    if (match) {
                                        let year, month, day;
                                        
                                        // 根据不同的模式提取年月日
                                        if (pattern === patterns[0]) { // YYYY-MM-DD
                                            [, year, month, day] = match;
                                        } else if (pattern === patterns[1]) { // YYYY年MM月DD日
                                            [, year, month, day] = match;
                                        } else if (pattern === patterns[2]) { // YYYY.MM.DD
                                            [, year, month, day] = match;
                                        } else if (pattern === patterns[3]) { // MM-DD-YYYY 或 DD-MM-YYYY
                                            let part1 = parseInt(match[1], 10);
                                            let part2 = parseInt(match[2], 10);
                                            year = match[3];
                                            
                                            // 智能判断：如果part1 > 12，那么它是日期，part2是月份
                                            if (part1 > 12 && part2 <= 12) {
                                                month = part2;
                                                day = part1;
                                            } else {
                                                month = part1;
                                                day = part2;
                                            }
                                        } else if (pattern === patterns[4]) { // MM.DD.YYYY 或 DD.MM.YYYY
                                            let part1 = parseInt(match[1], 10);
                                            let part2 = parseInt(match[2], 10);
                                            year = match[3];
                                            
                                            // 智能判断：如果part1 > 12，那么它是日期，part2是月份
                                            if (part1 > 12 && part2 <= 12) {
                                                month = part2;
                                                day = part1;
                                            } else {
                                                month = part1;
                                                day = part2;
                                            }
                                        } else if (pattern === patterns[5]) { // MM-DD-YY 或 DD-MM-YY
                                            let part1 = parseInt(match[1], 10);
                                            let part2 = parseInt(match[2], 10);
                                            let year2 = match[3];
                                            year = '20' + year2; // 假设是21世纪
                                            
                                            // 智能判断：如果part1 > 12，那么它是日期，part2是月份
                                            if (part1 > 12 && part2 <= 12) {
                                                month = part2;
                                                day = part1;
                                            } else {
                                                month = part1;
                                                day = part2;
                                            }
                                        } else if (pattern === patterns[6]) { // YYYYMMDD
                                            [, year, month, day] = match;
                                        }
                                        
                                        // 验证月和日的有效性
                                        month = parseInt(month, 10);
                                        day = parseInt(day, 10);
                                        year = parseInt(year, 10);
                                        
                                        if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year >= 1900 && year <= 2100) {
                                            const dateObj = new Date(year, month - 1, day);
                                            if (!isNaN(dateObj.getTime())) {
                                                log(`  ✓ 模式匹配解析成功: ${dateObj.toISOString().split('T')[0]}`);
                                                return dateObj;
                                            }
                                        }
                                    }
                                }
                                
                                // 尝试直接解析（作为备选方案，放在模式匹配之后）
                                let dateObj = new Date(trimmedStr);
                                if (!isNaN(dateObj.getTime())) {
                                    log(`  ✓ 直接字符串解析成功: ${dateObj.toISOString().split('T')[0]}`);
                                    return dateObj;
                                }
                                
                                // 尝试提取所有数字并重组
                                const numbers = trimmedStr.match(/\d+/g);
                                if (numbers && numbers.length >= 3) {
                                    // 找4位数字作为年份
                                    const yearMatch = numbers.find(n => n.length === 4 && parseInt(n) >= 1900 && parseInt(n) <= 2100);
                                    if (yearMatch) {
                                        const year = parseInt(yearMatch, 10);
                                        const otherNumbers = numbers.filter(n => n !== yearMatch).map(n => parseInt(n, 10)).filter(n => n <= 31);
                                        
                                        if (otherNumbers.length >= 2) {
                                            let possibleCombinations = [
                                                [otherNumbers[0], otherNumbers[1]],  // 可能是月-日
                                                [otherNumbers[1], otherNumbers[0]]   // 可能是日-月
                                            ];
                                            
                                            // 智能判断：如果一个数字大于12，它更可能是日期而不是月份
                                            if (otherNumbers[0] > 12 && otherNumbers[1] <= 12) {
                                                // 明确是日-月顺序
                                                possibleCombinations = [[otherNumbers[1], otherNumbers[0]]];
                                            } else if (otherNumbers[1] > 12 && otherNumbers[0] <= 12) {
                                                // 明确是月-日顺序
                                                possibleCombinations = [[otherNumbers[0], otherNumbers[1]]];
                                            }
                                            
                                            for (const [m, d] of possibleCombinations) {
                                                if (m >= 1 && m <= 12 && d >= 1 && d <= 31) {
                                                    const dateObj = new Date(year, m - 1, d);
                                                    if (!isNaN(dateObj.getTime())) {
                                                        log(`  ✓ 数字重组解析成功: ${dateObj.toISOString().split('T')[0]} (${year}-${m}-${d})`);
                                                        return dateObj;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                                
                                log(`  ✗ 字符串解析失败: "${trimmedStr}"`);
                                return null;
                            };
                            
                            // 1. 首先尝试直接从工作表获取原始单元格信息
                            const cellAddress = XLSX.utils.encode_cell({r: i, c: 0}); // 注意: i从1开始，对应工作表第2行（因为rawData[0]是表头，对应工作表第0行）
                            const cell = ws[cellAddress];
                            
                            log(`\n处理第${i+1}行数据:`);
                            log(`  原始行索引: ${i}, 单元格地址: ${cellAddress}`);
                            
                            let dateObj = null;
                            
                            // 从单元格对象处理
                            if (cell) {
                                dateObj = processDate(cell.v, cell.t, cell.w);
                            }
                            
                            // 如果单元格处理失败，尝试从行数据处理
                            if (!dateObj && row[0] !== undefined && row[0] !== null && row[0] !== '') {
                                log(`  尝试从行数据处理`);
                                dateObj = processDate(row[0], typeof row[0]);
                            }
                            
                            // 如果成功解析到日期，格式化为ISO日期字符串
                            if (dateObj) {
                                date = dateObj.toISOString().split('T')[0];
                            } else {
                                // 如果所有方法都失败，使用当前日期作为最后的备选
                                date = new Date().toISOString().split('T')[0];
                                log(`  ✗ 所有方法都失败，使用当前日期: ${date}`);
                            }
                            
                            log(`  最终使用日期: ${date}`);
                            
                            // 位置1: 类型
                            let type = 'expense'; // 默认支出
                            if (row[1] !== undefined && row[1] !== null && row[1] !== '') {
                                const typeStr = String(row[1]).toLowerCase().trim();
                                if (typeStr.includes('收入') || typeStr.includes('income')) {
                                    type = 'income';
                                }
                            }
                            log(`  类型: ${type === 'income' ? '收入' : '支出'}`);
                            
                            // 位置2: 分类
                            let categoryId = null;
                            let categoryName = '其他';
                            if (row[2] !== undefined && row[2] !== null && row[2] !== '') {
                                const catStr = String(row[2]).trim();
                                categoryName = catStr;
                                
                                // 查找匹配的分类
                                const categories = type === 'income' ? window.categories.income : window.categories.expense;
                                for (const cat of categories) {
                                    if (cat.name === catStr || 
                                        cat.name.includes(catStr) || 
                                        catStr.includes(cat.name)) {
                                        categoryId = cat.id;
                                        categoryName = cat.name;
                                        break;
                                    }
                                }
                            }
                            
                            // 如果没找到分类，使用默认分类
                            if (!categoryId) {
                                categoryId = type === 'income' ? 'other-income' : 'other-expense';
                                categoryName = type === 'income' ? '其他收入' : '其它支出';
                            }
                            log(`  分类: ${categoryName} (ID: ${categoryId})`);
                            
                            // 位置3: 金额
                            let amount = 0;
                            if (row[3] !== undefined && row[3] !== null && row[3] !== '') {
                                if (typeof row[3] === 'number') {
                                    amount = Math.abs(row[3]);
                                } else {
                                    const amountStr = String(row[3]).trim().replace(/[^0-9.-]/g, '');
                                    const parsedAmount = parseFloat(amountStr);
                                    if (!isNaN(parsedAmount)) {
                                        amount = Math.abs(parsedAmount);
                                    }
                                }
                            }
                            log(`  金额: ${amount}`);
                            
                            // 位置4: 描述
                            const description = row[4] !== undefined && row[4] !== null ? String(row[4]).trim() : '';
                            log(`  描述: ${description}`);
                            
                            // 检查Excel文件的列结构，确定单位字段的位置
                            // 支持两种格式：
                            // 1. 模板格式：只有一个单位名称列（位置5）
                            // 2. 完整格式：付款单位（位置5）和收款单位（位置6）
                            
                            // 尝试获取单位相关数据
                            let payerUnit = '';
                            let payeeUnit = '';
                            let unitName = '';
                            
                            // 首先检查是否是完整格式（两列单位）
                            if (row[5] !== undefined && row[5] !== null) {
                                payerUnit = String(row[5]).trim();
                                log(`  从位置5获取付款单位: ${payerUnit}`);
                            }
                            
                            if (row[6] !== undefined && row[6] !== null) {
                                payeeUnit = String(row[6]).trim();
                                log(`  从位置6获取收款单位: ${payeeUnit}`);
                            }
                            
                            // 如果只有一列单位数据，按模板格式处理
                            if ((!payerUnit && payeeUnit) || (payerUnit && !payeeUnit)) {
                                // 只有一列有数据，判断哪一列是单位名称
                                unitName = payerUnit || payeeUnit;
                                payerUnit = '';
                                payeeUnit = '';
                                log(`  检测到模板格式，只有一列单位数据: ${unitName}`);
                            }
                            
                            // 兼容处理：如果只提供了一个单位名称字段（模板格式）
                            // 根据交易类型将该字段的值设置为对应的单位
                            if (unitName) {
                                if (type === 'income') {
                                    payerUnit = unitName;
                                    log(`  兼容处理: 收入类型使用单位名称作为付款单位`);
                                } else {
                                    payeeUnit = unitName;
                                    log(`  兼容处理: 支出类型使用单位名称作为收款单位`);
                                }
                            }
                            
                            // 根据交易类型使用对应的单位
                            let unit = type === 'income' ? payerUnit : payeeUnit;
                            
                            // 只有金额大于0才创建交易记录
                            if (amount > 0) {
                                const transaction = {
                                    id: generateId(),
                                    type: type,
                                    amount: amount,
                                    categoryId: categoryId,
                                    categoryName: categoryName,
                                    date: date,
                                    description: description,
                                    unit: unit,
                                    payeeUnit: payeeUnit,  // 保存收款单位
                                    payerUnit: payerUnit,  // 保存付款单位
                                    createdAt: new Date().toISOString()
                                };
                                
                                transactions.push(transaction);
                                successRows.push(i+1);
                                log(`  ✓ 成功创建交易记录`, 'success');
                            } else {
                                skippedRows.push({row: i+1, reason: '金额为0或无效'});
                                log(`  ✗ 跳过：金额为0或无效`, 'error');
                            }
                            
                        } catch (error) {
                            skippedRows.push({row: i+1, reason: error.message});
                            log(`  ✗ 处理第${i+1}行时出错: ${error.message}`, 'error');
                            continue;
                        }
                    }
                    
                    // 生成详细的处理报告
                    log('\n========== 导入完成 ==========');
                    log(`成功导入: ${transactions.length} 条记录`, 'success');
                    log(`成功行: ${successRows.length > 0 ? successRows.join(', ') : '无'}`);
                    if (skippedRows.length > 0) {
                        log(`跳过: ${skippedRows.length} 行`, 'error');
                        skippedRows.forEach(skip => {
                            log(`  第${skip.row}行: ${skip.reason}`, 'error');
                        });
                    }
                    
                    // 如果导入了交易记录，保存它们
                    if (transactions.length > 0) {
                        const company = getCurrentCompany();
                        localStorage.setItem(`transactions_${company}`, JSON.stringify(transactions));
                        
                        // 更新最后修改时间
                        const today = new Date().toISOString().split('T')[0];
                        localStorage.setItem(`lastUpdated_${company}`, today);
                        if (document.getElementById('last-updated')) {
                            document.getElementById('last-updated').textContent = today;
                        }
                        
                        // 重新加载数据
                        if (typeof loadTransactions === 'function') {
                            loadTransactions();
                        }
                        if (typeof updateFinancialSummary === 'function') {
                            updateFinancialSummary();
                        }
                        
                        alert(`✅ Excel导入成功！\n成功导入: ${transactions.length} 条记录\n\n请查看页面底部的详细调试信息`);
                    } else {
                        // 如果没有成功导入记录，创建一些示例数据
                        const sampleTransactions = [
                            {
                                id: generateId(),
                                type: 'expense',
                                amount: 100,
                                categoryId: 'raw-materials',
                                categoryName: '原材料',
                                date: new Date().toISOString().split('T')[0],
                                description: '系统创建的示例支出',
                                unit: '示例供应商',
                                createdAt: new Date().toISOString()
                            },
                            {
                                id: generateId(),
                                type: 'income',
                                amount: 1000,
                                categoryId: 'salary',
                                categoryName: '工资',
                                date: new Date().toISOString().split('T')[0],
                                description: '系统创建的示例收入',
                                unit: '示例客户',
                                createdAt: new Date().toISOString()
                            }
                        ];
                        
                        const company = getCurrentCompany();
                        localStorage.setItem(`transactions_${company}`, JSON.stringify(sampleTransactions));
                        
                        if (typeof loadTransactions === 'function') {
                            loadTransactions();
                        }
                        if (typeof updateFinancialSummary === 'function') {
                            updateFinancialSummary();
                        }
                        
                        alert(`⚠️ 没有从Excel文件中成功导入任何记录\n已创建2条示例记录供参考\n\n请查看页面底部的详细调试信息`);
                    }
                    
                } catch (error) {
                    log('导入过程中发生严重错误: ' + error.message, 'error');
                    console.error('Excel导入错误:', error);
                    
                    // 错误情况下也创建示例数据
                    const sampleTransactions = [
                        {
                            id: generateId(),
                            type: 'expense',
                            amount: 50,
                            categoryId: 'raw-materials',
                            categoryName: '原材料',
                            date: new Date().toISOString().split('T')[0],
                            description: '系统恢复数据',
                            unit: '系统',
                            createdAt: new Date().toISOString()
                        }
                    ];
                    
                    const company = getCurrentCompany();
                    localStorage.setItem(`transactions_${company}`, JSON.stringify(sampleTransactions));
                    if (typeof loadTransactions === 'function') {
                        loadTransactions();
                    }
                    if (typeof updateFinancialSummary === 'function') {
                        updateFinancialSummary();
                    }
                    
                    alert(`❌ 导入过程中发生错误\n错误信息: ${error.message}\n\n已创建1条示例记录\n请查看页面底部的详细调试信息`);
                }
            };
            
            reader.onerror = function(error) {
                log('文件读取失败: ' + (error.message || '未知错误'), 'error');
                
                // 读取失败时也创建示例数据
                const sampleTransactions = [
                    {
                        id: generateId(),
                        type: 'expense',
                        amount: 50,
                        categoryId: 'raw-materials',
                        categoryName: '原材料',
                        date: new Date().toISOString().split('T')[0],
                        description: '文件读取失败时的示例',
                        unit: '系统',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                const company = getCurrentCompany();
                    localStorage.setItem(`transactions_${company}`, JSON.stringify(sampleTransactions));
                if (typeof loadTransactions === 'function') {
                    loadTransactions();
                }
                if (typeof updateFinancialSummary === 'function') {
                    updateFinancialSummary();
                }
                
                alert('❌ 文件读取失败\n\n已创建1条示例记录\n请查看页面底部的详细调试信息');
            };
            
            // 开始读取文件
            log('开始读取文件内容...');
            reader.readAsArrayBuffer(file);
        }
        

        
        // 根据分类名称获取分类ID
        function getCategoryIdByName(type, categoryName) {
            const categories = type === 'income' ? window.categories.income : window.categories.expense;
            // 转换为小写进行比较，提高匹配成功率
            const normalizedName = categoryName.toLowerCase().trim();
            
            for (const category of categories) {
                // 同样转换分类名到小写进行比较
                if (category.name.toLowerCase().trim() === normalizedName) {
                    return category.id;
                }
                // 增加模糊匹配：如果分类名包含搜索的名称，也认为匹配成功
                if (category.name.toLowerCase().includes(normalizedName)) {
                    return category.id;
                }
            }
            return null;
        }
        
        // 导出Excel模板函数 - 确保与导入功能完全兼容
        function exportExcelTemplate() {
            // 创建示例数据 - 使用最简单的数据类型
            const sampleData = [
                // 表头 - 使用简单列名
                ['日期', '类型', '分类', '金额', '描述', '单位名称'], // 支出对应收款单位，收入对应付款单位
                // 示例数据行 - 确保数值为纯数字，日期为纯字符串
                [new Date().toISOString().split('T')[0], '支出', '原材料', 1000, '购买原材料', '供应商A'],
                [new Date().toISOString().split('T')[0], '收入', '工资', 2000, '工资收入', '公司B'],
                [new Date().toISOString().split('T')[0], '支出', '工资', 5000, '支付员工工资', '张三'],
                [new Date().toISOString().split('T')[0], '支出', '电镀费', 800, '产品表面处理', '电镀厂C'],
                [new Date().toISOString().split('T')[0], '支出', '个人借款', 3000, '员工临时借款', '李四']
            ];
            
            // 创建工作簿 - 使用最简单的配置
            const ws = XLSX.utils.aoa_to_sheet(sampleData);
            
            // 设置金额列的数值格式
            const amountColumn = XLSX.utils.encode_col(3); // 金额列是D列 (从0开始计数)
            const range = XLSX.utils.decode_range(ws['!ref']);
            
            // 为金额列的所有单元格设置数值格式
            for (let r = range.s.r; r <= range.e.r; r++) {
                const cellAddress = amountColumn + r;
                if (ws[cellAddress]) {
                    // 设置数值格式，保留两位小数，带千位分隔符
                    ws[cellAddress].z = '#,##0.00';
                    // 确保单元格类型为数字
                    ws[cellAddress].t = 'n';
                }
            }
            
            // 设置列宽以提高可读性
            ws['!cols'] = [
                { wch: 15 }, // 日期
                { wch: 8 },  // 类型
                { wch: 12 }, // 分类
                { wch: 12 }, // 金额
                { wch: 20 }, // 描述
                { wch: 15 }  // 单位名称（收款单位/付款单位）
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '交易记录');
            
            // 导出文件
            const filename = `交易记录导入模板_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename, {
                cellDates: true,
                cellStyles: false
            });
            
            // 显示详细提示信息
            alert('✅ Excel导入模板已下载成功！\n\n📋 使用说明：\n' + 
                  '1. 日期格式：YYYY-MM-DD\n' +
                  '2. 类型只能填写"收入"或"支出"\n' + 
                  '3. 分类支持：原材料、工资、电镀费、个人借款等\n' +
                  '4. 金额必须是数字格式\n' +
                  '5. 单位名称：\n' +
                  '   - 支出类型：填写收款单位\n' +
                  '   - 收入类型：填写付款单位\n' +
                  '6. 填写完成后保存文件\n' +
                  '7. 使用页面上的"导入Excel"功能上传\n\n' +
                  '💡 提示：页面底部会显示详细的导入调试信息，帮助您解决导入问题');
        }
        
        // 在页面加载完成后添加模板导出按钮
        document.addEventListener('DOMContentLoaded', function() {
            const importBtnContainer = document.querySelector('#import-excel').parentElement;
            const templateBtn = document.createElement('button');
            templateBtn.textContent = '下载Excel模板';
            templateBtn.className = 'btn btn-secondary ml-2';
            templateBtn.onclick = exportExcelTemplate;
            importBtnContainer.appendChild(templateBtn);
        });
        

        
        // 为导入导出按钮添加事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 这里只保留Excel导入导出功能的事件监听
            // JSON导入导出功能已被移除
        });
    
</script>
</body>
</html>
